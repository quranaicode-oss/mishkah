# إرشادات العمل بـ HTMLx في منظومة مشكاة

> **الغرض:** مساعدة المبرمجين على بناء واجهات HTMLx مستقرة عند التعامل مع قوالب متداخلة وكثيرة العناصر، وضمان توافق كامل مع نواة Mishkah وطبقة الـ DSL.

## 1. المبادئ العامة للقوالب

1. **كل `<template>` نطاق مستقل تلقائيًا:**
   * تم تعليم جذر القالب بـ `data-m-scope` مع مفتاح `tpl:<hash>`، لذا تُحجز أوامر القالب داخل هذا السياج.
   * لا تزيل هذه السمة يدويًا إلا إذا كنت متأكدًا أنك تحتاج مشاركة الأحداث مع نطاقات أخرى (`options.fence: 'soft' | 'none'`).
2. **اجعل الجذور واضحة:** استخدم عنصرًا واحدًا واضحًا داخل `<template>` ليكون الجذر، وتجنب إدخال نصوص حرة أو عقد متجاورة على المستوى الأعلى.
3. **سمِّ القوالب الذرّية:** عند بناء مكتبة من القوالب الصغيرة (مثل أزرار أو بطاقات)، ضع اسمًا وصفيًا في تعليق أعلى القالب، واحتفظ بمصدر الـ HTML مرجعيًا في ملف منفصل عند الحاجة.

## 2. إدارة المفاتيح داخل القالب

1. **تمييز كل عنصر فعّال بـ `data-m-gkey`:**
   * استخدم قيمًا معبرة تربط الحدث بالمكوّن المنطقي (مثل `lang:switch:ar`).
   * امتنع عن تكرار نفس المفتاح لأغراض مختلفة داخل القالب نفسه.
2. **عند التكرار (loops):**
   * اجمع قيمة مميِّزة من البيانات (مثال: `item.id`) وأضفها للمفتاح النهائي (`menu:item:${item.id}`).
   * إذا لم تتوفر قيمة فريدة، استخرج فهرس العنصر عبر `each` وأضِفَه صراحةً (`idx`).
3. **حافظ على تطابق `gkeys` مع الأوامر:** أي مفتاح تضعه في `data-m-gkey` يجب أن يقابله أمر في طبقة الأوامر (`orders`) يحمل نفس القيمة.

## 3. فصل السكربتات لكل مكوّن

1. **قسّم شيفرة التفاعل:** لكل مكوّن رئيسي داخل القالب (كالتبويب، مبدّل اللغة، قائمة جانبية)، وفر أمرًا أو مجموعة أوامر خاصة به.
2. **استخدم ملفات `<script type="module">` منفصلة عند الحاجة:** تجميع الأحداث في ملف واحد ضخم يصعّب تتبع السياقات.
3. **استورد الأدوات المشتركة من `mishkah-utils.js`:** تجنب كتابة دوال مساعدة مكررة داخل كل سكربت.

## 4. التداخل العميق وارتباط الأحداث

1. **اعتمد على السياق (`context.scopeNode`, `context.scopeQuery`):**
   * استخدم `context.scopeQuery` للوصول إلى عناصر داخل نفس القالب فقط.
   * لا تعتمد على `document.querySelector` في الأوامر، فهذا قد يقفز إلى نطاق آخر.
2. **اجعل الأحداث خاصة بأقرب عنصر:**
   * عند وجود قوائم متداخلة، اربط الحدث في العنصر الداخلي، ثم مرّر المعلومات للأمر عبر `data-*` أو عبر الحالة (`database`).
   * استخدم `event.currentTarget` بدلًا من `event.target` داخل المعالج عند الحاجة لتثبيت المرجع.
3. **استعمل `context.stop()` بحذر:**
   * أوقف تدفق الأوامر عندما يتعارض حدث داخلي مع حدث أعلى.
   * لا تترك أوامر تعتمد على حدوث stop ضمنيًا؛ صرّح بذلك في التعليقات.

## 5. تشخيص الأخطاء الشائعة

| العرض | السبب المحتمل | الحل |
| --- | --- | --- |
| جميع الأزرار تُشغِّل نفس الأمر | مفاتيح `data-m-gkey` متطابقة أو تُولّد من تعبير واحد | أعد تصميم المفتاح ليحمل معرف العنصر (`item.id` أو `lang`)|
| أوامر القالب الأب تُفعّل على أحداث الابن | القالب الأب بلا سياج أو ضبط `fence:'soft'` دون ضرورة | اترك الوضع الافتراضي (`hard`) أو أضف `data-m-scope` يدويًا |
| تغيّر لغة أو تبويب واحد يؤثر على البقية | مشاركة نفس الحقل في `database` أو غياب نسخة محلية للحالة | استعمل مسارًا منفصلًا في `database` لكل مكوّن أو فرّع الحالة | 
| صعوبة تتبع الأوامر أثناء التصحيح | الاعتماد على مفاتيح hash فقط | استعمل حقل `alias` المتاح في التوليد لتوثيق اسم إنساني لكل أمر |

## 6. سير العمل المقترح لمشروع HTMLx

1. **صمّم البيانات:** حدد شكل `database` المطلوب وحقول البيئة (`env`).
2. **ابنِ القوالب:** اكتب كل مكوّن HTMLx في `<template>` مستقل. تأكد من ضبط `data-m-gkey` و`data-*` الضرورية.
3. **ولّد الأوامر:** استخدم HTMLxAgent أو سكربت التجميع لتحويل القوالب إلى DSL + أوامر.
4. **راجع الناتج:**
   * تحقق من أن كل أمر يمتلك `gkeys` صحيحة ومفتاح `tpl:` ضمن `keys`.
   * تأكد من أن `scopeId` يظهر في أحداث القالب فقط.
5. **اختبر تداخلاً عميقًا:** بإنشاء سيناريوهات مستخدم تغطي جميع الأزرار المتداخلة.
6. **فعّل Gard/Auditor:** حافظ على مراقبة السجل للتأكد من عدم ظهور مخالفات أثناء التشغيل.

## 7. نصائح إضافية

* **دوّن النية في التعليقات:** عند إنشاء قوالب مركبة، اشرح كيف يرتبط الحدث بالحالة لتسهيل التوسعة لاحقًا.
* **استخدم الـ Mock Data:** جرّب القوالب مع بيانات مختلفة لتكشف عن مفاتيح مكررة أو حالات لم تُغطَّ.
* **شارك التوليد بين الفريق:** لا تعتمد على نسخة محلية فقط من HTMLxAgent؛ وثّق خطوات التحويل ضمن المشروع.

باتباع هذه الإرشادات ستحافظ على عزل الأحداث واستقرار الحالة حتى في أكثر السيناريوهات تعقيدًا داخل HTMLx.
