# مناقشة دعم استدعاء الدوال داخل تعبيرات HTMLx

## المقدمة
في هذا المستند ألخّص الأفكار التي نوقشت حول تمكين HTMLx من التعامل مع استدعاء الدوال في التعبيرات (مثل `formatTimeLeft(state.data.game)`)، وذلك استجابةً لرسالة الخطأ التي ظهرت في الملف `index-htmlx-v2.html`.

## تحليل الوضع الحالي
- محرك HTMLx الحالي يسمح بتقييم التعابير البسيطة فقط (قراءة خصائص، عمليات حسابية أساسية) ولا يدعم استدعاء الدوال مباشرة داخل التعبير.
- لهذا السبب يظهر الخطأ `ReferenceError` عندما نحاول تنفيذ `formatTimeLeft(...)` داخل التعبير، لأن الـ parser يرفض توقيع الدوال أو لا يمرره إلى وقت التشغيل.

## أسباب التفكير في التحديث
1. **دعم حالات الاستخدام المتقدمة:** بعض التعابير تحتاج تنسيقًا أو تحويلًا لا يمكن تمثيله بعمليات بسيطة. السماح باستدعاء دوال موثوقة داخل التعبير يزيل الحاجة إلى حلول التفاف خارجية.
2. **تقليل التكرار داخل القوالب:** بدلاً من إضافة عقد DOM إضافية أو أوامر لاحقة للمعالجة، يمكننا تنفيذ التحويل مباشرة أثناء الربط.
3. **تحسين تجربة التطوير:** يجعل HTMLx أقرب إلى بيئات ربط البيانات المعاصرة، ما يقلل الفجوة الذهنية بين تطوير Mishkah والتقنيات الأخرى.

## خطة العمل المقترحة
### 1. تحديث الـ Parser
- تمديد القواعد النحوية كي تتعرّف على استدعاءات الدوال ذات التوقيع البسيط: `identifier(args)`.
- التأكد من أن الـ AST يُخزن عقدة من نوع `CallExpression` تحتوي على اسم الدالة وقائمة الوسائط.
- الحفاظ على القيود الأمنيّة: السماح فقط بالأسماء الموجودة داخل نطاق `state.helpers` أو قائمة بيضاء محددة.

### 2. تحديث مرحلة التحويل (AST → Runtime Expression)
- عند وجود `CallExpression` نولّد كودًا يحترم القيود، مثل:
  ```js
  const fn = context.lookupFunction('formatTimeLeft');
  return fn?.apply(null, evaluatedArgs);
  ```
- توفير آلية `lookupFunction` داخل الـ runtime تمنع الوصول إلى دوال غير مصرّح بها.

### 3. تحديث محرك الأحداث (Runtime)
- توسيع كائن `state` بحيث يضم مساحة `helpers` أو `functions` تُحقن عند التهيئة.
- التحقق من أن الاستدعاء لا يكسر مبدأ عدم وجود آثار جانبية في التعبيرات (pure functions). يجب التوثيق أن أي دالة تُحقن يجب أن تكون نقية.

## الحماية والتحقق
- **قائمة بيضاء:** السماح بالدوال المعرّفة في `state.helpers` فقط، ورفض أي أسماء أخرى في مرحلة التحليل.
- **حظر الدوال الخطيرة:** منع الوصول إلى `Function` أو `eval` أو خصائص السلسلة `constructor`.
- **أخطاء واضحة:** عند وجود دالة غير مسجلة، يولّد النظام رسالة مفهومة تشير إلى الحل (إضافة الدالة إلى `helpers`).

## سير العمل التطويري
1. كتابة اختبارات وحدات للـ parser تغطي التعابير الجديدة (استدعاء دالة مع معاملات، بدون معاملات، دوال غير مصرح بها).
2. كتابة اختبارات تكامل على عينة HTMLx للتأكد من أن الدوال تعمل في وقت التشغيل.
3. مراجعة أداء المحرك للتأكد أن التقييم المؤجل للتعابير لا يتضرر.
4. تحديث الوثائق (`docs/htmlx-guidelines.md`) لشرح كيفية تسجيل الدوال الآمنة.

## خطوات ما بعد التنفيذ
- إجراء اختبار داخلي على قوالب حقيقية (مثل `index-htmlx-v2.html`).
- جمع ملاحظات الفريق حول تجربة التطوير الجديدة.
- تحضير خطة رجوع (rollback) في حال ظهرت مشاكل أداء أو أمن.

## الخلاصة
تحديث الـ HTMLx parser والسماح باستدعاء الدوال من خلال قائمة بيضاء مُدارة سيمنحنا مرونة أكبر في بناء الواجهات دون التضحية بالأمان أو البساطة. التركيز على اختبارات صارمة ومسار واضح للتهجين سيضمن أن الميزة تُدمج بشكل آمن ومتدرج.
