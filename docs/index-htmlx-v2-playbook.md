# دليل المبرمج لملف `index-htmlx-v2.html`

هذا الدليل يشرح كيفية قراءة، تعديل، وتوسيع تجربة HTMLx في ملف `index-htmlx-v2.html`. ستجد هنا خريطة كاملة للصفحة، مصادر البيانات، كيفية توصيل Ajax، ومكان وضع الوظائف والأوامر. الهدف هو أن تنجز أي إضافة دون ضياع بين الأقسام المختلفة.

## 1. المنظور العام

- **الصفحة هي مختبر متكامل**: كل قسم (Sidebar، تبويبات، ألعاب، Ajax) موجود داخل نفس الملف حتى يسهل تتبع الاعتمادات المتبادلة.
- **البيانات هي المصدر الأساسي**: كل جزء من الصفحة يقرأ حالته من كتل `script[type="application/json"]` التي تحمل `data-m-path`. تعديل السلوك يبدأ بتعديل هذه البيانات.
- **الأوامر تكتب محليًا**: كل تبويب أو مكوّن يحتوي على كتلة `<script>` قريبة منه تضم الدوال الخاصة به (مثل `switchTab`, `updateCounter`). احتفظ بهذا التقارب لكي تبقى القراءة خطية.

## 2. الهيكل الرئيسي

1. **التهيئة العامة (HEAD + CSS)**: يبدأ الملف بتعريف الخطوط، متغيرات CSS، وتصميم الزجاج المعشق للصفحة. لا تحتاج إلى لمسها إلا لتعديلات جمالية عامة.
2. **مضخة Mishkah (`template#mishkah-index`)**:
   - جميع البيانات والأوامر تعيش داخل هذا القالب.
   - عند الإطلاق، يقوم المحرك بقراءة كتل البيانات ثم بناء الصفحة تلقائيًا.
3. **الـ ENV و `data-m-path="head"`**: تستخدم لضبط اللغة، الاتجاه، العنوان، وأعلام التجربة.
4. **الـ Layout الأساسي**: `.page-shell` ثم `.app-card` يغطّيان كل المحتوى. داخل البطاقة يوجد `header` ثم `.layout` التي تنقسم إلى Sidebar + Main Column.

## 3. قواعد البيانات (`data-m-path`)

- استخدم `data-m-path` لتحديد المكان الذي تُدمج فيه البيانات داخل الحالة. مثال: `data-m-path="data.counter"` يملأ `state.data.counter` بقيمة البداية.
- لا حاجة الآن إلى `data-m-data` منفصل؛ وجود `data-m-path` يكفي لأن المحرك يفهم أنها كتلة بيانات.
- الترجمة (`i18n.strings`) توضع بالقرب من المكوّن الذي يحتاجها. هذا يقلل الحاجة إلى القفز في الملف.

### خطوات عملية لإضافة مسار بيانات جديد

1. أضف كتلة JSON جديدة داخل القسم المناسب، وليكن:
   ```html
   <script type="application/json" data-m-path="data.todo">
     { "items": [] }
   </script>
   ```
2. استخدم `state.data.todo.items` داخل القالب لعرضها.
3. إذا احتجت ترجمة، أضف كتلة `i18n.strings` في نفس المكان.

## 4. الخرائط والمصادر Ajax

### 4.1 إعلان الخريطة العامة

- في أعلى القالب يوجد تعريف عام:
  ```html
  <script type="application/json" data-m-ajax-map>
    {
      "docs.ajaxBase": { "url": "./docs/htmlx-ajax-demo.json", "responseType": "json", "mode": "merge" }
    }
  </script>
  ```
- ولأن المحرّك بات يدعم تقسيم الخرائط، يمكنك وضع مفاتيح إضافية قرب المكوّن الذي يستخدمها:
  ```html
  <script type="application/json" data-m-ajax-map="docs.ajaxDigest">
    {
      "url": "./docs/htmlx-ajax-demo.json",
      "responseType": "json",
      "extract": "digest",
      "mode": "replace"
    }
  </script>
  ```
- الحالتان متكاملتان: الأولى تنشئ خريطة عامة، والثانية تُسجّل مفتاحًا واحدًا فقط معرّفًا عبر قيمة السمة `data-m-ajax-map`، مما يسهل ربطه منطقيًا بالعنصر الذي يعتمد عليه.
- المفتاح (`docs.ajaxBase` أو `docs.ajaxDigest`) هو ما ستستدعيه حقول البيانات لاحقًا عبر `data-m-ajax`.

### 4.2 ربط البيانات بAjax

- أي كتلة بيانات يمكنها الاشتراك بمصدر Ajax عبر `data-m-ajax`.
- مثال التبويب الجديد:
  ```html
  <script type="application/json"
          data-m-path="data.ajaxDemo"
          data-m-ajax="docs.ajaxBase"
          data-m-ajax-merge='{"extract":"guide.{{env.lang}}","mode":"replace"}'>
    {
      "status": "loading",
      "summary": "نحضّر المحتوى...",
      "steps": [],
      "resources": []
    }
  </script>
  ```
- **ما يحدث بالضبط**:
  1. تُحمَّل البيانات المبدئية محليًا (يظهر النص الافتراضي فورًا).
  2. المحرك يستدعي الخريطة `docs.ajaxBase` قبل الإقلاع.
  3. عند وصول الاستجابة، تُدمج مع الحقل حسب إعداد `mode`، ويمكن تخصيص الدمج لكل حقل بواسطة `data-m-ajax-merge`.
  4. يمكنك استخدام متغيرات الحالة داخل `data-m-ajax-merge` مثل `{{env.lang}}` لاختيار جزء من الاستجابة بناءً على اللغة.

### 4.3 نصائح تكامل Ajax

- ضع fallback واضحًا داخل JSON المحلي حتى لا تظهر الشاشة فارغة أثناء الانتظار.
- لو كان المصدر يحتاج معاملات (query params أو body)، قم بإضافتها داخل تعريف الخريطة العامة (`data-m-ajax-map`).
- إن احتجت لمصدر ديناميكي يعتمد على قيم runtime، استخدم `commit` لتحديث البيانات ثم اطلب إعادة بناء المصدر عبر أوامر مخصصة.

## 5. إدارة التبويبات والمكوّنات

- التبويبات تعمل عبر `state.data.activeTab`.
- الدالة `switchTab(tab, ctx)` متمركزة أعلى `.layout` لتبقى مرئية أثناء قراءة الـ Sidebar.
- كل تبويب يلتزم بالترتيب التالي:
  1. كتل البيانات (ترجمات + حالة).
  2. هيكل HTML.
  3. سكريبت صغير يحتوي الوظائف الخاصة به.

## 6. وظائف مساعدة مشتركة

- **`commit(ctx, updater, after?)`**: تُستخدم لتعديل الحالة بشكل آمن مع خيار تمرير دالة لاحقة لتطبيق آثار جانبية (مثل حفظ التفضيلات).
- **`rememberState(ctx)`**: تحفظ نسخة من الحالة في `window.__INDEX_STATE__`، مفيدة لتصحيح الأخطاء.
- **`runtime()`**: تستدعي دوال مساعدة من بيئة Mishkah إن وجدت (مثل `applyEnvironment`).
- **`setTheme` و `setLanguage`**: يغيران `state.env` ويستدعيان أدوات التطبيق لتحديث الاتجاه والخطوط وحفظ الاختيار.

احتفظ بالوظائف القابلة لإعادة الاستخدام بالقرب من أعلى الملف أو قبل أول استخدام مباشر لها حتى لا يحتاج القارئ للبحث بعيدًا.

## 7. مساحة Ajax Showcase

- تقع داخل `section.panel` عندما يكون `activeTab === 'ajax'`.
- يعتمد على مسارين للبيانات:
  - `data.ajaxDemo` لعرض المحتوى النصي (عنوان، ملخص، خطوات، روابط).
  - `data.ajaxDigest` لقائمة العناصر المجمعة من `digest`.
- بعد تحميل البيانات، تُعرض الحالات عبر حلقات `x-for` وفحص حالات فارغة.
- الدالة `syncAjaxDigest(ctx)` (إن أضفتها لاحقًا) يجب أن تحدث `data.ajaxDigest` إما بتحريك الطلب في الخلفية أو باستخدام مصدر جديد.

## 8. إضافة تبويب أو تجربة جديدة

1. أضف زرًا جديدًا في `.nav-list` يحرك `activeTab` إلى قيمة جديدة.
2. أسفل الأزرار، أنشئ `section.panel` بشرط `x-if` مناسب.
3. عرّف البيانات والترجمات داخل `script[data-m-path]` قبل المحتوى.
4. أضف الدوال التي يحتاجها التبويب مباشرة أسفل القسم.
5. حدّث Ajax map إذا احتجت بيانات خارجية.

## 9. اختبار التعديلات

- استخدم `node -e "require('./dist/mishkah-htmlx.js')"` للتأكد من أن المحرك يستطيع قراءة الملف دون أخطاء.
- افتح `index-htmlx-v2.html` في متصفح محلي لمراجعة المخرجات والتأكد من أن البيانات تتزامن مع التبويب المناسب.

## 10. ملخص سريع (Cheat Sheet)

| المهمة | أين نعدل؟ | ماذا نفعل؟ |
| ------ | --------- | ---------- |
| إضافة ترجمة | بالقرب من المكوّن داخل كتلة `data-m-path="i18n.strings"` | أضف المفتاح واللغات المطلوبة |
| إضافة حالة جديدة | كتلة `data-m-path="data.*"` داخل التبويب | عرف القيمة الابتدائية |
| توصيل مصدر Ajax | أعلن عنه في `data-m-ajax-map` ثم استخدم `data-m-ajax` مع `data-m-path` | حدّد `mode` و`extract` عند الحاجة |
| إنشاء دالة تفاعل | سكريبت `<script>` ملاصق للتبويب | استعمل `commit` أو `ctx.set` للتحديث |
| حفظ تفضيلات | الدوال العامة أعلى الملف | استخدم `runtime().persistPrefs` إن وُجد |

باتباع هذا الدليل ستكون قادرًا على العمل بسرعة وثقة داخل `index-htmlx-v2.html` دون أن تضيع بين الأقسام أو تنسى خطوة حيوية.
