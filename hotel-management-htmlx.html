<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>G-remal PMS — Mishkah HTMLx</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Work+Sans:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        color-scheme: light dark;
        --background: #f7f9fb;
        --foreground: #101828;
        --muted-foreground: rgba(71, 84, 103, 0.82);
        --border: rgba(148, 163, 184, 0.38);
        --primary: #2563eb;
        --primary-foreground: #f8fafc;
        --secondary: rgba(37, 99, 235, 0.12);
        --secondary-foreground: #1d4ed8;
        --accent: rgba(14, 165, 233, 0.14);
        --accent-foreground: #0f172a;
        --destructive: #dc2626;
        --destructive-foreground: #fef2f2;
        --card: rgba(255, 255, 255, 0.82);
        --card-foreground: #0f172a;
        --surface-1: rgba(255, 255, 255, 0.76);
        --surface-2: rgba(241, 245, 249, 0.86);
        --shadow: 0 28px 68px -40px rgba(15, 23, 42, 0.6);
        --radius: 18px;
        --ring: rgba(37, 99, 235, 0.35);
        --success: #16a34a;
        --warning: #f97316;
        --info: #0891b2;
        --font-body: 'Cairo', 'Work Sans', system-ui;
      }

      :root.dark {
        --background: #0f172a;
        --foreground: #f8fafc;
        --muted-foreground: rgba(226, 232, 240, 0.75);
        --border: rgba(71, 85, 105, 0.55);
        --primary: #60a5fa;
        --primary-foreground: #0f172a;
        --secondary: rgba(96, 165, 250, 0.18);
        --secondary-foreground: #f8fafc;
        --accent: rgba(14, 165, 233, 0.22);
        --accent-foreground: #f8fafc;
        --destructive: #f87171;
        --destructive-foreground: #450a0a;
        --card: rgba(15, 23, 42, 0.78);
        --card-foreground: #f8fafc;
        --surface-1: rgba(15, 23, 42, 0.74);
        --surface-2: rgba(30, 41, 59, 0.82);
        --shadow: 0 35px 80px -42px rgba(15, 23, 42, 0.85);
        --ring: rgba(96, 165, 250, 0.55);
        --success: #22c55e;
        --warning: #fb923c;
        --info: #38bdf8;
      }

      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: var(--font-body);
        background: radial-gradient(circle at 18% 12%, rgba(37, 99, 235, 0.08), transparent 55%),
          radial-gradient(circle at 88% 24%, rgba(14, 165, 233, 0.12), transparent 60%),
          linear-gradient(180deg, rgba(15, 23, 42, 0.04), transparent 60%),
          var(--background);
        color: var(--foreground);
      }

      #app {
        min-height: 100vh;
      }
    </style>
  </head>
  <body>
    <div id="app"></div>

    <template id="gremal-hotel-app" data-namespace="gremal.hotel" data-mount="#app">
      <style data-m-scope>
        :host {
          display: block;
        }

        .app-shell {
          position: relative;
          min-height: 100vh;
          padding: 2rem;
          display: flex;
          flex-direction: column;
          gap: 1.5rem;
        }

        .app-card {
          background: var(--card);
          border-radius: 28px;
          box-shadow: var(--shadow);
          border: 1px solid var(--border);
          overflow: hidden;
          display: flex;
          flex-direction: column;
          min-height: 88vh;
        }

        .app-header {
          padding: 2.25rem 2.5rem 1.5rem;
          display: flex;
          flex-wrap: wrap;
          gap: 1.5rem;
          align-items: center;
          border-bottom: 1px solid var(--border);
          background: linear-gradient(140deg, rgba(37, 99, 235, 0.12), transparent 55%), var(--card);
        }

        .header-meta {
          display: grid;
          gap: 0.55rem;
          flex: 1 1 320px;
          min-width: 260px;
        }

        .header-meta h1 {
          margin: 0;
          font-size: clamp(1.8rem, 2.3vw, 2.75rem);
          font-weight: 700;
        }

        .header-meta p {
          margin: 0;
          color: var(--muted-foreground);
          font-size: 1rem;
        }

        .header-actions {
          margin-inline-start: auto;
          display: flex;
          flex-wrap: wrap;
          gap: 0.75rem;
          align-items: center;
          justify-content: flex-end;
        }

        .segmented {
          display: inline-flex;
          align-items: center;
          gap: 0.35rem;
          border-radius: 999px;
          border: 1px solid var(--border);
          background: var(--surface-1);
          padding: 0.25rem;
        }

        .segmented button {
          border: none;
          border-radius: 999px;
          background: transparent;
          color: var(--muted-foreground);
          font-weight: 600;
          padding: 0.45rem 1.1rem;
          cursor: pointer;
          transition: background 0.25s ease, color 0.25s ease, box-shadow 0.25s ease;
        }

        .segmented button.active {
          background: var(--primary);
          color: var(--primary-foreground);
          box-shadow: 0 18px 36px -22px rgba(37, 99, 235, 0.5);
        }

        .layout {
          display: grid;
          grid-template-columns: minmax(0, 280px) minmax(0, 1fr);
          gap: 1.5rem;
          padding: 1.5rem 2.5rem 2.5rem;
          flex: 1 1 auto;
        }

        .sidebar {
          display: flex;
          flex-direction: column;
          gap: 1.1rem;
          position: sticky;
          top: 2rem;
          align-self: flex-start;
          max-height: calc(100vh - 6rem);
        }

        .sidebar-card {
          background: var(--surface-1);
          border-radius: 24px;
          border: 1px solid var(--border);
          padding: 1.5rem;
          display: grid;
          gap: 1rem;
        }

        .sidebar-card h2 {
          margin: 0;
          font-size: 1rem;
          text-transform: uppercase;
          letter-spacing: 0.3em;
          color: var(--muted-foreground);
        }

        .nav-list {
          display: grid;
          gap: 0.65rem;
        }

        .nav-item {
          display: flex;
          align-items: center;
          justify-content: space-between;
          gap: 0.65rem;
          padding: 0.85rem 1rem;
          border-radius: 16px;
          border: 1px solid transparent;
          background: transparent;
          color: var(--muted-foreground);
          cursor: pointer;
          transition: background 0.2s ease, border 0.2s ease, color 0.2s ease;
        }

        .nav-item strong {
          font-size: 1rem;
        }

        .nav-item span.badge {
          border-radius: 999px;
          padding: 0.25rem 0.75rem;
          background: var(--secondary);
          color: var(--secondary-foreground);
          font-size: 0.75rem;
          font-weight: 600;
        }

        .nav-item.active {
          border-color: color-mix(in oklab, var(--primary) 18%, transparent);
          background: color-mix(in oklab, var(--primary) 14%, transparent);
          color: var(--foreground);
        }

        .main-column {
          display: grid;
          gap: 1.5rem;
          align-content: flex-start;
        }

        .panel {
          background: var(--surface-1);
          border-radius: 28px;
          border: 1px solid var(--border);
          box-shadow: 0 18px 52px -32px rgba(15, 23, 42, 0.4);
          padding: 2rem;
          display: grid;
          gap: 1.5rem;
        }

        .panel header {
          display: flex;
          flex-wrap: wrap;
          gap: 0.75rem;
          align-items: flex-start;
        }

        .panel header h2 {
          margin: 0;
          font-size: 1.45rem;
        }

        .panel header p {
          margin: 0;
          color: var(--muted-foreground);
        }

        .metrics-grid {
          display: grid;
          gap: 1rem;
          grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        }

        .metric-card {
          background: var(--surface-2);
          border-radius: 20px;
          border: 1px solid var(--border);
          padding: 1.2rem;
          display: grid;
          gap: 0.45rem;
        }

        .metric-card h3 {
          margin: 0;
          font-size: 0.95rem;
          color: var(--muted-foreground);
        }

        .metric-card strong {
          font-size: 1.65rem;
        }

        .status-tag {
          display: inline-flex;
          align-items: center;
          gap: 0.35rem;
          padding: 0.35rem 0.8rem;
          border-radius: 999px;
          background: var(--accent);
          color: var(--accent-foreground);
          font-size: 0.8rem;
          font-weight: 600;
        }

        .table {
          width: 100%;
          border-collapse: collapse;
        }

        .table thead {
          background: color-mix(in oklab, var(--primary) 8%, transparent);
        }

        .table th,
        .table td {
          padding: 0.85rem 1rem;
          text-align: start;
          border-bottom: 1px solid var(--border);
        }

        .table tbody tr:hover {
          background: color-mix(in oklab, var(--primary) 6%, transparent);
        }

        .tag {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          padding: 0.35rem 0.75rem;
          border-radius: 999px;
          background: color-mix(in oklab, var(--primary) 12%, transparent);
          color: var(--primary-foreground);
          font-size: 0.78rem;
          font-weight: 600;
        }

        .tag.success {
          background: color-mix(in oklab, var(--success) 18%, transparent);
          color: #022c22;
        }

        .tag.warning {
          background: color-mix(in oklab, var(--warning) 18%, transparent);
          color: #7c2d12;
        }

        .tag.muted {
          background: color-mix(in oklab, var(--muted-foreground) 12%, transparent);
          color: var(--muted-foreground);
        }

        .form-grid {
          display: grid;
          gap: 1rem;
          grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }

        label {
          font-weight: 600;
          font-size: 0.92rem;
          color: var(--muted-foreground);
        }

        input,
        select,
        textarea {
          border-radius: 14px;
          border: 1px solid var(--border);
          padding: 0.65rem 0.9rem;
          font-size: 0.95rem;
          background: var(--card);
          color: var(--foreground);
          transition: border 0.2s ease, box-shadow 0.2s ease;
        }

        input:focus,
        select:focus,
        textarea:focus {
          outline: none;
          border-color: var(--primary);
          box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
        }

        textarea {
          min-height: 120px;
          resize: vertical;
        }

        .actions {
          display: flex;
          flex-wrap: wrap;
          gap: 0.75rem;
          align-items: center;
        }

        .button {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          gap: 0.45rem;
          border-radius: 999px;
          border: none;
          background: var(--primary);
          color: var(--primary-foreground);
          font-weight: 600;
          padding: 0.65rem 1.35rem;
          cursor: pointer;
          transition: transform 0.2s ease, box-shadow 0.3s ease;
        }

        .button:hover {
          transform: translateY(-1px);
          box-shadow: 0 20px 35px -22px rgba(37, 99, 235, 0.55);
        }

        .button.secondary {
          background: transparent;
          color: var(--foreground);
          border: 1px solid var(--border);
        }

        .button.ghost {
          background: transparent;
          color: var(--muted-foreground);
        }

        .room-grid {
          display: grid;
          gap: 1rem;
        }

        .room-floor {
          display: grid;
          gap: 0.75rem;
          background: var(--surface-2);
          border-radius: 20px;
          border: 1px solid var(--border);
          padding: 1.25rem;
        }

        .floor-header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          color: var(--muted-foreground);
          font-weight: 600;
        }

        .rooms-row {
          display: grid;
          gap: 0.75rem;
          grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        }

        .room-card {
          border-radius: 18px;
          border: 1px solid var(--border);
          padding: 0.85rem;
          display: grid;
          gap: 0.4rem;
          background: var(--card);
        }

        .room-card .number {
          font-weight: 700;
          font-size: 1.1rem;
        }

        .room-card .status {
          font-size: 0.85rem;
          color: var(--muted-foreground);
        }

        .room-card.busy {
          border-color: color-mix(in oklab, var(--primary) 28%, transparent);
          background: color-mix(in oklab, var(--primary) 18%, transparent);
        }

        .room-card.dirty {
          border-color: color-mix(in oklab, var(--warning) 32%, transparent);
          background: color-mix(in oklab, var(--warning) 16%, transparent);
        }

        .room-card.out {
          border-color: color-mix(in oklab, var(--destructive) 35%, transparent);
          background: color-mix(in oklab, var(--destructive) 18%, transparent);
        }

        .timeline {
          display: grid;
          gap: 1rem;
        }

        .timeline-item {
          display: grid;
          gap: 0.35rem;
          padding: 1rem 1.2rem;
          border-radius: 18px;
          border: 1px solid var(--border);
          background: var(--surface-2);
        }

        .timeline-item h4 {
          margin: 0;
          font-size: 1rem;
        }

        .timeline-item footer {
          display: flex;
          gap: 0.75rem;
          align-items: center;
          font-size: 0.85rem;
          color: var(--muted-foreground);
        }

        .split-columns {
          display: grid;
          gap: 1.25rem;
          grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }

        .list {
          display: grid;
          gap: 0.75rem;
        }

        .list-item {
          border-radius: 18px;
          border: 1px solid var(--border);
          padding: 0.95rem 1.1rem;
          background: var(--card);
          display: grid;
          gap: 0.3rem;
        }

        .list-item header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          gap: 0.75rem;
        }

        .mini-table {
          width: 100%;
          border-collapse: collapse;
        }

        .mini-table td {
          padding: 0.4rem 0.25rem;
          font-size: 0.85rem;
          color: var(--muted-foreground);
        }

        .mini-table td:first-child {
          font-weight: 600;
          color: var(--foreground);
        }

        @media (max-width: 1024px) {
          .layout {
            grid-template-columns: 1fr;
          }

          .sidebar {
            position: static;
            max-height: none;
          }
        }
      </style>

      <script type="application/json" data-m-env>
        {
          "theme": "light",
          "lang": "ar",
          "dir": "rtl",
          "flags": {
            "indexedDB": true
          }
        }
      </script>

      <script type="application/json" data-m-data data-m-path="head">
        {
          "title": "G-remal Hotel PMS"
        }
      </script>

      <script type="application/json" data-m-data data-m-path="hotel">
        {
          "name": "G-remal",
          "brand": "G-remal Collection",
          "location": "المعمورة، الإسكندرية — مصر",
          "roomsTotal": 40,
          "timezone": "Africa/Cairo",
          "contact": {
            "email": "connect@gremalhotels.com",
            "phone": "+20 3 555 7700"
          }
        }
      </script>

      <script type="application/json" data-m-data data-m-path="structure">
        {
          "modules": [
            {
              "id": "frontOffice",
              "title": { "ar": "المكاتب الأمامية", "en": "Front Office" },
              "description": {
                "ar": "عرض شامل للحالة التشغيلية ومهام الفريق.",
                "en": "Operational heartbeat of arrivals, departures, and team workload."
              }
            },
            {
              "id": "reservations",
              "title": { "ar": "الحجوزات", "en": "Reservations" },
              "description": {
                "ar": "نظام مركزي لإدارة الحجوزات الفردية والجماعية.",
                "en": "Central reservations management for individuals and groups."
              }
            },
            {
              "id": "checkin",
              "title": { "ar": "تسجيل الوصول/المغادرة", "en": "Check-in / Check-out" },
              "description": {
                "ar": "إدارة تدفق النزلاء اليومي ورقابة التخصيص.",
                "en": "Daily arrivals, departures, and assignment control."
              }
            },
            {
              "id": "profiles",
              "title": { "ar": "ملفات النزلاء", "en": "Guest Profiles" },
              "description": {
                "ar": "تخصيص التجربة عبر بيانات مدمجة مع الولاء.",
                "en": "Personalised experiences with loyalty & preference data."
              }
            },
            {
              "id": "rack",
              "title": { "ar": "لوحة حالة الغرف", "en": "Room Rack" },
              "description": {
                "ar": "تصور متقدّم لحجوزات وطاقات الفندق اللحظية.",
                "en": "Real-time visual allocation of inventory and status."
              }
            },
            {
              "id": "folio",
              "title": { "ar": "حسابات النزلاء", "en": "Guest Folios" },
              "description": {
                "ar": "فوترة كاملة، مدفوعات، وتسويات الشركات.",
                "en": "Complete folio billing, payments, and corporate settlements."
              }
            },
            {
              "id": "nightAudit",
              "title": { "ar": "التدقيق الليلي", "en": "Night Audit" },
              "description": {
                "ar": "إغلاق اليوم المالي وتشغيل التقارير التحليلية.",
                "en": "Close the business day with analytical & compliance reports."
              }
            }
          ],
          "entities": {
            "room": {
              "fields": ["id", "number", "floor", "type", "status", "features", "rate"]
            },
            "reservation": {
              "fields": [
                "id",
                "guestId",
                "type",
                "roomType",
                "roomId",
                "rooms",
                "status",
                "source",
                "adults",
                "children",
                "arrival",
                "departure",
                "createdAt",
                "guarantee",
                "balance"
              ]
            },
            "guest": {
              "fields": ["id", "profile", "preferences", "stats"]
            },
            "folio": {
              "fields": ["id", "reservationId", "guestId", "status", "currency", "charges", "payments"]
            },
            "nightAudit": {
              "fields": ["id", "businessDate", "status", "roomsSold", "occupancy", "adr", "revPar", "notes"]
            }
          }
        }
      </script>

      <script type="application/json" data-m-data data-m-path="mock">
        {
                  "rooms": [
                            {
                                      "id": "R001",
                                      "number": "101",
                                      "floor": 1,
                                      "type": "single",
                                      "status": "available",
                                      "features": [
                                                "queen_bed"
                                      ],
                                      "rate": 120
                            },
                            {
                                      "id": "R002",
                                      "number": "102",
                                      "floor": 1,
                                      "type": "single",
                                      "status": "available",
                                      "features": [
                                                "queen_bed"
                                      ],
                                      "rate": 120
                            },
                            {
                                      "id": "R003",
                                      "number": "103",
                                      "floor": 1,
                                      "type": "double",
                                      "status": "available",
                                      "features": [
                                                "balcony",
                                                "twin_beds"
                                      ],
                                      "rate": 180
                            },
                            {
                                      "id": "R004",
                                      "number": "104",
                                      "floor": 1,
                                      "type": "single",
                                      "status": "available",
                                      "features": [
                                                "queen_bed"
                                      ],
                                      "rate": 120
                            },
                            {
                                      "id": "R005",
                                      "number": "105",
                                      "floor": 1,
                                      "type": "single",
                                      "status": "available",
                                      "features": [
                                                "queen_bed"
                                      ],
                                      "rate": 120
                            },
                            {
                                      "id": "R006",
                                      "number": "106",
                                      "floor": 1,
                                      "type": "double",
                                      "status": "available",
                                      "features": [
                                                "balcony",
                                                "twin_beds"
                                      ],
                                      "rate": 180
                            },
                            {
                                      "id": "R007",
                                      "number": "107",
                                      "floor": 1,
                                      "type": "single",
                                      "status": "available",
                                      "features": [
                                                "queen_bed"
                                      ],
                                      "rate": 120
                            },
                            {
                                      "id": "R008",
                                      "number": "108",
                                      "floor": 1,
                                      "type": "single",
                                      "status": "available",
                                      "features": [
                                                "queen_bed"
                                      ],
                                      "rate": 120
                            },
                            {
                                      "id": "R009",
                                      "number": "109",
                                      "floor": 1,
                                      "type": "double",
                                      "status": "available",
                                      "features": [
                                                "balcony",
                                                "twin_beds"
                                      ],
                                      "rate": 180
                            },
                            {
                                      "id": "R010",
                                      "number": "110",
                                      "floor": 1,
                                      "type": "single",
                                      "status": "available",
                                      "features": [
                                                "queen_bed"
                                      ],
                                      "rate": 120
                            },
                            {
                                      "id": "R011",
                                      "number": "201",
                                      "floor": 2,
                                      "type": "single",
                                      "status": "available",
                                      "features": [
                                                "queen_bed"
                                      ],
                                      "rate": 120
                            },
                            {
                                      "id": "R012",
                                      "number": "202",
                                      "floor": 2,
                                      "type": "single",
                                      "status": "available",
                                      "features": [
                                                "queen_bed"
                                      ],
                                      "rate": 120
                            },
                            {
                                      "id": "R013",
                                      "number": "203",
                                      "floor": 2,
                                      "type": "double",
                                      "status": "available",
                                      "features": [
                                                "balcony",
                                                "twin_beds"
                                      ],
                                      "rate": 180
                            },
                            {
                                      "id": "R014",
                                      "number": "204",
                                      "floor": 2,
                                      "type": "single",
                                      "status": "available",
                                      "features": [
                                                "queen_bed"
                                      ],
                                      "rate": 120
                            },
                            {
                                      "id": "R015",
                                      "number": "205",
                                      "floor": 2,
                                      "type": "single",
                                      "status": "available",
                                      "features": [
                                                "queen_bed"
                                      ],
                                      "rate": 120
                            },
                            {
                                      "id": "R016",
                                      "number": "206",
                                      "floor": 2,
                                      "type": "double",
                                      "status": "available",
                                      "features": [
                                                "balcony",
                                                "twin_beds"
                                      ],
                                      "rate": 180
                            },
                            {
                                      "id": "R017",
                                      "number": "207",
                                      "floor": 2,
                                      "type": "single",
                                      "status": "available",
                                      "features": [
                                                "queen_bed"
                                      ],
                                      "rate": 120
                            },
                            {
                                      "id": "R018",
                                      "number": "208",
                                      "floor": 2,
                                      "type": "single",
                                      "status": "available",
                                      "features": [
                                                "queen_bed"
                                      ],
                                      "rate": 120
                            },
                            {
                                      "id": "R019",
                                      "number": "209",
                                      "floor": 2,
                                      "type": "double",
                                      "status": "available",
                                      "features": [
                                                "balcony",
                                                "twin_beds"
                                      ],
                                      "rate": 180
                            },
                            {
                                      "id": "R020",
                                      "number": "210",
                                      "floor": 2,
                                      "type": "single",
                                      "status": "available",
                                      "features": [
                                                "queen_bed"
                                      ],
                                      "rate": 120
                            },
                            {
                                      "id": "R021",
                                      "number": "301",
                                      "floor": 3,
                                      "type": "single",
                                      "status": "available",
                                      "features": [
                                                "queen_bed"
                                      ],
                                      "rate": 120
                            },
                            {
                                      "id": "R022",
                                      "number": "302",
                                      "floor": 3,
                                      "type": "single",
                                      "status": "available",
                                      "features": [
                                                "queen_bed"
                                      ],
                                      "rate": 120
                            },
                            {
                                      "id": "R023",
                                      "number": "303",
                                      "floor": 3,
                                      "type": "double",
                                      "status": "available",
                                      "features": [
                                                "balcony",
                                                "twin_beds"
                                      ],
                                      "rate": 180
                            },
                            {
                                      "id": "R024",
                                      "number": "304",
                                      "floor": 3,
                                      "type": "single",
                                      "status": "available",
                                      "features": [
                                                "queen_bed"
                                      ],
                                      "rate": 120
                            },
                            {
                                      "id": "R025",
                                      "number": "305",
                                      "floor": 3,
                                      "type": "single",
                                      "status": "available",
                                      "features": [
                                                "queen_bed"
                                      ],
                                      "rate": 120
                            },
                            {
                                      "id": "R026",
                                      "number": "306",
                                      "floor": 3,
                                      "type": "double",
                                      "status": "available",
                                      "features": [
                                                "balcony",
                                                "twin_beds"
                                      ],
                                      "rate": 180
                            },
                            {
                                      "id": "R027",
                                      "number": "307",
                                      "floor": 3,
                                      "type": "single",
                                      "status": "available",
                                      "features": [
                                                "queen_bed"
                                      ],
                                      "rate": 120
                            },
                            {
                                      "id": "R028",
                                      "number": "308",
                                      "floor": 3,
                                      "type": "single",
                                      "status": "available",
                                      "features": [
                                                "queen_bed"
                                      ],
                                      "rate": 120
                            },
                            {
                                      "id": "R029",
                                      "number": "309",
                                      "floor": 3,
                                      "type": "double",
                                      "status": "available",
                                      "features": [
                                                "balcony",
                                                "twin_beds"
                                      ],
                                      "rate": 180
                            },
                            {
                                      "id": "R030",
                                      "number": "310",
                                      "floor": 3,
                                      "type": "single",
                                      "status": "available",
                                      "features": [
                                                "queen_bed"
                                      ],
                                      "rate": 120
                            },
                            {
                                      "id": "R031",
                                      "number": "401",
                                      "floor": 4,
                                      "type": "single",
                                      "status": "available",
                                      "features": [
                                                "queen_bed"
                                      ],
                                      "rate": 120
                            },
                            {
                                      "id": "R032",
                                      "number": "402",
                                      "floor": 4,
                                      "type": "single",
                                      "status": "available",
                                      "features": [
                                                "queen_bed"
                                      ],
                                      "rate": 120
                            },
                            {
                                      "id": "R033",
                                      "number": "403",
                                      "floor": 4,
                                      "type": "double",
                                      "status": "available",
                                      "features": [
                                                "balcony",
                                                "twin_beds"
                                      ],
                                      "rate": 180
                            },
                            {
                                      "id": "R034",
                                      "number": "404",
                                      "floor": 4,
                                      "type": "single",
                                      "status": "available",
                                      "features": [
                                                "queen_bed"
                                      ],
                                      "rate": 120
                            },
                            {
                                      "id": "R035",
                                      "number": "405",
                                      "floor": 4,
                                      "type": "single",
                                      "status": "available",
                                      "features": [
                                                "queen_bed"
                                      ],
                                      "rate": 120
                            },
                            {
                                      "id": "R036",
                                      "number": "406",
                                      "floor": 4,
                                      "type": "double",
                                      "status": "available",
                                      "features": [
                                                "balcony",
                                                "twin_beds"
                                      ],
                                      "rate": 180
                            },
                            {
                                      "id": "R037",
                                      "number": "407",
                                      "floor": 4,
                                      "type": "suite",
                                      "status": "available",
                                      "features": [
                                                "sea_view",
                                                "living_area",
                                                "butler"
                                      ],
                                      "rate": 320
                            },
                            {
                                      "id": "R038",
                                      "number": "408",
                                      "floor": 4,
                                      "type": "suite",
                                      "status": "available",
                                      "features": [
                                                "sea_view",
                                                "living_area",
                                                "butler"
                                      ],
                                      "rate": 320
                            },
                            {
                                      "id": "R039",
                                      "number": "409",
                                      "floor": 4,
                                      "type": "suite",
                                      "status": "available",
                                      "features": [
                                                "sea_view",
                                                "living_area",
                                                "butler"
                                      ],
                                      "rate": 320
                            },
                            {
                                      "id": "R040",
                                      "number": "410",
                                      "floor": 4,
                                      "type": "suite",
                                      "status": "available",
                                      "features": [
                                                "sea_view",
                                                "living_area",
                                                "butler"
                                      ],
                                      "rate": 320
                            }
                  ],
                  "guests": [
                            {
                                      "id": "G001",
                                      "profile": {
                                                "name": {
                                                          "ar": "أحمد سعيد",
                                                          "en": "Ahmed Saeed"
                                                },
                                                "nationality": "EG",
                                                "language": "ar",
                                                "contact": {
                                                          "email": "ahmed.saeed@gremal.com",
                                                          "phone": "201234567890",
                                                          "address": "Alexandria, Egypt"
                                                },
                                                "loyaltyTier": "elite",
                                                "marketingOptIn": true
                                      },
                                      "preferences": {
                                                "bed": "king",
                                                "pillow": "standard",
                                                "amenities": [
                                                          "welcome_drink"
                                                ],
                                                "notes": ""
                                      },
                                      "stats": {
                                                "totalStays": 3,
                                                "nights": 12,
                                                "totalSpend": 2500
                                      }
                            },
                            {
                                      "id": "G002",
                                      "profile": {
                                                "name": {
                                                          "ar": "ليلى منصور",
                                                          "en": "Laila Mansour"
                                                },
                                                "nationality": "EG",
                                                "language": "ar",
                                                "contact": {
                                                          "email": "laila.mansour@gmail.com",
                                                          "phone": "201223344556",
                                                          "address": "Alexandria, Egypt"
                                                },
                                                "loyaltyTier": "gold",
                                                "marketingOptIn": true
                                      },
                                      "preferences": {
                                                "bed": "queen",
                                                "pillow": "memory foam",
                                                "amenities": [
                                                          "welcome_drink"
                                                ],
                                                "notes": ""
                                      },
                                      "stats": {
                                                "totalStays": 4,
                                                "nights": 14,
                                                "totalSpend": 2950
                                      }
                            },
                            {
                                      "id": "G003",
                                      "profile": {
                                                "name": {
                                                          "ar": "خالد عمر",
                                                          "en": "Khaled Omar"
                                                },
                                                "nationality": "EG",
                                                "language": "ar",
                                                "contact": {
                                                          "email": "khaled.omar@yahoo.com",
                                                          "phone": "201198877665",
                                                          "address": "Alexandria, Egypt"
                                                },
                                                "loyaltyTier": "silver",
                                                "marketingOptIn": true
                                      },
                                      "preferences": {
                                                "bed": "queen",
                                                "pillow": "standard",
                                                "amenities": [
                                                          "welcome_drink"
                                                ],
                                                "notes": ""
                                      },
                                      "stats": {
                                                "totalStays": 5,
                                                "nights": 16,
                                                "totalSpend": 3400
                                      }
                            },
                            {
                                      "id": "G004",
                                      "profile": {
                                                "name": {
                                                          "ar": "نور الهادي",
                                                          "en": "Nour Elhady"
                                                },
                                                "nationality": "EG",
                                                "language": "ar",
                                                "contact": {
                                                          "email": "nour.hadi@gmail.com",
                                                          "phone": "201155544433",
                                                          "address": "Alexandria, Egypt"
                                                },
                                                "loyaltyTier": "platinum",
                                                "marketingOptIn": true
                                      },
                                      "preferences": {
                                                "bed": "king",
                                                "pillow": "standard",
                                                "amenities": [
                                                          "welcome_drink"
                                                ],
                                                "notes": ""
                                      },
                                      "stats": {
                                                "totalStays": 6,
                                                "nights": 18,
                                                "totalSpend": 3850
                                      }
                            },
                            {
                                      "id": "G005",
                                      "profile": {
                                                "name": {
                                                          "ar": "منى السيد",
                                                          "en": "Mona Elsayed"
                                                },
                                                "nationality": "EG",
                                                "language": "ar",
                                                "contact": {
                                                          "email": "mona.el@gremal.com",
                                                          "phone": "201188899900",
                                                          "address": "Alexandria, Egypt"
                                                },
                                                "loyaltyTier": "classic",
                                                "marketingOptIn": true
                                      },
                                      "preferences": {
                                                "bed": "queen",
                                                "pillow": "standard",
                                                "amenities": [
                                                          "welcome_drink"
                                                ],
                                                "notes": ""
                                      },
                                      "stats": {
                                                "totalStays": 7,
                                                "nights": 20,
                                                "totalSpend": 4300
                                      }
                            },
                            {
                                      "id": "G006",
                                      "profile": {
                                                "name": {
                                                          "ar": "طارق فؤاد",
                                                          "en": "Tarek Fouad"
                                                },
                                                "nationality": "EG",
                                                "language": "ar",
                                                "contact": {
                                                          "email": "tarek.fouad@outlook.com",
                                                          "phone": "201266778899",
                                                          "address": "Alexandria, Egypt"
                                                },
                                                "loyaltyTier": "silver",
                                                "marketingOptIn": true
                                      },
                                      "preferences": {
                                                "bed": "queen",
                                                "pillow": "standard",
                                                "amenities": [
                                                          "welcome_drink"
                                                ],
                                                "notes": ""
                                      },
                                      "stats": {
                                                "totalStays": 8,
                                                "nights": 22,
                                                "totalSpend": 4750
                                      }
                            },
                            {
                                      "id": "G007",
                                      "profile": {
                                                "name": {
                                                          "ar": "هند عصمت",
                                                          "en": "Hind Esmat"
                                                },
                                                "nationality": "EG",
                                                "language": "ar",
                                                "contact": {
                                                          "email": "hind.e@gremal.com",
                                                          "phone": "201277889900",
                                                          "address": "Alexandria, Egypt"
                                                },
                                                "loyaltyTier": "gold",
                                                "marketingOptIn": true
                                      },
                                      "preferences": {
                                                "bed": "queen",
                                                "pillow": "memory foam",
                                                "amenities": [
                                                          "welcome_drink"
                                                ],
                                                "notes": ""
                                      },
                                      "stats": {
                                                "totalStays": 3,
                                                "nights": 24,
                                                "totalSpend": 5200
                                      }
                            },
                            {
                                      "id": "G008",
                                      "profile": {
                                                "name": {
                                                          "ar": "يوسف عادل",
                                                          "en": "Yousef Adel"
                                                },
                                                "nationality": "EG",
                                                "language": "ar",
                                                "contact": {
                                                          "email": "yousef.adel@gmail.com",
                                                          "phone": "201233445566",
                                                          "address": "Alexandria, Egypt"
                                                },
                                                "loyaltyTier": "classic",
                                                "marketingOptIn": true
                                      },
                                      "preferences": {
                                                "bed": "queen",
                                                "pillow": "standard",
                                                "amenities": [
                                                          "welcome_drink"
                                                ],
                                                "notes": ""
                                      },
                                      "stats": {
                                                "totalStays": 4,
                                                "nights": 26,
                                                "totalSpend": 5650
                                      }
                            },
                            {
                                      "id": "G009",
                                      "profile": {
                                                "name": {
                                                          "ar": "عمر عبد الرحيم",
                                                          "en": "Omar Abdelrahim"
                                                },
                                                "nationality": "EG",
                                                "language": "ar",
                                                "contact": {
                                                          "email": "omar.abdelrahim@travel.org",
                                                          "phone": "201299887766",
                                                          "address": "Alexandria, Egypt"
                                                },
                                                "loyaltyTier": "elite",
                                                "marketingOptIn": true
                                      },
                                      "preferences": {
                                                "bed": "king",
                                                "pillow": "standard",
                                                "amenities": [
                                                          "welcome_drink"
                                                ],
                                                "notes": ""
                                      },
                                      "stats": {
                                                "totalStays": 5,
                                                "nights": 28,
                                                "totalSpend": 6100
                                      }
                            },
                            {
                                      "id": "G010",
                                      "profile": {
                                                "name": {
                                                          "ar": "سارة إبراهيم",
                                                          "en": "Sara Ibrahim"
                                                },
                                                "nationality": "EG",
                                                "language": "ar",
                                                "contact": {
                                                          "email": "sara.ibrahim@icloud.com",
                                                          "phone": "201244556677",
                                                          "address": "Alexandria, Egypt"
                                                },
                                                "loyaltyTier": "silver",
                                                "marketingOptIn": true
                                      },
                                      "preferences": {
                                                "bed": "queen",
                                                "pillow": "standard",
                                                "amenities": [
                                                          "welcome_drink"
                                                ],
                                                "notes": ""
                                      },
                                      "stats": {
                                                "totalStays": 6,
                                                "nights": 30,
                                                "totalSpend": 6550
                                      }
                            },
                            {
                                      "id": "G011",
                                      "profile": {
                                                "name": {
                                                          "ar": "مجموعة النور",
                                                          "en": "Al Noor Group"
                                                },
                                                "nationality": "EG",
                                                "language": "en",
                                                "contact": {
                                                          "email": "coordinator@alnoor-travel.com",
                                                          "phone": "201233009900",
                                                          "address": "Corporate Account"
                                                },
                                                "loyaltyTier": "corporate",
                                                "marketingOptIn": false
                                      },
                                      "preferences": {
                                                "bed": "queen",
                                                "pillow": "standard",
                                                "amenities": [
                                                          "workspace",
                                                          "projector"
                                                ],
                                                "notes": "Handled via corporate coordinator."
                                      },
                                      "stats": {
                                                "totalStays": 7,
                                                "nights": 32,
                                                "totalSpend": 7000
                                      }
                            },
                            {
                                      "id": "G012",
                                      "profile": {
                                                "name": {
                                                          "ar": "مجموعة أويسس",
                                                          "en": "Oasis Group"
                                                },
                                                "nationality": "EG",
                                                "language": "en",
                                                "contact": {
                                                          "email": "events@oasis-group.com",
                                                          "phone": "201277331199",
                                                          "address": "Corporate Account"
                                                },
                                                "loyaltyTier": "corporate",
                                                "marketingOptIn": false
                                      },
                                      "preferences": {
                                                "bed": "queen",
                                                "pillow": "standard",
                                                "amenities": [
                                                          "workspace",
                                                          "projector"
                                                ],
                                                "notes": "Handled via corporate coordinator."
                                      },
                                      "stats": {
                                                "totalStays": 8,
                                                "nights": 34,
                                                "totalSpend": 7450
                                      }
                            },
                            {
                                      "id": "G013",
                                      "profile": {
                                                "name": {
                                                          "ar": "مجموعة بريق",
                                                          "en": "Bariq Delegation"
                                                },
                                                "nationality": "EG",
                                                "language": "en",
                                                "contact": {
                                                          "email": "host@bariqglobal.com",
                                                          "phone": "201211002244",
                                                          "address": "Corporate Account"
                                                },
                                                "loyaltyTier": "corporate",
                                                "marketingOptIn": false
                                      },
                                      "preferences": {
                                                "bed": "queen",
                                                "pillow": "standard",
                                                "amenities": [
                                                          "workspace",
                                                          "projector"
                                                ],
                                                "notes": "Handled via corporate coordinator."
                                      },
                                      "stats": {
                                                "totalStays": 3,
                                                "nights": 36,
                                                "totalSpend": 7900
                                      }
                            },
                            {
                                      "id": "G014",
                                      "profile": {
                                                "name": {
                                                          "ar": "هدى شريف",
                                                          "en": "Hoda Sherif"
                                                },
                                                "nationality": "EG",
                                                "language": "ar",
                                                "contact": {
                                                          "email": "hoda.sherif@gmail.com",
                                                          "phone": "201233899900",
                                                          "address": "Alexandria, Egypt"
                                                },
                                                "loyaltyTier": "gold",
                                                "marketingOptIn": true
                                      },
                                      "preferences": {
                                                "bed": "queen",
                                                "pillow": "memory foam",
                                                "amenities": [
                                                          "welcome_drink"
                                                ],
                                                "notes": ""
                                      },
                                      "stats": {
                                                "totalStays": 4,
                                                "nights": 38,
                                                "totalSpend": 8350
                                      }
                            },
                            {
                                      "id": "G015",
                                      "profile": {
                                                "name": {
                                                          "ar": "رائد حامد",
                                                          "en": "Raed Hamed"
                                                },
                                                "nationality": "EG",
                                                "language": "ar",
                                                "contact": {
                                                          "email": "raed.hamed@biz.net",
                                                          "phone": "201255667788",
                                                          "address": "Alexandria, Egypt"
                                                },
                                                "loyaltyTier": "classic",
                                                "marketingOptIn": true
                                      },
                                      "preferences": {
                                                "bed": "queen",
                                                "pillow": "standard",
                                                "amenities": [
                                                          "welcome_drink"
                                                ],
                                                "notes": ""
                                      },
                                      "stats": {
                                                "totalStays": 5,
                                                "nights": 40,
                                                "totalSpend": 8800
                                      }
                            },
                            {
                                      "id": "G016",
                                      "profile": {
                                                "name": {
                                                          "ar": "مجموعة أطلس",
                                                          "en": "Atlas Team"
                                                },
                                                "nationality": "EG",
                                                "language": "en",
                                                "contact": {
                                                          "email": "ops@atlasventures.com",
                                                          "phone": "201233110022",
                                                          "address": "Corporate Account"
                                                },
                                                "loyaltyTier": "corporate",
                                                "marketingOptIn": false
                                      },
                                      "preferences": {
                                                "bed": "queen",
                                                "pillow": "standard",
                                                "amenities": [
                                                          "workspace",
                                                          "projector"
                                                ],
                                                "notes": "Handled via corporate coordinator."
                                      },
                                      "stats": {
                                                "totalStays": 6,
                                                "nights": 42,
                                                "totalSpend": 9250
                                      }
                            },
                            {
                                      "id": "G017",
                                      "profile": {
                                                "name": {
                                                          "ar": "هديل سمير",
                                                          "en": "Hadeel Samir"
                                                },
                                                "nationality": "EG",
                                                "language": "ar",
                                                "contact": {
                                                          "email": "hadeel.samir@mail.com",
                                                          "phone": "201233556677",
                                                          "address": "Alexandria, Egypt"
                                                },
                                                "loyaltyTier": "silver",
                                                "marketingOptIn": true
                                      },
                                      "preferences": {
                                                "bed": "queen",
                                                "pillow": "standard",
                                                "amenities": [
                                                          "welcome_drink"
                                                ],
                                                "notes": ""
                                      },
                                      "stats": {
                                                "totalStays": 7,
                                                "nights": 44,
                                                "totalSpend": 9700
                                      }
                            },
                            {
                                      "id": "G018",
                                      "profile": {
                                                "name": {
                                                          "ar": "نادر رؤوف",
                                                          "en": "Nader Raouf"
                                                },
                                                "nationality": "EG",
                                                "language": "ar",
                                                "contact": {
                                                          "email": "nader.raouf@gmail.com",
                                                          "phone": "201255009988",
                                                          "address": "Alexandria, Egypt"
                                                },
                                                "loyaltyTier": "gold",
                                                "marketingOptIn": true
                                      },
                                      "preferences": {
                                                "bed": "queen",
                                                "pillow": "memory foam",
                                                "amenities": [
                                                          "welcome_drink"
                                                ],
                                                "notes": ""
                                      },
                                      "stats": {
                                                "totalStays": 8,
                                                "nights": 46,
                                                "totalSpend": 10150
                                      }
                            },
                            {
                                      "id": "G019",
                                      "profile": {
                                                "name": {
                                                          "ar": "زياد مجدي",
                                                          "en": "Ziad Magdy"
                                                },
                                                "nationality": "EG",
                                                "language": "ar",
                                                "contact": {
                                                          "email": "ziad.magdy@company.com",
                                                          "phone": "201288778899",
                                                          "address": "Alexandria, Egypt"
                                                },
                                                "loyaltyTier": "classic",
                                                "marketingOptIn": true
                                      },
                                      "preferences": {
                                                "bed": "queen",
                                                "pillow": "standard",
                                                "amenities": [
                                                          "welcome_drink"
                                                ],
                                                "notes": ""
                                      },
                                      "stats": {
                                                "totalStays": 3,
                                                "nights": 48,
                                                "totalSpend": 10600
                                      }
                            },
                            {
                                      "id": "G020",
                                      "profile": {
                                                "name": {
                                                          "ar": "مي خليل",
                                                          "en": "Mai Khalil"
                                                },
                                                "nationality": "EG",
                                                "language": "ar",
                                                "contact": {
                                                          "email": "mai.khalil@gremal.com",
                                                          "phone": "201233445500",
                                                          "address": "Alexandria, Egypt"
                                                },
                                                "loyaltyTier": "silver",
                                                "marketingOptIn": true
                                      },
                                      "preferences": {
                                                "bed": "queen",
                                                "pillow": "standard",
                                                "amenities": [
                                                          "welcome_drink"
                                                ],
                                                "notes": ""
                                      },
                                      "stats": {
                                                "totalStays": 4,
                                                "nights": 50,
                                                "totalSpend": 11050
                                      }
                            }
                  ],
                  "reservations": [
                            {
                                      "id": "RES-1001",
                                      "guestId": "G001",
                                      "type": "individual",
                                      "roomType": "single",
                                      "roomId": "R001",
                                      "status": "checked_in",
                                      "source": "website",
                                      "adults": 1,
                                      "children": 0,
                                      "arrival": "2024-08-14",
                                      "departure": "2024-08-17",
                                      "createdAt": "2024-07-26",
                                      "guarantee": "credit_card",
                                      "balance": 240
                            },
                            {
                                      "id": "RES-1002",
                                      "guestId": "G002",
                                      "type": "individual",
                                      "roomType": "double",
                                      "roomId": "R006",
                                      "status": "booked",
                                      "source": "travel_agent",
                                      "adults": 2,
                                      "children": 0,
                                      "arrival": "2024-08-18",
                                      "departure": "2024-08-21",
                                      "createdAt": "2024-08-05",
                                      "guarantee": "company",
                                      "balance": 540
                            },
                            {
                                      "id": "RES-1003",
                                      "guestId": "G003",
                                      "type": "individual",
                                      "roomType": "single",
                                      "roomId": "R008",
                                      "status": "checked_out",
                                      "source": "direct",
                                      "adults": 1,
                                      "children": 1,
                                      "arrival": "2024-08-09",
                                      "departure": "2024-08-14",
                                      "createdAt": "2024-07-16",
                                      "guarantee": "cash",
                                      "balance": 0
                            },
                            {
                                      "id": "RES-1004",
                                      "guestId": "G004",
                                      "type": "individual",
                                      "roomType": "suite",
                                      "roomId": "R038",
                                      "status": "checked_in",
                                      "source": "vip",
                                      "adults": 2,
                                      "children": 1,
                                      "arrival": "2024-08-13",
                                      "departure": "2024-08-18",
                                      "createdAt": "2024-07-01",
                                      "guarantee": "credit_card",
                                      "balance": 1280
                            },
                            {
                                      "id": "RES-1005",
                                      "guestId": "G005",
                                      "type": "individual",
                                      "roomType": "single",
                                      "roomId": "R009",
                                      "status": "cancelled",
                                      "source": "website",
                                      "adults": 1,
                                      "children": 0,
                                      "arrival": "2024-08-20",
                                      "departure": "2024-08-22",
                                      "createdAt": "2024-08-10",
                                      "guarantee": "cash",
                                      "balance": 0
                            },
                            {
                                      "id": "RES-1006",
                                      "guestId": "G006",
                                      "type": "individual",
                                      "roomType": "double",
                                      "roomId": "R013",
                                      "status": "checked_in",
                                      "source": "direct",
                                      "adults": 2,
                                      "children": 0,
                                      "arrival": "2024-08-15",
                                      "departure": "2024-08-19",
                                      "createdAt": "2024-08-03",
                                      "guarantee": "credit_card",
                                      "balance": 720
                            },
                            {
                                      "id": "RES-1007",
                                      "guestId": "G007",
                                      "type": "individual",
                                      "roomType": "suite",
                                      "roomId": "R039",
                                      "status": "booked",
                                      "source": "loyalty",
                                      "adults": 1,
                                      "children": 0,
                                      "arrival": "2024-08-25",
                                      "departure": "2024-08-30",
                                      "createdAt": "2024-08-12",
                                      "guarantee": "credit_card",
                                      "balance": 1600
                            },
                            {
                                      "id": "RES-1008",
                                      "guestId": "G008",
                                      "type": "individual",
                                      "roomType": "double",
                                      "roomId": "R015",
                                      "status": "booked",
                                      "source": "travel_agent",
                                      "adults": 2,
                                      "children": 2,
                                      "arrival": "2024-08-19",
                                      "departure": "2024-08-22",
                                      "createdAt": "2024-08-06",
                                      "guarantee": "company",
                                      "balance": 720
                            },
                            {
                                      "id": "RES-1009",
                                      "guestId": "G009",
                                      "type": "individual",
                                      "roomType": "suite",
                                      "roomId": "R040",
                                      "status": "checked_in",
                                      "source": "vip",
                                      "adults": 2,
                                      "children": 0,
                                      "arrival": "2024-08-14",
                                      "departure": "2024-08-16",
                                      "createdAt": "2024-07-28",
                                      "guarantee": "credit_card",
                                      "balance": 640
                            },
                            {
                                      "id": "RES-1010",
                                      "guestId": "G010",
                                      "type": "individual",
                                      "roomType": "single",
                                      "roomId": "R012",
                                      "status": "booked",
                                      "source": "website",
                                      "adults": 1,
                                      "children": 1,
                                      "arrival": "2024-08-17",
                                      "departure": "2024-08-19",
                                      "createdAt": "2024-08-08",
                                      "guarantee": "cash",
                                      "balance": 360
                            },
                            {
                                      "id": "RES-2001",
                                      "guestId": "G011",
                                      "type": "group",
                                      "groupName": "مؤتمر النور",
                                      "status": "checked_in",
                                      "source": "corporate",
                                      "arrival": "2024-08-14",
                                      "departure": "2024-08-17",
                                      "createdAt": "2024-07-16",
                                      "guarantee": "company",
                                      "balance": 4200,
                                      "rooms": [
                                                "R021",
                                                "R022",
                                                "R023",
                                                "R024",
                                                "R025"
                                      ],
                                      "manifest": [
                                                {
                                                          "guestId": "G011",
                                                          "name": "سارة أبو الخير",
                                                          "role": "coordinator"
                                                },
                                                {
                                                          "guestId": "G011",
                                                          "name": "وفد النور - 10 ضيوف",
                                                          "role": "delegates"
                                                }
                                      ]
                            },
                            {
                                      "id": "RES-2002",
                                      "guestId": "G012",
                                      "type": "group",
                                      "groupName": "قمة أويسس",
                                      "status": "booked",
                                      "source": "corporate",
                                      "arrival": "2024-08-22",
                                      "departure": "2024-08-26",
                                      "createdAt": "2024-08-01",
                                      "guarantee": "bank_transfer",
                                      "balance": 6800,
                                      "rooms": [
                                                "R026",
                                                "R027",
                                                "R028",
                                                "R029",
                                                "R030"
                                      ],
                                      "manifest": [
                                                {
                                                          "guestId": "G012",
                                                          "name": "قسم الفعاليات",
                                                          "role": "organizer"
                                                }
                                      ]
                            },
                            {
                                      "id": "RES-2003",
                                      "guestId": "G013",
                                      "type": "group",
                                      "groupName": "بعثة بريق",
                                      "status": "checked_out",
                                      "source": "corporate",
                                      "arrival": "2024-08-07",
                                      "departure": "2024-08-12",
                                      "createdAt": "2024-06-16",
                                      "guarantee": "company",
                                      "balance": 0,
                                      "rooms": [
                                                "R016",
                                                "R017",
                                                "R018"
                                      ],
                                      "manifest": [
                                                {
                                                          "guestId": "G013",
                                                          "name": "منسق البعثة",
                                                          "role": "coordinator"
                                                }
                                      ]
                            },
                            {
                                      "id": "RES-2004",
                                      "guestId": "G016",
                                      "type": "group",
                                      "groupName": "فريق أطلس",
                                      "status": "booked",
                                      "source": "corporate",
                                      "arrival": "2024-08-16",
                                      "departure": "2024-08-21",
                                      "createdAt": "2024-08-04",
                                      "guarantee": "company",
                                      "balance": 5400,
                                      "rooms": [
                                                "R031",
                                                "R032",
                                                "R033",
                                                "R034"
                                      ],
                                      "manifest": [
                                                {
                                                          "guestId": "G016",
                                                          "name": "مها عوض",
                                                          "role": "team lead"
                                                }
                                      ]
                            },
                            {
                                      "id": "RES-2005",
                                      "guestId": "G018",
                                      "type": "group",
                                      "groupName": "منتدى الريادة",
                                      "status": "pending",
                                      "source": "event",
                                      "arrival": "2024-08-27",
                                      "departure": "2024-08-31",
                                      "createdAt": "2024-08-07",
                                      "guarantee": "credit_card",
                                      "balance": 7200,
                                      "rooms": [
                                                "R035",
                                                "R036",
                                                "R037"
                                      ],
                                      "manifest": [
                                                {
                                                          "guestId": "G018",
                                                          "name": "منظم الحدث",
                                                          "role": "coordinator"
                                                }
                                      ]
                            }
                  ],
                  "folios": [
                            {
                                      "id": "F-1001",
                                      "reservationId": "RES-1001",
                                      "guestId": "G001",
                                      "status": "open",
                                      "currency": "EGP",
                                      "charges": [
                                                {
                                                          "id": "CH-1",
                                                          "date": "2024-08-14",
                                                          "description": "غرفة فردية - ليلة 1",
                                                          "amount": 360
                                                },
                                                {
                                                          "id": "CH-2",
                                                          "date": "2024-08-15",
                                                          "description": "مطعم جلال - عشاء",
                                                          "amount": 220
                                                }
                                      ],
                                      "payments": [
                                                {
                                                          "id": "PM-1",
                                                          "date": "2024-08-14",
                                                          "description": "بطاقة ائتمان",
                                                          "amount": 300
                                                }
                                      ]
                            },
                            {
                                      "id": "F-1004",
                                      "reservationId": "RES-1004",
                                      "guestId": "G004",
                                      "status": "open",
                                      "currency": "USD",
                                      "charges": [
                                                {
                                                          "id": "CH-5",
                                                          "date": "2024-08-13",
                                                          "description": "جناح ملكي - ليلة 1",
                                                          "amount": 640
                                                },
                                                {
                                                          "id": "CH-6",
                                                          "date": "2024-08-14",
                                                          "description": "سبا جرمل",
                                                          "amount": 180
                                                }
                                      ],
                                      "payments": [
                                                {
                                                          "id": "PM-4",
                                                          "date": "2024-08-13",
                                                          "description": "تفويض بطاقة",
                                                          "amount": 500
                                                }
                                      ]
                            },
                            {
                                      "id": "F-2001",
                                      "reservationId": "RES-2001",
                                      "guestId": "G011",
                                      "status": "open",
                                      "currency": "USD",
                                      "charges": [
                                                {
                                                          "id": "CH-10",
                                                          "date": "2024-08-14",
                                                          "description": "حجز قاعة مؤتمر",
                                                          "amount": 2800
                                                },
                                                {
                                                          "id": "CH-11",
                                                          "date": "2024-08-14",
                                                          "description": "ضيافة - باقة ذهبية",
                                                          "amount": 1400
                                                }
                                      ],
                                      "payments": [
                                                {
                                                          "id": "PM-8",
                                                          "date": "2024-08-14",
                                                          "description": "تحويل بنكي",
                                                          "amount": 2000
                                                }
                                      ]
                            },
                            {
                                      "id": "F-2003",
                                      "reservationId": "RES-2003",
                                      "guestId": "G013",
                                      "status": "closed",
                                      "currency": "USD",
                                      "charges": [
                                                {
                                                          "id": "CH-14",
                                                          "date": "2024-08-07",
                                                          "description": "حجز غرف",
                                                          "amount": 3600
                                                }
                                      ],
                                      "payments": [
                                                {
                                                          "id": "PM-10",
                                                          "date": "2024-08-11",
                                                          "description": "شركة بريق",
                                                          "amount": 3600
                                                }
                                      ]
                            }
                  ],
                  "nightAudits": [
                            {
                                      "id": "NA-20240810",
                                      "businessDate": "2024-08-10",
                                      "status": "posted",
                                      "roomsSold": 32,
                                      "occupancy": 0.78,
                                      "adr": 245,
                                      "revPar": 192,
                                      "notes": "تسوية كاملة دون تعليقات."
                            },
                            {
                                      "id": "NA-20240811",
                                      "businessDate": "2024-08-11",
                                      "status": "posted",
                                      "roomsSold": 30,
                                      "occupancy": 0.74,
                                      "adr": 233,
                                      "revPar": 172,
                                      "notes": "تم ضبط الفرق على حساب مجموعة بريق."
                            },
                            {
                                      "id": "NA-20240812",
                                      "businessDate": "2024-08-12",
                                      "status": "posted",
                                      "roomsSold": 34,
                                      "occupancy": 0.82,
                                      "adr": 251,
                                      "revPar": 206,
                                      "notes": "زيادة في مبيعات السبا +12%."
                            }
                  ],
                  "frontOfficeTasks": [
                            {
                                      "id": "FD-1",
                                      "time": "07:00",
                                      "title": "تأكيد وصول مجموعة أطلس",
                                      "owner": "سلمى",
                                      "priority": "high",
                                      "status": "pending"
                            },
                            {
                                      "id": "FD-2",
                                      "time": "09:30",
                                      "title": "ترقية أحمد سعيد إلى جناح",
                                      "owner": "كريم",
                                      "priority": "medium",
                                      "status": "in_progress"
                            },
                            {
                                      "id": "FD-3",
                                      "time": "12:00",
                                      "title": "متابعة خصم الولاء مع سارة إبراهيم",
                                      "owner": "مها",
                                      "priority": "low",
                                      "status": "pending"
                            }
                  ]
        }
      </script>

      <script type="application/json" data-m-data data-m-path="runtime">
        {
                  "initialized": false,
                  "businessDate": "2024-08-15",
                  "rooms": [],
                  "reservations": [],
                  "guests": [],
                  "folios": [],
                  "nightAudits": [],
                  "tasks": [],
                  "alerts": [],
                  "views": {
                            "reservations": [],
                            "arrivals": [],
                            "departures": [],
                            "profiles": [],
                            "rack": [],
                            "folios": []
                  },
                  "metrics": {
                            "frontOffice": {
                                      "occupancy": 0,
                                      "occupied": 0,
                                      "available": 0,
                                      "arrivals": 0,
                                      "departures": 0,
                                      "inhouse": 0,
                                      "adr": 0,
                                      "revPar": 0,
                                      "revenueToday": 0
                            },
                            "reservations": {
                                      "total": 0,
                                      "individual": 0,
                                      "group": 0,
                                      "pending": 0,
                                      "booked": 0,
                                      "checkedIn": 0,
                                      "checkedOut": 0
                            }
                  }
        }
      </script>

      <script type="application/json" data-m-data data-m-path="view">
        {
                  "activeModule": "frontOffice",
                  "filters": {
                            "reservations": {
                                      "status": "all",
                                      "type": "all",
                                      "search": ""
                            },
                            "profiles": {
                                      "search": "",
                                      "tier": "all"
                            },
                            "folio": {
                                      "status": "all"
                            },
                            "rack": {
                                      "status": "all"
                            }
                  },
                  "nightAudit": {
                            "inProgress": false,
                            "lastRun": null
                  }
        }
      </script>

      <script type="application/json" data-m-data data-m-path="forms">
        {
                  "reservation": {
                            "type": "individual",
                            "guestId": "",
                            "groupName": "",
                            "roomType": "single",
                            "roomId": "",
                            "roomIds": [],
                            "arrival": "2024-08-15",
                            "departure": "2024-08-16",
                            "adults": 1,
                            "children": 0,
                            "source": "direct",
                            "guarantee": "credit_card",
                            "notes": ""
                  },
                  "guest": {
                            "id": "",
                            "notes": "",
                            "amenities": []
                  },
                  "folioCharge": {
                            "reservationId": "",
                            "description": "",
                            "amount": 0,
                            "date": "2024-08-15"
                  },
                  "folioPayment": {
                            "reservationId": "",
                            "description": "",
                            "amount": 0,
                            "date": "2024-08-15"
                  },
                  "audit": {
                            "businessDate": "2024-08-15",
                            "notes": "",
                            "includeStatistics": true
                  }
        }
      </script>

      <script type="application/json" data-m-data data-m-path="i18n.strings">
        {
                  "app.subtitle": {
                            "ar": "نظام إدارة الفنادق العالمي المتكامل لفندق جرمل المعمورة.",
                            "en": "Global property management backbone for G-remal Almaamoura."
                  },
                  "app.badge": {
                            "ar": "تشغيل مباشر",
                            "en": "Live Operations"
                  },
                  "header.theme.light": {
                            "ar": "نهاري",
                            "en": "Light"
                  },
                  "header.theme.dark": {
                            "ar": "ليلي",
                            "en": "Dark"
                  },
                  "header.lang.ar": {
                            "ar": "العربية",
                            "en": "Arabic"
                  },
                  "header.lang.en": {
                            "ar": "الإنجليزية",
                            "en": "English"
                  },
                  "header.sync": {
                            "ar": "مزامنة فورية",
                            "en": "Instant Sync"
                  },
                  "header.businessDate": {
                            "ar": "تاريخ العمل",
                            "en": "Business Date"
                  },
                  "header.businessDateUnset": {
                            "ar": "غير محدد",
                            "en": "Not set"
                  },
                  "frontOffice.metrics.occupancy": {
                            "ar": "نسبة الإشغال",
                            "en": "Occupancy"
                  },
                  "frontOffice.metrics.adr": {
                            "ar": "متوسط السعر اليومي",
                            "en": "Average Daily Rate"
                  },
                  "frontOffice.metrics.revpar": {
                            "ar": "العائد لكل غرفة",
                            "en": "RevPAR"
                  },
                  "frontOffice.metrics.arrivals": {
                            "ar": "الوصول اليوم",
                            "en": "Arrivals Today"
                  },
                  "frontOffice.metrics.departures": {
                            "ar": "المغادرة اليوم",
                            "en": "Departures Today"
                  },
                  "frontOffice.metrics.inhouse": {
                            "ar": "النزلاء بالداخل",
                            "en": "In-house Guests"
                  },
                  "frontOffice.tasks.title": {
                            "ar": "مهام المكاتب الأمامية",
                            "en": "Front Desk Tasks"
                  },
                  "frontOffice.tasks.complete": {
                            "ar": "تم الإنجاز",
                            "en": "Mark Done"
                  },
                  "frontOffice.timeline.arrivals": {
                            "ar": "وصول قادم",
                            "en": "Upcoming Arrivals"
                  },
                  "frontOffice.timeline.departures": {
                            "ar": "مغادرة متوقعة",
                            "en": "Expected Departures"
                  },
                  "reservations.title": {
                            "ar": "نظام الحجوزات المركزي",
                            "en": "Central Reservations"
                  },
                  "reservations.subtitle": {
                            "ar": "إدارة الحجوزات الفردية والجماعية مع توزيع الغرف.",
                            "en": "Manage individual and group reservations with inventory control."
                  },
                  "reservations.filters.status": {
                            "ar": "الحالة",
                            "en": "Status"
                  },
                  "reservations.filters.type": {
                            "ar": "النوع",
                            "en": "Type"
                  },
                  "reservations.filters.search": {
                            "ar": "بحث عن نزيل أو حجز",
                            "en": "Search guest or reservation"
                  },
                  "reservations.create": {
                            "ar": "إنشاء حجز",
                            "en": "Create Reservation"
                  },
                  "reservations.table.reservation": {
                            "ar": "الحجز",
                            "en": "Reservation"
                  },
                  "reservations.table.guest": {
                            "ar": "النزيل / المجموعة",
                            "en": "Guest / Group"
                  },
                  "reservations.table.dates": {
                            "ar": "التواريخ",
                            "en": "Dates"
                  },
                  "reservations.table.status": {
                            "ar": "الحالة",
                            "en": "Status"
                  },
                  "reservations.table.balance": {
                            "ar": "الرصيد",
                            "en": "Balance"
                  },
                  "reservations.form.type": {
                            "ar": "نوع الحجز",
                            "en": "Reservation Type"
                  },
                  "reservations.form.guest": {
                            "ar": "اختر النزيل / المجموعة",
                            "en": "Select guest / group"
                  },
                  "reservations.form.groupName": {
                            "ar": "اسم المجموعة",
                            "en": "Group name"
                  },
                  "reservations.form.roomType": {
                            "ar": "نوع الغرفة",
                            "en": "Room type"
                  },
                  "reservations.form.room": {
                            "ar": "الغرفة",
                            "en": "Room"
                  },
                  "reservations.form.rooms": {
                            "ar": "الغرف",
                            "en": "Rooms"
                  },
                  "reservations.form.arrival": {
                            "ar": "تاريخ الوصول",
                            "en": "Arrival date"
                  },
                  "reservations.form.departure": {
                            "ar": "تاريخ المغادرة",
                            "en": "Departure date"
                  },
                  "reservations.form.adults": {
                            "ar": "عدد البالغين",
                            "en": "Adults"
                  },
                  "reservations.form.children": {
                            "ar": "عدد الأطفال",
                            "en": "Children"
                  },
                  "reservations.form.source": {
                            "ar": "مصدر الحجز",
                            "en": "Source"
                  },
                  "reservations.form.guarantee": {
                            "ar": "ضمان الدفع",
                            "en": "Guarantee"
                  },
                  "reservations.form.notes": {
                            "ar": "ملاحظات داخلية",
                            "en": "Internal notes"
                  },
                  "reservations.form.submit": {
                            "ar": "حفظ الحجز",
                            "en": "Save reservation"
                  },
                  "checkin.title": {
                            "ar": "تسجيل الوصول والمغادرة",
                            "en": "Check-in & Check-out"
                  },
                  "checkin.subtitle": {
                            "ar": "تابع العمليات اللحظية وحوّل الحجوزات إلى نزلاء.",
                            "en": "Track real-time operations and convert bookings into stays."
                  },
                  "checkin.arrivals": {
                            "ar": "وصول اليوم",
                            "en": "Today arrivals"
                  },
                  "checkin.departures": {
                            "ar": "مغادرة اليوم",
                            "en": "Today departures"
                  },
                  "checkin.button.checkin": {
                            "ar": "تسجيل وصول",
                            "en": "Check-in"
                  },
                  "checkin.button.checkout": {
                            "ar": "تسجيل مغادرة",
                            "en": "Check-out"
                  },
                  "profiles.title": {
                            "ar": "ملفات النزلاء",
                            "en": "Guest Profiles"
                  },
                  "profiles.subtitle": {
                            "ar": "ثري البيانات مع تفضيلات محدّثة وحساسية للغات.",
                            "en": "Rich data with up-to-date preferences and languages."
                  },
                  "profiles.filters.search": {
                            "ar": "بحث بالاسم أو البريد",
                            "en": "Search by name or email"
                  },
                  "profiles.filters.tier": {
                            "ar": "شريحة الولاء",
                            "en": "Loyalty tier"
                  },
                  "profiles.form.notes": {
                            "ar": "ملاحظات مخصصة",
                            "en": "Personal notes"
                  },
                  "profiles.form.amenities": {
                            "ar": "وسائل الراحة المفضلة",
                            "en": "Preferred amenities"
                  },
                  "profiles.form.save": {
                            "ar": "تحديث الملف",
                            "en": "Update profile"
                  },
                  "rack.title": {
                            "ar": "لوحة حالة الغرف",
                            "en": "Room Rack"
                  },
                  "rack.subtitle": {
                            "ar": "جداول بحسب الطابق مع حالة اللحظة.",
                            "en": "Floor-by-floor grids with live status."
                  },
                  "folio.title": {
                            "ar": "حسابات وفوترة النزلاء",
                            "en": "Guest Billing & Folios"
                  },
                  "folio.subtitle": {
                            "ar": "أدر الرسوم والمدفوعات والتسويات بضغطة زر.",
                            "en": "Manage charges, payments, and settlements instantly."
                  },
                  "folio.charge.add": {
                            "ar": "إضافة رسم",
                            "en": "Add charge"
                  },
                  "folio.payment.add": {
                            "ar": "إضافة دفعة",
                            "en": "Add payment"
                  },
                  "folio.close": {
                            "ar": "إغلاق الفاتورة",
                            "en": "Close folio"
                  },
                  "nightAudit.title": {
                            "ar": "التدقيق الليلي الآلي",
                            "en": "Automated Night Audit"
                  },
                  "nightAudit.subtitle": {
                            "ar": "إقفال اليوم المالي مع مؤشرات الأداء.",
                            "en": "Close the business day with performance KPIs."
                  },
                  "nightAudit.run": {
                            "ar": "تشغيل التدقيق",
                            "en": "Run audit"
                  },
                  "nightAudit.lastRun": {
                            "ar": "آخر تشغيل",
                            "en": "Last run"
                  },
                  "nightAudit.status.success": {
                            "ar": "تم تسجيل التدقيق",
                            "en": "Audit posted successfully"
                  },
                  "alerts.saved": {
                            "ar": "تم حفظ البيانات في النظام.",
                            "en": "Data saved successfully."
                  },
                  "alerts.error": {
                            "ar": "حدث خطأ غير متوقع.",
                            "en": "Unexpected error occurred."
                  }
        }
      </script>


      <div class="app-shell" dir="{state.env.dir}">
        <div class="app-card">
          <header class="app-header">
            <div class="header-meta">
              <span class="status-tag">{trans('app.badge')}</span>
              <h1>{state.hotel.name} — {state.env.lang === 'ar' ? 'مركز التحكم الفندقي' : 'Hotel Command Center'}</h1>
              <p>{trans('app.subtitle')}</p>
            </div>
            <div class="header-actions">
              <div class="segmented">
                <button class="{state.env.theme === 'light' ? 'active' : ''}" onclick="setTheme('light', ctx)">{trans('header.theme.light')}</button>
                <button class="{state.env.theme === 'dark' ? 'active' : ''}" onclick="setTheme('dark', ctx)">{trans('header.theme.dark')}</button>
              </div>
              <div class="segmented">
                <button class="{state.env.lang === 'ar' ? 'active' : ''}" onclick="setLanguage('ar', ctx)">{trans('header.lang.ar')}</button>
                <button class="{state.env.lang === 'en' ? 'active' : ''}" onclick="setLanguage('en', ctx)">{trans('header.lang.en')}</button>
              </div>
              <button class="button secondary" onclick="forceSync(ctx)">
                🔄 {trans('header.sync')}
              </button>
              <div class="status-tag">
                <strong>{trans('header.businessDate')}:</strong>
                <span>{(state.data.runtime && state.data.runtime.businessDate) ? state.data.runtime.businessDate : trans('header.businessDateUnset')}</span>
              </div>
            </div>
          </header>

          <div class="layout">
            <aside class="sidebar">
              <div class="sidebar-card">
                <h2>{state.env.lang === 'ar' ? 'التنقل الرئيسي' : 'Primary Navigation'}</h2>
                <div class="nav-list">
                  <button
                    class="nav-item {(state.data.view && state.data.view.activeModule === module.id) ? 'active' : ''}"
                    x-for="module in state.structure.modules"
                    key="module.id"
                    onclick="switchModule(module.id, ctx)"
                  >
                    <strong>{state.env.lang === 'ar' ? module.title.ar : module.title.en}</strong>
                    <span class="badge">{navBadge(state, module.id)}</span>
                  </button>
                </div>
              </div>
              <div class="sidebar-card">
                <h2>{state.env.lang === 'ar' ? 'تنبيهات' : 'Alerts'}</h2>
                <div class="list">
                  <p x-if="!(state.data.runtime && state.data.runtime.alerts && state.data.runtime.alerts.length)" class="{state.env.lang === 'ar' ? 'text-right' : ''}" style="margin:0;color:var(--muted-foreground);">
                    {state.env.lang === 'ar' ? 'لا توجد تنبيهات حالية.' : 'No alerts at the moment.'}
                  </p>
                  <div class="list-item" x-for="alert in (state.data.runtime && state.data.runtime.alerts ? state.data.runtime.alerts : [])" key="alert.id">
                    <header>
                      <span>{alert.message}</span>
                      <span class="tag {alert.type === 'error' ? 'warning' : 'success'}">{alert.type}</span>
                    </header>
                    <small style="color:var(--muted-foreground);">{alert.timestamp}</small>
                  </div>
                </div>
              </div>
            </aside>

            <div class="main-column">
              <section class="panel" x-if="state.data.view && state.data.view.activeModule === 'frontOffice'">
                <header>
                  <h2>{state.env.lang === 'ar' ? 'مؤشرات التشغيل الفوري' : 'Real-time Operating Pulse'}</h2>
                  <p>{state.env.lang === 'ar' ? 'تتبّع الإشغال والمهام والمواعيد الحرجة.' : 'Track occupancy, tasks, and critical appointments.'}</p>
                </header>
                <div class="metrics-grid">
                  <div class="metric-card">
                    <h3>{trans('frontOffice.metrics.occupancy')}</h3>
                    <strong>{state.data.runtime.metrics.frontOffice.occupancy}%</strong>
                    <span class="status-tag">{state.data.runtime.metrics.frontOffice.occupied}/{state.hotel.roomsTotal}</span>
                  </div>
                  <div class="metric-card">
                    <h3>{trans('frontOffice.metrics.adr')}</h3>
                    <strong>{state.data.runtime.metrics.frontOffice.adr} USD</strong>
                    <span class="status-tag">ADR</span>
                  </div>
                  <div class="metric-card">
                    <h3>{trans('frontOffice.metrics.revpar')}</h3>
                    <strong>{state.data.runtime.metrics.frontOffice.revPar} USD</strong>
                    <span class="status-tag">RevPAR</span>
                  </div>
                  <div class="metric-card">
                    <h3>{trans('frontOffice.metrics.arrivals')}</h3>
                    <strong>{state.data.runtime.metrics.frontOffice.arrivals}</strong>
                    <span class="status-tag">{state.env.lang === 'ar' ? 'قادم' : 'Arrivals'}</span>
                  </div>
                  <div class="metric-card">
                    <h3>{trans('frontOffice.metrics.departures')}</h3>
                    <strong>{state.data.runtime.metrics.frontOffice.departures}</strong>
                    <span class="status-tag">{state.env.lang === 'ar' ? 'مغادر' : 'Departures'}</span>
                  </div>
                  <div class="metric-card">
                    <h3>{trans('frontOffice.metrics.inhouse')}</h3>
                    <strong>{state.data.runtime.metrics.frontOffice.inhouse}</strong>
                    <span class="status-tag">{state.env.lang === 'ar' ? 'بالداخل' : 'In-house'}</span>
                  </div>
                </div>

                <div class="split-columns">
                  <div>
                    <h3 style="margin:0 0 0.75rem;font-size:1.1rem;">{trans('frontOffice.tasks.title')}</h3>
                    <div class="list" x-if="state.data.runtime.tasks.length">
                      <div class="list-item" x-for="task in state.data.runtime.tasks" key="task.id">
                        <header>
                          <span>{task.time} — {task.title}</span>
                          <span class="tag {task.priority === 'high' ? 'warning' : task.priority === 'medium' ? 'muted' : ''}">{task.priority}</span>
                        </header>
                        <div style="display:flex;justify-content:space-between;align-items:center;gap:0.75rem;">
                          <span style="color:var(--muted-foreground);">{state.env.lang === 'ar' ? 'المسؤول:' : 'Owner:'} {task.owner}</span>
                          <div class="actions">
                            <button class="button ghost" onclick="updateTaskStatus(task.id, 'completed', ctx)">{trans('frontOffice.tasks.complete')}</button>
                          </div>
                        </div>
                      </div>
                    </div>
                    <p x-if="!state.data.runtime.tasks.length" style="margin:0;color:var(--muted-foreground);">{state.env.lang === 'ar' ? 'لا توجد مهام حاليًا.' : 'No pending tasks.'}</p>
                  </div>
                  <div>
                    <h3 style="margin:0 0 0.75rem;font-size:1.1rem;">{state.env.lang === 'ar' ? 'جدول الحركة' : 'Movement timeline'}</h3>
                    <div class="timeline">
                      <div class="timeline-item" x-for="arrival in state.data.runtime.views.arrivals" key="'arr-' + arrival.id">
                        <h4>{trans('frontOffice.timeline.arrivals')}</h4>
                        <p style="margin:0;">{arrival.guestLabel}</p>
                        <footer>
                          <span>{arrival.arrival}</span>
                          <span class="tag">{arrival.roomLabel}</span>
                        </footer>
                      </div>
                      <div class="timeline-item" x-for="departure in state.data.runtime.views.departures" key="'dep-' + departure.id">
                        <h4>{trans('frontOffice.timeline.departures')}</h4>
                        <p style="margin:0;">{departure.guestLabel}</p>
                        <footer>
                          <span>{departure.departure}</span>
                          <span class="tag warning">{departure.roomLabel}</span>
                        </footer>
                      </div>
                    </div>
                  </div>
                </div>
              </section>

              <section class="panel" x-if="state.data.view && state.data.view.activeModule === 'reservations'">
                <header>
                  <h2>{trans('reservations.title')}</h2>
                  <p>{trans('reservations.subtitle')}</p>
                </header>
                <div class="actions" style="justify-content:space-between;gap:1rem;flex-wrap:wrap;">
                  <div class="actions" style="flex-wrap:wrap;gap:0.75rem;">
                    <label>
                      {trans('reservations.filters.status')}
                      <select onchange="updateReservationFilter('status', this.value, ctx)" value="{state.data.view.filters.reservations.status}">
                        <option value="all">{state.env.lang === 'ar' ? 'الكل' : 'All'}</option>
                        <option value="booked">{state.env.lang === 'ar' ? 'محجوز' : 'Booked'}</option>
                        <option value="pending">{state.env.lang === 'ar' ? 'معلق' : 'Pending'}</option>
                        <option value="checked_in">{state.env.lang === 'ar' ? 'متواجد' : 'Checked-in'}</option>
                        <option value="checked_out">{state.env.lang === 'ar' ? 'مغادر' : 'Checked-out'}</option>
                        <option value="cancelled">{state.env.lang === 'ar' ? 'ملغى' : 'Cancelled'}</option>
                      </select>
                    </label>
                    <label>
                      {trans('reservations.filters.type')}
                      <select onchange="updateReservationFilter('type', this.value, ctx)" value="{state.data.view.filters.reservations.type}">
                        <option value="all">{state.env.lang === 'ar' ? 'الكل' : 'All'}</option>
                        <option value="individual">{state.env.lang === 'ar' ? 'أفراد' : 'Individual'}</option>
                        <option value="group">{state.env.lang === 'ar' ? 'مجموعات' : 'Group'}</option>
                      </select>
                    </label>
                  </div>
                  <div class="actions">
                    <input
                      type="search"
                      placeholder="{trans('reservations.filters.search')}"
                      value="{state.data.view.filters.reservations.search}"
                      oninput="updateReservationFilter('search', this.value, ctx)"
                    />
                    <button class="button" onclick="toggleReservationForm(ctx)">{trans('reservations.create')}</button>
                  </div>
                </div>

                <div x-if="state.data.view.showReservationForm" style="border:1px solid var(--border);border-radius:20px;padding:1.5rem;background:var(--surface-2);">
                  <form class="form-grid" onsubmit="return submitReservation(event, ctx)">
                    <label>
                      {trans('reservations.form.type')}
                      <select onchange="updateReservationForm('type', this.value, ctx)" value="{state.data.forms.reservation.type}">
                        <option value="individual">{state.env.lang === 'ar' ? 'فردي' : 'Individual'}</option>
                        <option value="group">{state.env.lang === 'ar' ? 'مجموعة' : 'Group'}</option>
                      </select>
                    </label>
                    <label>
                      {trans('reservations.form.guest')}
                      <select onchange="updateReservationForm('guestId', this.value, ctx)" value="{state.data.forms.reservation.guestId}">
                        <option value="">{state.env.lang === 'ar' ? 'اختر' : 'Select'}</option>
                        <option x-for="guest in state.data.runtime.guests" key="guest.id" value="{guest.id}">{guest.profile.name[state.env.lang]}</option>
                      </select>
                    </label>
                    <label x-if="state.data.forms.reservation.type === 'group'">
                      {trans('reservations.form.groupName')}
                      <input type="text" value="{state.data.forms.reservation.groupName}" oninput="updateReservationForm('groupName', this.value, ctx)" />
                    </label>
                    <label>
                      {trans('reservations.form.roomType')}
                      <select onchange="updateReservationForm('roomType', this.value, ctx)" value="{state.data.forms.reservation.roomType}">
                        <option value="single">{state.env.lang === 'ar' ? 'فردي' : 'Single'}</option>
                        <option value="double">{state.env.lang === 'ar' ? 'مزدوج' : 'Double'}</option>
                        <option value="suite">{state.env.lang === 'ar' ? 'جناح' : 'Suite'}</option>
                      </select>
                    </label>
                    <label x-if="state.data.forms.reservation.type === 'individual'">
                      {trans('reservations.form.room')}
                      <select onchange="updateReservationForm('roomId', this.value, ctx)" value="{state.data.forms.reservation.roomId}">
                        <option value="">{state.env.lang === 'ar' ? 'اختر' : 'Select'}</option>
                        <option x-for="room in availableRooms(state, state.data.forms.reservation.roomType)" key="room.id" value="{room.id}">{room.number} — {room.type}</option>
                      </select>
                    </label>
                    <div x-if="state.data.forms.reservation.type === 'group'">
                      <label>{trans('reservations.form.rooms')}</label>
                      <div class="list" style="max-height:180px;overflow:auto;padding:0.75rem;border:1px solid var(--border);border-radius:16px;background:var(--card);">
                        <label x-for="room in availableRooms(state, state.data.forms.reservation.roomType)" key="'sel-' + room.id" style="display:flex;align-items:center;gap:0.6rem;font-weight:500;">
                          <input type="checkbox" checked="{state.data.forms.reservation.roomIds.includes(room.id)}" onchange="toggleGroupRoom(room.id, this.checked, ctx)" />
                          <span>{room.number} — {room.type}</span>
                        </label>
                      </div>
                    </div>
                    <label>
                      {trans('reservations.form.arrival')}
                      <input type="date" data-form-field="reservation-arrival" onchange="updateReservationForm('arrival', this.value, ctx)" />
                    </label>
                    <label>
                      {trans('reservations.form.departure')}
                      <input type="date" data-form-field="reservation-departure" onchange="updateReservationForm('departure', this.value, ctx)" />
                    </label>
                    <label>
                      {trans('reservations.form.adults')}
                      <input type="number" min="1" data-form-field="reservation-adults" oninput="updateReservationForm('adults', this.value, ctx)" />
                    </label>
                    <label>
                      {trans('reservations.form.children')}
                      <input type="number" min="0" data-form-field="reservation-children" oninput="updateReservationForm('children', this.value, ctx)" />
                    </label>
                    <label>
                      {trans('reservations.form.source')}
                      <select onchange="updateReservationForm('source', this.value, ctx)" value="{state.data.forms.reservation.source}">
                        <option value="direct">{state.env.lang === 'ar' ? 'مباشر' : 'Direct'}</option>
                        <option value="website">{state.env.lang === 'ar' ? 'موقع إلكتروني' : 'Website'}</option>
                        <option value="travel_agent">{state.env.lang === 'ar' ? 'وكيل' : 'Travel agent'}</option>
                        <option value="corporate">{state.env.lang === 'ar' ? 'شركة' : 'Corporate'}</option>
                        <option value="event">{state.env.lang === 'ar' ? 'فعالية' : 'Event'}</option>
                      </select>
                    </label>
                    <label>
                      {trans('reservations.form.guarantee')}
                      <select onchange="updateReservationForm('guarantee', this.value, ctx)" value="{state.data.forms.reservation.guarantee}">
                        <option value="credit_card">{state.env.lang === 'ar' ? 'بطاقة ائتمان' : 'Credit card'}</option>
                        <option value="cash">{state.env.lang === 'ar' ? 'نقدي' : 'Cash'}</option>
                        <option value="company">{state.env.lang === 'ar' ? 'شركة' : 'Company'}</option>
                        <option value="bank_transfer">{state.env.lang === 'ar' ? 'تحويل' : 'Bank transfer'}</option>
                      </select>
                    </label>
                    <label style="grid-column:1 / -1;">
                      {trans('reservations.form.notes')}
                      <textarea oninput="updateReservationForm('notes', this.value, ctx)">{state.data.forms.reservation.notes}</textarea>
                    </label>
                    <div class="actions" style="grid-column:1 / -1;justify-content:flex-end;">
                      <button class="button" type="submit">{trans('reservations.form.submit')}</button>
                      <button type="button" class="button secondary" onclick="toggleReservationForm(ctx)">{state.env.lang === 'ar' ? 'إغلاق' : 'Close'}</button>
                    </div>
                  </form>
                </div>

                <div style="overflow:auto;border-radius:20px;border:1px solid var(--border);">
                  <table class="table">
                    <thead>
                      <tr>
                        <th>{trans('reservations.table.reservation')}</th>
                        <th>{trans('reservations.table.guest')}</th>
                        <th>{trans('reservations.table.dates')}</th>
                        <th>{trans('reservations.table.status')}</th>
                        <th>{trans('reservations.table.balance')}</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr x-for="reservation in state.data.runtime.views.reservations" key="reservation.id">
                        <td>
                          <strong>{reservation.id}</strong>
                          <div style="color:var(--muted-foreground);font-size:0.85rem;">{reservation.type}</div>
                        </td>
                        <td>
                          <strong>{reservation.guestLabel}</strong>
                          <div style="color:var(--muted-foreground);font-size:0.85rem;">{reservation.roomSummary}</div>
                        </td>
                        <td>
                          <div>{reservation.arrival} → {reservation.departure}</div>
                          <div style="color:var(--muted-foreground);font-size:0.8rem;">{reservation.nightsLabel}</div>
                        </td>
                        <td>
                          <span class="tag {statusTag(reservation.status)}">{reservation.statusLabel}</span>
                        </td>
                        <td>{reservation.balanceFormatted}</td>
                        <td>
                          <div class="actions">
                            <button class="button ghost" onclick="assignRoomFromList(reservation.id, ctx)">{state.env.lang === 'ar' ? 'تحديث الغرفة' : 'Assign room'}</button>
                          </div>
                        </td>
                      </tr>
                      <tr x-if="!state.data.runtime.views.reservations.length">
                        <td colspan="6" style="text-align:center;color:var(--muted-foreground);padding:1.5rem;">
                          {state.env.lang === 'ar' ? 'لا توجد حجوزات مطابقة.' : 'No reservations match the filters.'}
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </section>

              <section class="panel" x-if="state.data.view && state.data.view.activeModule === 'checkin'">
                <header>
                  <h2>{trans('checkin.title')}</h2>
                  <p>{trans('checkin.subtitle')}</p>
                </header>
                <div class="split-columns">
                  <div>
                    <h3 style="margin:0 0 0.75rem;">{trans('checkin.arrivals')}</h3>
                    <div class="list" x-if="state.data.runtime.views.arrivals.length">
                      <div class="list-item" x-for="arrival in state.data.runtime.views.arrivals" key="'arrive-' + arrival.id">
                        <header>
                          <span>{arrival.guestLabel}</span>
                          <span class="tag">{arrival.roomLabel}</span>
                        </header>
                        <div style="display:flex;justify-content:space-between;align-items:center;gap:0.75rem;">
                          <span style="color:var(--muted-foreground);">{arrival.arrival}</span>
                          <div class="actions">
                            <button class="button" onclick="performCheckIn(arrival.id, ctx)">{trans('checkin.button.checkin')}</button>
                          </div>
                        </div>
                      </div>
                    </div>
                    <p x-if="!state.data.runtime.views.arrivals.length" style="margin:0;color:var(--muted-foreground);">{state.env.lang === 'ar' ? 'لا وصول اليوم.' : 'No arrivals today.'}</p>
                  </div>
                  <div>
                    <h3 style="margin:0 0 0.75rem;">{trans('checkin.departures')}</h3>
                    <div class="list" x-if="state.data.runtime.views.departures.length">
                      <div class="list-item" x-for="departure in state.data.runtime.views.departures" key="'depart-' + departure.id">
                        <header>
                          <span>{departure.guestLabel}</span>
                          <span class="tag warning">{departure.roomLabel}</span>
                        </header>
                        <div style="display:flex;justify-content:space-between;align-items:center;gap:0.75rem;">
                          <span style="color:var(--muted-foreground);">{departure.departure}</span>
                          <div class="actions">
                            <button class="button secondary" onclick="performCheckOut(departure.id, ctx)">{trans('checkin.button.checkout')}</button>
                          </div>
                        </div>
                      </div>
                    </div>
                    <p x-if="!state.data.runtime.views.departures.length" style="margin:0;color:var(--muted-foreground);">{state.env.lang === 'ar' ? 'لا مغادرة اليوم.' : 'No departures today.'}</p>
                  </div>
                </div>
              </section>

              <section class="panel" x-if="state.data.view && state.data.view.activeModule === 'profiles'">
                <header>
                  <h2>{trans('profiles.title')}</h2>
                  <p>{trans('profiles.subtitle')}</p>
                </header>
                <div class="actions" style="gap:0.75rem;flex-wrap:wrap;">
                  <input
                    type="search"
                    placeholder="{trans('profiles.filters.search')}"
                    value="{state.data.view.filters.profiles.search}"
                    oninput="updateProfileFilter('search', this.value, ctx)"
                  />
                  <select onchange="updateProfileFilter('tier', this.value, ctx)" value="{state.data.view.filters.profiles.tier}">
                    <option value="all">{state.env.lang === 'ar' ? 'كل الشرائح' : 'All tiers'}</option>
                    <option value="elite">Elite</option>
                    <option value="platinum">Platinum</option>
                    <option value="gold">Gold</option>
                    <option value="silver">Silver</option>
                    <option value="classic">Classic</option>
                    <option value="corporate">Corporate</option>
                  </select>
                </div>

                <div class="split-columns">
                  <div class="list" x-if="state.data.runtime.views.profiles.length">
                    <div class="list-item" x-for="guest in state.data.runtime.views.profiles" key="guest.id" onclick="loadGuestForm(guest.id, ctx)" style="cursor:pointer;">
                      <header>
                        <span>{guest.profile.name[state.env.lang]}</span>
                        <span class="tag {guest.profile.loyaltyTier}">{guest.profile.loyaltyTier}</span>
                      </header>
                      <table class="mini-table">
                        <tr>
                          <td>{state.env.lang === 'ar' ? 'البريد' : 'Email'}</td>
                          <td>{guest.profile.contact.email}</td>
                        </tr>
                        <tr>
                          <td>{state.env.lang === 'ar' ? 'الهاتف' : 'Phone'}</td>
                          <td>{guest.profile.contact.phone}</td>
                        </tr>
                        <tr>
                          <td>{state.env.lang === 'ar' ? 'الإقامات' : 'Stays'}</td>
                          <td>{guest.stats.totalStays} / {guest.stats.nights} nights</td>
                        </tr>
                      </table>
                    </div>
                  </div>
                  <p x-if="!state.data.runtime.views.profiles.length" style="margin:0;color:var(--muted-foreground);">{state.env.lang === 'ar' ? 'اختر مرشحًا لعرض الملفات.' : 'Adjust filters to see profiles.'}</p>

                  <div style="border:1px solid var(--border);border-radius:20px;padding:1.5rem;background:var(--surface-2);">
                    <h3 style="margin-top:0;">{state.env.lang === 'ar' ? 'تخصيص الملف' : 'Personalise profile'}</h3>
                    <form class="form-grid" onsubmit="return submitGuestProfile(event, ctx)">
                      <label>
                        {trans('profiles.form.notes')}
                        <textarea oninput="updateGuestForm('notes', this.value, ctx)">{state.data.forms.guest.notes}</textarea>
                      </label>
                      <label>
                        {trans('profiles.form.amenities')}
                        <input type="text" placeholder="spa, pillow, arabic_breakfast" value="{state.data.forms.guest.amenities.join(', ')}" oninput="updateGuestAmenities(this.value, ctx)" />
                      </label>
                      <div class="actions" style="grid-column:1 / -1;justify-content:flex-end;">
                        <button class="button" type="submit">{trans('profiles.form.save')}</button>
                      </div>
                    </form>
                  </div>
                </div>
              </section>

              <section class="panel" x-if="state.data.view && state.data.view.activeModule === 'rack'">
                <header>
                  <h2>{trans('rack.title')}</h2>
                  <p>{trans('rack.subtitle')}</p>
                </header>
                <div class="actions" style="gap:0.75rem;">
                  <select onchange="updateRackFilter(this.value, ctx)" value="{state.data.view.filters.rack.status}">
                    <option value="all">{state.env.lang === 'ar' ? 'كل الحالات' : 'All statuses'}</option>
                    <option value="available">{state.env.lang === 'ar' ? 'متاح' : 'Available'}</option>
                    <option value="occupied">{state.env.lang === 'ar' ? 'مشغول' : 'Occupied'}</option>
                    <option value="dirty">{state.env.lang === 'ar' ? 'قيد التنظيف' : 'Dirty'}</option>
                    <option value="out_of_order">{state.env.lang === 'ar' ? 'خارج الخدمة' : 'Out of order'}</option>
                    <option value="reserved">{state.env.lang === 'ar' ? 'محجوز' : 'Reserved'}</option>
                  </select>
                </div>
                <div class="room-grid">
                  <div class="room-floor" x-for="floor in state.data.runtime.views.rack" key="'floor-' + floor.floor">
                    <div class="floor-header">
                      <span>{state.env.lang === 'ar' ? 'الطابق' : 'Floor'} {floor.floor}</span>
                      <span class="status-tag">{floor.summary}</span>
                    </div>
                    <div class="rooms-row">
                      <div class="room-card {room.stateClass}" x-for="room in floor.rooms" key="room.id">
                        <div class="number">{room.number}</div>
                        <div class="status">{room.statusLabel}</div>
                        <div style="font-size:0.78rem;color:var(--muted-foreground);">{room.typeLabel}</div>
                      </div>
                    </div>
                  </div>
                </div>
              </section>

              <section class="panel" x-if="state.data.view && state.data.view.activeModule === 'folio'">
                <header>
                  <h2>{trans('folio.title')}</h2>
                  <p>{trans('folio.subtitle')}</p>
                </header>
                <div class="actions" style="gap:0.75rem;flex-wrap:wrap;">
                  <select onchange="updateFolioFilter(this.value, ctx)" value="{state.data.view.filters.folio.status}">
                    <option value="all">{state.env.lang === 'ar' ? 'كل الفواتير' : 'All folios'}</option>
                    <option value="open">{state.env.lang === 'ar' ? 'مفتوح' : 'Open'}</option>
                    <option value="closed">{state.env.lang === 'ar' ? 'مغلق' : 'Closed'}</option>
                  </select>
                </div>
                <div class="split-columns">
                  <div class="list" x-if="state.data.runtime.views.folios.length">
                    <div class="list-item" x-for="folio in state.data.runtime.views.folios" key="folio.id" onclick="loadFolioForms(folio.id, ctx)" style="cursor:pointer;">
                      <header>
                        <span>{folio.id} — {folio.guestLabel}</span>
                        <span class="tag {folio.status === 'open' ? 'success' : 'muted'}">{folio.status}</span>
                      </header>
                      <div style="display:flex;justify-content:space-between;gap:0.75rem;color:var(--muted-foreground);">
                        <span>{folio.totalChargesLabel}</span>
                        <span>{folio.balanceLabel}</span>
                      </div>
                    </div>
                  </div>
                  <p x-if="!state.data.runtime.views.folios.length" style="margin:0;color:var(--muted-foreground);">{state.env.lang === 'ar' ? 'لم يتم العثور على فواتير.' : 'No folios found.'}</p>

                  <div style="border:1px solid var(--border);border-radius:20px;padding:1.5rem;background:var(--surface-2);">
                    <h3 style="margin-top:0;">{state.env.lang === 'ar' ? 'رسوم ودفعات' : 'Charges & Payments'}</h3>
                    <form class="form-grid" onsubmit="return submitFolioCharge(event, ctx)">
                      <label>
                        {state.env.lang === 'ar' ? 'الحجز' : 'Reservation'}
                        <select onchange="updateFolioCharge('reservationId', this.value, ctx)" value="{state.data.forms.folioCharge.reservationId}">
                          <option value="">{state.env.lang === 'ar' ? 'اختر' : 'Select'}</option>
                          <option x-for="reservation in state.data.runtime.reservations" key="'fc-' + reservation.id" value="{reservation.id}">{reservation.id}</option>
                        </select>
                      </label>
                      <label>
                        {state.env.lang === 'ar' ? 'الوصف' : 'Description'}
                        <input type="text" value="{state.data.forms.folioCharge.description}" oninput="updateFolioCharge('description', this.value, ctx)" />
                      </label>
                      <label>
                        {state.env.lang === 'ar' ? 'المبلغ' : 'Amount'}
                        <input type="number" step="0.01" data-form-field="folio-charge-amount" oninput="updateFolioCharge('amount', this.value, ctx)" />
                      </label>
                      <label>
                        {state.env.lang === 'ar' ? 'التاريخ' : 'Date'}
                        <input type="date" data-form-field="folio-charge-date" onchange="updateFolioCharge('date', this.value, ctx)" />
                      </label>
                      <div class="actions" style="grid-column:1 / -1;justify-content:flex-end;">
                        <button class="button" type="submit">{trans('folio.charge.add')}</button>
                      </div>
                    </form>
                    <form class="form-grid" onsubmit="return submitFolioPayment(event, ctx)">
                      <label>
                        {state.env.lang === 'ar' ? 'الحجز' : 'Reservation'}
                        <select onchange="updateFolioPayment('reservationId', this.value, ctx)" value="{state.data.forms.folioPayment.reservationId}">
                          <option value="">{state.env.lang === 'ar' ? 'اختر' : 'Select'}</option>
                          <option x-for="reservation in state.data.runtime.reservations" key="'fp-' + reservation.id" value="{reservation.id}">{reservation.id}</option>
                        </select>
                      </label>
                      <label>
                        {state.env.lang === 'ar' ? 'الوصف' : 'Description'}
                        <input type="text" value="{state.data.forms.folioPayment.description}" oninput="updateFolioPayment('description', this.value, ctx)" />
                      </label>
                      <label>
                        {state.env.lang === 'ar' ? 'المبلغ' : 'Amount'}
                        <input type="number" step="0.01" data-form-field="folio-payment-amount" oninput="updateFolioPayment('amount', this.value, ctx)" />
                      </label>
                      <label>
                        {state.env.lang === 'ar' ? 'التاريخ' : 'Date'}
                        <input type="date" data-form-field="folio-payment-date" onchange="updateFolioPayment('date', this.value, ctx)" />
                      </label>
                      <div class="actions" style="grid-column:1 / -1;justify-content:flex-end;">
                        <button class="button secondary" type="submit">{trans('folio.payment.add')}</button>
                      </div>
                    </form>
                    <button class="button ghost" style="margin-top:1rem;" onclick="closeSelectedFolio(ctx)">{trans('folio.close')}</button>
                  </div>
                </div>
              </section>

              <section class="panel" x-if="state.data.view && state.data.view.activeModule === 'nightAudit'">
                <header>
                  <h2>{trans('nightAudit.title')}</h2>
                  <p>{trans('nightAudit.subtitle')}</p>
                </header>
                <div class="actions" style="justify-content:space-between;flex-wrap:wrap;gap:1rem;">
                  <div>
                    <strong>{trans('nightAudit.lastRun')}:</strong>
                    <span>{state.data.view.nightAudit.lastRun || (state.env.lang === 'ar' ? 'لم يتم بعد' : 'Not yet')}</span>
                  </div>
                  <button class="button" onclick="runNightAudit(ctx)">
                    🌙 {trans('nightAudit.run')}
                  </button>
                </div>
                <div class="list">
                  <div class="list-item" x-for="audit in state.data.runtime.nightAudits" key="audit.id">
                    <header>
                      <span>{audit.businessDate}</span>
                      <span class="tag {audit.status === 'posted' ? 'success' : 'warning'}">{audit.status}</span>
                    </header>
                    <table class="mini-table">
                      <tr><td>Rooms Sold</td><td>{audit.roomsSold}</td></tr>
                      <tr><td>Occupancy</td><td>{Math.round(audit.occupancy * 100)}%</td></tr>
                      <tr><td>ADR</td><td>{audit.adr}</td></tr>
                      <tr><td>RevPAR</td><td>{audit.revPar}</td></tr>
                    </table>
                    <p style="margin:0;color:var(--muted-foreground);">{audit.notes}</p>
                  </div>
                </div>
              </section>
            </div>
          </div>
        </div>
      </div>

      <script>
        (function(){
          'use strict';

          function commit(ctx, producer, after){
            if(!ctx) return;
            if(typeof ctx.commit === 'function'){ return ctx.commit(producer, after); }
            if(ctx.actions && typeof ctx.actions.commit === 'function'){ return ctx.actions.commit(producer, after); }
            if(ctx.store && typeof ctx.store.commit === 'function'){ return ctx.store.commit(producer, after); }
            if(ctx.actions && ctx.actions.store && typeof ctx.actions.store.commit === 'function'){
              return ctx.actions.store.commit(producer, after);
            }
            if(typeof window !== 'undefined' && window.Mishkah && window.Mishkah.Actions && typeof window.Mishkah.Actions.commit === 'function'){
              return window.Mishkah.Actions.commit(ctx, producer, after);
            }
            if(typeof console !== 'undefined' && console.warn){
              console.warn('[Mishkah] commit helper not available on context');
            }
          }

          var DB_NAME = 'gremal-hotel-pms';
          var DB_VERSION = 1;
          var objectStores = Object.freeze(['rooms','guests','reservations','folios','nightAudits','tasks','settings']);

          function openDB(){
            return new Promise(function(resolve, reject){
              var request = indexedDB.open(DB_NAME, DB_VERSION);
              request.onupgradeneeded = function(event){
                var db = event.target.result;
                objectStores.forEach(function(store){
                  if(!db.objectStoreNames.contains(store)){
                    if(store === 'settings'){
                      db.createObjectStore(store, { keyPath: 'key' });
                    } else {
                      db.createObjectStore(store, { keyPath: 'id' });
                    }
                  }
                });
              };
              request.onsuccess = function(event){ resolve(event.target.result); };
              request.onerror = function(event){ reject(event.target.error || new Error('IndexedDB error')); };
            });
          }

          function txStore(db, store, mode){
            return db.transaction([store], mode).objectStore(store);
          }

          function readAllFromStore(db, store){
            return new Promise(function(resolve, reject){
              var out = [];
              var cursorRequest = txStore(db, store, 'readonly').openCursor();
              cursorRequest.onsuccess = function(event){
                var cursor = event.target.result;
                if(cursor){
                  out.push(cursor.value);
                  cursor.continue();
                } else {
                  resolve(out);
                }
              };
              cursorRequest.onerror = function(event){ reject(event.target.error || new Error('readAll error: ' + store)); };
            });
          }

          function clearStore(db, store){
            return new Promise(function(resolve, reject){
              var request = txStore(db, store, 'readwrite').clear();
              request.onsuccess = function(){ resolve(); };
              request.onerror = function(event){ reject(event.target.error || new Error('clear error: ' + store)); };
            });
          }

          function putMany(db, store, items){
            return new Promise(function(resolve, reject){
              if(!Array.isArray(items) || !items.length){ resolve(); return; }
              var storeRef = txStore(db, store, 'readwrite');
              var index = 0;
              function next(){
                if(index >= items.length){ resolve(); return; }
                var request = storeRef.put(items[index]);
                index += 1;
                request.onsuccess = function(){ next(); };
                request.onerror = function(event){ reject(event.target.error || new Error('put error: ' + store)); };
              }
              next();
            });
          }

          function countStore(db, store){
            return new Promise(function(resolve, reject){
              var request = txStore(db, store, 'readonly').count();
              request.onsuccess = function(event){ resolve(event.target.result || 0); };
              request.onerror = function(event){ reject(event.target.error || new Error('count error: ' + store)); };
            });
          }

          function asMap(list){
            var out = Object.create(null);
            if(Array.isArray(list)){
              list.forEach(function(item){ if(item && item.id){ out[item.id] = item; } });
            }
            return out;
          }

          function normaliseRooms(rooms, reservations){
            var map = asMap(rooms);
            var now = new Date();
            (reservations || []).forEach(function(res){
              if(!res) return;
              var status = res.status;
              var markOccupied = status === 'checked_in';
              var markReserved = status === 'booked' || status === 'pending';
              var markDirty = status === 'checked_out';
              function tagRoom(id){
                var room = map[id];
                if(!room) return;
                if(markOccupied){ room.status = 'occupied'; }
                else if(markReserved && room.status !== 'occupied'){ room.status = 'reserved'; }
                else if(markDirty && room.status !== 'occupied'){ room.status = 'dirty'; }
                room.updatedAt = now.toISOString();
              }
              if(res.type === 'group' && Array.isArray(res.rooms)){
                res.rooms.forEach(tagRoom);
              } else if(res.roomId){
                tagRoom(res.roomId);
              }
            });
            return Object.keys(map).map(function(key){ return map[key]; });
          }

          function setFormFieldValue(selector, value){
            if(typeof document === 'undefined') return;
            var element = document.querySelector(selector);
            if(!element) return;
            if(document.activeElement === element) return;
            var normalised = value;
            if(normalised === undefined || normalised === null){
              normalised = '';
            }
            if(element.type === 'number'){
              element.value = normalised === '' ? '' : String(normalised);
            } else {
              element.value = normalised || '';
            }
          }

          function syncFormFields(ctx){
            if(!ctx) return;
            var state = ctx.getState();
            if(!state || !state.data || !state.data.forms) return;
            var forms = state.data.forms;
            var reservation = forms.reservation || {};
            var folioCharge = forms.folioCharge || {};
            var folioPayment = forms.folioPayment || {};
            setFormFieldValue('[data-form-field="reservation-arrival"]', reservation.arrival);
            setFormFieldValue('[data-form-field="reservation-departure"]', reservation.departure);
            setFormFieldValue('[data-form-field="reservation-adults"]', reservation.adults);
            setFormFieldValue('[data-form-field="reservation-children"]', reservation.children);
            setFormFieldValue('[data-form-field="folio-charge-amount"]', folioCharge.amount);
            setFormFieldValue('[data-form-field="folio-charge-date"]', folioCharge.date);
            setFormFieldValue('[data-form-field="folio-payment-amount"]', folioPayment.amount);
            setFormFieldValue('[data-form-field="folio-payment-date"]', folioPayment.date);
          }

          function ensureAlerts(state){
            state.data = state.data || {};
            state.data.runtime = state.data.runtime || {};
            var runtime = state.data.runtime;
            if(!runtime.businessDate){
              runtime.businessDate = new Date().toISOString().slice(0, 10);
            }
            runtime.rooms = runtime.rooms || [];
            runtime.reservations = runtime.reservations || [];
            runtime.guests = runtime.guests || [];
            runtime.folios = runtime.folios || [];
            runtime.nightAudits = runtime.nightAudits || [];
            runtime.tasks = runtime.tasks || [];
            runtime.alerts = Array.isArray(runtime.alerts) ? runtime.alerts : [];
            runtime.metrics = runtime.metrics || {};
            runtime.metrics.frontOffice = Object.assign({
              occupancy: 0,
              occupied: 0,
              available: 0,
              arrivals: 0,
              departures: 0,
              inhouse: 0,
              adr: 0,
              revPar: 0,
              revenueToday: 0
            }, runtime.metrics.frontOffice || {});
            runtime.metrics.reservations = Object.assign({
              total: 0,
              individual: 0,
              group: 0,
              pending: 0,
              booked: 0,
              checkedIn: 0,
              checkedOut: 0
            }, runtime.metrics.reservations || {});
            runtime.views = runtime.views || {};
            runtime.views.reservations = runtime.views.reservations || [];
            runtime.views.arrivals = runtime.views.arrivals || [];
            runtime.views.departures = runtime.views.departures || [];
            runtime.views.profiles = runtime.views.profiles || [];
            runtime.views.rack = runtime.views.rack || [];
            runtime.views.folios = runtime.views.folios || [];
          }

          function addAlert(ctx, type, message){
            if(!ctx) return;
            commit(ctx, function(next){
              next.data = next.data || {};
              next.data.runtime = next.data.runtime || {};
              var alerts = Array.isArray(next.data.runtime.alerts) ? next.data.runtime.alerts.slice() : [];
              alerts.unshift({ id: 'al-' + Date.now(), type: type, message: message, timestamp: new Date().toLocaleString() });
              alerts = alerts.slice(0, 6);
              next.data.runtime.alerts = alerts;
            });
          }

          function navBadge(state, moduleId){
            if(!state || !state.data || !state.data.runtime) return '';
            var metrics = state.data.runtime.metrics || {};
            var counts = metrics.reservations || {};
            var front = metrics.frontOffice || {};
            switch(moduleId){
              case 'frontOffice':
                return (front.occupancy || 0) + '%';
              case 'reservations':
                return (counts.total || 0) + ' / ' + (counts.booked || 0);
              case 'checkin':
                return (front.arrivals || 0) + ' ⇄ ' + (front.departures || 0);
              case 'profiles':
                return (state.data.runtime.guests || []).length + '';
              case 'rack':
                return (front.available || 0) + ' free';
              case 'folio':
                return (state.data.runtime.folios || []).length + '';
              case 'nightAudit':
                return (state.data.runtime.nightAudits || []).length + '';
              default:
                return '';
            }
          }

          function statusTag(status){
            switch(status){
              case 'checked_in': return 'success';
              case 'checked_out': return 'muted';
              case 'pending': return 'warning';
              case 'cancelled': return 'warning';
              case 'booked': return '';
              default: return '';
            }
          }

          function availableRooms(state, type){
            if(!state || !state.data || !state.data.runtime) return [];
            var list = state.data.runtime.rooms || [];
            return list.filter(function(room){
              if(type && room.type !== type) return false;
              return room.status === 'available' || room.status === 'reserved';
            });
          }

          function applyEnvironment(state){
            if(!state || !state.env) return;
            var root = document.documentElement;
            root.setAttribute('dir', state.env.dir || 'rtl');
            root.setAttribute('lang', state.env.lang || 'ar');
            if(state.env.theme === 'dark') root.classList.add('dark');
            else root.classList.remove('dark');
          }

          function persistEnvironment(state){
            try {
              var payload = {
                theme: state.env && state.env.theme,
                lang: state.env && state.env.lang,
                dir: state.env && state.env.dir
              };
              openDB().then(function(db){
                var store = txStore(db, 'settings', 'readwrite');
                store.put({ key: 'env', value: payload });
              });
            } catch(err){ console.warn('failed to persist env', err); }
          }

          function loadEnvironment(ctx){
            return openDB().then(function(db){
              return new Promise(function(resolve){
                var request = txStore(db, 'settings', 'readonly').get('env');
                request.onsuccess = function(event){
                  var env = event.target.result && event.target.result.value;
                  if(env){
                    commit(ctx, function(next){
                      next.env = next.env || {};
                      if(env.theme) next.env.theme = env.theme;
                      if(env.lang) next.env.lang = env.lang;
                      next.env.dir = env.dir || (env.lang === 'ar' ? 'rtl' : 'ltr');
                    }, function(state){ applyEnvironment(state); });
                  }
                  resolve();
                };
                request.onerror = function(){ resolve(); };
              });
            });
          }

          function seedDatabase(ctx, db){
            return Promise.all(objectStores.filter(function(store){ return store !== 'settings'; }).map(function(store){ return countStore(db, store); }))
              .then(function(counts){
                var needsSeed = counts.some(function(count){ return count === 0; });
                if(!needsSeed){ return; }
                var state = ctx.getState();
                var mock = state.data && state.data.mock;
                if(!mock){ return; }
                var rooms = normaliseRooms((mock.rooms || []).map(function(room){ return Object.assign({}, room); }), mock.reservations || []);
                var reservations = (mock.reservations || []).map(function(res){ return Object.assign({}, res); });
                var guests = (mock.guests || []).map(function(guest){ return Object.assign({}, guest); });
                var folios = (mock.folios || []).map(function(folio){ return Object.assign({}, folio); });
                var nightAudits = (mock.nightAudits || []).map(function(audit){ return Object.assign({}, audit); });
                var tasks = (mock.frontOfficeTasks || []).map(function(task){ return Object.assign({}, task); });
                return Promise.all([
                  clearStore(db, 'rooms').then(function(){ return putMany(db, 'rooms', rooms); }),
                  clearStore(db, 'guests').then(function(){ return putMany(db, 'guests', guests); }),
                  clearStore(db, 'reservations').then(function(){ return putMany(db, 'reservations', reservations); }),
                  clearStore(db, 'folios').then(function(){ return putMany(db, 'folios', folios); }),
                  clearStore(db, 'nightAudits').then(function(){ return putMany(db, 'nightAudits', nightAudits); }),
                  clearStore(db, 'tasks').then(function(){ return putMany(db, 'tasks', tasks); })
                ]);
              });
          }

          function loadAllData(db){
            return Promise.all([
              readAllFromStore(db, 'rooms'),
              readAllFromStore(db, 'guests'),
              readAllFromStore(db, 'reservations'),
              readAllFromStore(db, 'folios'),
              readAllFromStore(db, 'nightAudits'),
              readAllFromStore(db, 'tasks')
            ]).then(function(result){
              return {
                rooms: result[0],
                guests: result[1],
                reservations: result[2],
                folios: result[3],
                nightAudits: result[4],
                tasks: result[5]
              };
            });
          }

          function persistCollections(ctx){
            var state = ctx.getState();
            var runtime = state.data && state.data.runtime;
            if(!runtime) return Promise.resolve();
            return openDB().then(function(db){
              return Promise.all([
                clearStore(db, 'rooms').then(function(){ return putMany(db, 'rooms', runtime.rooms || []); }),
                clearStore(db, 'guests').then(function(){ return putMany(db, 'guests', runtime.guests || []); }),
                clearStore(db, 'reservations').then(function(){ return putMany(db, 'reservations', runtime.reservations || []); }),
                clearStore(db, 'folios').then(function(){ return putMany(db, 'folios', runtime.folios || []); }),
                clearStore(db, 'nightAudits').then(function(){ return putMany(db, 'nightAudits', runtime.nightAudits || []); }),
                clearStore(db, 'tasks').then(function(){ return putMany(db, 'tasks', runtime.tasks || []); })
              ]);
            });
          }

          function enhanceReservation(state, reservation){
            var guest = (state.data.runtime.guests || []).find(function(item){ return item.id === reservation.guestId; });
            var label = guest ? guest.profile.name[state.env.lang || 'ar'] : reservation.guestId;
            var isGroup = reservation.type === 'group';
            var roomSummary = isGroup ? (reservation.rooms || []).length + ' rooms' : (reservation.roomId || reservation.roomType || 'N/A');
            var statusDictionary = {
              'booked': state.env.lang === 'ar' ? 'محجوز' : 'Booked',
              'pending': state.env.lang === 'ar' ? 'معلق' : 'Pending',
              'checked_in': state.env.lang === 'ar' ? 'متواجد' : 'In-house',
              'checked_out': state.env.lang === 'ar' ? 'مغادر' : 'Checked-out',
              'cancelled': state.env.lang === 'ar' ? 'ملغى' : 'Cancelled'
            };
            var arrival = reservation.arrival;
            var departure = reservation.departure;
            var nights = 1;
            try {
              var a = new Date(arrival);
              var d = new Date(departure);
              var diff = Math.round((d - a) / (1000 * 60 * 60 * 24));
              nights = diff || 1;
            } catch(_err){}
            return Object.assign({}, reservation, {
              guestLabel: isGroup && reservation.groupName ? reservation.groupName : label,
              roomSummary: roomSummary,
              arrival: arrival,
              departure: departure,
              nightsLabel: (state.env.lang === 'ar' ? 'ليالٍ: ' : 'Nights: ') + nights,
              statusLabel: statusDictionary[reservation.status] || reservation.status,
              balanceFormatted: reservation.balance ? reservation.balance.toLocaleString(undefined, { style: 'currency', currency: 'USD' }) : '0.00'
            });
          }

          function buildRackView(state){
            var rooms = state.data.runtime.rooms || [];
            var filter = state.data.view.filters.rack.status;
            var grouped = {};
            rooms.forEach(function(room){
              if(filter && filter !== 'all' && room.status !== filter) return;
              grouped[room.floor] = grouped[room.floor] || [];
              grouped[room.floor].push(room);
            });
            return Object.keys(grouped).sort().map(function(floor){
              var roomsOnFloor = grouped[floor].map(function(room){
                var statusMap = {
                  'available': state.env.lang === 'ar' ? 'متاح' : 'Available',
                  'occupied': state.env.lang === 'ar' ? 'مشغول' : 'Occupied',
                  'dirty': state.env.lang === 'ar' ? 'قيد التنظيف' : 'Dirty',
                  'out_of_order': state.env.lang === 'ar' ? 'خارج الخدمة' : 'Out of order',
                  'reserved': state.env.lang === 'ar' ? 'محجوز' : 'Reserved'
                };
                return Object.assign({}, room, {
                  statusLabel: statusMap[room.status] || room.status,
                  typeLabel: room.type,
                  stateClass: room.status === 'occupied' ? 'busy' : room.status === 'dirty' ? 'dirty' : room.status === 'out_of_order' ? 'out' : ''
                });
              });
              var summary = roomsOnFloor.length + ' / ' + (state.env.lang === 'ar' ? 'غرف' : 'rooms');
              return { floor: floor, rooms: roomsOnFloor, summary: summary };
            });
          }

          function computeMetrics(ctx){
            var state = ctx.getState();
            var runtime = state.data.runtime || {};
            var rooms = runtime.rooms || [];
            var reservations = runtime.reservations || [];
            var folios = runtime.folios || [];
            var businessDate = state.data.runtime.businessDate;
            var occupied = rooms.filter(function(room){ return room.status === 'occupied'; }).length;
            var available = rooms.filter(function(room){ return room.status === 'available'; }).length;
            var occupancy = state.hotel && state.hotel.roomsTotal ? Math.round((occupied / state.hotel.roomsTotal) * 100) : 0;
            var arrivals = reservations.filter(function(res){ return res.arrival === businessDate && (res.status === 'booked' || res.status === 'pending'); }).length;
            var departures = reservations.filter(function(res){ return res.departure === businessDate && res.status === 'checked_in'; }).length;
            var inhouse = reservations.filter(function(res){ return res.status === 'checked_in'; }).length;
            var adr = 0;
            var revenueToday = 0;
            var occupiedReservations = reservations.filter(function(res){ return res.status === 'checked_in'; });
            if(occupiedReservations.length){
              var totalRate = occupiedReservations.reduce(function(sum, res){
                var room = rooms.find(function(roomItem){ return roomItem.id === res.roomId; });
                return sum + (room ? room.rate : 0);
              }, 0);
              adr = Math.round(totalRate / occupiedReservations.length);
              revenueToday = occupiedReservations.reduce(function(sum, res){ return sum + (res.balance || 0); }, 0);
            }
            var revPar = state.hotel && state.hotel.roomsTotal ? Math.round((adr * occupied) / state.hotel.roomsTotal) : 0;
            var counts = {
              total: reservations.length,
              individual: reservations.filter(function(res){ return res.type === 'individual'; }).length,
              group: reservations.filter(function(res){ return res.type === 'group'; }).length,
              pending: reservations.filter(function(res){ return res.status === 'pending'; }).length,
              booked: reservations.filter(function(res){ return res.status === 'booked'; }).length,
              checkedIn: inhouse,
              checkedOut: reservations.filter(function(res){ return res.status === 'checked_out'; }).length
            };
            commit(ctx, function(next){
              next.data.runtime.metrics.frontOffice = {
                occupancy: occupancy,
                occupied: occupied,
                available: available,
                arrivals: arrivals,
                departures: departures,
                inhouse: inhouse,
                adr: adr,
                revPar: revPar,
                revenueToday: revenueToday
              };
              next.data.runtime.metrics.reservations = counts;
            });

            var enhancedReservations = reservations.map(function(res){ return enhanceReservation(ctx.getState(), res); });
            var filters = state.data.view.filters.reservations || {};
            var filteredReservations = enhancedReservations.filter(function(res){
              if(filters.status && filters.status !== 'all' && res.status !== filters.status) return false;
              if(filters.type && filters.type !== 'all' && res.type !== filters.type) return false;
              if(filters.search){
                var search = filters.search.toLowerCase();
                if(String(res.id).toLowerCase().indexOf(search) === -1 && String(res.guestLabel || '').toLowerCase().indexOf(search) === -1){
                  return false;
                }
              }
              return true;
            });

            var arrivalsList = enhancedReservations.filter(function(res){ return res.arrival === businessDate && (res.status === 'booked' || res.status === 'pending'); });
            var departuresList = enhancedReservations.filter(function(res){ return res.departure === businessDate && res.status === 'checked_in'; });

            var profileFilter = state.data.view.filters.profiles || {};
            var profileList = (runtime.guests || []).filter(function(guest){
              if(profileFilter.tier && profileFilter.tier !== 'all' && guest.profile.loyaltyTier !== profileFilter.tier) return false;
              if(profileFilter.search){
                var search = profileFilter.search.toLowerCase();
                var name = guest.profile.name[state.env.lang || 'ar'].toLowerCase();
                var email = String(guest.profile.contact.email || '').toLowerCase();
                if(name.indexOf(search) === -1 && email.indexOf(search) === -1) return false;
              }
              return true;
            });

            var folioFilter = state.data.view.filters.folio || {};
            var folioList = (runtime.folios || []).filter(function(folio){
              if(folioFilter.status && folioFilter.status !== 'all' && folio.status !== folioFilter.status) return false;
              return true;
            }).map(function(folio){
              var reservation = reservations.find(function(res){ return res.id === folio.reservationId; });
              var guest = reservation ? runtime.guests.find(function(item){ return item.id === reservation.guestId; }) : null;
              var guestLabel = guest ? guest.profile.name[state.env.lang || 'ar'] : folio.guestId;
              var totalCharges = (folio.charges || []).reduce(function(sum, charge){ return sum + (charge.amount || 0); }, 0);
              var totalPayments = (folio.payments || []).reduce(function(sum, payment){ return sum + (payment.amount || 0); }, 0);
              var balance = totalCharges - totalPayments;
              return Object.assign({}, folio, {
                guestLabel: guestLabel,
                totalChargesLabel: (state.env.lang === 'ar' ? 'الرسوم: ' : 'Charges: ') + totalCharges.toLocaleString(),
                balanceLabel: (state.env.lang === 'ar' ? 'الرصيد: ' : 'Balance: ') + balance.toLocaleString()
              });
            });

            var rackView = buildRackView(state);

            commit(ctx, function(next){
              next.data.runtime.views = next.data.runtime.views || {};
              next.data.runtime.views.reservations = filteredReservations;
              next.data.runtime.views.arrivals = arrivalsList;
              next.data.runtime.views.departures = departuresList;
              next.data.runtime.views.profiles = profileList;
              next.data.runtime.views.folios = folioList;
              next.data.runtime.views.rack = rackView;
            });
          }

          function setTheme(theme, ctx){
            commit(ctx, function(next){
              next.env.theme = theme;
            }, function(state){
              applyEnvironment(state);
              persistEnvironment(state);
            });
          }

          function setLanguage(lang, ctx){
            commit(ctx, function(next){
              next.env.lang = lang;
              next.env.dir = lang === 'ar' ? 'rtl' : 'ltr';
            }, function(state){
              applyEnvironment(state);
              persistEnvironment(state);
              computeMetrics(ctx);
            });
          }

          function forceSync(ctx){
            return openDB().then(function(db){
              return loadAllData(db).then(function(data){
                commit(ctx, function(next){
                  next.data.runtime.rooms = data.rooms;
                  next.data.runtime.guests = data.guests;
                  next.data.runtime.reservations = data.reservations;
                  next.data.runtime.folios = data.folios;
                  next.data.runtime.nightAudits = data.nightAudits;
                  next.data.runtime.tasks = data.tasks;
                  next.data.runtime.initialized = true;
                }, function(){
                  computeMetrics(ctx);
                  syncFormFields(ctx);
                  var latest = ctx.getState();
                  addAlert(ctx, 'info', latest.env.lang === 'ar' ? 'تمت المزامنة من القاعدة.' : 'Sync completed.');
                });
              });
            });
          }

          function switchModule(moduleId, ctx){
            commit(ctx, function(next){
              next.data.view.activeModule = moduleId;
            });
          }

          function toggleReservationForm(ctx){
            commit(ctx, function(next){
              next.data.view.showReservationForm = !next.data.view.showReservationForm;
              if(!next.data.view.showReservationForm){ resetReservationForm(next); }
            }, function(){
              syncFormFields(ctx);
            });
          }

          function resetReservationForm(state){
            if(!state || !state.data || !state.data.forms) return;
            var base = state.data.forms.reservation;
            base.type = 'individual';
            base.guestId = '';
            base.groupName = '';
            base.roomType = 'single';
            base.roomId = '';
            base.roomIds = [];
            base.arrival = state.data.runtime.businessDate;
            base.departure = state.data.runtime.businessDate;
            base.adults = 1;
            base.children = 0;
            base.source = 'direct';
            base.guarantee = 'credit_card';
            base.notes = '';
          }

          function updateReservationForm(field, value, ctx){
            commit(ctx, function(next){
              next.data.forms = next.data.forms || {};
              var form = next.data.forms.reservation;
              if(field === 'adults' || field === 'children'){ value = Number(value || 0); }
              form[field] = value;
              if(field === 'type' && value === 'individual'){
                form.roomIds = [];
              }
            });
          }

          function toggleGroupRoom(roomId, checked, ctx){
            commit(ctx, function(next){
              var form = next.data.forms.reservation;
              var list = Array.isArray(form.roomIds) ? form.roomIds.slice() : [];
              if(checked && list.indexOf(roomId) === -1) list.push(roomId);
              if(!checked) list = list.filter(function(id){ return id !== roomId; });
              form.roomIds = list;
            });
          }

          function updateReservationFilter(field, value, ctx){
            commit(ctx, function(next){
              next.data.view.filters.reservations[field] = value;
            }, function(){ computeMetrics(ctx); });
          }

          function submitReservation(event, ctx){
            event.preventDefault();
            var state = ctx.getState();
            var form = state.data.forms.reservation;
            var newReservation = {
              id: 'RES-' + Date.now(),
              guestId: form.guestId,
              type: form.type,
              groupName: form.groupName,
              roomType: form.roomType,
              roomId: form.type === 'individual' ? form.roomId : null,
              rooms: form.type === 'group' ? form.roomIds.slice() : [],
              status: 'booked',
              source: form.source,
              adults: form.adults,
              children: form.children,
              arrival: form.arrival,
              departure: form.departure,
              createdAt: new Date().toISOString().slice(0,10),
              guarantee: form.guarantee,
              balance: 0
            };
            commit(ctx, function(next){
              next.data.runtime.reservations = [newReservation].concat(next.data.runtime.reservations || []);
            }, function(){
              toggleReservationForm(ctx);
              computeMetrics(ctx);
              persistCollections(ctx).then(function(){
                addAlert(ctx, 'success', ctx.getState().env.lang === 'ar' ? 'تم إنشاء الحجز.' : 'Reservation created.');
              });
            });
            return false;
          }

          function assignRoomFromList(reservationId, ctx){
            var state = ctx.getState();
            var reservation = (state.data.runtime.reservations || []).find(function(res){ return res.id === reservationId; });
            if(!reservation || reservation.type === 'group') return;
            var room = (state.data.runtime.rooms || []).find(function(room){ return room.type === reservation.roomType && room.status === 'available'; });
            if(!room) return;
            commit(ctx, function(next){
              next.data.runtime.reservations = next.data.runtime.reservations.map(function(res){
                if(res.id !== reservationId) return res;
                return Object.assign({}, res, { roomId: room.id, status: 'booked' });
              });
              next.data.runtime.rooms = next.data.runtime.rooms.map(function(r){
                if(r.id === room.id) return Object.assign({}, r, { status: 'reserved' });
                return r;
              });
            }, function(){
              computeMetrics(ctx);
              persistCollections(ctx);
            });
          }

          function performCheckIn(reservationId, ctx){
            commit(ctx, function(next){
              var rooms = next.data.runtime.rooms;
              next.data.runtime.reservations = next.data.runtime.reservations.map(function(res){
                if(res.id !== reservationId) return res;
                if(res.type === 'group'){
                  (res.rooms || []).forEach(function(roomId){
                    rooms = rooms.map(function(room){
                      if(room.id === roomId) return Object.assign({}, room, { status: 'occupied' });
                      return room;
                    });
                  });
                } else if(res.roomId){
                  rooms = rooms.map(function(room){
                    if(room.id === res.roomId) return Object.assign({}, room, { status: 'occupied' });
                    return room;
                  });
                }
                return Object.assign({}, res, { status: 'checked_in' });
              });
              next.data.runtime.rooms = rooms;
            }, function(){
              computeMetrics(ctx);
              persistCollections(ctx);
            });
          }

          function performCheckOut(reservationId, ctx){
            commit(ctx, function(next){
              var rooms = next.data.runtime.rooms;
              next.data.runtime.reservations = next.data.runtime.reservations.map(function(res){
                if(res.id !== reservationId) return res;
                if(res.type === 'group'){
                  (res.rooms || []).forEach(function(roomId){
                    rooms = rooms.map(function(room){
                      if(room.id === roomId) return Object.assign({}, room, { status: 'dirty' });
                      return room;
                    });
                  });
                } else if(res.roomId){
                  rooms = rooms.map(function(room){
                    if(room.id === res.roomId) return Object.assign({}, room, { status: 'dirty' });
                    return room;
                  });
                }
                return Object.assign({}, res, { status: 'checked_out' });
              });
              next.data.runtime.rooms = rooms;
            }, function(){
              computeMetrics(ctx);
              persistCollections(ctx);
            });
          }

          function updateProfileFilter(field, value, ctx){
            commit(ctx, function(next){
              next.data.view.filters.profiles[field] = value;
            }, function(){ computeMetrics(ctx); });
          }

          function loadGuestForm(guestId, ctx){
            var state = ctx.getState();
            var guest = (state.data.runtime.guests || []).find(function(item){ return item.id === guestId; });
            if(!guest) return;
            commit(ctx, function(next){
              next.data.forms.guest.id = guestId;
              next.data.forms.guest.notes = guest.preferences.notes || '';
              next.data.forms.guest.amenities = guest.preferences.amenities || [];
            });
          }

          function updateGuestForm(field, value, ctx){
            commit(ctx, function(next){
              next.data.forms.guest[field] = value;
            });
          }

          function updateGuestAmenities(value, ctx){
            commit(ctx, function(next){
              var list = value.split(',').map(function(item){ return item.trim(); }).filter(Boolean);
              next.data.forms.guest.amenities = list;
            });
          }

          function submitGuestProfile(event, ctx){
            event.preventDefault();
            var state = ctx.getState();
            var form = state.data.forms.guest;
            if(!form.id) return false;
            commit(ctx, function(next){
              next.data.runtime.guests = next.data.runtime.guests.map(function(guest){
                if(guest.id !== form.id) return guest;
                var prefs = Object.assign({}, guest.preferences, { notes: form.notes, amenities: form.amenities.slice() });
                return Object.assign({}, guest, { preferences: prefs });
              });
            }, function(){
              persistCollections(ctx);
              addAlert(ctx, 'success', ctx.getState().env.lang === 'ar' ? 'تم تحديث ملف النزيل.' : 'Guest profile updated.');
            });
            return false;
          }

          function updateRackFilter(value, ctx){
            commit(ctx, function(next){
              next.data.view.filters.rack.status = value;
            }, function(){ computeMetrics(ctx); });
          }

          function updateFolioFilter(value, ctx){
            commit(ctx, function(next){
              next.data.view.filters.folio.status = value;
            }, function(){ computeMetrics(ctx); });
          }

          function loadFolioForms(folioId, ctx){
            commit(ctx, function(next){
              next.data.forms.folioCharge.reservationId = folioId;
              next.data.forms.folioPayment.reservationId = folioId;
            });
          }

          function updateFolioCharge(field, value, ctx){
            commit(ctx, function(next){
              if(field === 'amount') value = Number(value || 0);
              next.data.forms.folioCharge[field] = value;
            });
          }

          function updateFolioPayment(field, value, ctx){
            commit(ctx, function(next){
              if(field === 'amount') value = Number(value || 0);
              next.data.forms.folioPayment[field] = value;
            });
          }

          function submitFolioCharge(event, ctx){
            event.preventDefault();
            var state = ctx.getState();
            var form = state.data.forms.folioCharge;
            if(!form.reservationId) return false;
            commit(ctx, function(next){
              next.data.runtime.folios = next.data.runtime.folios.map(function(folio){
                if(folio.id !== form.reservationId) return folio;
                var charges = Array.isArray(folio.charges) ? folio.charges.slice() : [];
                charges.push({ id: 'CH-' + Date.now(), description: form.description, amount: Number(form.amount || 0), date: form.date });
                return Object.assign({}, folio, { charges: charges });
              });
            }, function(){
              computeMetrics(ctx);
              persistCollections(ctx);
            });
            return false;
          }

          function submitFolioPayment(event, ctx){
            event.preventDefault();
            var state = ctx.getState();
            var form = state.data.forms.folioPayment;
            if(!form.reservationId) return false;
            commit(ctx, function(next){
              next.data.runtime.folios = next.data.runtime.folios.map(function(folio){
                if(folio.id !== form.reservationId) return folio;
                var payments = Array.isArray(folio.payments) ? folio.payments.slice() : [];
                payments.push({ id: 'PM-' + Date.now(), description: form.description, amount: Number(form.amount || 0), date: form.date });
                return Object.assign({}, folio, { payments: payments });
              });
            }, function(){
              computeMetrics(ctx);
              persistCollections(ctx);
            });
            return false;
          }

          function closeSelectedFolio(ctx){
            var state = ctx.getState();
            var folioId = state.data.forms.folioCharge.reservationId || state.data.forms.folioPayment.reservationId;
            if(!folioId) return;
            commit(ctx, function(next){
              next.data.runtime.folios = next.data.runtime.folios.map(function(folio){
                if(folio.id !== folioId) return folio;
                return Object.assign({}, folio, { status: 'closed' });
              });
            }, function(){
              computeMetrics(ctx);
              persistCollections(ctx);
            });
          }

          function runNightAudit(ctx){
            commit(ctx, function(next){
              if(next.data.view.nightAudit.inProgress) return;
              next.data.view.nightAudit.inProgress = true;
            }, function(){
              var state = ctx.getState();
              var businessDate = state.data.runtime.businessDate;
              var metrics = state.data.runtime.metrics.frontOffice || {};
              var audit = {
                id: 'NA-' + businessDate.replace(/-/g, ''),
                businessDate: businessDate,
                status: 'posted',
                roomsSold: metrics.occupied || 0,
                occupancy: (metrics.occupancy || 0) / 100,
                adr: metrics.adr || 0,
                revPar: metrics.revPar || 0,
                notes: state.env.lang === 'ar' ? 'تم الإغلاق الآلي لليوم.' : 'Day closed automatically.'
              };
              commit(ctx, function(next){
                var existing = (next.data.runtime.nightAudits || []).filter(function(item){ return item.id !== audit.id; });
                existing.unshift(audit);
                next.data.runtime.nightAudits = existing;
                next.data.view.nightAudit.lastRun = new Date().toLocaleString();
                next.data.view.nightAudit.inProgress = false;
              }, function(){
                persistCollections(ctx);
                addAlert(ctx, 'success', ctx.getState().env.lang === 'ar' ? 'تم تسجيل التدقيق الليلي.' : 'Night audit posted.');
              });
            });
          }

          function updateTaskStatus(taskId, status, ctx){
            commit(ctx, function(next){
              next.data.runtime.tasks = (next.data.runtime.tasks || []).map(function(task){
                if(task.id !== taskId) return task;
                return Object.assign({}, task, { status: status });
              });
            }, function(){
              persistCollections(ctx);
            });
          }

          function initialise(ctx){
            ensureAlerts(ctx.getState());
            openDB().then(function(db){
              seedDatabase(ctx, db).then(function(){
                return loadAllData(db);
              }).then(function(data){
                commit(ctx, function(next){
                  next.data.runtime.rooms = data.rooms;
                  next.data.runtime.guests = data.guests;
                  next.data.runtime.reservations = data.reservations;
                  next.data.runtime.folios = data.folios;
                  next.data.runtime.nightAudits = data.nightAudits;
                  next.data.runtime.tasks = data.tasks;
                  next.data.runtime.alerts = next.data.runtime.alerts || [];
                  next.data.runtime.initialized = true;
                  next.data.view.showReservationForm = false;
                }, function(){
                  computeMetrics(ctx);
                  syncFormFields(ctx);
                });
              }).then(function(){ loadEnvironment(ctx); }).catch(function(err){ console.error('init error', err); });
            }).catch(function(err){ console.error('DB open error', err); });
          }

          window.navBadge = navBadge;
          window.statusTag = statusTag;
          window.availableRooms = availableRooms;
          window.setTheme = setTheme;
          window.setLanguage = setLanguage;
          window.forceSync = forceSync;
          window.switchModule = switchModule;
          window.toggleReservationForm = toggleReservationForm;
          window.updateReservationForm = updateReservationForm;
          window.toggleGroupRoom = toggleGroupRoom;
          window.updateReservationFilter = updateReservationFilter;
          window.submitReservation = submitReservation;
          window.assignRoomFromList = assignRoomFromList;
          window.performCheckIn = performCheckIn;
          window.performCheckOut = performCheckOut;
          window.updateTaskStatus = updateTaskStatus;
          window.updateProfileFilter = updateProfileFilter;
          window.loadGuestForm = loadGuestForm;
          window.submitGuestProfile = submitGuestProfile;
          window.updateGuestForm = updateGuestForm;
          window.updateGuestAmenities = updateGuestAmenities;
          window.updateRackFilter = updateRackFilter;
          window.updateFolioFilter = updateFolioFilter;
          window.loadFolioForms = loadFolioForms;
          window.updateFolioCharge = updateFolioCharge;
          window.submitFolioCharge = submitFolioCharge;
          window.updateFolioPayment = updateFolioPayment;
          window.submitFolioPayment = submitFolioPayment;
          window.closeSelectedFolio = closeSelectedFolio;
          window.runNightAudit = runNightAudit;

          window.__bootstrap__ = function(database){
            ensureAlerts(database);
          };

          window.__init__ = function(ctx){
            applyEnvironment(ctx.getState());
            syncFormFields(ctx);
            initialise(ctx);
          };
        })();
      </script>

    </template>

    <script src="./mishkah-utils.js"></script>
    <script src="./mishkah.core.js"></script>
    <script src="./mishkah-ui.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/acorn@8.15.0/dist/acorn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/acorn-walk@8.3.4/dist/walk.min.js"></script>
    <script>
      window.acornWalk = window.acornWalk || (window.acorn && window.acorn.walk);
    </script>
    <script src="./mishkah-htmlx.js"></script>

    <script>
      (function(window){
        'use strict';
        var M = window.Mishkah;
        if(!M || !M.HTMLxAgent){ console.error('Mishkah HTMLx agent is required.'); return; }
        var start = M.HTMLxAgent.make();
        Promise.resolve(start).catch(function(err){ console.error('Failed to start G-remal PMS:', err); });
      })(window);
    </script>
  </body>
</html>
