<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>مشكاة — تجربة HTMLx (v3)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet" />
    <style>
      :root {
        color-scheme: light dark;
        --page-gradient: linear-gradient(160deg, #f8f9ff 0%, #e8ecff 100%);
        --page-overlay-1: radial-gradient(circle at 20% 25%, rgba(79, 70, 229, 0.18), transparent 55%);
        --page-overlay-2: radial-gradient(circle at 80% 70%, rgba(14, 165, 233, 0.18), transparent 50%);
        --panel-glass: rgba(255, 255, 255, 0.78);
        --panel-border: rgba(99, 102, 241, 0.12);
        --panel-shadow: 0 25px 50px -20px rgba(15, 23, 42, 0.18);
        --surface-1: rgba(255, 255, 255, 0.72);
        --surface-2: rgba(241, 245, 249, 0.82);
        --border: rgba(99, 102, 241, 0.18);
        --foreground: #111827;
        --muted-foreground: rgba(55, 65, 81, 0.72);
        --primary: #4f46e5;
        --primary-foreground: #f9fafb;
        --accent-ring: rgba(79, 70, 229, 0.18);
        --tile-bg: linear-gradient(160deg, rgba(255, 255, 255, 0.95), rgba(241, 245, 249, 0.85));
        --tile-bg-revealed: linear-gradient(160deg, rgba(129, 140, 248, 0.75), rgba(79, 70, 229, 0.65));
        --tile-border: rgba(99, 102, 241, 0.25);
        --letters-shadow: 0 18px 45px -24px rgba(15, 23, 42, 0.35);
        --letters-hover: 0 25px 50px -20px rgba(99, 102, 241, 0.45);
        --font-body: 'Cairo', 'Tajawal', system-ui;
      }
      :root.dark {
        --page-gradient: linear-gradient(160deg, #0d1224 0%, #111c3d 100%);
        --page-overlay-1: radial-gradient(circle at 80% 30%, rgba(168, 85, 247, 0.22), transparent 55%);
        --page-overlay-2: radial-gradient(circle at 15% 80%, rgba(56, 189, 248, 0.18), transparent 55%);
        --panel-glass: rgba(17, 25, 40, 0.75);
        --panel-border: rgba(148, 163, 184, 0.32);
        --panel-shadow: 0 25px 50px -18px rgba(15, 23, 42, 0.55);
        --surface-1: rgba(17, 25, 40, 0.76);
        --surface-2: rgba(30, 41, 59, 0.78);
        --border: rgba(148, 163, 184, 0.35);
        --foreground: #f8fafc;
        --muted-foreground: rgba(203, 213, 225, 0.75);
        --primary: #818cf8;
        --primary-foreground: #0f172a;
        --accent-ring: rgba(129, 140, 248, 0.35);
        --tile-bg: linear-gradient(160deg, rgba(30, 41, 59, 0.78), rgba(15, 23, 42, 0.92));
        --tile-bg-revealed: linear-gradient(160deg, rgba(99, 102, 241, 0.55), rgba(79, 70, 229, 0.38));
        --tile-border: rgba(148, 163, 184, 0.35);
        --letters-shadow: 0 20px 40px -18px rgba(148, 163, 184, 0.35);
        --letters-hover: 0 28px 60px -20px rgba(99, 102, 241, 0.6);
      }
      *,*::before,*::after{box-sizing:border-box}
      body{margin:0;min-height:100vh;font-family:var(--font-body);background:var(--page-gradient);color:var(--foreground)}
      .page-shell{position:relative;min-height:100vh;padding:2rem 1.5rem 3.5rem}
      .page-shell::before,.page-shell::after{content:"";position:fixed;inset:0;pointer-events:none;z-index:-1}
      .page-shell::before{background:var(--page-overlay-1)}
      .page-shell::after{background:var(--page-overlay-2)}
      .app-card{background:var(--panel-glass);backdrop-filter:blur(22px);border:1px solid var(--panel-border);border-radius:2rem;box-shadow:var(--panel-shadow);overflow:hidden}
      header.header{margin:0 auto 2rem;max-width:1500px}
      header.header .header-inner{display:flex;flex-wrap:wrap;gap:1.5rem;align-items:center;padding:1.5rem}
      header.header .header-text{display:grid;gap:.4rem;flex:1 1 320px;min-width:220px}
      header.header h1{margin:0;font-size:clamp(1.8rem,2.8vw,2.6rem)}
      header.header p{margin:0;font-size:.95rem;color:var(--muted-foreground)}
      .header-actions{margin-inline-start:auto;display:flex;flex-wrap:wrap;gap:.75rem;align-items:center;justify-content:flex-end}
      .header-badge{display:inline-flex;align-items:center;gap:.5rem;padding:.45rem 1rem;border-radius:999px;border:1px solid var(--border);background:var(--surface-1);color:var(--muted-foreground);font-weight:600}
      .status-strip{display:flex;flex-wrap:wrap;gap:1.25rem;padding:.75rem 1.25rem;border-radius:999px;border:1px solid var(--border);background:var(--surface-1);box-shadow:0 18px 40px -28px rgba(79,70,229,.45)}
      .status-block{display:inline-flex;align-items:center;gap:.6rem;font-size:.95rem}
      .status-block strong{font-size:1.05rem}
      .hearts-row{display:inline-flex;gap:.4rem;font-size:1.1rem}
      .controls{margin-inline-start:auto;display:flex;flex-wrap:wrap;gap:.75rem;align-items:center}
      .segmented{display:inline-flex;align-items:center;background:var(--surface-1);border:1px solid var(--border);border-radius:999px;padding:.25rem;gap:.25rem}
      .segmented button{border:none;background:transparent;color:var(--muted-foreground);padding:.45rem 1.15rem;border-radius:999px;font-weight:600;cursor:pointer;transition:color .2s ease, background .2s ease}
      .segmented button.active{background:var(--primary);color:var(--primary-foreground);box-shadow:0 18px 38px -22px rgba(79,70,229,.55)}
      .layout{display:flex;flex-direction:column;gap:1.5rem;margin:0 auto;max-width:1500px}
      @media (min-width:1024px){.layout{flex-direction:row}}
      aside.sidebar{flex:0 0 280px}
      .sidebar-card{position:sticky;top:1.5rem;padding:1.5rem;display:flex;flex-direction:column;gap:1rem}
      .sidebar-card h2{margin:0;font-size:1rem;letter-spacing:.35em;text-transform:uppercase;color:var(--muted-foreground)}
      .nav-list{display:flex;flex-direction:column;gap:.65rem}
      .nav-button{width:100%;border:1px solid transparent;border-radius:1.1rem;background:transparent;padding:.85rem 1rem;text-align:start;font-weight:600;font-size:1rem;color:var(--muted-foreground);cursor:pointer;transition:border .25s ease, background .25s ease, color .25s ease}
      .nav-button .hint{display:block;margin-top:.35rem;font-size:.82rem;color:var(--muted-foreground);font-weight:400}
      .nav-button.active{border-color:var(--primary);background:color-mix(in oklab, var(--primary) 16%, transparent);color:var(--foreground)}
      .main-column{flex:1 1 auto;min-width:0;display:flex;flex-direction:column;gap:1.5rem}
      .panel{padding:2rem;border-radius:2rem;background:var(--panel-glass);border:1px solid var(--panel-border);box-shadow:var(--panel-shadow);backdrop-filter:blur(18px)}
      .panel header{margin-bottom:1.5rem}
      .panel header h2{margin:0;font-size:1.4rem}
      .panel header p{margin:.4rem 0 0;color:var(--muted-foreground);font-size:.95rem}
      .md-prose{line-height:1.7;display:grid;gap:1.1rem;color:var(--foreground)}
      .md-prose h2,.md-prose h3,.md-prose h4{margin:0}
      .md-prose h2{font-size:1.4rem}
      .md-prose h3{font-size:1.2rem}
      .md-prose ul{margin:0;padding-inline-start:1.4rem;display:grid;gap:.35rem}
      .md-prose blockquote{margin:0;padding:1rem 1.25rem;border-inline-start:4px solid var(--primary);background:color-mix(in oklab, var(--primary) 12%, transparent);border-radius:1rem}
      .counter-view{display:flex;align-items:center;justify-content:center;gap:1.25rem}
      .counter-display{font-size:2.2rem;font-weight:700}
      .button{border:none;background:var(--primary);color:var(--primary-foreground);font-weight:600;padding:.65rem 1.5rem;border-radius:999px;cursor:pointer;transition:transform .15s ease, box-shadow .2s ease}
      .button:hover{transform:translateY(-1px);box-shadow:0 16px 40px -22px rgba(79,70,229,.6)}
      .button.secondary{background:transparent;color:var(--foreground);border:1px solid var(--border)}
      .logic-sequence{display:flex;flex-wrap:wrap;justify-content:center;gap:.75rem}
      .logic-sequence .term,.logic-options button{width:4rem;height:4rem;display:grid;place-items:center;border-radius:1.4rem;border:1px solid var(--panel-border);background:var(--surface-1);font-weight:600;font-size:1.1rem;box-shadow:var(--panel-shadow)}
      .logic-options{display:grid;gap:.75rem;grid-template-columns:repeat(auto-fit,minmax(100px,1fr))}
      .logic-options button{cursor:pointer;border:none;transition:transform .15s ease}
      .logic-options button:hover{transform:translateY(-2px)}
      .logic-options button.correct{border-color:rgba(34,197,94,.45);background:rgba(34,197,94,.2)}
      .logic-options button.wrong{border-color:rgba(239,68,68,.45);background:rgba(239,68,68,.2)}
      .ajax-layout{display:grid;gap:1.5rem}
      @media (min-width:1024px){.ajax-layout{grid-template-columns:minmax(0,2fr) minmax(0,1fr)}}
      .ajax-card{background:var(--surface-2);border:1px solid var(--panel-border);border-radius:1.5rem;padding:1.5rem;display:grid;gap:1.25rem;box-shadow:var(--panel-shadow)}
      .ajax-card h3{margin:0;font-size:1.1rem}
      .ajax-status{display:flex;gap:1rem;align-items:flex-start}
      .ajax-state{display:inline-flex;align-items:center;justify-content:center;width:2.75rem;height:2.75rem;border-radius:999px;background:var(--surface-1);box-shadow:var(--panel-shadow);font-size:1.35rem}
      .ajax-steps ol{margin:0;padding-inline-start:1.5rem;display:grid;gap:.75rem}
      .ajax-steps li{background:var(--surface-1);border:1px solid var(--panel-border);border-radius:1rem;padding:1rem;box-shadow:var(--panel-shadow)}
      .ajax-steps li strong{display:block;margin-bottom:.35rem}
      .ajax-resources ul{margin:0;padding:0;list-style:none;display:grid;gap:.6rem}
      .ajax-resources a{text-decoration:none;font-weight:600;color:var(--primary)}
      .ajax-resources a:hover{text-decoration:underline}
      .ajax-digest-list{display:grid;gap:.75rem}
      .ajax-digest-item{padding:1rem;border-radius:1rem;background:var(--surface-1);border:1px solid var(--panel-border);display:flex;justify-content:space-between;align-items:center;gap:.75rem}
      .ajax-digest-badge{display:inline-flex;align-items:center;justify-content:center;padding:.25rem .85rem;border-radius:999px;background:color-mix(in oklab, var(--primary) 22%, transparent);font-size:.8rem;font-weight:600}
      .ajax-empty{margin:0;color:var(--muted-foreground)}
      .ajax-sync{margin:0;color:var(--muted-foreground);font-size:.9rem}
      .live-rates{display:grid;gap:1.25rem}
      .live-rates-header{display:flex;flex-wrap:wrap;gap:1.25rem;align-items:flex-start;justify-content:space-between}
      .live-rates-meta{display:flex;gap:1rem;align-items:center}
      .live-rates-state{display:inline-flex;align-items:center;justify-content:center;width:3rem;height:3rem;border-radius:1.1rem;background:var(--surface-1);box-shadow:var(--panel-shadow);font-size:1.45rem}
      .live-rates-updated{margin:.15rem 0 0;font-size:.9rem;color:var(--muted-foreground)}
      .live-rates-actions{display:flex;flex-wrap:wrap;gap:.75rem;align-items:center;justify-content:flex-end}
      .live-rates-base{display:grid;gap:.25rem;font-size:.9rem;color:var(--muted-foreground)}
      .live-rates-base select{border-radius:.9rem;border:1px solid var(--panel-border);background:var(--surface-1);padding:.45rem .85rem;font-size:1rem;color:var(--foreground)}
      .live-rates-grid{display:grid;border:1px solid var(--panel-border);border-radius:1.25rem;overflow:hidden;background:var(--surface-1);box-shadow:var(--panel-shadow)}
      .live-rates-head,.live-rates-row{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:.5rem;padding:.75rem 1rem;align-items:center}
      .live-rates-head{font-weight:700;background:color-mix(in oklab, var(--primary) 12%, transparent)}
      .live-rates-row:nth-child(even){background:color-mix(in oklab, var(--primary) 6%, transparent)}
      .live-rates-row span:last-child{text-align:end;font-variant-numeric:tabular-nums}
      .live-rates-empty,.live-rates-source{margin:0;font-size:.95rem;color:var(--muted-foreground)}
      .live-rates-error{margin:0;border:1px solid rgba(239,68,68,.35);background:rgba(239,68,68,.12);padding:1rem 1.25rem;border-radius:1rem;color:#b91c1c;display:grid;gap:.35rem}
      .live-rates-error strong{font-size:1rem;color:#dc2626}
      .button[disabled]{opacity:.6;cursor:not-allowed;transform:none;box-shadow:none}
      .game-board{display:grid;gap:1.5rem}
      .puzzle-row{display:flex;flex-wrap:wrap;justify-content:center;gap:.75rem}
      .puzzle-tile{width:var(--tile-size,3rem);height:var(--tile-size,3rem);border-radius:1.4rem;display:grid;place-items:center;background:var(--tile-bg);border:1px solid var(--tile-border);font-weight:600;font-size:1.2rem;box-shadow:0 18px 38px -28px rgba(15,23,42,.45)}
      .puzzle-tile.revealed{background:var(--tile-bg-revealed);color:#fff}
      .puzzle-tile.space{width:2rem;border:none;background:transparent;box-shadow:none}
      .letters-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(46px,1fr));gap:.55rem}
      .letters-grid button{border:none;border-radius:.95rem;padding:.5rem 0;font-weight:600;background:var(--surface-1);cursor:pointer;box-shadow:var(--panel-shadow);transition:transform .15s ease, box-shadow .2s ease}
      .letters-grid button:hover{transform:translateY(-1px);box-shadow:var(--letters-hover)}
      .letters-grid button.used{opacity:.45;box-shadow:none;cursor:default}
      .game-status-strip{display:flex;flex-direction:column;gap:1rem;margin-bottom:1.5rem}
      @media (min-width:768px){.game-status-strip{flex-direction:row;align-items:center}}
      .game-status-strip .status-strip{flex:1 1 auto;min-width:240px}
      .game-status-actions{display:flex;flex-wrap:wrap;gap:.75rem}
      @media (min-width:768px){.game-status-actions{margin-inline-start:auto}}
      .game-controls{display:grid;gap:1rem}
      .game-controls .control-row{display:flex;flex-wrap:wrap;gap:.75rem;align-items:center}
      .toggle{display:inline-flex;align-items:center;gap:.5rem;padding:.4rem .85rem;border-radius:999px;border:1px solid var(--border);background:var(--surface-1)}
      .game-feedback{display:grid;gap:1rem}
      .game-feedback .card{border-radius:1.5rem;border:1px solid var(--panel-border);background:var(--surface-2);padding:1.25rem;box-shadow:var(--panel-shadow)}
      .game-feedback .card strong{font-size:1rem}
      .settings-modal{position:fixed;inset:0;background:rgba(15,23,42,.45);backdrop-filter:blur(12px);display:grid;place-items:center;padding:2rem;z-index:40}
      .settings-body{width:min(420px,100%);background:var(--panel-glass);border-radius:1.6rem;padding:1.75rem;display:grid;gap:1.25rem;border:1px solid var(--panel-border);box-shadow:var(--panel-shadow)}
      .settings-body h3{margin:0;font-size:1.25rem}
      .settings-grid{display:grid;gap:1rem}
      .settings-grid label{display:grid;gap:.4rem;font-size:.95rem}
      .settings-grid input[type="range"],.settings-grid select{width:100%}
      .settings-actions{display:flex;justify-content:space-between;gap:.75rem}
      select,input,button{font-family:inherit}
    </style>
  </head>
  <body>
    <div id="app"></div>

    <template id="mishkah-index">
      <script type="application/json" data-m-env>
        {
          "theme": "dark",
          "lang": "ar",
          "dir": "rtl",
          "flags": {
            "htmlxExperiment": true
          }
        }
      </script>

      <script type="application/json" data-m-ajax-map>
        {
          "docs.ajaxBase": {
            "url": "./docs/htmlx-ajax-demo.json",
            "responseType": "json",
            "mode": "merge"
          }
        }
      </script>

      <script type="application/json" data-m-data data-m-path="head">
        {
          "title": "مشكاة — تجربة HTMLx"
        }
      </script>

      <script type="application/json" data-m-data data-m-path="i18n.strings">
        {
          "app.title": { "ar": "مشكاة — تجربة HTMLx", "en": "Mishkah — HTMLx Experience" },
          "header.subtitle": { "ar": "نموذج مبسط يعرض التبويبات، العدادات، وتحديات Mishkah دون لغة DSL.", "en": "A lightweight showcase of tabs, counters, and Mishkah challenges without the legacy DSL." },
          "header.theme.light": { "ar": "نهاري", "en": "Light" },
          "header.theme.dark": { "ar": "ليلي", "en": "Dark" },
          "header.lang.ar": { "ar": "العربية", "en": "Arabic" },
          "header.lang.en": { "ar": "الإنجليزية", "en": "English" },
          "settings.open": { "ar": "التخصيص", "en": "Customize" }
        }
      </script>

      <div class="page-shell">
        <div class="app-card">
          <header class="header">
            <div class="header-inner">
              <div class="header-text">
                <h1>{trans('app.title')}</h1>
                <p>{trans('header.subtitle')}</p>
              </div>
              <div class="header-actions">
                <div class="header-badge" x-if="state.env.flags && state.env.flags.htmlxExperiment">
                  <span>🧪 HTMLx</span>
                  <span>{state.env.lang === 'ar' ? 'تجريبي' : 'Experimental'}</span>
                </div>
                <div class="segmented">
                  <button class="{state.env.theme === 'light' ? 'active' : ''}" onclick="setTheme('light', ctx)">{trans('header.theme.light')}</button>
                  <button class="{state.env.theme === 'dark' ? 'active' : ''}" onclick="setTheme('dark', ctx)">{trans('header.theme.dark')}</button>
                </div>
                <div class="segmented">
                  <button class="{state.env.lang === 'ar' ? 'active' : ''}" onclick="setLanguage('ar', ctx)">{trans('header.lang.ar')}</button>
                  <button class="{state.env.lang === 'en' ? 'active' : ''}" onclick="setLanguage('en', ctx)">{trans('header.lang.en')}</button>
                </div>
                <button class="button secondary" onclick="toggleSettings(ctx)">{trans('settings.open')}</button>
              </div>
            </div>
          </header>

          <script>
            function formatTimeLeft(game){ if(!game || !game.timerOn) return '—'; var value=typeof game.timeLeft==='number'? game.timeLeft: game.timerSec; return value>=0? value: '—'; }
            function switchTab(tab, ctx){ ctx.set('data.activeTab', tab); rememberState(ctx); if(tab==='liveRates' && typeof refreshLiveRates==='function' && ctx && typeof ctx.getState==='function'){ try { var state=ctx.getState(); var live=state && state.data && state.data.liveRates; if(!live || live.status==='idle' || live.status==='error'){ window.setTimeout(function(){ refreshLiveRates(ctx); }, 0); } } catch(_err){} } }
            function setTheme(theme, ctx){ commit(ctx, function(next){ next.env.theme=theme; }, function(state){ var env=runtime(); if(env.applyEnvironment) env.applyEnvironment(state); if(env.persistPrefs) env.persistPrefs(state); }); }
            function setLanguage(lang, ctx){ commit(ctx, function(next){ next.env.lang=lang; next.env.dir= lang==='ar'? 'rtl':'ltr'; }, function(state){ var env=runtime(); if(env.applyEnvironment) env.applyEnvironment(state); if(env.persistPrefs) env.persistPrefs(state); }); }
            function toggleSettings(ctx){ commit(ctx, function(next){ next.data.settingsOpen=!next.data.settingsOpen; }); }
          </script>

          <div class="layout">
            <aside class="sidebar">
              <div class="sidebar-card">
                <h2>{trans('nav.menu')}</h2>
                <script type="application/json" data-m-data data-m-path="i18n.strings">
                  {
                    "nav.menu": { "ar": "التصفّح", "en": "Navigation" },
                    "nav.readmeBase": { "ar": "الرحلة المعمارية", "en": "Architectural Journey" },
                    "nav.readmeTec": { "ar": "الدليل التقني", "en": "Technical Guide" },
                    "nav.counter": { "ar": "العداد التفاعلي", "en": "Interactive Counter" },
                    "nav.logic": { "ar": "تحدي المنطق", "en": "Logic Challenge" },
                    "nav.game": { "ar": "لعبة الأمثال", "en": "Proverbs Game" },
                    "nav.ajax": { "ar": "بيانات Ajax", "en": "Ajax Data" },
                    "nav.liveRates": { "ar": "أسعار مباشرة", "en": "Live rates" },
                    "doc.base.lead": { "ar": "قراءة روحية لمعماريات مشكاة ومحركها.", "en": "A reflective tour through Mishkah's architecture." },
                    "doc.tec.lead": { "ar": "الملف التقني الذي يشرح تفاصيل النظام.", "en": "The technical dossier explaining the system." },
                    "doc.language.hint": { "ar": "بدّل اللغة من الأعلى لعرض الوثيقة بالعربية أو الإنجليزية.", "en": "Use the header switcher to view the document in Arabic or English." },
                    "counter.lead": { "ar": "مثال يوضح استخدام أوامر HTMLx للتحديث.", "en": "An example that shows HTMLx driven updates." },
                    "logic.lead": { "ar": "حل متتاليات رقمية بأسلوب ممتع.", "en": "Solve number sequences in a playful way." },
                    "game.lead": { "ar": "لعبة تفاعلية للتعرّف على الأمثال.", "en": "An interactive game to rediscover proverbs." },
                    "ajax.lead": { "ar": "عرض لكيفية مزج data-m-ajax مع data-m-path بسهولة.", "en": "Showcases how data-m-ajax plugs into data-m-path effortlessly." },
                    "ajax.title": { "ar": "واجهات البيانات الحية", "en": "Live data interfaces" },
                    "ajax.subtitle": { "ar": "عرّف خريطة Ajax عامة ثم أوصلها بحقول البيانات داخل القالب.", "en": "Declare a global Ajax map and hook it into your data blocks." },
                    "ajax.summary.title": { "ar": "لماذا الخرائط المعلنة؟", "en": "Why declarative maps?" },
                    "ajax.steps.title": { "ar": "خطوات التشغيل", "en": "Execution steps" },
                    "ajax.resources.title": { "ar": "مراجع موثوقة", "en": "Helpful references" },
                    "ajax.digest.title": { "ar": "مصادر جاهزة للاستهلاك", "en": "Ready-made sources" },
                    "ajax.digest.syncedAt": { "ar": "آخر مزامنة:", "en": "Last sync:" },
                    "ajax.digest.empty": { "ar": "لم تصل بيانات بعد — جرّب الإعلان عن مصدر Ajax.", "en": "No entries yet—try wiring a declarative Ajax source." },
                    "liveRates.title": { "ar": "متابعة أسعار العملات", "en": "Live currency rates" },
                    "liveRates.lead": { "ar": "أسعار فورية من خدمة عالمية مجانية.", "en": "Live prices from a free global service." },
                    "liveRates.status.idle": { "ar": "جاهز للتحميل", "en": "Ready to load" },
                    "liveRates.status.loading": { "ar": "جارٍ جلب البيانات...", "en": "Fetching data..." },
                    "liveRates.status.ready": { "ar": "بيانات محدثة", "en": "Updated data" },
                    "liveRates.status.error": { "ar": "تعذر تحميل البيانات", "en": "Unable to load data" },
                    "liveRates.updatedLabel": { "ar": "آخر تحديث:", "en": "Last update:" },
                    "liveRates.updated.pending": { "ar": "بإنتظار التحديث", "en": "Awaiting refresh" },
                    "liveRates.refresh": { "ar": "تحديث الأسعار", "en": "Refresh rates" },
                    "liveRates.refreshing": { "ar": "جارٍ التحديث...", "en": "Refreshing..." },
                    "liveRates.base": { "ar": "العملة الأساسية", "en": "Base currency" },
                    "liveRates.column.currency": { "ar": "العملة", "en": "Currency" },
                    "liveRates.column.rate": { "ar": "السعر مقابل الأساس", "en": "Rate vs base" },
                    "liveRates.empty": { "ar": "لم يتم تحميل الأسعار بعد.", "en": "Rates have not loaded yet." },
                    "liveRates.source": { "ar": "المصدر:", "en": "Source:" },
                    "liveRates.errorTitle": { "ar": "تعذر جلب الأسعار", "en": "Could not fetch rates" },
                    "liveRates.errorFallback": { "ar": "تأكد من الاتصال بالإنترنت ثم أعد المحاولة.", "en": "Check the connection and try again." }
                  }
                </script>

                <script type="application/json" data-m-data data-m-path="data">
                  {
                    "activeTab": "readmeBase"
                  }
                </script>
                <div class="nav-list">
                  <button class="nav-button {state.data.activeTab === 'readmeBase' ? 'active' : ''}" onclick="switchTab('readmeBase', ctx)"><span>{trans('nav.readmeBase')}</span><span class="hint">{trans('doc.base.lead')}</span></button>
                  <button class="nav-button {state.data.activeTab === 'readmeTec' ? 'active' : ''}" onclick="switchTab('readmeTec', ctx)"><span>{trans('nav.readmeTec')}</span><span class="hint">{trans('doc.tec.lead')}</span></button>
                  <button class="nav-button {state.data.activeTab === 'counter' ? 'active' : ''}" onclick="switchTab('counter', ctx)"><span>{trans('nav.counter')}</span><span class="hint">{trans('counter.lead')}</span></button>
                  <button class="nav-button {state.data.activeTab === 'logic' ? 'active' : ''}" onclick="switchTab('logic', ctx)"><span>{trans('nav.logic')}</span><span class="hint">{trans('logic.lead')}</span></button>
                  <button class="nav-button {state.data.activeTab === 'ajax' ? 'active' : ''}" onclick="switchTab('ajax', ctx)"><span>{trans('nav.ajax')}</span><span class="hint">{trans('ajax.lead')}</span></button>
                  <button class="nav-button {state.data.activeTab === 'liveRates' ? 'active' : ''}" onclick="switchTab('liveRates', ctx)"><span>{trans('nav.liveRates')}</span><span class="hint">{trans('liveRates.lead')}</span></button>
                  <button class="nav-button {state.data.activeTab === 'game' ? 'active' : ''}" onclick="switchTab('game', ctx)"><span>{trans('nav.game')}</span><span class="hint">{trans('game.lead')}</span></button>
                </div>
              </div>
            </aside>

            <div class="main-column">
              <script type="application/json" data-m-data data-m-path="data.docs">
                {
                  "base": { "ar": "", "en": "" },
                  "tec": { "ar": "", "en": "" }
                }
              </script>

              <script type="application/json" data-m-data data-m-path="data.liveRates">
                {
                  "status": "idle",
                  "base": "USD",
                  "availableBases": ["USD", "EUR", "GBP", "SAR", "AED", "EGP"],
                  "currencies": ["EUR", "GBP", "SAR", "AED", "EGP"],
                  "rates": [],
                  "updatedAt": null,
                  "fetchedAt": null,
                  "error": null,
                  "source": null,
                  "lastErrorAt": null
                }
              </script>

              <section class="panel" x-if="state.data.activeTab === 'readmeBase'">
                <header><h2>{trans('nav.readmeBase')}</h2><p>{trans('doc.language.hint')}</p></header>
                <article class="md-prose" x-html="state.data.docs.base[state.env.lang]"></article>
              </section>

              <section class="panel" x-if="state.data.activeTab === 'readmeTec'">
                <header><h2>{trans('nav.readmeTec')}</h2><p>{trans('doc.language.hint')}</p></header>
                <article class="md-prose" x-html="state.data.docs.tec[state.env.lang]"></article>
              </section>

              <section class="panel" x-if="state.data.activeTab === 'counter'">
                <script type="application/json" data-m-data data-m-path="i18n.strings">
                  {
                    "counter.title": { "ar": "عداد بسيط", "en": "Simple Counter" },
                    "counter.reset": { "ar": "إعادة الضبط", "en": "Reset" }
                  }
                </script>

                <script type="application/json" data-m-data data-m-path="data">
                  {
                    "counter": 0
                  }
                </script>
                <header><h2>{trans('counter.title')}</h2><p>{trans('counter.lead')}</p></header>
                <div class="counter-view">
                  <button class="button secondary" onclick="updateCounter(-1, ctx)">−</button>
                  <div class="counter-display">{state.data.counter}</div>
                  <button class="button" onclick="updateCounter(+1, ctx)">+</button>
                  <button class="button secondary" onclick="resetCounter(ctx)" data-m-once>{trans('counter.reset')}</button>
                </div>
              </section>

              <script>
                function updateCounter(delta, ctx){ commit(ctx, function(next){ var value=typeof next.data.counter==='number'? next.data.counter:0; next.data.counter=value+delta; }); }
                function resetCounter(ctx){ ctx.set('data.counter', 0); rememberState(ctx); }
              </script>

              <section class="panel" x-if="state.data.activeTab === 'logic'">
                <script type="application/json" data-m-data data-m-path="i18n.strings">
                  {
                    "logic.title": { "ar": "تحدي الذكاء الاستقرائي", "en": "Pattern Logic Trainer" },
                    "logic.subtitle": { "ar": "استكشف المتتاليات وصقل مهارة اكتشاف النمط.", "en": "Explore sequences and sharpen your pattern sense." },
                    "logic.start": { "ar": "ابدأ التحدي", "en": "Start challenge" },
                    "logic.newChallenge": { "ar": "تحدٍ جديد", "en": "New challenge" },
                    "logic.feedback.correct": { "ar": "إجابة صحيحة! منطقك حاضر.", "en": "Great choice! Your reasoning is sharp." },
                    "logic.feedback.wrong": { "ar": "ليست الإجابة الصحيحة، حاول مرة أخرى.", "en": "Not quite right, try once more." }
                  }
                </script>

                <script type="application/json" data-m-data data-m-path="data.logicGame">
                  {
                    "sequence": [],
                    "options": [],
                    "answer": null,
                    "feedback": null,
                    "explain": null,
                    "selected": null
                  }
                </script>
                <header><h2>{trans('logic.title')}</h2><p>{trans('logic.subtitle')}</p></header>
                <div class="logic-sequence"><div class="term" x-for="term, idx in state.data.logicGame.sequence" key="idx">{term}</div><div class="term">?</div></div>
                <div class="logic-options">
                  <button x-for="option in state.data.logicGame.options" key="option" class="{logicOptionClass(option, state.data.logicGame)}" onclick="chooseLogic(option, ctx)">{option}</button>
                </div>
                <div class="game-feedback" x-if="state.data.logicGame.feedback">
                  <div class="card"><strong>{logicFeedbackTitle(ctx)}</strong><p>{logicFeedbackMessage(ctx)}</p></div>
                </div>
                <div class="controls" style="margin-top:1.5rem"><button class="button" onclick="startLogic(ctx, locals)">{state.data.logicGame.sequence.length ? trans('logic.newChallenge') : trans('logic.start')}</button></div>
              </section>

              <script>
                var LOGIC_GENERATORS=[
                  function arithmetic(h){ var step=h.randomBetween(2,8); var start=h.randomBetween(2,15); var length=4; var seq=[]; for(var i=0;i<length;i++){ seq.push(start + i*step); } var answer=start + length*step; var pool=h.shuffle([answer, answer+step, answer-step, answer+2*step, answer-2*step]).slice(0,4); return { type:'arithmetic', sequence:seq, answer:answer, options:pool, message:{ ar:'تزداد القيم بمقدار '+step+' في كل خطوة.', en:'Values increase by '+step+' each step.' } }; },
                  function doubling(h){ var start=h.randomBetween(2,6); var length=4; var seq=[]; for(var i=0;i<length;i++){ seq.push(start * Math.pow(2,i)); } var answer=start * Math.pow(2,length); var pool=h.shuffle([answer, answer/2, answer*2, answer+start, answer-start]).slice(0,4); return { type:'double', sequence:seq, answer:answer, options:pool, message:{ ar:'كل قيمة ضعف السابقة.', en:'Each value doubles the previous one.' } }; },
                  function squares(h){ var start=h.randomBetween(2,5); var length=4; var seq=[]; for(var i=0;i<length;i++){ var base=start+i; seq.push(base*base); } var nextBase=start+length; var answer=nextBase*nextBase; var pool=h.shuffle([answer,(nextBase+1)*(nextBase+1),(nextBase-1)*(nextBase-1), answer+nextBase, answer-nextBase]).slice(0,4); return { type:'square', sequence:seq, answer:answer, options:pool, message:{ ar:'الأعداد مربعات متتالية تبدأ من '+start+'².', en:'Squares that start at '+start+'².' } }; }
                ];
                function logicGenerators(locals){ if(locals && Array.isArray(locals.LOGIC_GENERATORS) && locals.LOGIC_GENERATORS.length){ logicGenerators.__cache=locals.LOGIC_GENERATORS; return locals.LOGIC_GENERATORS; } if(logicGenerators.__cache && logicGenerators.__cache.length){ return logicGenerators.__cache; } var fallback=(typeof LOGIC_GENERATORS!=='undefined' && Array.isArray(LOGIC_GENERATORS))? LOGIC_GENERATORS: []; logicGenerators.__cache=fallback; return fallback; }
                function logicOptionClass(option, game){ if(!game || !game.feedback) return ''; if(option===game.answer) return 'correct'; if(game.selected===option) return 'wrong'; return ''; }
                function logicFeedbackTitle(ctx){ var state=ctx.getState(); var game=state && state.data && state.data.logicGame; if(!game || !game.feedback) return ''; var type=game.feedback.type==='correct'?'correct':'wrong'; var key= type==='correct'? 'logic.feedback.correct':'logic.feedback.wrong'; var emoji= type==='correct'? '✅ ':'⚠️ '; return emoji + ctx.trans(key); }
                function logicFeedbackMessage(ctx){ var state=ctx.getState(); var game=state && state.data && state.data.logicGame; if(!game || !game.feedback) return ''; var msg=game.feedback.message; var lang=(state.env && state.env.lang)||'ar'; if(typeof msg==='function') return msg(lang); if(typeof msg==='string') return msg; if(msg && typeof msg==='object') return msg[lang] || msg.ar || msg.en || ''; return ''; }
                function buildLogicChallenge(locals){ var pool=logicGenerators(locals); if(!Array.isArray(pool) || !pool.length) return null; var pick=pool[Math.floor(Math.random()*pool.length)]; if(typeof pick!=='function') return null; return pick({ randomBetween: randomBetween, shuffle: shuffle }); }
                function startLogic(ctx, locals){ var challenge=buildLogicChallenge(locals); if(!ctx || !challenge) return; commit(ctx, function(next){ var logic=next.data.logicGame; logic.sequence=challenge.sequence; logic.options=challenge.options; logic.answer=challenge.answer; logic.feedback=null; logic.explain=challenge.message; logic.selected=null; }); }
                function chooseLogic(option, ctx){ commit(ctx, function(next){ var logic=next.data.logicGame; if(!Array.isArray(logic.options)||!logic.options.length) return; if(logic.feedback && logic.feedback.type==='correct') return; var isCorrect= option===logic.answer; logic.selected=option; logic.feedback={ type: isCorrect? 'correct':'wrong', message: logic.explain }; }); }
              </script>

              <section class="panel" x-if="state.data.activeTab === 'ajax'">
                <script type="application/json" data-m-data data-m-path="data.ajaxDemo" data-m-ajax="docs.ajaxBase" data-m-ajax-merge='{"extract":"guide.{{env.lang}}","mode":"replace"}'>
                  {
                    "status": "loading",
                    "summary": "نحضّر المحتوى...",
                    "steps": [],
                    "resources": []
                  }
                </script>

                <script type="application/json" data-m-ajax-map="docs.ajaxDigest">
                  {
                    "url": "./docs/htmlx-ajax-demo.json",
                    "responseType": "json",
                    "extract": "digest",
                    "mode": "replace"
                  }
                </script>

                <script type="application/json" data-m-data data-m-path="data.ajaxDigest" data-m-ajax="docs.ajaxDigest">
                  {
                    "lastSync": "—",
                    "items": []
                  }
                </script>

                <header><h2>{trans('ajax.title')}</h2><p>{trans('ajax.subtitle')}</p></header>
                <div class="ajax-layout">
                  <div class="ajax-card">
                    <div class="ajax-status">
                      <span class="ajax-state">{state.data.ajaxDemo.status === 'ready' ? '✅' : '⏳'}</span>
                      <div>
                        <strong>{trans('ajax.summary.title')}</strong>
                        <p>{state.data.ajaxDemo.summary || ''}</p>
                      </div>
                    </div>
                    <div class="ajax-steps" x-if="state.data.ajaxDemo.steps && state.data.ajaxDemo.steps.length">
                      <h3>{trans('ajax.steps.title')}</h3>
                      <ol>
                        <li x-for="step, idx in state.data.ajaxDemo.steps" key="idx">
                          <strong>{step.title}</strong>
                          <p>{step.body}</p>
                        </li>
                      </ol>
                    </div>
                    <div class="ajax-resources" x-if="state.data.ajaxDemo.resources && state.data.ajaxDemo.resources.length">
                      <h3>{trans('ajax.resources.title')}</h3>
                      <ul>
                        <li x-for="link in state.data.ajaxDemo.resources" key="link.url"><a href="{link.url}" target="_blank" rel="noreferrer">{link.label}</a></li>
                      </ul>
                    </div>
                  </div>
                  <div class="ajax-card">
                    <h3>{trans('ajax.digest.title')}</h3>
                    <p class="ajax-sync">{trans('ajax.digest.syncedAt')} <strong>{digestSyncLabel(state.data.ajaxDigest)}</strong></p>
                    <div class="ajax-digest-list" x-if="state.data.ajaxDigest.items && state.data.ajaxDigest.items.length">
                      <div class="ajax-digest-item" x-for="item in state.data.ajaxDigest.items" key="item.id || item.title">
                        <strong>{digestItemTitle(item, ctx)}</strong>
                        <span class="ajax-digest-badge" x-if="item.badge">{item.badge}</span>
                      </div>
                    </div>
                    <p class="ajax-empty" x-if="!state.data.ajaxDigest.items || !state.data.ajaxDigest.items.length">{trans('ajax.digest.empty')}</p>
                  </div>
              </div>
            </section>

            <script>
              function digestSyncLabel(digest){ if(!digest || !digest.lastSync) return '—'; try { var dt=new Date(digest.lastSync); if(Number.isNaN(dt.getTime())) return digest.lastSync; return dt.toLocaleString(); } catch(_err){ return digest.lastSync; } }
              function digestItemTitle(item, ctx){ if(!item) return ''; var state=ctx.getState(); var lang=(state && state.env && state.env.lang)||'ar'; if(item.title && typeof item.title==='object'){ return item.title[lang] || item.title.ar || item.title.en || ''; } return item.title || ''; }
            </script>

            <section class="panel" x-if="state.data.activeTab === 'liveRates'">
              <header><h2>{trans('liveRates.title')}</h2><p>{trans('liveRates.lead')}</p></header>
              <div class="live-rates">
                <div class="live-rates-header">
                  <div class="live-rates-meta">
                    <span class="live-rates-state">{liveRatesStatusIcon(state.data.liveRates)}</span>
                    <div>
                      <strong>{liveRatesStatusText(state.data.liveRates, ctx)}</strong>
                      <p class="live-rates-updated">{trans('liveRates.updatedLabel')} <span>{liveRatesUpdatedLabel(state.data.liveRates, ctx)}</span></p>
                    </div>
                  </div>
                  <div class="live-rates-actions">
                    <label class="live-rates-base">
                      <span>{trans('liveRates.base')}</span>
                      <select onchange="changeLiveRatesBase(event, ctx)">
                        <option x-for="code in state.data.liveRates.availableBases" key="code" value="{code}" selected="{code === state.data.liveRates.base ? 'selected' : null}">{code}</option>
                      </select>
                    </label>
                    <button class="button" onclick="refreshLiveRates(ctx)" disabled="{state.data.liveRates.status === 'loading' ? 'disabled' : null}">
                      {state.data.liveRates.status === 'loading' ? trans('liveRates.refreshing') : '🔄 ' + trans('liveRates.refresh')}
                    </button>
                  </div>
                </div>
                <div class="live-rates-error" x-if="state.data.liveRates.status === 'error'">
                  <strong>{trans('liveRates.errorTitle')}</strong>
                  <p>{state.data.liveRates.error || trans('liveRates.errorFallback')}</p>
                </div>
                <div class="live-rates-grid" x-if="state.data.liveRates.rates && state.data.liveRates.rates.length">
                  <div class="live-rates-head"><span>{trans('liveRates.column.currency')}</span><span>{trans('liveRates.column.rate')}</span></div>
                  <div class="live-rates-row" x-for="entry in state.data.liveRates.rates" key="entry.code"><span>{entry.code}</span><span>{formatLiveRate(entry.value)}</span></div>
                </div>
                <p class="live-rates-empty" x-if="!state.data.liveRates.rates || !state.data.liveRates.rates.length">{trans('liveRates.empty')}</p>
                <p class="live-rates-source" x-if="state.data.liveRates.source && state.data.liveRates.source.url">{trans('liveRates.source')} <a href="{state.data.liveRates.source.url}" target="_blank" rel="noreferrer">{state.data.liveRates.source.label || state.data.liveRates.source.url}</a></p>
              </div>
            </section>

            <script>
              function liveRatesStatusIcon(live){ if(!live) return '🕒'; if(live.status==='ready') return '🌐'; if(live.status==='error') return '⚠️'; if(live.status==='loading') return '⏳'; return '🕒'; }
              function liveRatesStatusText(live, ctx){ var status=(live && live.status) || 'idle'; var key='liveRates.status.' + status; return ctx && typeof ctx.trans==='function'? ctx.trans(key): key; }
              function liveRatesUpdatedLabel(live, ctx){ var translator=ctx && typeof ctx.trans==='function'? ctx.trans: function(key){ return key; }; if(!live) return '—'; if(live.status==='loading') return translator('liveRates.updated.pending'); var iso=live.updatedAt || live.fetchedAt; if(!iso) return translator('liveRates.updated.pending'); try { var dt=new Date(iso); if(Number.isNaN(dt.getTime())) throw new Error('invalid'); var utils=(window.Mishkah && window.Mishkah.utils) || {}; var Time=utils.Time; if(Time && typeof Time.fmt==='function'){ return Time.fmt(dt, { year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit' }); } return dt.toLocaleString(); } catch(_err){ return typeof iso==='string'? iso: translator('liveRates.updated.pending'); } }
              function formatLiveRate(value){ var num=Number(value); if(!Number.isFinite(num)) return '—'; return num.toFixed(3); }
              function changeLiveRatesBase(event, ctx){ var nextBase=event && event.target && event.target.value; if(!nextBase || !ctx) return; commit(ctx, function(next){ next.data=next.data||{}; next.data.liveRates=next.data.liveRates||{}; next.data.liveRates.base=String(nextBase).toUpperCase(); }, function(){ refreshLiveRates(ctx); }); }
              function refreshLiveRates(ctx){ if(!ctx || typeof ctx.getState!=='function') return; var host=window.Mishkah || {}; var utils=host.utils || {}; var Net=utils && utils.Net; if(!Net || typeof Net.ajax!=='function'){ commit(ctx, function(next){ next.data=next.data||{}; next.data.liveRates=next.data.liveRates||{}; next.data.liveRates.status='error'; next.data.liveRates.error='Networking utility unavailable.'; next.data.liveRates.lastErrorAt=(utils && utils.Time && typeof utils.Time.ts==='function')? utils.Time.ts(): new Date().toISOString(); }); return; } var state=ctx.getState(); var store=(state && state.data && state.data.liveRates) || {}; var base=store.base || 'USD'; var targets=Array.isArray(store.currencies)? store.currencies.slice(): []; var symbols=targets.filter(function(code){ return code && code !== base; }); commit(ctx, function(next){ next.data=next.data||{}; next.data.liveRates=next.data.liveRates||{}; next.data.liveRates.status='loading'; next.data.liveRates.error=null; }); var query={ base: base }; if(symbols.length){ query.symbols=symbols.join(','); }
                Net.ajax('https://api.exchangerate.host/latest', { query: query, timeout: 10000, responseType: 'json' }).then(function(payload){ if(payload && payload.success===false){ var msg=(payload.error && (payload.error.type || payload.error.info)) || 'Request failed'; throw new Error(msg); } commit(ctx, function(next){ next.data=next.data||{}; next.data.liveRates=next.data.liveRates||{}; var live=next.data.liveRates; live.status='ready'; live.error=null; var effectiveBase=(payload && payload.base) || base; live.base=effectiveBase; var Time=utils && utils.Time; var toIso=function(raw){ if(!raw) return null; var candidate=new Date(raw); if(Number.isNaN(candidate.getTime())) return null; return candidate.toISOString(); }; var updatedIso=null; if(payload && payload.time_last_update_utc){ updatedIso=toIso(payload.time_last_update_utc); } if(!updatedIso && payload && payload.date){ updatedIso=toIso(payload.date + 'T00:00:00Z'); }
                  var nowIso=(Time && typeof Time.ts==='function')? Time.ts(): new Date().toISOString(); live.updatedAt=updatedIso || nowIso; live.fetchedAt=nowIso; var ratesObj=(payload && payload.rates && typeof payload.rates==='object')? payload.rates: {}; var codes=Array.isArray(live.currencies)? live.currencies.slice(): []; if(codes.indexOf(effectiveBase)===-1){ codes.unshift(effectiveBase); }
                  var entries=codes.map(function(code){ if(!code) return null; var upper=String(code).toUpperCase(); var val=upper===effectiveBase? 1: ratesObj[upper]; var num=typeof val==='number'? val: Number(val); return { code: upper, value: Number.isFinite(num)? num: null }; }).filter(function(entry){ return entry && entry.code; }); entries.sort(function(a,b){ return a.code.localeCompare(b.code); }); live.rates=entries; live.source={ label: 'exchangerate.host', url: 'https://exchangerate.host' }; live.lastErrorAt=null; }); }).catch(function(error){ commit(ctx, function(next){ next.data=next.data||{}; next.data.liveRates=next.data.liveRates||{}; next.data.liveRates.status='error'; next.data.liveRates.error=(error && error.message) || 'Unable to load live rates.'; var Time=utils && utils.Time; next.data.liveRates.lastErrorAt=(Time && typeof Time.ts==='function')? Time.ts(): new Date().toISOString(); }); }); }
            </script>

            <section class="panel" x-if="state.data.activeTab === 'game'">
                <script type="application/json" data-m-data data-m-path="i18n.strings">
                  {
                    "game.title": { "ar": "لعبة الأمثال والحكم", "en": "Proverbs & Wisdom Game" },
                    "game.subtitle": { "ar": "اكتشف الحكمة بحروف عربية وتحديات ذكية.", "en": "Unveil wisdom through Arabic letters and smart challenges." },
                    "game.timeLabel": { "ar": "الوقت المتبقي", "en": "Time left" },
                    "game.tries": { "ar": "المحاولات", "en": "Tries" },
                    "game.statusLabel": { "ar": "الحالة", "en": "Status" },
                    "game.status.idle": { "ar": "جاهزة", "en": "Ready" },
                    "game.status.running": { "ar": "قيد اللعب", "en": "Running" },
                    "game.status.won": { "ar": "انتصار", "en": "Victory" },
                    "game.status.lost": { "ar": "خسارة", "en": "Defeat" },
                    "game.start": { "ar": "ابدأ اللعبة", "en": "Start game" },
                    "game.new": { "ar": "مثل جديد", "en": "New proverb" },
                    "game.musicOn": { "ar": "الموسيقى مفعّلة", "en": "Music on" },
                    "game.musicOff": { "ar": "الموسيقى متوقفة", "en": "Music off" },
                    "game.timerOn": { "ar": "المؤقت نشط", "en": "Timer on" },
                    "game.timerOff": { "ar": "المؤقت متوقف", "en": "Timer off" },
                    "game.timerSeconds": { "ar": "عدد الثواني", "en": "Seconds" },
                    "game.hintTitle": { "ar": "التلميح التعليمي", "en": "Educational hint" },
                    "game.solution": { "ar": "الحل الكامل", "en": "Full solution" },
                    "game.explanation": { "ar": "الشرح", "en": "Explanation" },
                    "game.lesson": { "ar": "العبرة", "en": "Lesson" },
                    "game.source": { "ar": "المصدر", "en": "Source" },
                    "game.feedback.correct": { "ar": "أحسنت! رف صحيح.", "en": "Great! Correct letter." },
                    "game.feedback.wrong": { "ar": "هذه المحاولة لم تصب الهدف.", "en": "That guess missed the mark." },
                    "game.feedback.win": { "ar": "إبداع! اكتملت الحكمة.", "en": "Brilliant! Wisdom unveiled." },
                    "game.feedback.lose": { "ar": "انتهت المحاولات، لا بأس أن تكشف الحكمة.", "en": "No tries left, time to reveal the wisdom." },
                    "game.reveal": { "ar": "اكتشف الحكمة", "en": "Reveal wisdom" }
                  }
                </script>

                <script type="application/json" data-m-data data-m-path="data">
                  {
                    "alphabet": ["ا","ب","ت","ث","ج","ح","خ","د","ذ","ر","ز","س","ش","ص","ض","ط","ظ","ع","غ","ف","ق","ك","ل","م","ن","و","ه","ة","ء","ي","ى"],
                    "game": {
                      "musicOn": true,
                      "timerOn": true,
                      "timerSec": 45,
                      "timeLeft": 45,
                      "triesMax": 5,
                      "triesLeft": 5,
                      "audioList": [
                        { "name": "Ghost Stories", "url": "https://www.fesliyanstudios.com/musicfiles/2020-10-26_-_Ghost_Stories_-_www.FesliyanStudios.com_Steve_Oxen/2020-10-26_-_Ghost_Stories_-_www.FesliyanStudios.com_Steve_Oxen.mp3" },
                        { "name": "The Unsolved Mystery", "url": "https://www.fesliyanstudios.com/musicfiles/2018-07-22_-_The_Unsolved_Murder_-_David_Fesliyan.mp3" },
                        { "name": "Dark Shadows", "url": "https://www.fesliyanstudios.com/musicfiles/2020-06-25_-_Dark_Shadows_-_www.FesliyanStudios.com_David_Fesliyan.mp3" }
                      ],
                      "audioIdx": 0,
                      "proverb": null,
                      "guessed": {},
                      "status": "idle",
                      "revealSolution": false,
                      "feedback": null,
                      "proverbs": [
                        { "t": "رجع بخفي حنين", "hint": "يُقال لمن عاد بلا نتيجة.", "explanation": "تحكي القصة عن رجل فشل في مفاوضة إسكافي فعاد خالي الوفاض وقد فقد نعليه، فصار مثلاً عن الخيبة بعد مشقة.", "lesson": "التخطيط والمرونة في التفاوض يحميان من ضياع الجهد.", "source": "مثل عربي قديم" },
                        { "t": "خير الكلام ما قل ودل", "hint": "يتعلق بفصاحة التعبير.", "explanation": "يشجع المثل على اختيار كلمات قليلة لكنها معبرة وواضحة بدلاً من الإطالة المملة.", "lesson": "الإيجاز الواضح يبني تواصلاً أقوى.", "source": "حكمة عربية قديمة" },
                        { "t": "الصبر مفتاح الفرج", "hint": "يدعو للتريث.", "explanation": "يعلمنا المثل أن ضيق اللحظة لا يدوم وأن الصبر يفتح أبواب الحلول.", "lesson": "الهدوء والثبات يمنحان رؤية أوضح.", "source": "حكمة روحانية" }
                      ],
                      "soundEffects": {
                        "correct": "https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3",
                        "wrong": "https://assets.mixkit.co/sfx/preview/mixkit-failure-arcade-alert-notification-240.mp3",
                        "win": "https://assets.mixkit.co/sfx/preview/mixkit-small-crowd-cheer-and-applause-518.mp3",
                        "lose": "https://assets.mixkit.co/sfx/preview/mixkit-game-over-dark-2068.mp3"
                      }
                    }
                  }
                </script>
                <header><h2>{trans('game.title')}</h2><p>{trans('game.subtitle')}</p></header>
                <div class="game-status-strip">
                  <div class="status-strip">
                    <div class="status-block">
                      <strong>{trans('game.tries')}</strong>
                      <span>{state.data.game.triesLeft} / {state.data.game.triesMax}</span>
                    </div>
                    <div class="status-block">
                      <strong>{trans('game.timeLabel')}</strong>
                      <span>{formatTimeLeft(state.data.game)}</span>
                    </div>
                    <div class="status-block">
                      <strong>{trans('game.statusLabel')}</strong>
                      <span>{trans('game.status.' + state.data.game.status)}</span>
                    </div>
                  </div>
                  <div class="game-status-actions">
                    <button class="button" onclick="startGame(ctx)">🎮 {state.data.game.status === 'running' ? trans('game.new') : trans('game.start')}</button>
                    <button class="button secondary" x-if="state.data.game.status === 'lost'" onclick="revealSolution(ctx)">{trans('game.reveal')}</button>
                  </div>
                </div>
                <div class="game-board">
                  <div class="puzzle-row"><div class="{tileClass(ch, state.data.game)}" x-for="ch, idx in state.data.game.proverb ? state.data.game.proverb.t.split('') : []" key="idx">{tileContent(ch, state.data.game)}</div></div>
                  <div class="letters-grid"><button x-for="letter in state.data.alphabet" key="letter" class="{letterClass(letter, state.data.game)}" onclick="chooseLetter(letter, ctx)">{letter}</button></div>
                  <div class="game-controls">
                    <div class="control-row">
                      <span class="toggle"><input type="checkbox" onclick="toggleMusic(event, ctx)" checked="{state.data.game.musicOn ? 'checked' : null}" /><span>{state.data.game.musicOn ? trans('game.musicOn') : trans('game.musicOff')}</span></span>
                      <select onchange="selectTrack(event, ctx)"><option x-for="track, idx in state.data.game.audioList" key="track.url" value="{idx}" selected="{idx === state.data.game.audioIdx ? 'selected' : null}">{track.name}</option></select>
                      <div class="status-block" style="margin-inline-start:auto"><strong>❤️</strong><div class="hearts-row"><span x-for="i in range(state.data.game.triesMax)" key="i">{i < state.data.game.triesLeft ? '❤️' : '🤍'}</span></div></div>
                    </div>
                    <div class="control-row">
                      <span class="toggle"><input type="checkbox" onclick="toggleTimer(event, ctx)" checked="{state.data.game.timerOn ? 'checked' : null}" /><span>{state.data.game.timerOn ? trans('game.timerOn') : trans('game.timerOff')}</span></span>
                      <label>{trans('game.timerSeconds')} <input type="number" min="5" max="300" value="{state.data.game.timerSec}" onchange="setTimerSeconds(event, ctx)" /></label>
                    </div>
                  </div>
                  <div class="game-feedback">
                    <div class="card" x-if="state.data.game.feedback"><strong>{gameFeedbackTitle(ctx)}</strong><p>{gameFeedbackMessage(ctx)}</p></div>
                    <div class="card" x-if="state.data.game.proverb"><strong>💡 {trans('game.hintTitle')}</strong><p>{state.data.game.proverb.hint}</p></div>
                    <div class="card" x-if="state.data.game.revealSolution && state.data.game.proverb"><strong>📜 {trans('game.solution')}</strong><p>{trans('game.explanation')}: {state.data.game.proverb.explanation}</p><p>{trans('game.lesson')}: {state.data.game.proverb.lesson}</p><p class="hint">{trans('game.source')}: {state.data.game.proverb.source}</p></div>
                  </div>
                  <audio class="hidden" x-if="state.data.game.musicOn && state.data.game.status === 'running'" src="{state.data.game.audioList[state.data.game.audioIdx].url}" autoplay loop></audio>
                  <audio class="hidden" x-if="state.data.game.feedback && state.data.game.feedback.sound" src="{state.data.game.feedback.sound}" autoplay></audio>
                </div>
              </section>

              <script>
                function normalizeLetter(ch){ return String(ch||'').replace(/[أإآ]/g,'ا'); }
                function tileClass(ch, game){ if(ch===' ') return 'puzzle-tile space'; var norm=normalizeLetter(ch); var revealed=game && game.guessed && game.guessed[norm]; return 'puzzle-tile' + (revealed? ' revealed':''); }
                function tileContent(ch, game){ if(ch===' ') return ''; var norm=normalizeLetter(ch); return game && game.guessed && game.guessed[norm]? ch: '•'; }
                function letterClass(letter, game){ if(!game) return ''; var norm=normalizeLetter(letter); return game.guessed && game.guessed[norm]? 'used': ''; }
                function gameFeedbackTitle(ctx){ var state=ctx.getState(); var game=state && state.data && state.data.game; if(!game || !game.feedback) return ''; var emojiMap={correct:'✅',wrong:'⚠️',win:'🏆',lose:'💔'}; var keyMap={correct:'game.feedback.correct',wrong:'game.feedback.wrong',win:'game.feedback.win',lose:'game.feedback.lose'}; var type=game.feedback.type; var emoji=emojiMap[type]||'✨'; var key=keyMap[type]||'game.feedback.correct'; return emoji+' '+ctx.trans(key); }
                function gameFeedbackMessage(ctx){ var state=ctx.getState(); var game=state && state.data && state.data.game; if(!game || !game.feedback) return ''; var keyMap={correct:'game.feedback.correct',wrong:'game.feedback.wrong',win:'game.feedback.win',lose:'game.feedback.lose'}; var key=keyMap[game.feedback.type]||'game.feedback.correct'; return ctx.trans(key); }
                function isSolved(game){ if(!game || !game.proverb) return false; var text=game.proverb.t||''; return text.split('').every(function(ch){ return ch===' ' || game.guessed[normalizeLetter(ch)]; }); }
                function startGame(ctx){ var env=runtime(); if(env.stopTimer) env.stopTimer(); commit(ctx, function(next){ var game=next.data.game; if(!game) return; var list=Array.isArray(game.proverbs)? game.proverbs: []; var proverb=list.length? list[Math.floor(Math.random()*list.length)]: null; game.proverb=proverb; game.guessed={}; game.triesLeft=game.triesMax; game.status='running'; game.revealSolution=false; game.feedback=null; game.timeLeft= game.timerOn ? game.timerSec: 0; }, function(state, context){ var env=runtime(); if(env.applyEnvironment) env.applyEnvironment(state); if(state.data.game.timerOn && state.data.game.status==='running' && env.startTimer){ env.startTimer(context); } }); }
                function chooseLetter(letter, ctx){ commit(ctx, function(next){ var game=next.data.game; if(!game || game.status!=='running') return; var sounds=game.soundEffects || {}; var norm=normalizeLetter(letter); if(game.guessed[norm]) return; game.guessed[norm]=true; var hasLetter= game.proverb && game.proverb.t.split('').some(function(ch){ return normalizeLetter(ch)===norm; }); if(!hasLetter){ game.triesLeft=Math.max(0, game.triesLeft-1); game.feedback={ type:'wrong', sound: sounds.wrong || ''}; } else { game.feedback={ type:'correct', sound: sounds.correct || ''}; } if(isSolved(game)){ game.status='won'; game.revealSolution=true; game.feedback={ type:'win', sound: sounds.win || ''}; if(game.timerOn){ game.timeLeft= typeof game.timeLeft==='number'? game.timeLeft: game.timerSec; } } else if (game.triesLeft<=0){ game.status='lost'; game.revealSolution=true; game.feedback={ type:'lose', sound: sounds.lose || ''}; } }, function(state){ var env=runtime(); var game=state.data.game; if(game.status!=='running' && env.stopTimer){ env.stopTimer(); } }); }
                function toggleMusic(event, ctx){ var checked=!!(event && event.target && event.target.checked); ctx.set('data.game.musicOn', checked); rememberState(ctx); }
                function selectTrack(event, ctx){ var idx=parseInt(event && event.target && event.target.value,10); if(!Number.isFinite(idx)) idx=0; commit(ctx, function(next){ var list=next.data.game.audioList||[]; next.data.game.audioIdx=Math.max(0, Math.min(idx, list.length-1)); }); }
                function toggleTimer(event, ctx){ var checked=!!(event && event.target && event.target.checked); var env=runtime(); if(env.stopTimer) env.stopTimer(); commit(ctx, function(next){ var game=next.data.game; game.timerOn=checked; game.timeLeft= checked? game.timerSec: 0; if(!checked && game.status==='running'){ game.status='idle'; } }, function(state, context){ if(state.data.game.status==='running' && state.data.game.timerOn && runtime().startTimer){ runtime().startTimer(context); } }); }
                function setTimerSeconds(event, ctx){ var value=parseInt(event && event.target && event.target.value,10); if(!Number.isFinite(value)) return; value=Math.min(300, Math.max(5, value)); commit(ctx, function(next){ var game=next.data.game; game.timerSec=value; if(game.timerOn){ game.timeLeft=value; } }); }
                function revealSolution(ctx){ ctx.set('data.game.revealSolution', true); rememberState(ctx); }
              </script>

            </div>
          </div>
        </div>

        <div class="settings-modal" x-if="state.data.settingsOpen" onclick="closeSettings(event, ctx)">
          <div class="settings-body" onclick="event.stopPropagation()">
            <script type="application/json" data-m-data data-m-path="i18n.strings">
              {
                "settings.title": { "ar": "إعدادات المظهر", "en": "Appearance settings" },
                "settings.fontLabel": { "ar": "حجم الخط", "en": "Font scale" },
                "settings.background": { "ar": "الخلفية", "en": "Background" },
                "settings.reset": { "ar": "إعادة الافتراضي", "en": "Reset defaults" },
                "settings.close": { "ar": "تم", "en": "Done" }
              }
            </script>

            <script type="application/json" data-m-data data-m-path="data">
              {
                "settingsOpen": false,
                "themePrefs": { "fontScale": 100, "background": "nebula" },
                "backgrounds": [
                  {
                    "id": "nebula",
                    "label": { "ar": "شفق بنفسجي", "en": "Violet nebula" },
                    "light": {
                      "gradient": "linear-gradient(160deg, #f8f9ff 0%, #e8ecff 100%)",
                      "overlay1": "radial-gradient(circle at 20% 25%, rgba(79, 70, 229, 0.18), transparent 55%)",
                      "overlay2": "radial-gradient(circle at 80% 70%, rgba(14, 165, 233, 0.18), transparent 50%)"
                    },
                    "dark": {
                      "gradient": "linear-gradient(160deg, #0d1224 0%, #111c3d 100%)",
                      "overlay1": "radial-gradient(circle at 80% 30%, rgba(168, 85, 247, 0.22), transparent 55%)",
                      "overlay2": "radial-gradient(circle at 15% 80%, rgba(56, 189, 248, 0.18), transparent 55%)"
                    }
                  },
                  {
                    "id": "sunset",
                    "label": { "ar": "غروب ذهبي", "en": "Golden sunset" },
                    "light": {
                      "gradient": "linear-gradient(145deg, #fff7ed 0%, #fde68a 100%)",
                      "overlay1": "radial-gradient(circle at 25% 20%, rgba(251, 191, 36, 0.24), transparent 55%)",
                      "overlay2": "radial-gradient(circle at 75% 80%, rgba(249, 115, 22, 0.18), transparent 55%)"
                    },
                    "dark": {
                      "gradient": "linear-gradient(145deg, #1f172a 0%, #312e81 100%)",
                      "overlay1": "radial-gradient(circle at 25% 20%, rgba(147, 51, 234, 0.24), transparent 55%)",
                      "overlay2": "radial-gradient(circle at 75% 80%, rgba(234, 179, 8, 0.18), transparent 55%)"
                    }
                  }
                ]
              }
            </script>
            <h3>{trans('settings.title')}</h3>
            <div class="settings-grid">
              <label>{trans('settings.fontLabel')} ({state.data.themePrefs.fontScale}%)<input type="range" min="85" max="130" step="5" value="{state.data.themePrefs.fontScale}" onchange="setFontScale(event, ctx)" /></label>
              <label>{trans('settings.background')}<select onchange="setBackgroundPreset(event, ctx)"><option x-for="preset in state.data.backgrounds" key="preset.id" value="{preset.id}" selected="{preset.id === state.data.themePrefs.background ? 'selected' : null}">{preset.label[state.env.lang] || preset.label.ar}</option></select></label>
            </div>
            <div class="settings-actions"><button class="button secondary" onclick="resetThemePrefs(ctx)">{trans('settings.reset')}</button><button class="button" onclick="toggleSettings(ctx)">{trans('settings.close')}</button></div>
          </div>
        </div>
      </div>

      <script>
        function closeSettings(event, ctx){ if(event && event.target && event.currentTarget && event.target!==event.currentTarget) return; ctx.set('data.settingsOpen', false); rememberState(ctx); }
        function setFontScale(event, ctx){ var value=parseInt(event && event.target && event.target.value,10); if(!Number.isFinite(value)) return; commit(ctx, function(next){ next.data.themePrefs.fontScale=value; }, function(state){ var env=runtime(); if(env.applyThemePrefs) env.applyThemePrefs(state); if(env.persistPrefs) env.persistPrefs(state); }); }
        function setBackgroundPreset(event, ctx){ var id= event && event.target && event.target.value; commit(ctx, function(next){ next.data.themePrefs.background=id; }, function(state){ var env=runtime(); if(env.applyThemePrefs) env.applyThemePrefs(state); if(env.persistPrefs) env.persistPrefs(state); }); }
        function resetThemePrefs(ctx){ var defaults= defaultThemePrefs(); commit(ctx, function(next){ next.data.themePrefs=defaults; }, function(state){ var env=runtime(); if(env.applyThemePrefs) env.applyThemePrefs(state); if(env.persistPrefs) env.persistPrefs(state); }); }
      </script>

            <script>
        // ====== وظائف محلية مشتركة داخل template ======
        function runtime(){ return ensureRuntimeGlobals(); }
        function cloneState(prev){ return JSON.parse(JSON.stringify(prev || {})); }
        function rememberState(ctx){ try{ window.__INDEX_STATE__ = ctx.getState(); }catch(_){} }
        function commit(ctx, mutate, after){ if(!ctx) return; ctx.setState(function(prev){ var next = cloneState(prev); if(typeof mutate==='function'){ mutate(next, prev||{}); } return next; }); window.setTimeout(function(){ rememberState(ctx); if(typeof after==='function'){ after(ctx.getState(), ctx); } },0); }
        function randomBetween(min, max){ return Math.floor(Math.random() * (max - min + 1)) + min; }
        function shuffle(arr){ var copy = arr.slice(); for(var i=copy.length-1;i>0;i--){ var j=Math.floor(Math.random()*(i+1)); var tmp=copy[i]; copy[i]=copy[j]; copy[j]=tmp; } return copy; }
        function defaultThemePrefs(){ return { fontScale: 100, background: 'nebula' }; }
        function range(count){ var len=Math.max(0, Number(count)||0), out=[]; for(var i=0;i<len;i++) out.push(i); return out; }

        function ensureRuntimeGlobals(){
          var runtimeGlobals = window.__INDEX_RUNTIME = window.__INDEX_RUNTIME || {};
          var STORAGE_KEY = runtimeGlobals.storageKey || 'mishkah:htmlx:index:prefs';
          runtimeGlobals.storageKey = STORAGE_KEY;

          if (typeof runtimeGlobals.persistPrefs !== 'function') {
            runtimeGlobals.persistPrefs = function(state){
              try{
                var payload={ theme: state.env && state.env.theme, lang: state.env && state.env.lang, dir: state.env && state.env.dir, themePrefs: state.data && state.data.themePrefs };
                window.localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
              }catch(_){ }
            };
          }

          runtimeGlobals.applyThemePrefs = function(state){
            var prefs=(state.data && state.data.themePrefs) || defaultThemePrefs();
            var scale=prefs.fontScale || 100;
            document.documentElement.style.setProperty('--user-font-scale', String(scale));
            var presets = (state.data && state.data.backgrounds) || [];
            var fallback = presets[0] || { light:{}, dark:{} };
            var preset = presets.find(function(p){ return p && p.id===prefs.background; }) || fallback;
            var palette = state.env && state.env.theme==='dark'? (preset && preset.dark) : (preset && preset.light);
            if(palette){
              if(palette.gradient) document.documentElement.style.setProperty('--page-gradient', palette.gradient);
              if(palette.overlay1) document.documentElement.style.setProperty('--page-overlay-1', palette.overlay1);
              if(palette.overlay2) document.documentElement.style.setProperty('--page-overlay-2', palette.overlay2);
            }
          };

          runtimeGlobals.applyEnvironment = function(state){
            var lang=(state.env && state.env.lang) || 'ar';
            document.documentElement.lang = lang;
            document.documentElement.dir = (state.env && state.env.dir) || (lang==='ar' ? 'rtl':'ltr');
            document.documentElement.classList.toggle('dark', !!(state.env && state.env.theme==='dark'));
            runtimeGlobals.applyThemePrefs(state);
          };

          runtimeGlobals.stopTimer = function(){
            if(runtimeGlobals._activeTimer){
              window.clearInterval(runtimeGlobals._activeTimer);
              runtimeGlobals._activeTimer=null;
            }
          };

          runtimeGlobals.startTimer = function(ctx){
            runtimeGlobals.stopTimer();
            runtimeGlobals._activeTimer = window.setInterval(function(){ tickTimer(ctx); }, 1000);
          };

          return runtimeGlobals;
        }

        function readStoredPrefs(storageKey){
          if(!storageKey) return {};
          try{
            var raw=window.localStorage.getItem(storageKey);
            if(!raw) return {};
            var parsed=JSON.parse(raw);
            return parsed && typeof parsed==='object'? parsed: {};
          }catch(_){ return {}; }
        }

        function extractDocs(){
          var host=window.Mishkah || {};
          var source=host.readme || {};
          function esc(value){ return String(value || ''); }
          return {
            base: {
              ar: esc(source.base && source.base.ar),
              en: esc((source.base && source.base.en) || (source.base && source.base.ar) || '')
            },
            tec: {
              ar: esc(source.tec && source.tec.ar),
              en: esc((source.tec && source.tec.en) || (source.tec && source.tec.ar) || '')
            }
          };
        }

        function collectExternalProverbs(){
          var list = window.PROVERBS;
          if(!Array.isArray(list) || !list.length) return null;
          return list.map(function(item){
            if(item && typeof item==='object'){
              var copy={};
              for(var key in item){
                if(Object.prototype.hasOwnProperty.call(item, key)) copy[key]=item[key];
              }
              return copy;
            }
            return item;
          });
        }

        function mergeStoredPreferences(database, stored){
          if(!database || typeof database!=='object' || !stored || typeof stored!=='object') return;
          database.env = database.env && typeof database.env==='object'? database.env: {};
          var env = database.env;
          if(stored.lang){
            env.lang=stored.lang;
            env.dir=stored.dir || (stored.lang==='ar'? 'rtl':'ltr');
          }
          if(stored.dir){
            env.dir=stored.dir;
          }
          if(stored.theme){
            env.theme=stored.theme;
          }
          database.data = database.data && typeof database.data==='object'? database.data: {};
          if(stored.themePrefs && typeof stored.themePrefs==='object'){
            var base = database.data.themePrefs && typeof database.data.themePrefs==='object'? database.data.themePrefs: defaultThemePrefs();
            database.data.themePrefs = Object.assign({}, base, stored.themePrefs);
          }
        }

        function mergeDocs(database, docs){
          if(!database || typeof database!=='object' || !docs) return;
          database.data = database.data && typeof database.data==='object'? database.data: {};
          database.data.docs = docs;
        }

        function mergeExternalProverbs(database, list){
          if(!database || typeof database!=='object' || !Array.isArray(list) || !list.length) return;
          database.data = database.data && typeof database.data==='object'? database.data: {};
          database.data.game = database.data.game && typeof database.data.game==='object'? database.data.game: {};
          database.data.game.proverbs = list.slice();
        }

        function applySnapshotEnvironment(snapshot){
          var runtimeGlobals = ensureRuntimeGlobals();
          if(runtimeGlobals.applyEnvironment) runtimeGlobals.applyEnvironment(snapshot);
        }

        function __bootstrap__(database){
          if(!database || typeof database!=='object') return;
          var runtimeGlobals = ensureRuntimeGlobals();
          var stored = readStoredPrefs(runtimeGlobals.storageKey);
          mergeStoredPreferences(database, stored);
          mergeDocs(database, extractDocs());
          mergeExternalProverbs(database, collectExternalProverbs());
          var snapshot = { env: database.env || {}, data: database.data || {} };
          applySnapshotEnvironment(snapshot);
          if(runtimeGlobals.persistPrefs) runtimeGlobals.persistPrefs(snapshot);
          window.__INDEX_STATE__ = {};
        }

        function __init__(ctx){
          var runtimeGlobals = ensureRuntimeGlobals();
          if(!ctx || typeof ctx.getState!=='function') return;
          rememberState(ctx);
          var state = ctx.getState();
          if(runtimeGlobals.applyEnvironment) runtimeGlobals.applyEnvironment(state);
          if(runtimeGlobals.persistPrefs) runtimeGlobals.persistPrefs(state);
          if(typeof refreshLiveRates==='function'){
            try {
              var live=state && state.data && state.data.liveRates;
              if(!live || live.status==='idle'){
                window.setTimeout(function(){ refreshLiveRates(ctx); }, 0);
              }
            } catch(_err){}
          }
        }

        function tickTimer(ctx){
          if(!ctx || typeof ctx.getState!=='function') return;
          var runtimeGlobals = ensureRuntimeGlobals();
          var current=ctx.getState();
          var game=current.data && current.data.game;
          if(!game || !game.timerOn || game.status!=='running'){
            runtimeGlobals.stopTimer();
            return;
          }
          ctx.setState(function(prev){
            var next=cloneState(prev||{});
            var g=next.data.game;
            if(!g.timerOn || g.status!=='running') return prev;
            var nextTime=(typeof g.timeLeft==='number'? g.timeLeft: g.timerSec) - 1;
            g.timeLeft=Math.max(0,nextTime);
            if(g.timeLeft<=0){
              g.status='lost';
              g.revealSolution=true;
              var effects=(next.data && next.data.game && next.data.game.soundEffects)||{};
              g.feedback={ type:'lose', sound: effects.lose };
              runtimeGlobals.stopTimer();
            }
            return next;
          });
          window.setTimeout(function(){ rememberState(ctx); },0);
        }
      </script>
    </template>

    <!-- النواة -->
    <script src="./mishkah-utils.js"></script>
    <script src="./mishkah.core.js"></script>
    <script src="./readme.js"></script>
    <script src="./dist/mishkah-htmlx.js"></script>

    <script>
      (function (window) {
        'use strict';
        var M = window.Mishkah;
        if (!M || !M.HTMLxAgent) { console.error('Mishkah HTMLx agent is required.'); return; }

        var start = M.HTMLxAgent.make();
        Promise.resolve(start).catch(function (error) {
          console.error('Failed to start Mishkah HTMLx index:', error);
        });
      })(window);
    </script>
  </body>
</html>
