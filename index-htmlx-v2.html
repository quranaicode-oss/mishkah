<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ù…Ø´ÙƒØ§Ø© â€” ØªØ¬Ø±Ø¨Ø© HTMLx (v3)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet" />
    <style>
      :root {
        color-scheme: light dark;
        --page-gradient: linear-gradient(160deg, #f8f9ff 0%, #e8ecff 100%);
        --page-overlay-1: radial-gradient(circle at 20% 25%, rgba(79, 70, 229, 0.18), transparent 55%);
        --page-overlay-2: radial-gradient(circle at 80% 70%, rgba(14, 165, 233, 0.18), transparent 50%);
        --panel-glass: rgba(255, 255, 255, 0.78);
        --panel-border: rgba(99, 102, 241, 0.12);
        --panel-shadow: 0 25px 50px -20px rgba(15, 23, 42, 0.18);
        --surface-1: rgba(255, 255, 255, 0.72);
        --surface-2: rgba(241, 245, 249, 0.82);
        --border: rgba(99, 102, 241, 0.18);
        --foreground: #111827;
        --muted-foreground: rgba(55, 65, 81, 0.72);
        --primary: #4f46e5;
        --primary-foreground: #f9fafb;
        --accent-ring: rgba(79, 70, 229, 0.18);
        --tile-bg: linear-gradient(160deg, rgba(255, 255, 255, 0.95), rgba(241, 245, 249, 0.85));
        --tile-bg-revealed: linear-gradient(160deg, rgba(129, 140, 248, 0.75), rgba(79, 70, 229, 0.65));
        --tile-border: rgba(99, 102, 241, 0.25);
        --letters-shadow: 0 18px 45px -24px rgba(15, 23, 42, 0.35);
        --letters-hover: 0 25px 50px -20px rgba(99, 102, 241, 0.45);
        --font-body: 'Cairo', 'Tajawal', system-ui;
      }
      :root.dark {
        --page-gradient: linear-gradient(160deg, #0d1224 0%, #111c3d 100%);
        --page-overlay-1: radial-gradient(circle at 80% 30%, rgba(168, 85, 247, 0.22), transparent 55%);
        --page-overlay-2: radial-gradient(circle at 15% 80%, rgba(56, 189, 248, 0.18), transparent 55%);
        --panel-glass: rgba(17, 25, 40, 0.75);
        --panel-border: rgba(148, 163, 184, 0.32);
        --panel-shadow: 0 25px 50px -18px rgba(15, 23, 42, 0.55);
        --surface-1: rgba(17, 25, 40, 0.76);
        --surface-2: rgba(30, 41, 59, 0.78);
        --border: rgba(148, 163, 184, 0.35);
        --foreground: #f8fafc;
        --muted-foreground: rgba(203, 213, 225, 0.75);
        --primary: #818cf8;
        --primary-foreground: #0f172a;
        --accent-ring: rgba(129, 140, 248, 0.35);
        --tile-bg: linear-gradient(160deg, rgba(30, 41, 59, 0.78), rgba(15, 23, 42, 0.92));
        --tile-bg-revealed: linear-gradient(160deg, rgba(99, 102, 241, 0.55), rgba(79, 70, 229, 0.38));
        --tile-border: rgba(148, 163, 184, 0.35);
        --letters-shadow: 0 20px 40px -18px rgba(148, 163, 184, 0.35);
        --letters-hover: 0 28px 60px -20px rgba(99, 102, 241, 0.6);
      }
      *,*::before,*::after{box-sizing:border-box}
      body{margin:0;min-height:100vh;font-family:var(--font-body);background:var(--page-gradient);color:var(--foreground)}
      .page-shell{position:relative;min-height:100vh;padding:2rem 1.5rem 3.5rem}
      .page-shell::before,.page-shell::after{content:"";position:fixed;inset:0;pointer-events:none;z-index:-1}
      .page-shell::before{background:var(--page-overlay-1)}
      .page-shell::after{background:var(--page-overlay-2)}
      .app-card{background:var(--panel-glass);backdrop-filter:blur(22px);border:1px solid var(--panel-border);border-radius:2rem;box-shadow:var(--panel-shadow);overflow:hidden}
      header.header{margin:0 auto 2rem;max-width:1500px}
      header.header .header-inner{display:flex;flex-wrap:wrap;gap:1.5rem;align-items:center;padding:1.5rem}
      header.header h1{margin:0;font-size:clamp(1.8rem,2.8vw,2.6rem)}
      header.header p{margin:.4rem 0 0;font-size:.95rem;color:var(--muted-foreground)}
      .status-strip{display:flex;flex-wrap:wrap;gap:1.25rem;padding:.75rem 1.25rem;border-radius:999px;border:1px solid var(--border);background:var(--surface-1);box-shadow:0 18px 40px -28px rgba(79,70,229,.45)}
      .status-block{display:inline-flex;align-items:center;gap:.6rem;font-size:.95rem}
      .status-block strong{font-size:1.05rem}
      .hearts-row{display:inline-flex;gap:.4rem;font-size:1.1rem}
      .controls{margin-inline-start:auto;display:flex;flex-wrap:wrap;gap:.75rem;align-items:center}
      .segmented{display:inline-flex;align-items:center;background:var(--surface-1);border:1px solid var(--border);border-radius:999px;padding:.25rem;gap:.25rem}
      .segmented button{border:none;background:transparent;color:var(--muted-foreground);padding:.45rem 1.15rem;border-radius:999px;font-weight:600;cursor:pointer;transition:color .2s ease, background .2s ease}
      .segmented button.active{background:var(--primary);color:var(--primary-foreground);box-shadow:0 18px 38px -22px rgba(79,70,229,.55)}
      .layout{display:flex;flex-direction:column;gap:1.5rem;margin:0 auto;max-width:1500px}
      @media (min-width:1024px){.layout{flex-direction:row}}
      aside.sidebar{flex:0 0 280px}
      .sidebar-card{position:sticky;top:1.5rem;padding:1.5rem;display:flex;flex-direction:column;gap:1rem}
      .sidebar-card h2{margin:0;font-size:1rem;letter-spacing:.35em;text-transform:uppercase;color:var(--muted-foreground)}
      .nav-list{display:flex;flex-direction:column;gap:.65rem}
      .nav-button{width:100%;border:1px solid transparent;border-radius:1.1rem;background:transparent;padding:.85rem 1rem;text-align:start;font-weight:600;font-size:1rem;color:var(--muted-foreground);cursor:pointer;transition:border .25s ease, background .25s ease, color .25s ease}
      .nav-button .hint{display:block;margin-top:.35rem;font-size:.82rem;color:var(--muted-foreground);font-weight:400}
      .nav-button.active{border-color:var(--primary);background:color-mix(in oklab, var(--primary) 16%, transparent);color:var(--foreground)}
      .main-column{flex:1 1 auto;min-width:0;display:flex;flex-direction:column;gap:1.5rem}
      .panel{padding:2rem;border-radius:2rem;background:var(--panel-glass);border:1px solid var(--panel-border);box-shadow:var(--panel-shadow);backdrop-filter:blur(18px)}
      .panel header{margin-bottom:1.5rem}
      .panel header h2{margin:0;font-size:1.4rem}
      .panel header p{margin:.4rem 0 0;color:var(--muted-foreground);font-size:.95rem}
      .md-prose{line-height:1.7;display:grid;gap:1.1rem;color:var(--foreground)}
      .md-prose h2,.md-prose h3,.md-prose h4{margin:0}
      .md-prose h2{font-size:1.4rem}
      .md-prose h3{font-size:1.2rem}
      .md-prose ul{margin:0;padding-inline-start:1.4rem;display:grid;gap:.35rem}
      .md-prose blockquote{margin:0;padding:1rem 1.25rem;border-inline-start:4px solid var(--primary);background:color-mix(in oklab, var(--primary) 12%, transparent);border-radius:1rem}
      .counter-view{display:flex;align-items:center;justify-content:center;gap:1.25rem}
      .counter-display{font-size:2.2rem;font-weight:700}
      .button{border:none;background:var(--primary);color:var(--primary-foreground);font-weight:600;padding:.65rem 1.5rem;border-radius:999px;cursor:pointer;transition:transform .15s ease, box-shadow .2s ease}
      .button:hover{transform:translateY(-1px);box-shadow:0 16px 40px -22px rgba(79,70,229,.6)}
      .button.secondary{background:transparent;color:var(--foreground);border:1px solid var(--border)}
      .logic-sequence{display:flex;flex-wrap:wrap;justify-content:center;gap:.75rem}
      .logic-sequence .term,.logic-options button{width:4rem;height:4rem;display:grid;place-items:center;border-radius:1.4rem;border:1px solid var(--panel-border);background:var(--surface-1);font-weight:600;font-size:1.1rem;box-shadow:var(--panel-shadow)}
      .logic-options{display:grid;gap:.75rem;grid-template-columns:repeat(auto-fit,minmax(100px,1fr))}
      .logic-options button{cursor:pointer;border:none;transition:transform .15s ease}
      .logic-options button:hover{transform:translateY(-2px)}
      .logic-options button.correct{border-color:rgba(34,197,94,.45);background:rgba(34,197,94,.2)}
      .logic-options button.wrong{border-color:rgba(239,68,68,.45);background:rgba(239,68,68,.2)}
      .game-board{display:grid;gap:1.5rem}
      .puzzle-row{display:flex;flex-wrap:wrap;justify-content:center;gap:.75rem}
      .puzzle-tile{width:var(--tile-size,3rem);height:var(--tile-size,3rem);border-radius:1.4rem;display:grid;place-items:center;background:var(--tile-bg);border:1px solid var(--tile-border);font-weight:600;font-size:1.2rem;box-shadow:0 18px 38px -28px rgba(15,23,42,.45)}
      .puzzle-tile.revealed{background:var(--tile-bg-revealed);color:#fff}
      .puzzle-tile.space{width:2rem;border:none;background:transparent;box-shadow:none}
      .letters-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(46px,1fr));gap:.55rem}
      .letters-grid button{border:none;border-radius:.95rem;padding:.5rem 0;font-weight:600;background:var(--surface-1);cursor:pointer;box-shadow:var(--panel-shadow);transition:transform .15s ease, box-shadow .2s ease}
      .letters-grid button:hover{transform:translateY(-1px);box-shadow:var(--letters-hover)}
      .letters-grid button.used{opacity:.45;box-shadow:none;cursor:default}
      .game-controls{display:grid;gap:1rem}
      .game-controls .control-row{display:flex;flex-wrap:wrap;gap:.75rem;align-items:center}
      .toggle{display:inline-flex;align-items:center;gap:.5rem;padding:.4rem .85rem;border-radius:999px;border:1px solid var(--border);background:var(--surface-1)}
      .game-feedback{display:grid;gap:1rem}
      .game-feedback .card{border-radius:1.5rem;border:1px solid var(--panel-border);background:var(--surface-2);padding:1.25rem;box-shadow:var(--panel-shadow)}
      .game-feedback .card strong{font-size:1rem}
      .settings-modal{position:fixed;inset:0;background:rgba(15,23,42,.45);backdrop-filter:blur(12px);display:grid;place-items:center;padding:2rem;z-index:40}
      .settings-body{width:min(420px,100%);background:var(--panel-glass);border-radius:1.6rem;padding:1.75rem;display:grid;gap:1.25rem;border:1px solid var(--panel-border);box-shadow:var(--panel-shadow)}
      .settings-body h3{margin:0;font-size:1.25rem}
      .settings-grid{display:grid;gap:1rem}
      .settings-grid label{display:grid;gap:.4rem;font-size:.95rem}
      .settings-grid input[type="range"],.settings-grid select{width:100%}
      .settings-actions{display:flex;justify-content:space-between;gap:.75rem}
      select,input,button{font-family:inherit}
    </style>
  </head>
  <body>
    <div id="app"></div>

    <template id="mishkah-index">
      <script type="application/json" data-m-env>
        {
          "theme": "dark",
          "lang": "ar",
          "dir": "rtl",
          "flags": {
            "htmlxExperiment": true
          }
        }
      </script>

      <script type="application/json" data-m-data data-m-path="head">
        {
          "title": "Ù…Ø´ÙƒØ§Ø© â€” ØªØ¬Ø±Ø¨Ø© HTMLx"
        }
      </script>

      <script type="application/json" data-m-data data-m-path="i18n.strings">
        {
          "app.title": { "ar": "Ù…Ø´ÙƒØ§Ø© â€” ØªØ¬Ø±Ø¨Ø© HTMLx", "en": "Mishkah â€” HTMLx Experience" },
          "header.subtitle": { "ar": "Ù†Ù…ÙˆØ°Ø¬ Ù…Ø¨Ø³Ø· ÙŠØ¹Ø±Ø¶ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§ØªØŒ Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§ØªØŒ ÙˆØªØ­Ø¯ÙŠØ§Øª Mishkah Ø¯ÙˆÙ† Ù„ØºØ© DSL.", "en": "A lightweight showcase of tabs, counters, and Mishkah challenges without the legacy DSL." },
          "header.theme.light": { "ar": "Ù†Ù‡Ø§Ø±ÙŠ", "en": "Light" },
          "header.theme.dark": { "ar": "Ù„ÙŠÙ„ÙŠ", "en": "Dark" },
          "header.lang.ar": { "ar": "Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", "en": "Arabic" },
          "header.lang.en": { "ar": "Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©", "en": "English" },
          "settings.open": { "ar": "Ø§Ù„ØªØ®ØµÙŠØµ", "en": "Customize" }
        }
      </script>

      <div class="page-shell">
        <div class="app-card">
          <header class="header">
            <div class="header-inner">
              <div>
                <h1>{trans('app.title')}</h1>
                <p>{trans('header.subtitle')}</p>
              </div>
              <div class="status-strip">
                <div class="status-block">
                  <strong>{trans('game.tries')}</strong>
                  <span>{state.data.game.triesLeft} / {state.data.game.triesMax}</span>
                </div>
                <div class="status-block">
                  <strong>{trans('game.timeLabel')}</strong>
                  <span>{formatTimeLeft(state.data.game)}</span>
                </div>
                <div class="status-block">
                  <strong>{trans('game.statusLabel')}</strong>
                  <span>{trans('game.status.' + state.data.game.status)}</span>
                </div>
                <div class="status-block" x-if="state.env.flags && state.env.flags.htmlxExperiment">
                  <strong>ğŸ§ª HTMLx</strong>
                  <span>{state.env.lang === 'ar' ? 'ØªØ¬Ø±ÙŠØ¨ÙŠ' : 'Experimental'}</span>
                </div>
                <div class="controls">
                  <div class="segmented">
                    <button class="{state.env.theme === 'light' ? 'active' : ''}" onclick="setTheme('light', ctx)">{trans('header.theme.light')}</button>
                    <button class="{state.env.theme === 'dark' ? 'active' : ''}" onclick="setTheme('dark', ctx)">{trans('header.theme.dark')}</button>
                  </div>
                  <div class="segmented">
                    <button class="{state.env.lang === 'ar' ? 'active' : ''}" onclick="setLanguage('ar', ctx)">{trans('header.lang.ar')}</button>
                    <button class="{state.env.lang === 'en' ? 'active' : ''}" onclick="setLanguage('en', ctx)">{trans('header.lang.en')}</button>
                  </div>
                  <button class="button secondary" onclick="toggleSettings(ctx)">{trans('settings.open')}</button>
                  <button class="button" x-if="state.data.activeTab === 'game'" onclick="startGame(ctx)">ğŸ® {state.data.game.status === 'running' ? trans('game.new') : trans('game.start')}</button>
                </div>
              </div>
            </div>
          </header>

          <script>
            function formatTimeLeft(game){ if(!game || !game.timerOn) return 'â€”'; var value=typeof game.timeLeft==='number'? game.timeLeft: game.timerSec; return value>=0? value: 'â€”'; }
            function switchTab(tab, ctx){ ctx.set('data.activeTab', tab); rememberState(ctx); }
            function setTheme(theme, ctx){ commit(ctx, function(next){ next.env.theme=theme; }, function(state){ var env=runtime(); if(env.applyEnvironment) env.applyEnvironment(state); if(env.persistPrefs) env.persistPrefs(state); }); }
            function setLanguage(lang, ctx){ commit(ctx, function(next){ next.env.lang=lang; next.env.dir= lang==='ar'? 'rtl':'ltr'; }, function(state){ var env=runtime(); if(env.applyEnvironment) env.applyEnvironment(state); if(env.persistPrefs) env.persistPrefs(state); }); }
            function toggleSettings(ctx){ commit(ctx, function(next){ next.data.settingsOpen=!next.data.settingsOpen; }); }
          </script>

          <div class="layout">
            <aside class="sidebar">
              <div class="sidebar-card">
                <h2>{trans('nav.menu')}</h2>
                <script type="application/json" data-m-data data-m-path="i18n.strings">
                  {
                    "nav.menu": { "ar": "Ø§Ù„ØªØµÙÙ‘Ø­", "en": "Navigation" },
                    "nav.readmeBase": { "ar": "Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ù…Ø¹Ù…Ø§Ø±ÙŠØ©", "en": "Architectural Journey" },
                    "nav.readmeTec": { "ar": "Ø§Ù„Ø¯Ù„ÙŠÙ„ Ø§Ù„ØªÙ‚Ù†ÙŠ", "en": "Technical Guide" },
                    "nav.counter": { "ar": "Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ", "en": "Interactive Counter" },
                    "nav.logic": { "ar": "ØªØ­Ø¯ÙŠ Ø§Ù„Ù…Ù†Ø·Ù‚", "en": "Logic Challenge" },
                    "nav.game": { "ar": "Ù„Ø¹Ø¨Ø© Ø§Ù„Ø£Ù…Ø«Ø§Ù„", "en": "Proverbs Game" },
                    "doc.base.lead": { "ar": "Ù‚Ø±Ø§Ø¡Ø© Ø±ÙˆØ­ÙŠØ© Ù„Ù…Ø¹Ù…Ø§Ø±ÙŠØ§Øª Ù…Ø´ÙƒØ§Ø© ÙˆÙ…Ø­Ø±ÙƒÙ‡Ø§.", "en": "A reflective tour through Mishkah's architecture." },
                    "doc.tec.lead": { "ar": "Ø§Ù„Ù…Ù„Ù Ø§Ù„ØªÙ‚Ù†ÙŠ Ø§Ù„Ø°ÙŠ ÙŠØ´Ø±Ø­ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù….", "en": "The technical dossier explaining the system." },
                    "doc.language.hint": { "ar": "Ø¨Ø¯Ù‘Ù„ Ø§Ù„Ù„ØºØ© Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø£Ùˆ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©.", "en": "Use the header switcher to view the document in Arabic or English." },
                    "counter.lead": { "ar": "Ù…Ø«Ø§Ù„ ÙŠÙˆØ¶Ø­ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£ÙˆØ§Ù…Ø± HTMLx Ù„Ù„ØªØ­Ø¯ÙŠØ«.", "en": "An example that shows HTMLx driven updates." },
                    "logic.lead": { "ar": "Ø­Ù„ Ù…ØªØªØ§Ù„ÙŠØ§Øª Ø±Ù‚Ù…ÙŠØ© Ø¨Ø£Ø³Ù„ÙˆØ¨ Ù…Ù…ØªØ¹.", "en": "Solve number sequences in a playful way." },
                    "game.lead": { "ar": "Ù„Ø¹Ø¨Ø© ØªÙØ§Ø¹Ù„ÙŠØ© Ù„Ù„ØªØ¹Ø±Ù‘Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù…Ø«Ø§Ù„.", "en": "An interactive game to rediscover proverbs." }
                  }
                </script>

                <script type="application/json" data-m-data data-m-path="data">
                  {
                    "activeTab": "readmeBase"
                  }
                </script>
                <div class="nav-list">
                  <button class="nav-button {state.data.activeTab === 'readmeBase' ? 'active' : ''}" onclick="switchTab('readmeBase', ctx)"><span>{trans('nav.readmeBase')}</span><span class="hint">{trans('doc.base.lead')}</span></button>
                  <button class="nav-button {state.data.activeTab === 'readmeTec' ? 'active' : ''}" onclick="switchTab('readmeTec', ctx)"><span>{trans('nav.readmeTec')}</span><span class="hint">{trans('doc.tec.lead')}</span></button>
                  <button class="nav-button {state.data.activeTab === 'counter' ? 'active' : ''}" onclick="switchTab('counter', ctx)"><span>{trans('nav.counter')}</span><span class="hint">{trans('counter.lead')}</span></button>
                  <button class="nav-button {state.data.activeTab === 'logic' ? 'active' : ''}" onclick="switchTab('logic', ctx)"><span>{trans('nav.logic')}</span><span class="hint">{trans('logic.lead')}</span></button>
                  <button class="nav-button {state.data.activeTab === 'game' ? 'active' : ''}" onclick="switchTab('game', ctx)"><span>{trans('nav.game')}</span><span class="hint">{trans('game.lead')}</span></button>
                </div>
              </div>
            </aside>

            <div class="main-column">
              <script type="application/json" data-m-data data-m-path="data.docs">
                {
                  "base": { "ar": "", "en": "" },
                  "tec": { "ar": "", "en": "" }
                }
              </script>

              <section class="panel" x-if="state.data.activeTab === 'readmeBase'">
                <header><h2>{trans('nav.readmeBase')}</h2><p>{trans('doc.language.hint')}</p></header>
                <article class="md-prose" x-html="state.data.docs.base[state.env.lang]"></article>
              </section>

              <section class="panel" x-if="state.data.activeTab === 'readmeTec'">
                <header><h2>{trans('nav.readmeTec')}</h2><p>{trans('doc.language.hint')}</p></header>
                <article class="md-prose" x-html="state.data.docs.tec[state.env.lang]"></article>
              </section>

              <section class="panel" x-if="state.data.activeTab === 'counter'">
                <script type="application/json" data-m-data data-m-path="i18n.strings">
                  {
                    "counter.title": { "ar": "Ø¹Ø¯Ø§Ø¯ Ø¨Ø³ÙŠØ·", "en": "Simple Counter" },
                    "counter.reset": { "ar": "Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·", "en": "Reset" }
                  }
                </script>

                <script type="application/json" data-m-data data-m-path="data">
                  {
                    "counter": 0
                  }
                </script>
                <header><h2>{trans('counter.title')}</h2><p>{trans('counter.lead')}</p></header>
                <div class="counter-view">
                  <button class="button secondary" onclick="updateCounter(-1, ctx)">âˆ’</button>
                  <div class="counter-display">{state.data.counter}</div>
                  <button class="button" onclick="updateCounter(+1, ctx)">+</button>
                  <button class="button secondary" onclick="resetCounter(ctx)" data-m-once>{trans('counter.reset')}</button>
                </div>
              </section>

              <script>
                function updateCounter(delta, ctx){ commit(ctx, function(next){ var value=typeof next.data.counter==='number'? next.data.counter:0; next.data.counter=value+delta; }); }
                function resetCounter(ctx){ ctx.set('data.counter', 0); rememberState(ctx); }
              </script>

              <section class="panel" x-if="state.data.activeTab === 'logic'">
                <script type="application/json" data-m-data data-m-path="i18n.strings">
                  {
                    "logic.title": { "ar": "ØªØ­Ø¯ÙŠ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§Ø³ØªÙ‚Ø±Ø§Ø¦ÙŠ", "en": "Pattern Logic Trainer" },
                    "logic.subtitle": { "ar": "Ø§Ø³ØªÙƒØ´Ù Ø§Ù„Ù…ØªØªØ§Ù„ÙŠØ§Øª ÙˆØµÙ‚Ù„ Ù…Ù‡Ø§Ø±Ø© Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ù†Ù…Ø·.", "en": "Explore sequences and sharpen your pattern sense." },
                    "logic.start": { "ar": "Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ø¯ÙŠ", "en": "Start challenge" },
                    "logic.newChallenge": { "ar": "ØªØ­Ø¯Ù Ø¬Ø¯ÙŠØ¯", "en": "New challenge" },
                    "logic.feedback.correct": { "ar": "Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©! Ù…Ù†Ø·Ù‚Ùƒ Ø­Ø§Ø¶Ø±.", "en": "Great choice! Your reasoning is sharp." },
                    "logic.feedback.wrong": { "ar": "Ù„ÙŠØ³Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.", "en": "Not quite right, try once more." }
                  }
                </script>

                <script type="application/json" data-m-data data-m-path="data.logicGame">
                  {
                    "sequence": [],
                    "options": [],
                    "answer": null,
                    "feedback": null,
                    "explain": null,
                    "selected": null
                  }
                </script>
                <header><h2>{trans('logic.title')}</h2><p>{trans('logic.subtitle')}</p></header>
                <div class="logic-sequence"><div class="term" x-for="term, idx in state.data.logicGame.sequence" key="idx">{term}</div><div class="term">?</div></div>
                <div class="logic-options">
                  <button x-for="option in state.data.logicGame.options" key="option" class="{logicOptionClass(option, state.data.logicGame)}" onclick="chooseLogic(option, ctx)">{option}</button>
                </div>
                <div class="game-feedback" x-if="state.data.logicGame.feedback">
                  <div class="card"><strong>{logicFeedbackTitle(ctx)}</strong><p>{logicFeedbackMessage(ctx)}</p></div>
                </div>
                <div class="controls" style="margin-top:1.5rem"><button class="button" onclick="startLogic(ctx, locals)">{state.data.logicGame.sequence.length ? trans('logic.newChallenge') : trans('logic.start')}</button></div>
              </section>

              <script>
                var LOGIC_GENERATORS=[
                  function arithmetic(h){ var step=h.randomBetween(2,8); var start=h.randomBetween(2,15); var length=4; var seq=[]; for(var i=0;i<length;i++){ seq.push(start + i*step); } var answer=start + length*step; var pool=h.shuffle([answer, answer+step, answer-step, answer+2*step, answer-2*step]).slice(0,4); return { type:'arithmetic', sequence:seq, answer:answer, options:pool, message:{ ar:'ØªØ²Ø¯Ø§Ø¯ Ø§Ù„Ù‚ÙŠÙ… Ø¨Ù…Ù‚Ø¯Ø§Ø± '+step+' ÙÙŠ ÙƒÙ„ Ø®Ø·ÙˆØ©.', en:'Values increase by '+step+' each step.' } }; },
                  function doubling(h){ var start=h.randomBetween(2,6); var length=4; var seq=[]; for(var i=0;i<length;i++){ seq.push(start * Math.pow(2,i)); } var answer=start * Math.pow(2,length); var pool=h.shuffle([answer, answer/2, answer*2, answer+start, answer-start]).slice(0,4); return { type:'double', sequence:seq, answer:answer, options:pool, message:{ ar:'ÙƒÙ„ Ù‚ÙŠÙ…Ø© Ø¶Ø¹Ù Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©.', en:'Each value doubles the previous one.' } }; },
                  function squares(h){ var start=h.randomBetween(2,5); var length=4; var seq=[]; for(var i=0;i<length;i++){ var base=start+i; seq.push(base*base); } var nextBase=start+length; var answer=nextBase*nextBase; var pool=h.shuffle([answer,(nextBase+1)*(nextBase+1),(nextBase-1)*(nextBase-1), answer+nextBase, answer-nextBase]).slice(0,4); return { type:'square', sequence:seq, answer:answer, options:pool, message:{ ar:'Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ Ù…Ø±Ø¨Ø¹Ø§Øª Ù…ØªØªØ§Ù„ÙŠØ© ØªØ¨Ø¯Ø£ Ù…Ù† '+start+'Â².', en:'Squares that start at '+start+'Â².' } }; }
                ];
                function logicGenerators(locals){ if(locals && Array.isArray(locals.LOGIC_GENERATORS) && locals.LOGIC_GENERATORS.length){ logicGenerators.__cache=locals.LOGIC_GENERATORS; return locals.LOGIC_GENERATORS; } if(logicGenerators.__cache && logicGenerators.__cache.length){ return logicGenerators.__cache; } var fallback=(typeof LOGIC_GENERATORS!=='undefined' && Array.isArray(LOGIC_GENERATORS))? LOGIC_GENERATORS: []; logicGenerators.__cache=fallback; return fallback; }
                function logicOptionClass(option, game){ if(!game || !game.feedback) return ''; if(option===game.answer) return 'correct'; if(game.selected===option) return 'wrong'; return ''; }
                function logicFeedbackTitle(ctx){ var state=ctx.getState(); var game=state && state.data && state.data.logicGame; if(!game || !game.feedback) return ''; var type=game.feedback.type==='correct'?'correct':'wrong'; var key= type==='correct'? 'logic.feedback.correct':'logic.feedback.wrong'; var emoji= type==='correct'? 'âœ… ':'âš ï¸ '; return emoji + ctx.trans(key); }
                function logicFeedbackMessage(ctx){ var state=ctx.getState(); var game=state && state.data && state.data.logicGame; if(!game || !game.feedback) return ''; var msg=game.feedback.message; var lang=(state.env && state.env.lang)||'ar'; if(typeof msg==='function') return msg(lang); if(typeof msg==='string') return msg; if(msg && typeof msg==='object') return msg[lang] || msg.ar || msg.en || ''; return ''; }
                function buildLogicChallenge(locals){ var pool=logicGenerators(locals); if(!Array.isArray(pool) || !pool.length) return null; var pick=pool[Math.floor(Math.random()*pool.length)]; if(typeof pick!=='function') return null; return pick({ randomBetween: randomBetween, shuffle: shuffle }); }
                function startLogic(ctx, locals){ var challenge=buildLogicChallenge(locals); if(!ctx || !challenge) return; commit(ctx, function(next){ var logic=next.data.logicGame; logic.sequence=challenge.sequence; logic.options=challenge.options; logic.answer=challenge.answer; logic.feedback=null; logic.explain=challenge.message; logic.selected=null; }); }
                function chooseLogic(option, ctx){ commit(ctx, function(next){ var logic=next.data.logicGame; if(!Array.isArray(logic.options)||!logic.options.length) return; if(logic.feedback && logic.feedback.type==='correct') return; var isCorrect= option===logic.answer; logic.selected=option; logic.feedback={ type: isCorrect? 'correct':'wrong', message: logic.explain }; }); }
              </script>

              <section class="panel" x-if="state.data.activeTab === 'game'">
                <script type="application/json" data-m-data data-m-path="i18n.strings">
                  {
                    "game.title": { "ar": "Ù„Ø¹Ø¨Ø© Ø§Ù„Ø£Ù…Ø«Ø§Ù„ ÙˆØ§Ù„Ø­ÙƒÙ…", "en": "Proverbs & Wisdom Game" },
                    "game.subtitle": { "ar": "Ø§ÙƒØªØ´Ù Ø§Ù„Ø­ÙƒÙ…Ø© Ø¨Ø­Ø±ÙˆÙ Ø¹Ø±Ø¨ÙŠØ© ÙˆØªØ­Ø¯ÙŠØ§Øª Ø°ÙƒÙŠØ©.", "en": "Unveil wisdom through Arabic letters and smart challenges." },
                    "game.timeLabel": { "ar": "Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ", "en": "Time left" },
                    "game.tries": { "ar": "Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª", "en": "Tries" },
                    "game.statusLabel": { "ar": "Ø§Ù„Ø­Ø§Ù„Ø©", "en": "Status" },
                    "game.status.idle": { "ar": "Ø¬Ø§Ù‡Ø²Ø©", "en": "Ready" },
                    "game.status.running": { "ar": "Ù‚ÙŠØ¯ Ø§Ù„Ù„Ø¹Ø¨", "en": "Running" },
                    "game.status.won": { "ar": "Ø§Ù†ØªØµØ§Ø±", "en": "Victory" },
                    "game.status.lost": { "ar": "Ø®Ø³Ø§Ø±Ø©", "en": "Defeat" },
                    "game.start": { "ar": "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©", "en": "Start game" },
                    "game.new": { "ar": "Ù…Ø«Ù„ Ø¬Ø¯ÙŠØ¯", "en": "New proverb" },
                    "game.musicOn": { "ar": "Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰ Ù…ÙØ¹Ù‘Ù„Ø©", "en": "Music on" },
                    "game.musicOff": { "ar": "Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰ Ù…ØªÙˆÙ‚ÙØ©", "en": "Music off" },
                    "game.timerOn": { "ar": "Ø§Ù„Ù…Ø¤Ù‚Øª Ù†Ø´Ø·", "en": "Timer on" },
                    "game.timerOff": { "ar": "Ø§Ù„Ù…Ø¤Ù‚Øª Ù…ØªÙˆÙ‚Ù", "en": "Timer off" },
                    "game.timerSeconds": { "ar": "Ø¹Ø¯Ø¯ Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ", "en": "Seconds" },
                    "game.hintTitle": { "ar": "Ø§Ù„ØªÙ„Ù…ÙŠØ­ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ", "en": "Educational hint" },
                    "game.solution": { "ar": "Ø§Ù„Ø­Ù„ Ø§Ù„ÙƒØ§Ù…Ù„", "en": "Full solution" },
                    "game.explanation": { "ar": "Ø§Ù„Ø´Ø±Ø­", "en": "Explanation" },
                    "game.lesson": { "ar": "Ø§Ù„Ø¹Ø¨Ø±Ø©", "en": "Lesson" },
                    "game.source": { "ar": "Ø§Ù„Ù…ØµØ¯Ø±", "en": "Source" },
                    "game.feedback.correct": { "ar": "Ø£Ø­Ø³Ù†Øª! Ø±Ù ØµØ­ÙŠØ­.", "en": "Great! Correct letter." },
                    "game.feedback.wrong": { "ar": "Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ù… ØªØµØ¨ Ø§Ù„Ù‡Ø¯Ù.", "en": "That guess missed the mark." },
                    "game.feedback.win": { "ar": "Ø¥Ø¨Ø¯Ø§Ø¹! Ø§ÙƒØªÙ…Ù„Øª Ø§Ù„Ø­ÙƒÙ…Ø©.", "en": "Brilliant! Wisdom unveiled." },
                    "game.feedback.lose": { "ar": "Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§ØªØŒ Ù„Ø§ Ø¨Ø£Ø³ Ø£Ù† ØªÙƒØ´Ù Ø§Ù„Ø­ÙƒÙ…Ø©.", "en": "No tries left, time to reveal the wisdom." },
                    "game.reveal": { "ar": "Ø§ÙƒØªØ´Ù Ø§Ù„Ø­ÙƒÙ…Ø©", "en": "Reveal wisdom" }
                  }
                </script>

                <script type="application/json" data-m-data data-m-path="data">
                  {
                    "alphabet": ["Ø§","Ø¨","Øª","Ø«","Ø¬","Ø­","Ø®","Ø¯","Ø°","Ø±","Ø²","Ø³","Ø´","Øµ","Ø¶","Ø·","Ø¸","Ø¹","Øº","Ù","Ù‚","Ùƒ","Ù„","Ù…","Ù†","Ùˆ","Ù‡","Ø©","Ø¡","ÙŠ","Ù‰"],
                    "game": {
                      "musicOn": true,
                      "timerOn": true,
                      "timerSec": 45,
                      "timeLeft": 45,
                      "triesMax": 5,
                      "triesLeft": 5,
                      "audioList": [
                        { "name": "Ghost Stories", "url": "https://www.fesliyanstudios.com/musicfiles/2020-10-26_-_Ghost_Stories_-_www.FesliyanStudios.com_Steve_Oxen/2020-10-26_-_Ghost_Stories_-_www.FesliyanStudios.com_Steve_Oxen.mp3" },
                        { "name": "The Unsolved Mystery", "url": "https://www.fesliyanstudios.com/musicfiles/2018-07-22_-_The_Unsolved_Murder_-_David_Fesliyan.mp3" },
                        { "name": "Dark Shadows", "url": "https://www.fesliyanstudios.com/musicfiles/2020-06-25_-_Dark_Shadows_-_www.FesliyanStudios.com_David_Fesliyan.mp3" }
                      ],
                      "audioIdx": 0,
                      "proverb": null,
                      "guessed": {},
                      "status": "idle",
                      "revealSolution": false,
                      "feedback": null,
                      "proverbs": [
                        { "t": "Ø±Ø¬Ø¹ Ø¨Ø®ÙÙŠ Ø­Ù†ÙŠÙ†", "hint": "ÙŠÙÙ‚Ø§Ù„ Ù„Ù…Ù† Ø¹Ø§Ø¯ Ø¨Ù„Ø§ Ù†ØªÙŠØ¬Ø©.", "explanation": "ØªØ­ÙƒÙŠ Ø§Ù„Ù‚ØµØ© Ø¹Ù† Ø±Ø¬Ù„ ÙØ´Ù„ ÙÙŠ Ù…ÙØ§ÙˆØ¶Ø© Ø¥Ø³ÙƒØ§ÙÙŠ ÙØ¹Ø§Ø¯ Ø®Ø§Ù„ÙŠ Ø§Ù„ÙˆÙØ§Ø¶ ÙˆÙ‚Ø¯ ÙÙ‚Ø¯ Ù†Ø¹Ù„ÙŠÙ‡ØŒ ÙØµØ§Ø± Ù…Ø«Ù„Ø§Ù‹ Ø¹Ù† Ø§Ù„Ø®ÙŠØ¨Ø© Ø¨Ø¹Ø¯ Ù…Ø´Ù‚Ø©.", "lesson": "Ø§Ù„ØªØ®Ø·ÙŠØ· ÙˆØ§Ù„Ù…Ø±ÙˆÙ†Ø© ÙÙŠ Ø§Ù„ØªÙØ§ÙˆØ¶ ÙŠØ­Ù…ÙŠØ§Ù† Ù…Ù† Ø¶ÙŠØ§Ø¹ Ø§Ù„Ø¬Ù‡Ø¯.", "source": "Ù…Ø«Ù„ Ø¹Ø±Ø¨ÙŠ Ù‚Ø¯ÙŠÙ…" },
                        { "t": "Ø®ÙŠØ± Ø§Ù„ÙƒÙ„Ø§Ù… Ù…Ø§ Ù‚Ù„ ÙˆØ¯Ù„", "hint": "ÙŠØªØ¹Ù„Ù‚ Ø¨ÙØµØ§Ø­Ø© Ø§Ù„ØªØ¹Ø¨ÙŠØ±.", "explanation": "ÙŠØ´Ø¬Ø¹ Ø§Ù„Ù…Ø«Ù„ Ø¹Ù„Ù‰ Ø§Ø®ØªÙŠØ§Ø± ÙƒÙ„Ù…Ø§Øª Ù‚Ù„ÙŠÙ„Ø© Ù„ÙƒÙ†Ù‡Ø§ Ù…Ø¹Ø¨Ø±Ø© ÙˆÙˆØ§Ø¶Ø­Ø© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¥Ø·Ø§Ù„Ø© Ø§Ù„Ù…Ù…Ù„Ø©.", "lesson": "Ø§Ù„Ø¥ÙŠØ¬Ø§Ø² Ø§Ù„ÙˆØ§Ø¶Ø­ ÙŠØ¨Ù†ÙŠ ØªÙˆØ§ØµÙ„Ø§Ù‹ Ø£Ù‚ÙˆÙ‰.", "source": "Ø­ÙƒÙ…Ø© Ø¹Ø±Ø¨ÙŠØ© Ù‚Ø¯ÙŠÙ…Ø©" },
                        { "t": "Ø§Ù„ØµØ¨Ø± Ù…ÙØªØ§Ø­ Ø§Ù„ÙØ±Ø¬", "hint": "ÙŠØ¯Ø¹Ùˆ Ù„Ù„ØªØ±ÙŠØ«.", "explanation": "ÙŠØ¹Ù„Ù…Ù†Ø§ Ø§Ù„Ù…Ø«Ù„ Ø£Ù† Ø¶ÙŠÙ‚ Ø§Ù„Ù„Ø­Ø¸Ø© Ù„Ø§ ÙŠØ¯ÙˆÙ… ÙˆØ£Ù† Ø§Ù„ØµØ¨Ø± ÙŠÙØªØ­ Ø£Ø¨ÙˆØ§Ø¨ Ø§Ù„Ø­Ù„ÙˆÙ„.", "lesson": "Ø§Ù„Ù‡Ø¯ÙˆØ¡ ÙˆØ§Ù„Ø«Ø¨Ø§Øª ÙŠÙ…Ù†Ø­Ø§Ù† Ø±Ø¤ÙŠØ© Ø£ÙˆØ¶Ø­.", "source": "Ø­ÙƒÙ…Ø© Ø±ÙˆØ­Ø§Ù†ÙŠØ©" }
                      ],
                      "soundEffects": {
                        "correct": "https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3",
                        "wrong": "https://assets.mixkit.co/sfx/preview/mixkit-failure-arcade-alert-notification-240.mp3",
                        "win": "https://assets.mixkit.co/sfx/preview/mixkit-small-crowd-cheer-and-applause-518.mp3",
                        "lose": "https://assets.mixkit.co/sfx/preview/mixkit-game-over-dark-2068.mp3"
                      }
                    }
                  }
                </script>
                <header><h2>{trans('game.title')}</h2><p>{trans('game.subtitle')}</p></header>
                <div class="game-board">
                  <div class="puzzle-row"><div class="{tileClass(ch, state.data.game)}" x-for="ch, idx in state.data.game.proverb ? state.data.game.proverb.t.split('') : []" key="idx">{tileContent(ch, state.data.game)}</div></div>
                  <div class="letters-grid"><button x-for="letter in state.data.alphabet" key="letter" class="{letterClass(letter, state.data.game)}" onclick="chooseLetter(letter, ctx)">{letter}</button></div>
                  <div class="game-controls">
                    <div class="control-row">
                      <span class="toggle"><input type="checkbox" onclick="toggleMusic(event, ctx)" checked="{state.data.game.musicOn ? 'checked' : null}" /><span>{state.data.game.musicOn ? trans('game.musicOn') : trans('game.musicOff')}</span></span>
                      <select onchange="selectTrack(event, ctx)"><option x-for="track, idx in state.data.game.audioList" key="track.url" value="{idx}" selected="{idx === state.data.game.audioIdx ? 'selected' : null}">{track.name}</option></select>
                      <div class="status-block" style="margin-inline-start:auto"><strong>â¤ï¸</strong><div class="hearts-row"><span x-for="i in range(state.data.game.triesMax)" key="i">{i < state.data.game.triesLeft ? 'â¤ï¸' : 'ğŸ¤'}</span></div></div>
                    </div>
                    <div class="control-row">
                      <span class="toggle"><input type="checkbox" onclick="toggleTimer(event, ctx)" checked="{state.data.game.timerOn ? 'checked' : null}" /><span>{state.data.game.timerOn ? trans('game.timerOn') : trans('game.timerOff')}</span></span>
                      <label>{trans('game.timerSeconds')} <input type="number" min="5" max="300" value="{state.data.game.timerSec}" onchange="setTimerSeconds(event, ctx)" /></label>
                    </div>
                  </div>
                  <div class="game-feedback">
                    <div class="card" x-if="state.data.game.feedback"><strong>{gameFeedbackTitle(ctx)}</strong><p>{gameFeedbackMessage(ctx)}</p></div>
                    <div class="card" x-if="state.data.game.proverb"><strong>ğŸ’¡ {trans('game.hintTitle')}</strong><p>{state.data.game.proverb.hint}</p></div>
                    <div class="card" x-if="state.data.game.revealSolution && state.data.game.proverb"><strong>ğŸ“œ {trans('game.solution')}</strong><p>{trans('game.explanation')}: {state.data.game.proverb.explanation}</p><p>{trans('game.lesson')}: {state.data.game.proverb.lesson}</p><p class="hint">{trans('game.source')}: {state.data.game.proverb.source}</p></div>
                  </div>
                  <audio class="hidden" x-if="state.data.game.musicOn && state.data.game.status === 'running'" src="{state.data.game.audioList[state.data.game.audioIdx].url}" autoplay loop></audio>
                  <audio class="hidden" x-if="state.data.game.feedback && state.data.game.feedback.sound" src="{state.data.game.feedback.sound}" autoplay></audio>
                </div>
                <div class="controls" style="margin-top:1.5rem">
                  <button class="button" onclick="startGame(ctx)">{state.data.game.status === 'running' ? trans('game.new') : trans('game.start')}</button>
                  <button class="button secondary" x-if="state.data.game.status === 'lost'" onclick="revealSolution(ctx)">{trans('game.reveal')}</button>
                </div>
              </section>

              <script>
                function normalizeLetter(ch){ return String(ch||'').replace(/[Ø£Ø¥Ø¢]/g,'Ø§'); }
                function tileClass(ch, game){ if(ch===' ') return 'puzzle-tile space'; var norm=normalizeLetter(ch); var revealed=game && game.guessed && game.guessed[norm]; return 'puzzle-tile' + (revealed? ' revealed':''); }
                function tileContent(ch, game){ if(ch===' ') return ''; var norm=normalizeLetter(ch); return game && game.guessed && game.guessed[norm]? ch: 'â€¢'; }
                function letterClass(letter, game){ if(!game) return ''; var norm=normalizeLetter(letter); return game.guessed && game.guessed[norm]? 'used': ''; }
                function gameFeedbackTitle(ctx){ var state=ctx.getState(); var game=state && state.data && state.data.game; if(!game || !game.feedback) return ''; var emojiMap={correct:'âœ…',wrong:'âš ï¸',win:'ğŸ†',lose:'ğŸ’”'}; var keyMap={correct:'game.feedback.correct',wrong:'game.feedback.wrong',win:'game.feedback.win',lose:'game.feedback.lose'}; var type=game.feedback.type; var emoji=emojiMap[type]||'âœ¨'; var key=keyMap[type]||'game.feedback.correct'; return emoji+' '+ctx.trans(key); }
                function gameFeedbackMessage(ctx){ var state=ctx.getState(); var game=state && state.data && state.data.game; if(!game || !game.feedback) return ''; var keyMap={correct:'game.feedback.correct',wrong:'game.feedback.wrong',win:'game.feedback.win',lose:'game.feedback.lose'}; var key=keyMap[game.feedback.type]||'game.feedback.correct'; return ctx.trans(key); }
                function isSolved(game){ if(!game || !game.proverb) return false; var text=game.proverb.t||''; return text.split('').every(function(ch){ return ch===' ' || game.guessed[normalizeLetter(ch)]; }); }
                function startGame(ctx){ var env=runtime(); if(env.stopTimer) env.stopTimer(); commit(ctx, function(next){ var game=next.data.game; if(!game) return; var list=Array.isArray(game.proverbs)? game.proverbs: []; var proverb=list.length? list[Math.floor(Math.random()*list.length)]: null; game.proverb=proverb; game.guessed={}; game.triesLeft=game.triesMax; game.status='running'; game.revealSolution=false; game.feedback=null; game.timeLeft= game.timerOn ? game.timerSec: 0; }, function(state, context){ var env=runtime(); if(env.applyEnvironment) env.applyEnvironment(state); if(state.data.game.timerOn && state.data.game.status==='running' && env.startTimer){ env.startTimer(context); } }); }
                function chooseLetter(letter, ctx){ commit(ctx, function(next){ var game=next.data.game; if(!game || game.status!=='running') return; var sounds=game.soundEffects || {}; var norm=normalizeLetter(letter); if(game.guessed[norm]) return; game.guessed[norm]=true; var hasLetter= game.proverb && game.proverb.t.split('').some(function(ch){ return normalizeLetter(ch)===norm; }); if(!hasLetter){ game.triesLeft=Math.max(0, game.triesLeft-1); game.feedback={ type:'wrong', sound: sounds.wrong || ''}; } else { game.feedback={ type:'correct', sound: sounds.correct || ''}; } if(isSolved(game)){ game.status='won'; game.revealSolution=true; game.feedback={ type:'win', sound: sounds.win || ''}; if(game.timerOn){ game.timeLeft= typeof game.timeLeft==='number'? game.timeLeft: game.timerSec; } } else if (game.triesLeft<=0){ game.status='lost'; game.revealSolution=true; game.feedback={ type:'lose', sound: sounds.lose || ''}; } }, function(state){ var env=runtime(); var game=state.data.game; if(game.status!=='running' && env.stopTimer){ env.stopTimer(); } }); }
                function toggleMusic(event, ctx){ var checked=!!(event && event.target && event.target.checked); ctx.set('data.game.musicOn', checked); rememberState(ctx); }
                function selectTrack(event, ctx){ var idx=parseInt(event && event.target && event.target.value,10); if(!Number.isFinite(idx)) idx=0; commit(ctx, function(next){ var list=next.data.game.audioList||[]; next.data.game.audioIdx=Math.max(0, Math.min(idx, list.length-1)); }); }
                function toggleTimer(event, ctx){ var checked=!!(event && event.target && event.target.checked); var env=runtime(); if(env.stopTimer) env.stopTimer(); commit(ctx, function(next){ var game=next.data.game; game.timerOn=checked; game.timeLeft= checked? game.timerSec: 0; if(!checked && game.status==='running'){ game.status='idle'; } }, function(state, context){ if(state.data.game.status==='running' && state.data.game.timerOn && runtime().startTimer){ runtime().startTimer(context); } }); }
                function setTimerSeconds(event, ctx){ var value=parseInt(event && event.target && event.target.value,10); if(!Number.isFinite(value)) return; value=Math.min(300, Math.max(5, value)); commit(ctx, function(next){ var game=next.data.game; game.timerSec=value; if(game.timerOn){ game.timeLeft=value; } }); }
                function revealSolution(ctx){ ctx.set('data.game.revealSolution', true); rememberState(ctx); }
              </script>

            </div>
          </div>
        </div>

        <div class="settings-modal" x-if="state.data.settingsOpen" onclick="closeSettings(event, ctx)">
          <div class="settings-body" onclick="event.stopPropagation()">
            <script type="application/json" data-m-data data-m-path="i18n.strings">
              {
                "settings.title": { "ar": "Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¸Ù‡Ø±", "en": "Appearance settings" },
                "settings.fontLabel": { "ar": "Ø­Ø¬Ù… Ø§Ù„Ø®Ø·", "en": "Font scale" },
                "settings.background": { "ar": "Ø§Ù„Ø®Ù„ÙÙŠØ©", "en": "Background" },
                "settings.reset": { "ar": "Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ", "en": "Reset defaults" },
                "settings.close": { "ar": "ØªÙ…", "en": "Done" }
              }
            </script>

            <script type="application/json" data-m-data data-m-path="data">
              {
                "settingsOpen": false,
                "themePrefs": { "fontScale": 100, "background": "nebula" },
                "backgrounds": [
                  {
                    "id": "nebula",
                    "label": { "ar": "Ø´ÙÙ‚ Ø¨Ù†ÙØ³Ø¬ÙŠ", "en": "Violet nebula" },
                    "light": {
                      "gradient": "linear-gradient(160deg, #f8f9ff 0%, #e8ecff 100%)",
                      "overlay1": "radial-gradient(circle at 20% 25%, rgba(79, 70, 229, 0.18), transparent 55%)",
                      "overlay2": "radial-gradient(circle at 80% 70%, rgba(14, 165, 233, 0.18), transparent 50%)"
                    },
                    "dark": {
                      "gradient": "linear-gradient(160deg, #0d1224 0%, #111c3d 100%)",
                      "overlay1": "radial-gradient(circle at 80% 30%, rgba(168, 85, 247, 0.22), transparent 55%)",
                      "overlay2": "radial-gradient(circle at 15% 80%, rgba(56, 189, 248, 0.18), transparent 55%)"
                    }
                  },
                  {
                    "id": "sunset",
                    "label": { "ar": "ØºØ±ÙˆØ¨ Ø°Ù‡Ø¨ÙŠ", "en": "Golden sunset" },
                    "light": {
                      "gradient": "linear-gradient(145deg, #fff7ed 0%, #fde68a 100%)",
                      "overlay1": "radial-gradient(circle at 25% 20%, rgba(251, 191, 36, 0.24), transparent 55%)",
                      "overlay2": "radial-gradient(circle at 75% 80%, rgba(249, 115, 22, 0.18), transparent 55%)"
                    },
                    "dark": {
                      "gradient": "linear-gradient(145deg, #1f172a 0%, #312e81 100%)",
                      "overlay1": "radial-gradient(circle at 25% 20%, rgba(147, 51, 234, 0.24), transparent 55%)",
                      "overlay2": "radial-gradient(circle at 75% 80%, rgba(234, 179, 8, 0.18), transparent 55%)"
                    }
                  }
                ]
              }
            </script>
            <h3>{trans('settings.title')}</h3>
            <div class="settings-grid">
              <label>{trans('settings.fontLabel')} ({state.data.themePrefs.fontScale}%)<input type="range" min="85" max="130" step="5" value="{state.data.themePrefs.fontScale}" onchange="setFontScale(event, ctx)" /></label>
              <label>{trans('settings.background')}<select onchange="setBackgroundPreset(event, ctx)"><option x-for="preset in state.data.backgrounds" key="preset.id" value="{preset.id}" selected="{preset.id === state.data.themePrefs.background ? 'selected' : null}">{preset.label[state.env.lang] || preset.label.ar}</option></select></label>
            </div>
            <div class="settings-actions"><button class="button secondary" onclick="resetThemePrefs(ctx)">{trans('settings.reset')}</button><button class="button" onclick="toggleSettings(ctx)">{trans('settings.close')}</button></div>
          </div>
        </div>
      </div>

      <script>
        function closeSettings(event, ctx){ if(event && event.target && event.currentTarget && event.target!==event.currentTarget) return; ctx.set('data.settingsOpen', false); rememberState(ctx); }
        function setFontScale(event, ctx){ var value=parseInt(event && event.target && event.target.value,10); if(!Number.isFinite(value)) return; commit(ctx, function(next){ next.data.themePrefs.fontScale=value; }, function(state){ var env=runtime(); if(env.applyThemePrefs) env.applyThemePrefs(state); if(env.persistPrefs) env.persistPrefs(state); }); }
        function setBackgroundPreset(event, ctx){ var id= event && event.target && event.target.value; commit(ctx, function(next){ next.data.themePrefs.background=id; }, function(state){ var env=runtime(); if(env.applyThemePrefs) env.applyThemePrefs(state); if(env.persistPrefs) env.persistPrefs(state); }); }
        function resetThemePrefs(ctx){ var defaults= defaultThemePrefs(); commit(ctx, function(next){ next.data.themePrefs=defaults; }, function(state){ var env=runtime(); if(env.applyThemePrefs) env.applyThemePrefs(state); if(env.persistPrefs) env.persistPrefs(state); }); }
      </script>

            <script>
        // ====== ÙˆØ¸Ø§Ø¦Ù Ù…Ø­Ù„ÙŠØ© Ù…Ø´ØªØ±ÙƒØ© Ø¯Ø§Ø®Ù„ template ======
        function runtime(){ return ensureRuntimeGlobals(); }
        function cloneState(prev){ return JSON.parse(JSON.stringify(prev || {})); }
        function rememberState(ctx){ try{ window.__INDEX_STATE__ = ctx.getState(); }catch(_){} }
        function commit(ctx, mutate, after){ if(!ctx) return; ctx.setState(function(prev){ var next = cloneState(prev); if(typeof mutate==='function'){ mutate(next, prev||{}); } return next; }); window.setTimeout(function(){ rememberState(ctx); if(typeof after==='function'){ after(ctx.getState(), ctx); } },0); }
        function randomBetween(min, max){ return Math.floor(Math.random() * (max - min + 1)) + min; }
        function shuffle(arr){ var copy = arr.slice(); for(var i=copy.length-1;i>0;i--){ var j=Math.floor(Math.random()*(i+1)); var tmp=copy[i]; copy[i]=copy[j]; copy[j]=tmp; } return copy; }
        function defaultThemePrefs(){ return { fontScale: 100, background: 'nebula' }; }
        function range(count){ var len=Math.max(0, Number(count)||0), out=[]; for(var i=0;i<len;i++) out.push(i); return out; }

        function ensureRuntimeGlobals(){
          var runtimeGlobals = window.__INDEX_RUNTIME = window.__INDEX_RUNTIME || {};
          var STORAGE_KEY = runtimeGlobals.storageKey || 'mishkah:htmlx:index:prefs';
          runtimeGlobals.storageKey = STORAGE_KEY;

          if (typeof runtimeGlobals.persistPrefs !== 'function') {
            runtimeGlobals.persistPrefs = function(state){
              try{
                var payload={ theme: state.env && state.env.theme, lang: state.env && state.env.lang, dir: state.env && state.env.dir, themePrefs: state.data && state.data.themePrefs };
                window.localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
              }catch(_){ }
            };
          }

          runtimeGlobals.applyThemePrefs = function(state){
            var prefs=(state.data && state.data.themePrefs) || defaultThemePrefs();
            var scale=prefs.fontScale || 100;
            document.documentElement.style.setProperty('--user-font-scale', String(scale));
            var presets = (state.data && state.data.backgrounds) || [];
            var fallback = presets[0] || { light:{}, dark:{} };
            var preset = presets.find(function(p){ return p && p.id===prefs.background; }) || fallback;
            var palette = state.env && state.env.theme==='dark'? (preset && preset.dark) : (preset && preset.light);
            if(palette){
              if(palette.gradient) document.documentElement.style.setProperty('--page-gradient', palette.gradient);
              if(palette.overlay1) document.documentElement.style.setProperty('--page-overlay-1', palette.overlay1);
              if(palette.overlay2) document.documentElement.style.setProperty('--page-overlay-2', palette.overlay2);
            }
          };

          runtimeGlobals.applyEnvironment = function(state){
            var lang=(state.env && state.env.lang) || 'ar';
            document.documentElement.lang = lang;
            document.documentElement.dir = (state.env && state.env.dir) || (lang==='ar' ? 'rtl':'ltr');
            document.documentElement.classList.toggle('dark', !!(state.env && state.env.theme==='dark'));
            runtimeGlobals.applyThemePrefs(state);
          };

          runtimeGlobals.stopTimer = function(){
            if(runtimeGlobals._activeTimer){
              window.clearInterval(runtimeGlobals._activeTimer);
              runtimeGlobals._activeTimer=null;
            }
          };

          runtimeGlobals.startTimer = function(ctx){
            runtimeGlobals.stopTimer();
            runtimeGlobals._activeTimer = window.setInterval(function(){ tickTimer(ctx); }, 1000);
          };

          return runtimeGlobals;
        }

        function readStoredPrefs(storageKey){
          if(!storageKey) return {};
          try{
            var raw=window.localStorage.getItem(storageKey);
            if(!raw) return {};
            var parsed=JSON.parse(raw);
            return parsed && typeof parsed==='object'? parsed: {};
          }catch(_){ return {}; }
        }

        function extractDocs(){
          var host=window.Mishkah || {};
          var source=host.readme || {};
          function esc(value){ return String(value || ''); }
          return {
            base: {
              ar: esc(source.base && source.base.ar),
              en: esc((source.base && source.base.en) || (source.base && source.base.ar) || '')
            },
            tec: {
              ar: esc(source.tec && source.tec.ar),
              en: esc((source.tec && source.tec.en) || (source.tec && source.tec.ar) || '')
            }
          };
        }

        function collectExternalProverbs(){
          var list = window.PROVERBS;
          if(!Array.isArray(list) || !list.length) return null;
          return list.map(function(item){
            if(item && typeof item==='object'){
              var copy={};
              for(var key in item){
                if(Object.prototype.hasOwnProperty.call(item, key)) copy[key]=item[key];
              }
              return copy;
            }
            return item;
          });
        }

        function mergeStoredPreferences(database, stored){
          if(!database || typeof database!=='object' || !stored || typeof stored!=='object') return;
          database.env = database.env && typeof database.env==='object'? database.env: {};
          var env = database.env;
          if(stored.lang){
            env.lang=stored.lang;
            env.dir=stored.dir || (stored.lang==='ar'? 'rtl':'ltr');
          }
          if(stored.dir){
            env.dir=stored.dir;
          }
          if(stored.theme){
            env.theme=stored.theme;
          }
          database.data = database.data && typeof database.data==='object'? database.data: {};
          if(stored.themePrefs && typeof stored.themePrefs==='object'){
            var base = database.data.themePrefs && typeof database.data.themePrefs==='object'? database.data.themePrefs: defaultThemePrefs();
            database.data.themePrefs = Object.assign({}, base, stored.themePrefs);
          }
        }

        function mergeDocs(database, docs){
          if(!database || typeof database!=='object' || !docs) return;
          database.data = database.data && typeof database.data==='object'? database.data: {};
          database.data.docs = docs;
        }

        function mergeExternalProverbs(database, list){
          if(!database || typeof database!=='object' || !Array.isArray(list) || !list.length) return;
          database.data = database.data && typeof database.data==='object'? database.data: {};
          database.data.game = database.data.game && typeof database.data.game==='object'? database.data.game: {};
          database.data.game.proverbs = list.slice();
        }

        function applySnapshotEnvironment(snapshot){
          var runtimeGlobals = ensureRuntimeGlobals();
          if(runtimeGlobals.applyEnvironment) runtimeGlobals.applyEnvironment(snapshot);
        }

        function __bootstrap__(database){
          if(!database || typeof database!=='object') return;
          var runtimeGlobals = ensureRuntimeGlobals();
          var stored = readStoredPrefs(runtimeGlobals.storageKey);
          mergeStoredPreferences(database, stored);
          mergeDocs(database, extractDocs());
          mergeExternalProverbs(database, collectExternalProverbs());
          var snapshot = { env: database.env || {}, data: database.data || {} };
          applySnapshotEnvironment(snapshot);
          if(runtimeGlobals.persistPrefs) runtimeGlobals.persistPrefs(snapshot);
          window.__INDEX_STATE__ = {};
        }

        function __init__(ctx){
          var runtimeGlobals = ensureRuntimeGlobals();
          if(!ctx || typeof ctx.getState!=='function') return;
          rememberState(ctx);
          var state = ctx.getState();
          if(runtimeGlobals.applyEnvironment) runtimeGlobals.applyEnvironment(state);
          if(runtimeGlobals.persistPrefs) runtimeGlobals.persistPrefs(state);
        }

        function tickTimer(ctx){
          if(!ctx || typeof ctx.getState!=='function') return;
          var runtimeGlobals = ensureRuntimeGlobals();
          var current=ctx.getState();
          var game=current.data && current.data.game;
          if(!game || !game.timerOn || game.status!=='running'){
            runtimeGlobals.stopTimer();
            return;
          }
          ctx.setState(function(prev){
            var next=cloneState(prev||{});
            var g=next.data.game;
            if(!g.timerOn || g.status!=='running') return prev;
            var nextTime=(typeof g.timeLeft==='number'? g.timeLeft: g.timerSec) - 1;
            g.timeLeft=Math.max(0,nextTime);
            if(g.timeLeft<=0){
              g.status='lost';
              g.revealSolution=true;
              var effects=(next.data && next.data.game && next.data.game.soundEffects)||{};
              g.feedback={ type:'lose', sound: effects.lose };
              runtimeGlobals.stopTimer();
            }
            return next;
          });
          window.setTimeout(function(){ rememberState(ctx); },0);
        }
      </script>
    </template>

    <!-- Ø§Ù„Ù†ÙˆØ§Ø© -->
    <script src="./mishkah-utils.js"></script>
    <script src="./mishkah.core.js"></script>
    <script src="./readme.js"></script>
    <script src="./dist/mishkah-htmlx.js"></script>

    <script>
      (function (window) {
        'use strict';
        var M = window.Mishkah;
        if (!M || !M.HTMLxAgent) { console.error('Mishkah HTMLx agent is required.'); return; }

        var start = M.HTMLxAgent.make();
        Promise.resolve(start).catch(function (error) {
          console.error('Failed to start Mishkah HTMLx index:', error);
        });
      })(window);
    </script>
  </body>
</html>
