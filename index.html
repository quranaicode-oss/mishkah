<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <title>مشكاة — تبويبات + لعبة الأمثال</title>

  <script src="./mishkah-utils.js"></script>
  <script src="./mishkah.core.js"></script>
  <script src="./mishkah-ui.js"></script>
  <script src="./readme.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      color-scheme: light dark;
      --page-gradient: linear-gradient(160deg, #f8f9ff 0%, #e8ecff 100%);
      --page-overlay-1: radial-gradient(circle at 20% 25%, rgba(79, 70, 229, 0.18), transparent 55%);
      --page-overlay-2: radial-gradient(circle at 80% 70%, rgba(14, 165, 233, 0.18), transparent 50%);
      --panel-glass: rgba(255, 255, 255, 0.78);
      --panel-border: rgba(99, 102, 241, 0.12);
      --panel-shadow: 0 25px 50px -20px rgba(15, 23, 42, 0.18);
      --tile-bg: linear-gradient(160deg, rgba(255, 255, 255, 0.95), rgba(241, 245, 249, 0.85));
      --tile-bg-revealed: linear-gradient(160deg, rgba(129, 140, 248, 0.75), rgba(79, 70, 229, 0.65));
      --tile-border: rgba(99, 102, 241, 0.25);
      --letters-shadow: 0 18px 45px -24px rgba(15, 23, 42, 0.35);
      --letters-hover: 0 25px 50px -20px rgba(99, 102, 241, 0.45);
      --accent-ring: rgba(79, 70, 229, 0.18);
      --tile-size: 3.1rem;
    }

    :root.dark {
      --page-gradient: linear-gradient(160deg, #0d1224 0%, #111c3d 100%);
      --page-overlay-1: radial-gradient(circle at 80% 30%, rgba(168, 85, 247, 0.22), transparent 55%);
      --page-overlay-2: radial-gradient(circle at 15% 80%, rgba(56, 189, 248, 0.18), transparent 55%);
      --panel-glass: rgba(17, 25, 40, 0.75);
      --panel-border: rgba(148, 163, 184, 0.32);
      --panel-shadow: 0 25px 50px -18px rgba(15, 23, 42, 0.55);
      --tile-bg: linear-gradient(160deg, rgba(30, 41, 59, 0.78), rgba(15, 23, 42, 0.92));
      --tile-bg-revealed: linear-gradient(160deg, rgba(99, 102, 241, 0.55), rgba(79, 70, 229, 0.38));
      --tile-border: rgba(148, 163, 184, 0.35);
      --letters-shadow: 0 20px 40px -18px rgba(148, 163, 184, 0.35);
      --letters-hover: 0 28px 60px -20px rgba(99, 102, 241, 0.6);
      --accent-ring: rgba(129, 140, 248, 0.35);
    }

    @media (min-width: 640px) {
      :root { --tile-size: 3.25rem; }
    }

    @media (min-width: 1024px) {
      :root { --tile-size: 3.4rem; }
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      height: 100vh;
      font-family: 'Tajawal', 'Cairo', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--page-gradient);
      color: var(--foreground);
      position: relative;
      overflow: hidden;
      transition: background 0.45s ease, color 0.45s ease;
    }

    body::before,
    body::after {
      content: '';
      position: absolute;
      inset: 0;
      z-index: 0;
      pointer-events: none;
      background: var(--page-overlay-1);
      mix-blend-mode: screen;
      animation: pulseNebula 18s ease-in-out infinite alternate;
    }

    body::after {
      background: var(--page-overlay-2);
      animation-delay: 6s;
    }

    #app {
      position: relative;
      z-index: 1;
    }

    .app-shell {
      min-height: 100vh;
      max-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .content-shell {
      flex: 1;
      min-height: 0;
      display: flex;
      overflow: hidden;
    }

    .main-region {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      padding-bottom: 4rem;
      scroll-behavior: smooth;
    }

    .glass-panel {
      background: var(--panel-glass);
      backdrop-filter: blur(26px) saturate(135%);
      border: 1px solid var(--panel-border);
      box-shadow: var(--panel-shadow);
      transition: border-color 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
    }

    .glow-outline {
      box-shadow: 0 0 0 1px var(--accent-ring), var(--panel-shadow);
    }

    .animate-float {
      animation: floatHalo 14s ease-in-out infinite;
    }

    .letter-tile {
      transition: transform 0.35s ease, box-shadow 0.35s ease, background 0.35s ease;
      border: 1px solid var(--tile-border);
      background: var(--tile-bg);
      color: var(--foreground);
      text-shadow: 0 2px 12px rgba(15, 23, 42, 0.2);
    }

    .letter-slot {
      width: var(--tile-size);
      height: var(--tile-size);
    }

    .letter-space {
      width: calc(var(--tile-size) * 0.5);
      height: var(--tile-size);
    }

    .letter-tile[data-revealed="true"] {
      transform: translateY(-6px) scale(1.03);
      box-shadow: 0 18px 40px -22px rgba(79, 70, 229, 0.55);
      background: var(--tile-bg-revealed);
      color: #fff;
    }

    .letters-grid button {
      transition: transform 0.25s ease, box-shadow 0.25s ease, opacity 0.25s ease;
      box-shadow: var(--letters-shadow);
      font-size: 1.25rem;
      font-weight: 700;
      border-radius: 0.9rem !important;
      height: var(--tile-size);
      min-height: var(--tile-size);
      min-width: var(--tile-size);
    }

    .letters-grid button:hover:not([disabled]) {
      transform: translateY(-5px) scale(1.03);
      box-shadow: var(--letters-hover);
    }

    .letters-grid button[disabled] {
      opacity: 0.35;
      cursor: not-allowed;
    }

    .md-prose {
      line-height: 1.8;
      font-size: 1rem;
      color: var(--foreground);
    }

    .md-prose h1,
    .md-prose h2,
    .md-prose h3,
    .md-prose h4,
    .md-prose h5,
    .md-prose h6 {
      font-family: 'Cairo', 'Tajawal', system-ui, sans-serif;
      font-weight: 700;
      letter-spacing: 0.01em;
      color: color-mix(in oklab, var(--foreground) 92%, var(--primary) 8%);
      margin: 1.6em 0 0.8em;
    }

    .md-prose p {
      margin: 1em 0;
      color: color-mix(in oklab, var(--foreground) 88%, var(--muted-foreground) 12%);
    }

    .md-prose ul,
    .md-prose ol {
      margin: 1em 0;
      padding-inline-start: 1.4em;
      display: flex;
      flex-direction: column;
      gap: 0.5em;
    }

    .md-prose li {
      position: relative;
      padding-inline-start: 0.3em;
    }

    .md-prose blockquote {
      margin: 1.2em 0;
      padding: 1.2em 1.5em;
      border-inline-start: 4px solid color-mix(in oklab, var(--primary) 80%, transparent);
      background: color-mix(in oklab, var(--surface-1) 80%, transparent);
      border-radius: 1.2rem;
      color: color-mix(in oklab, var(--foreground) 80%, var(--muted-foreground) 20%);
      box-shadow: 0 12px 30px -24px rgba(79, 70, 229, 0.45);
    }

    .md-prose pre {
      margin: 1.4em 0;
      padding: 1.2em 1.4em;
      border-radius: 1.2rem;
      background: color-mix(in oklab, var(--surface-2) 88%, transparent);
      box-shadow: 0 24px 45px -24px rgba(15, 23, 42, 0.45);
      overflow-x: auto;
      font-size: 0.92rem;
      direction: ltr;
      text-align: left;
    }

    .md-prose code {
      font-family: 'Fira Code', 'IBM Plex Mono', 'Cascadia Code', monospace;
      background: color-mix(in oklab, var(--surface-2) 85%, transparent);
      padding: 0.15em 0.4em;
      border-radius: 0.5em;
      font-size: 0.92em;
    }

    .md-prose pre code {
      background: transparent;
      padding: 0;
    }

    .md-prose table {
      width: 100%;
      border-collapse: collapse;
      margin: 1.5em 0;
      border-radius: 1.2rem;
      overflow: hidden;
      box-shadow: 0 18px 45px -25px rgba(15, 23, 42, 0.35);
    }

    .md-prose thead {
      background: color-mix(in oklab, var(--surface-2) 55%, var(--primary) 45%);
      color: color-mix(in oklab, var(--primary-foreground) 65%, var(--foreground) 35%);
    }

    .md-prose th,
    .md-prose td {
      padding: 0.85em 1em;
      border: 1px solid color-mix(in oklab, var(--border) 60%, transparent);
      text-align: start;
    }

    .md-prose tbody tr:nth-child(even) {
      background: color-mix(in oklab, var(--surface-1) 80%, transparent);
    }

    .md-prose img {
      max-width: 100%;
      height: auto;
      display: inline-block;
      vertical-align: middle;
    }

    .settings-tile {
      border-radius: 1.5rem;
      padding: 1rem 1.25rem;
      background: color-mix(in oklab, var(--surface-2) 70%, transparent);
      border: 1px solid color-mix(in oklab, var(--border) 55%, transparent);
      box-shadow: 0 12px 35px -22px rgba(15, 23, 42, 0.35);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.75rem;
    }

    .game-panel {
      position: relative;
    }

    .game-board {
      position: relative;
      transition: transform 0.35s ease;
    }

    .puzzle-row {
      animation-duration: 0.6s;
      animation-timing-function: ease-in-out;
    }

    .game-board.feedback-correct .puzzle-row {
      animation-name: tilePop;
    }

    .game-board.feedback-wrong .puzzle-row {
      animation-name: tileShake;
    }

    .game-board.feedback-win .puzzle-row {
      animation-name: tileCelebrate;
    }

    .game-board.feedback-lose .puzzle-row {
      animation-name: tileFade;
    }

    .celebration-card,
    .gameover-card {
      position: relative;
      overflow: hidden;
    }

    .celebration-card::after {
      content: '';
      position: absolute;
      inset: -40%;
      background: radial-gradient(circle at 50% 20%, rgba(79, 70, 229, 0.25), transparent 55%);
      opacity: 0.8;
      animation: pulseNebula 8s ease-in-out infinite;
      pointer-events: none;
    }

    .gameover-card::after {
      content: '';
      position: absolute;
      inset: -30%;
      background: radial-gradient(circle at 50% 80%, rgba(239, 68, 68, 0.25), transparent 65%);
      opacity: 0.7;
      animation: overlayPulse 6s ease-in-out infinite;
      pointer-events: none;
    }

    .game-overlay-content {
      position: relative;
      z-index: 1;
    }

    .confetti-layer {
      position: fixed;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      z-index: 25;
    }

    .confetti-piece {
      position: absolute;
      top: -10vh;
      width: 0.55rem;
      height: 1.6rem;
      border-radius: 999px;
      opacity: 0;
      animation: confettiFall 3.6s ease-in forwards;
    }

    .confetti-piece:nth-child(odd) {
      animation-duration: 4s;
    }

    .md-prose a {
      color: var(--primary);
      text-decoration: none;
      border-bottom: 1px solid color-mix(in oklab, var(--primary) 65%, transparent);
      transition: color 0.2s ease, border-color 0.2s ease;
    }

    .md-prose a:hover {
      color: color-mix(in oklab, var(--primary) 90%, black);
      border-color: currentColor;
    }

    .md-prose hr {
      margin: 2.5em 0;
      border: none;
      border-top: 1px dashed color-mix(in oklab, var(--border) 65%, transparent);
    }

    @keyframes floatHalo {
      0%, 100% { transform: translate3d(0, 0, 0); }
      50% { transform: translate3d(0, -18px, 0) scale(1.01); }
    }

    @keyframes pulseNebula {
      0% { opacity: 0.45; }
      50% { opacity: 0.75; }
      100% { opacity: 0.45; }
    }

    @keyframes tilePop {
      0% { transform: scale(0.94); }
      40% { transform: scale(1.06); }
      100% { transform: scale(1); }
    }

    @keyframes tileShake {
      0%, 100% { transform: translateX(0); }
      20% { transform: translateX(-8px); }
      40% { transform: translateX(8px); }
      60% { transform: translateX(-6px); }
      80% { transform: translateX(6px); }
    }

    @keyframes tileCelebrate {
      0% { transform: translateY(0) scale(1); }
      30% { transform: translateY(-10px) scale(1.05); }
      70% { transform: translateY(4px) scale(0.98); }
      100% { transform: translateY(0) scale(1); }
    }

    @keyframes tileFade {
      0% { opacity: 1; }
      100% { opacity: 0.6; }
    }

    @keyframes overlayPulse {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 0.6; }
    }

    @keyframes confettiFall {
      0% { opacity: 0; transform: translate3d(0, -20vh, 0) rotate(0deg); }
      10% { opacity: 1; }
      100% { opacity: 0; transform: translate3d(0, 110vh, 0) rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
  (function(){
    const M = Mishkah, U = M.utils, UI = M.UI, D = M.DSL;
    const { tw } = U.twcss;
    const { makeLangLookup } = U.lang;

    /*
    ================================================================
    |                                                              |
    |      بسم الله الرحمن الرحيم: رحلة الخلق في "مشكاة"             |
    |                                                              |
    ================================================================
    |
    | إن بناء هذا التطبيق ليس مجرد كتابة كود، بل هو محاكاة لرحلة
    | الخلق والتكوين كما تصفها فلسفة "مشكاة". سنمر بمرحلتين
    | أساسيتين، كل مرحلة تتكون من زوجين:
    |
    | 1. الزوج الأول: التصميم والتسوية (تخطيط الجسد)
    |    - الركن الأول: الطين والذرات (Atoms as Components)
    |    - الركن الثاني: العلم الفطري (database as DNA)
    |    النتيجة: جسد مُصوَّر (VDOM) قبل نفخ الروح.
    |
    | 2. الزوج الثاني: التمكين والتكليف (نفخ الروح والحياة)
    |    - الركن الأول: الإيمان (database as State)
    |    - الركن الثاني: العمل الصالح (Orders)
    |    النتيجة: كائن حي متكامل يتفاعل ويستجيب.
    |
    */

    // ================================================================
    // المرحلة التمهيدية: جمع المادة الخام للمعرفة
    // قبل الخلق، نجمع كل المواد الأولية: النصوص، البيانات، والقواعد.
    // ================================================================

    /* ===================== i18n: المعاجم اللغوية ===================== */
    const dict = {
      'app.title'   : { ar:'مشكاة — مشكاة النور ولعبة الأمثال', en:'Mishkah — Lighthouse Docs & Proverbs Game' },
      'header.subtitle': { ar:'مرجع النور يجمع الوثائق، الإعدادات، ولعبة الأمثال في لوحة واحدة واسعة.', en:'A radiant hub that unifies the docs, controls, and the Proverbs game in a spacious canvas.' },
      'nav.menu'       : { ar:'التنقل', en:'Navigation' },
      'nav.readmeBase' : { ar:'مشكاة النور والذكر الأعلى', en:'Mishkah of Light & Highest Remembrance' },
      'nav.readmeTec'  : { ar:'وثيقة مشكاة التقنية', en:'Mishkah Technical Charter' },
      'nav.counter'    : { ar:'العداد', en:'Counter' },
      'nav.game'       : { ar:'لعبة الأمثال', en:'Proverbs Game' },
      'doc.base.lead'  : { ar:'رحلة فلسفة مشكاة ومنهج الذكر الأعلى الذي ألهم تصميمها.', en:'The philosophical journey behind Mishkah and the higher remembrance that inspires it.' },
      'doc.tec.lead'   : { ar:'الدليل التقني الكامل لمعمارية مشكاة ومحركها التعريفي.', en:'The complete technical dossier for Mishkah’s architecture and declarative engine.' },
      'doc.language.hint': { ar:'بدّل اللغة من الأعلى لتقرأ الوثيقة بلغتك المفضلة.', en:'Use the header controls to switch between Arabic and English.' },
      'counter.title'  : { ar:'عداد بسيط', en:'Simple Counter' },
      'counter.reset'  : { ar:'إعادة', en:'Reset' },
      'game.title'     : { ar:'لعبة الأمثال و الحكم', en:'Proverbs & Wisdom Game' },
      'game.music'     : { ar:'الموسيقى الغامرة', en:'Mystery Music' },
      'game.timer'     : { ar:'مؤقت التعلم', en:'Learning Timer' },
      'game.seconds'   : { ar:'ث', en:'s' },
      'game.start'     : { ar:'ابدأ اللعبة', en:'Start Game' },
      'game.new'       : { ar:'مثل جديد', en:'New Proverb' },
      'game.tries'     : { ar:'المحاولات المتبقية', en:'Tries Left' },
      'game.hintTitle' : { ar:'التلميح التعليمي', en:'Educational Hint' },
      'game.win'       : { ar:'ربحت! 🎉', en:'You won! 🎉' },
      'game.lose'      : { ar:'للأسف خسرت 🙈', en:'You lost 🙈' },
      'game.reveal'    : { ar:'اكتشف الحكمة', en:'Reveal Wisdom' },
      'game.solution'  : { ar:'الحل الكامل', en:'Full Solution' },
      'game.explanation':{ ar:'شرح المثل', en:'Explanation' },
      'game.lesson'    : { ar:'ما نتعلمه', en:'Key Lesson' },
      'game.source'    : { ar:'المصدر', en:'Source' },
      'game.timeLabel' : { ar:'الوقت المتبقي', en:'Time Left' },
      'game.letters'   : { ar:'الأحرف المتاحة', en:'Available Letters' },
      'game.statusLabel': { ar:'حالة اللعبة', en:'Game Status' },
      'game.status.idle': { ar:'جاهزة', en:'Ready' },
      'game.status.running': { ar:'قيد اللعب', en:'In Progress' },
      'game.status.won' : { ar:'انتصار', en:'Victory' },
      'game.status.lost': { ar:'خسارة', en:'Defeat' },
      'game.feedback.correct': { ar:'أحسنت! حرف صحيح يقترب بك من الحكمة.', en:'Great job! A correct letter brings you closer to the wisdom.' },
      'game.feedback.wrong'  : { ar:'هذه المحاولة لم تصب الهدف، جرّب مسارًا آخر.', en:'That guess missed the mark—try another path.' },
      'game.feedback.win'    : { ar:'إبداع! اكتملت الحكمة بالكامل.', en:'Brilliant! The proverb has been unveiled.' },
      'game.feedback.lose'   : { ar:'انتهت المحاولات، لكن الحكمة ما زالت بانتظارك.', en:'The tries are over, yet the wisdom still awaits you.' },
      'game.lastMove'        : { ar:'ردة فعل فورية', en:'Instant Feedback' },
      'game.musicOn'         : { ar:'الموسيقى مفعّلة', en:'Music On' },
      'game.musicOff'        : { ar:'الموسيقى متوقفة', en:'Music Off' },
      'game.timerOn'         : { ar:'المؤقت نشط', en:'Timer Enabled' },
      'game.timerOff'        : { ar:'المؤقت متوقف', en:'Timer Disabled' },
      'game.overlay.winTitle'    : { ar:'مبروك! لقد فزت 🎉', en:'Bravo! You Won 🎉' },
      'game.overlay.winSubtitle' : { ar:'جهدك أثمر حكمة مضيئة.', en:'Your effort blossomed into shining wisdom.' },
      'game.overlay.loseTitle'   : { ar:'انتهت المحاولات', en:'Game Over' },
      'game.overlay.loseSubtitle': { ar:'لا تيأس، الحكمة تُكافئ من يعاود المحاولة.', en:'Do not despair—the wisdom rewards another try.' },
      'game.rewardTitle'     : { ar:'مكافأة الحكمة', en:'Wisdom Reward' },
      'game.tryAgain'        : { ar:'حاول مجددًا', en:'Try Again' },
      'game.playAgain'       : { ar:'العب مرة أخرى', en:'Play Again' },
      'game.revealPrompt'    : { ar:'انقر لاكتشاف الحكمة كاملة بعد نهاية الجولة.', en:'Tap to reveal the full wisdom after the round ends.' }
    };

    /* ===================== Markdown: المحتوى المعرفي ===================== */
    const readmeStore = M.readme || {};
    const DOCS = {
      base:{
        ar: (readmeStore.base && readmeStore.base.ar) || '',
        en: (readmeStore.base && readmeStore.base.en) || (readmeStore.base && readmeStore.base.ar) || ''
      },
      tec:{
        ar: (readmeStore.tec && readmeStore.tec.ar) || '',
        en: (readmeStore.tec && readmeStore.tec.en) || (readmeStore.tec && readmeStore.tec.ar) || ''
      }
    };

    /* ===================== Game Data: بيانات اللعبة ===================== */
    const PROVERBS = [
      {
        t:"رجع بخفي حنين",
        hint:"يُقال لمن عاد بلا نتيجة",
        explanation:"تحكي القصة عن رجل فشل في مفاوضة إسكافي فعاد خالي الوفاض وقد فقد نعليه، فصار مثلاً عن الخيبة بعد مشقة.",
        lesson:"التخطيط والمرونة في التفاوض يحميان من ضياع الجهد بلا ثمر.",
        source:"مثل عربي قديم"
      },
      {
        t:"الي اختشوا ماتوا",
        hint:"يُنتقد فيه ذهاب الحياء",
        explanation:"نشأ في مصر زمن الحريق حين فضلت بعض النساء المحافظة على حيائهن فمُتن، فصار كناية عن تبدل الأحوال وغياب الخجل.",
        lesson:"حياء المجتمع ينعكس على سلوكه واستقراره.",
        source:"مثل مصري شعبي"
      },
      {
        t:"اقلب القدرة على فمها تطلع البنت لامها",
        hint:"يشير للشبه بين الأجيال",
        explanation:"يعبر المثل عن أن الفتاة غالبًا ما تشبه أمها في الطباع والسلوك مهما حاولت الاختلاف.",
        lesson:"القدوة الأسرية تترك بصمتها العميقة على الأبناء.",
        source:"تراث شعبي مصري"
      },
      {
        t:"ابنك على ما تربيه و جوزك على ما تعوديه",
        hint:"فيه حديث عن أثر التربية",
        explanation:"يوضح المثل أن السلوك الذي نزرعه في الأبناء والأزواج ينعكس علينا في المعاملة والنتائج.",
        lesson:"التربية الواعية والعلاقة الطيبة تصنع استقرار الأسرة.",
        source:"مثل عربي متداول"
      },
      {
        t:"ما حك جلدك مثل ظفرك",
        hint:"دعوة للاعتماد على الذات",
        explanation:"يشجع المثل على القيام بالعمل بنفسك لأنك الأحرص على مصلحتك والأقدر على إدراك حاجتك.",
        lesson:"المبادرة الذاتية تُختصر بها الطرق وتتحقق النجاحات.",
        source:"مثل عربي فصيح"
      },
      {
        t:"خير الكلام ما قل ودل",
        hint:"يتعلق بفصاحة التعبير",
        explanation:"يحُث المثل على اختيار كلمات قليلة لكنها معبرة وواضحة بدل الإطالة المملة.",
        lesson:"الإيجاز الواضح يبني تواصلًا أقوى وأكثر تأثيرًا.",
        source:"حكمة عربية قديمة"
      },
      {
        t:"الخبر الي انهرده بفلوس بكرة يبقى ببلاش",
        hint:"يتناول سرعة انتشار الأخبار",
        explanation:"يُقال عن أسرار اليوم التي سرعان ما يعرفها الجميع، فلا جدوى من شراء ما سيشيع بلا ثمن.",
        lesson:"الحذر من التسريب وتقدير قيمة المعلومة في وقتها.",
        source:"مثل شعبي مصري"
      },
      {
        t:"من طلب العلا سهر الليالي",
        hint:"يتحدث عن الاجتهاد",
        explanation:"يدعو المثل إلى المثابرة وبذل الجهد الطويل لتحقيق الأهداف السامية.",
        lesson:"الطموح يتحقق بالعمل والصبر لا بالتمني.",
        source:"حكمة تعليمية"
      },
      {
        t:"الي بيشيل قربة مخرومة بتخر على راسه",
        hint:"تحذير من الإهمال",
        explanation:"يضرب لمن يتهاون في إصلاح الخلل فيعود عليه بالخسارة والمشقة.",
        lesson:"علاج المشكلة الصغيرة مبكرًا يمنع كوارث أكبر لاحقًا.",
        source:"مثل شعبي شاملي"
      },
      {
        t:"ادي العيش لخبازه ولو كل نصه",
        hint:"يشير إلى التخصص",
        explanation:"يوصي المثل بإسناد الأمور لأهل الخبرة حتى لو كلف الأمر؛ فالنتيجة ستكون أضمن وأجود.",
        lesson:"الثقة بالمتخصصين تضمن جودة المخرجات وتختصر الوقت.",
        source:"مثل عربي دارج"
      },
      {
        t:"لا تؤجل عمل اليوم إلى الغد",
        hint:"محاربة التسويف",
        explanation:"ينبه المثل إلى خطورة تأجيل الأعمال لأن تراكمها يسبب ضياع الفرص والاضطراب.",
        lesson:"الإنجاز الفوري يفتح أبواب النجاح ويقلل التوتر.",
        source:"حكمة إدارية عالمية"
      },
      {
        t:"الوقت كالسيف ان لم تقطعه قطعك",
        hint:"يؤكد على قيمة الزمن",
        explanation:"يشبه المثل الوقت بالسيف الحاد الذي إن لم نحسن استخدامه سيوقع بنا الخسارة.",
        lesson:"إدارة الوقت محور أساسي للتفوق في الحياة.",
        source:"مثل عربي مأثور"
      },
      {
        t:"الصبر مفتاح الفرج",
        hint:"يدعو للتريث",
        explanation:"يعلمنا المثل أن ضيق اللحظة لا يدوم وأن الصبر يفتح أبواب الحلول المتوقعة وغير المتوقعة.",
        lesson:"الهدوء والثبات يمنحاننا رؤية أوضح للفرص المختبئة.",
        source:"حكمة عربية روحانية"
      },
      {
        t:"من جد وجد ومن زرع حصد",
        hint:"يرتبط بالعمل الجاد",
        explanation:"يجمع المثل بين بذل الجهد وقطف الثمار كعلاقة سببية لا مفر منها.",
        lesson:"الاجتهاد المستمر يثمر مهما طال الزمن.",
        source:"قول مأثور في التربية"
      },
      {
        t:"في التأني السلامة وفي العجلة الندامة",
        hint:"يحذر من التسرع",
        explanation:"يظهر المثل أن التأني يمنح السلامة بينما العجلة غير المحسوبة تجر الندم.",
        lesson:"التروّي قبل القرارات المصيرية يجنّب الأخطاء الكبيرة.",
        source:"مثل عربي مشترك"
      },
      {
        t:"إذا تم العقل نقص الكلام",
        hint:"يمجد الصمت الحكيم",
        explanation:"يرى المثل أن اكتمال الحكمة يجعل صاحبها قليل الكلام لأنه يزن العبارات.",
        lesson:"الوعي بذاتك يجعلك تختار كلماتك بعناية.",
        source:"حكمة منسوبة للإمام علي"
      },
      {
        t:"إذا عرف السبب بطل العجب",
        hint:"عن فهم الخلفيات",
        explanation:"يؤكد المثل أن معرفة الأسباب تزيل الغرابة وتكشف منطق الأحداث.",
        lesson:"التحليل العميق للأحداث يمنحنا حلاً أدق وقرارًا أصوب.",
        source:"مثل عربي قديم"
      },
      {
        t:"درهم وقاية خير من قنطار علاج",
        hint:"يشجع الوقاية",
        explanation:"يدعو المثل للاستثمار في الوقاية من الخطر قبل وقوعه لأن العلاج لاحقًا مكلف ومُرهق.",
        lesson:"الاستباق والتخطيط يقللان الخسائر المادية والمعنوية.",
        source:"حكمة طبية شائعة"
      },
      {
        t:"لا يموت الذئب ولا تفنى الغنم",
        hint:"يرصد التعارض بين مصلحتين",
        explanation:"يضرب لمن يحاول الجمع بين متضادين دون تضحية، وهو أمر مستحيل غالبًا.",
        lesson:"القرارات الجادة تستلزم اختيارًا واضحًا وتضحية محسوبة.",
        source:"مثل بدوي"
      },
      {
        t:"إذا كان الكلام من فضة فالسكوت من ذهب",
        hint:"يفاضل بين الكلام والصمت",
        explanation:"يشدد المثل على قيمة الصمت في مواضع الحكمة مقارنة بالكلام الزائد.",
        lesson:"اختيار اللحظة المناسبة للكلام مهارة قيادية مهمة.",
        source:"قول مأثور عربي"
      },
      {
        t:"رب ضارة نافعة",
        hint:"يرى الخير في الابتلاء",
        explanation:"يوضح المثل أن المصائب قد تحمل في طياتها فرصًا وألطافًا لا نراها للوهلة الأولى.",
        lesson:"تغيير زاوية النظر يحوّل المحن إلى منح وعبر.",
        source:"حكمة إسلامية شائعة"
      },
      {
        t:"العلم نور",
        hint:"يُشيد بالمعرفة",
        explanation:"يشبه المثل العلم بالنور الذي يبدد الظلام ويهدي العقول إلى الصواب.",
        lesson:"التعلم المستمر يفتح الآفاق ويصون الإنسان من الجهل.",
        source:"قول تربوي مأثور"
      },
      {
        t:"ليس الفتى من قال كان أبي",
        hint:"يحث على الإنجاز الشخصي",
        explanation:"يرفض المثل الاتكاء على أمجاد الآباء ويدعو لصناعة مجد ذاتي.",
        lesson:"هوية الإنسان تبنى بجهده لا بنسبه فحسب.",
        source:"بيت من شعر المتنبي"
      },
      {
        t:"من شب على شيء شاب عليه",
        hint:"يتعلق بالعادات",
        explanation:"يؤكد المثل أن ما ينشأ عليه الإنسان في صغره يستمر غالبًا معه حتى الكبر.",
        lesson:"تشكيل العادات الإيجابية مبكرًا استثمار طويل الأمد.",
        source:"مثل عربي دارج"
      },
      {
        t:"عند الامتحان يكرم المرء أو يهان",
        hint:"عن لحظات الحسم",
        explanation:"يشير المثل إلى أن الاختبارات تكشف حقيقة الاستعداد والجدية.",
        lesson:"الاستعداد المستمر يجعل المواقف الحاسمة فرصة للتألق.",
        source:"حكمة تعليمية"
      },
      {
        t:"إذا أردت أن تطاع فأمر بما يستطاع",
        hint:"يوازن بين الطموح والقدرة",
        explanation:"يعلم المثل القادة أن التكليف بما فوق الطاقة يولد العصيان، أما الواقعية فتجلب الطاعة.",
        lesson:"الإدارة الحكيمة تراعي طاقة الفريق وحدود الموارد.",
        source:"قول منسوب لعمر بن الخطاب"
      },
      {
        t:"على قدر أهل العزم تأتي العزائم",
        hint:"عن قوة الإرادة",
        explanation:"يشير البيت إلى أن القرارات الكبيرة لا ينهض بها إلا أصحاب الهمم العالية.",
        lesson:"طموحك يحدد حجم الإنجاز الذي يمكن أن تحققه.",
        source:"من قصيدة المتنبي"
      },
      {
        t:"الطيور على أشكالها تقع",
        hint:"يتناول صحبة المتشابهين",
        explanation:"يقول المثل إن الأفراد يميلون إلى من يشبهونهم في الطباع والقيم.",
        lesson:"اختر محيطك بعناية لأنه يعكسك ويؤثر عليك.",
        source:"مثل عالمي مترجم"
      },
      {
        t:"من سار على الدرب وصل",
        hint:"يتحدث عن المثابرة",
        explanation:"يجسد المثل قيمة الاستمرار في الطريق رغم طول المسافة حتى نبلغ الهدف.",
        lesson:"المواظبة اليومية الصغيرة تصنع إنجازًا عظيمًا مع الزمن.",
        source:"حكمة تطوير ذات"
      },
      {
        t:"رحم الله امرء عرف قدر نفسه",
        hint:"حول تقدير الذات",
        explanation:"يشجع المثل على معرفة الإنسان لطاقته وحدوده حتى لا يظلم نفسه ولا يتجاوز قدرته.",
        lesson:"الوعي بالذات يساعد على اختيار ما يناسبك من فرص ومسؤوليات.",
        source:"قول مأثور عن عمر بن عبد العزيز"
      },
      {
        t:"القناعة كنز لا يفنى",
        hint:"يدعو للرضا",
        explanation:"يبين المثل أن القناعة ثروة داخلية لا تنتهي، لأنها تمنح صاحبها راحة نفسية مستدامة.",
        lesson:"تقدير النعم الحالية يجلب السكينة ويحفز العمل المتوازن.",
        source:"مثل عربي متداول"
      },
      {
        t:"إن مع العسر يسرا",
        hint:"مستمد من القرآن",
        explanation:"يرسخ المثل القرآني حقيقة أن الضيق يتبعه فرج مزدوج لمن يصبر ويأمل.",
        lesson:"الأمل والثقة بالله يثبتان القلب في مواجهة المصاعب.",
        source:"القرآن الكريم — سورة الشرح"
      }
    ];
	
    const AR_ALPHA = ['ا','ب','ت','ث','ج','ح','خ','د','ذ','ر','ز','س','ش','ص','ض','ط','ظ','ع','غ','ف','ق','ك','ل','م','ن','و','ه','ة','ء','ي','ى'];
    const norm = (ch)=> String(ch).replace(/[أإآ]/g,'ا');

    const SOUND_EFFECTS = {
      correct: 'https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3',
      wrong: 'https://assets.mixkit.co/sfx/preview/mixkit-failure-arcade-alert-notification-240.mp3',
      win: 'https://assets.mixkit.co/sfx/preview/mixkit-small-crowd-cheer-and-applause-518.mp3',
      lose: 'https://assets.mixkit.co/sfx/preview/mixkit-game-over-dark-2068.mp3'
    };


    // ================================================================
    // الزوج الأول: التصميم والتسوية (تخطيط الجسد)
    // هنا نصنع الهيكل والشكل الخارجي للتطبيق.
    // ================================================================

    // ----------------------------------------------------------------
    // الركن الأول: الطين والذرات (`Atoms` as Components)
    // هذه هي المكونات، لبنات البناء الأساسية التي تشكل جسد التطبيق.
    // كل مكون هو "ذرة" أو مجموعة "ذرات" لها شكل ووظيفة محددة.
    // ----------------------------------------------------------------
    
    function HeaderBar(db){
      const { TL } = makeLangLookup(db);
      return D.Containers.Header({ attrs:{ class: tw`px-6 pt-6 pb-4` }}, [
        D.Containers.Div({ attrs:{ class: tw`mx-auto w-full max-w-[1600px]` }}, [
          D.Containers.Div({ attrs:{ class: `${tw`rounded-3xl p-6 space-y-5`} glass-panel glow-outline` }}, [
            D.Containers.Div({ attrs:{ class: tw`flex flex-wrap items-center justify-between gap-4` }}, [
              D.Text.Span({ attrs:{ class: tw`text-xl sm:text-2xl font-bold tracking-tight` }}, [TL('app.title')]),
              D.Containers.Div({ attrs:{ class: tw`flex items-center gap-2` }}, [
                UI.Button({ attrs:{ gkey:'ui:lang-ar' }, variant:'ghost', size:'sm' }, ['AR']),
                UI.Button({ attrs:{ gkey:'ui:lang-en' }, variant:'ghost', size:'sm' }, ['EN']),
                UI.Button({ attrs:{ gkey:'ui:theme-toggle' }, variant:'soft', size:'sm' }, ['🌓'])
              ])
            ]),
            D.Text.Span({ attrs:{ class: tw`text-sm text-[var(--muted-foreground)]` }}, [TL('header.subtitle')])
          ])
        ])
      ]);
    }

    function Sidebar(db){
      const { TL } = makeLangLookup(db);
      const route = db.data.activeTab;
      const NavBtn = (id,label,icon)=>{
        const active = route===id;
        return UI.Button({
          attrs:{
            gkey:`route:${id}`,
            class:`${tw`w-full justify-start text-start rounded-2xl transition-all duration-200`} glass-panel ${active ? 'glow-outline' : 'hover:opacity-90'} ${active?'':'opacity-85'}`
          },
          variant:'ghost', size:'sm'
        }, [`${icon} `, TL(label)]);
      };
      return D.Containers.Div({ attrs:{ class: tw`space-y-4` }}, [
        D.Containers.Div({ attrs:{ class: `${tw`rounded-3xl p-4 space-y-3`} glass-panel glow-outline` }}, [
          D.Text.Span({ attrs:{ class: tw`text-sm uppercase tracking-[0.3em] text-[var(--muted-foreground)]` }}, [TL('nav.menu')]),
          D.Containers.Nav({ attrs:{ class: tw`space-y-3` }}, [
            NavBtn('readmeBase','nav.readmeBase','🌌'),
            NavBtn('readmeTec','nav.readmeTec','🛠️'),
            NavBtn('counter','nav.counter','🔢'),
            NavBtn('game','nav.game','🎮')
          ])
        ])
      ]);
    }

    function DocPanel(db, kind){
      const lang = db.env.lang || 'ar';
      const key = kind==='tec' ? 'doc.tec.lead' : 'doc.base.lead';
      const titleKey = kind==='tec' ? 'nav.readmeTec' : 'nav.readmeBase';
      const docs = db.data.docs || {};
      const store = kind==='tec' ? docs.tec || {} : docs.base || {};
      const fallback = lang==='ar' ? (store.en || '') : (store.ar || '');
      const content = store[lang] || fallback || '';
      const { TL } = makeLangLookup(db);

      return UI.Card({
        title: TL(titleKey),
        description: TL('doc.language.hint'),
        content: D.Containers.Div({ attrs:{ class: tw`space-y-4` }}, [
          D.Text.P({ attrs:{ class: tw`text-base font-semibold`, style:'color:color-mix(in oklab,var(--foreground) 92%, var(--primary) 8%);' }}, [TL(key)]),
          UI.Markdown({ content, className: tw`md-prose` })
        ])
      });
    }

    function CounterPanel(db){
      const { TL } = makeLangLookup(db);
      return UI.Card({
        title: TL('counter.title'),
        content: D.Containers.Div({ attrs:{ class: tw`flex items-center justify-center gap-3` }}, [
          UI.Button({ attrs:{ gkey:'counter:dec' }, variant:'soft', size:'sm' }, ['−']),
          D.Text.Span({ attrs:{ class: tw`text-2xl font-bold` }}, [String(db.data.counter)]),
          UI.Button({ attrs:{ gkey:'counter:inc' }, variant:'soft', size:'sm' }, ['+']),
          UI.Button({ attrs:{ gkey:'counter:reset', class:tw`ms-4` }, variant:'ghost', size:'sm' }, [TL('counter.reset')]),
        ])
      });
    }

    function GamePanel(db){
      const { TL } = makeLangLookup(db);
      const g = db.data.game;
      const showSolution = g.revealSolution || g.status==='won';

      const timeValue = !g.timerOn ? null : (g.status==='running'
        ? (typeof g.timeLeft === 'number' ? g.timeLeft : g.timerSec)
        : (g.status==='lost' ? 0 : g.timerSec));
      const timeDisplay = g.timerOn ? `${String(timeValue ?? g.timerSec)} ${TL('game.seconds')}` : '—';
      const pv = g.proverb?.t || '';
      const feedbackType = g.feedback && g.feedback.type ? g.feedback.type : 'idle';
      const feedbackStamp = g.feedback?.stamp || 0;

      const heartsRow = D.Containers.Div({ attrs:{ class: tw`flex items-center justify-center gap-1 sm:gap-2 text-2xl sm:text-3xl drop-shadow` }},
        Array.from({ length:g.triesMax }, (_,i)=>{
          const full = i < g.triesLeft;
          return D.Text.Span({ attrs:{ key:'heart-'+i, class: tw`${full?'':'opacity-35'}` }}, [full ? '❤️' : '💔']);
        })
      );

      const statsRow = D.Containers.Div({ attrs:{ class: tw`flex flex-wrap items-center justify-center gap-2 text-sm` }}, [
        UI.Badge({ attrs:{ class: tw`bg-[var(--surface-2)] text-[var(--muted-foreground)]` }, leading:'⏳', text:`${TL('game.timeLabel')}: ${timeDisplay}` }),
        UI.Badge({ attrs:{ class: tw`bg-[var(--surface-2)] text-[var(--muted-foreground)]` }, leading:'❤️', text:`${TL('game.tries')}: ${g.triesLeft}/${g.triesMax}` }),
        UI.Badge({ attrs:{ class: tw`bg-[var(--surface-2)] text-[var(--muted-foreground)]` }, leading:'🎯', text:`${TL('game.statusLabel')}: ${TL(`game.status.${g.status}`)}` })
      ]);

      const musicTile = D.Containers.Div({ attrs:{ class: 'settings-tile' }}, [
        UI.Badge({ attrs:{ class: tw`bg-transparent text-[var(--muted-foreground)]` }, leading:'🎵', text:TL('game.music') }),
        D.Containers.Div({ attrs:{ class: tw`flex items-center gap-2` }}, [
          UI.Input({ attrs:{ type:'checkbox', checked:g.musicOn, gkey:'game:music:toggle' } }),
          D.Text.Span({ attrs:{ class: tw`text-sm` }}, [TL(g.musicOn ? 'game.musicOn' : 'game.musicOff')])
        ]),
        UI.Select({ attrs:{ gkey:'game:music:select', class: tw`min-w-[180px]` }, options: g.audioList.map((it,i)=>({ value:String(i), label:it.name })) })
      ]);

      const timerTile = D.Containers.Div({ attrs:{ class: 'settings-tile' }}, [
        UI.Badge({ attrs:{ class: tw`bg-transparent text-[var(--muted-foreground)]` }, leading:'⏱️', text:TL('game.timer') }),
        D.Containers.Div({ attrs:{ class: tw`flex items-center gap-2` }}, [
          UI.Input({ attrs:{ type:'checkbox', checked:g.timerOn, gkey:'game:timer:toggle' } }),
          D.Text.Span({ attrs:{ class: tw`text-sm` }}, [TL(g.timerOn ? 'game.timerOn' : 'game.timerOff')])
        ]),
        D.Containers.Div({ attrs:{ class: tw`flex items-center gap-2` }}, [
          UI.Input({ attrs:{ type:'number', min:'5', step:'1', value:String(g.timerSec), style:'width:92px', gkey:'game:timer:value' } }),
          D.Text.Span({ attrs:{ class: tw`text-xs text-[var(--muted-foreground)]` }}, [TL('game.seconds')])
        ])
      ]);

      const settingsRow = D.Containers.Div({ attrs:{ class: tw`flex flex-wrap items-stretch gap-4` }}, [
        musicTile,
        timerTile
      ]);

      const tiles = pv.split('').map((raw, idx)=>{
        if (raw===' ') return D.Containers.Div({ attrs:{ key:'sp'+idx, class: 'letter-space' }});
        const normalized = norm(raw);
        const revealed = !!g.guessed[normalized];
        return D.Containers.Div({
          attrs:{
            key:'bx'+idx,
            class: `${tw`grid place-items-center rounded-2xl text-2xl md:text-3xl font-semibold letter-tile letter-slot`}`,
            'data-revealed': revealed ? 'true' : 'false'
          }
        }, [ revealed ? raw : '' ]);
      });

      const puzzleRow = D.Containers.Div({ attrs:{ class: `${tw`flex flex-wrap justify-center gap-3`} puzzle-row` }}, tiles);

      const letters = D.Containers.Div({ attrs:{ class: `${tw`grid grid-cols-6 sm:grid-cols-8 xl:grid-cols-10 gap-2 letters-grid`}` }}, AR_ALPHA.map((L,i)=>
        UI.Button({
          attrs:{
            key:'L'+i,
            gkey:'game:guess',
            'data-ch':L,
            disabled: g.status!=='running' || !!g.guessed[L],
            class: tw`text-xl sm:text-2xl font-extrabold tracking-wider`
          },
          variant:'soft',
          size:'lg'
        }, [L])
      ));

      const feedbackClass = feedbackType && feedbackType!=='idle' ? ` feedback-${feedbackType}` : '';

      const boardCard = D.Containers.Div({ attrs:{ class: `${tw`space-y-6`} glass-panel glow-outline p-6 rounded-3xl game-board${feedbackClass}` }}, [
        D.Containers.Div({ attrs:{ class: tw`space-y-4` }}, [
          puzzleRow,
          UI.Divider(),
          D.Containers.Div({ attrs:{ class: tw`space-y-2` }}, [
            D.Text.Strong({ attrs:{ class: tw`text-sm text-[var(--muted-foreground)]` }}, [TL('game.letters')]),
            letters
          ])
        ])
      ]);

      const heartsWrap = D.Containers.Div({ attrs:{ class: tw`flex justify-center w-full md:w-auto` }}, [heartsRow]);
      const statsWrap = D.Containers.Div({ attrs:{ class: tw`flex justify-center w-full md:justify-end` }}, [statsRow]);

      const controlCard = D.Containers.Div({ attrs:{ class: `${tw`space-y-6`} glass-panel glow-outline p-6 rounded-3xl` }}, [
        D.Containers.Div({ attrs:{ class: tw`flex flex-wrap items-center justify-between gap-4` }}, [
          D.Containers.Div({ attrs:{ class: tw`space-y-1` }}, [
            D.Text.H3({ attrs:{ class: tw`text-2xl font-bold` }}, [TL('game.title')]),
            D.Text.Span({ attrs:{ class: tw`text-sm text-[var(--muted-foreground)]` }}, [TL('game.statusLabel'), ': ', TL(`game.status.${g.status}`)])
          ]),
          D.Containers.Div({ attrs:{ class: tw`flex flex-wrap items-center gap-3` }}, [
            UI.Button({ attrs:{ gkey:'game:start', class: tw`rounded-full px-8 py-3 font-semibold tracking-wide text-base` }, variant:'destructive', size:'lg' }, [g.status==='running' ? TL('game.new') : TL('game.start')])
          ])
        ]),
        settingsRow,
        D.Containers.Div({ attrs:{ class: tw`flex flex-wrap items-center gap-4` }}, [
          heartsWrap,
          statsWrap
        ])
      ]);

      const feedbackMessages = {
        correct: TL('game.feedback.correct'),
        wrong: TL('game.feedback.wrong'),
        win: TL('game.feedback.win'),
        lose: TL('game.feedback.lose')
      };
      const feedbackIcons = { correct:'✅', wrong:'⚠️', win:'🏆', lose:'💔' };

      const infoItems = [];
      if (feedbackType !== 'idle' && feedbackMessages[feedbackType]){
        infoItems.push(
          D.Containers.Div({ attrs:{ class: `${tw`rounded-3xl p-5 space-y-3`} glass-panel`, key:'feedback-card' }}, [
            UI.Badge({ attrs:{ class: tw`w-fit` }, leading: feedbackIcons[feedbackType] || '✨', text:TL('game.lastMove') }),
            D.Text.P({ attrs:{ class: tw`text-sm text-[var(--muted-foreground)] leading-relaxed` }}, [feedbackMessages[feedbackType]])
          ])
        );
      }

      if (g.proverb){
        infoItems.push(
          D.Containers.Div({ attrs:{ class: `${tw`rounded-3xl p-5 space-y-3`} glass-panel`, key:'hint-card' }}, [
            UI.Badge({ attrs:{ class: tw`w-fit` }, leading:'💡', text:TL('game.hintTitle') }),
            D.Text.P({ attrs:{ class: tw`text-sm text-[var(--muted-foreground)] leading-relaxed` }}, [g.proverb.hint])
          ])
        );
      }

      if (!showSolution && g.status==='lost'){
        infoItems.push(
          D.Containers.Div({ attrs:{ class: `${tw`rounded-3xl p-5 space-y-4 text-center`} glass-panel`, key:'reveal-card' }}, [
            UI.Badge({ attrs:{ class: tw`w-fit mx-auto` }, leading:'🙈', text:TL('game.lose') }),
            D.Text.P({ attrs:{ class: tw`text-sm text-[var(--muted-foreground)]` }}, [TL('game.revealPrompt')]),
            UI.Button({ attrs:{ gkey:'game:reveal', class: tw`px-8 py-3 rounded-full font-semibold text-base` }, variant:'soft', size:'lg' }, [TL('game.reveal')])
          ])
        );
      }

      if (showSolution && g.proverb){
        infoItems.push(
          D.Containers.Div({ attrs:{ class: `${tw`rounded-3xl p-5 space-y-3`} glass-panel`, style:'grid-column: 1 / -1;', key:'solution-card' }}, [
            UI.Badge({ attrs:{ class: tw`w-fit` }, leading:'📜', text:TL('game.solution') }),
            D.Text.P({ attrs:{ class: tw`text-lg font-semibold` }}, [g.proverb.t]),
            D.Text.P({ attrs:{ class: tw`text-sm text-[var(--muted-foreground)]` }}, [TL('game.explanation'), ': ', g.proverb.explanation]),
            D.Text.P({ attrs:{ class: tw`text-sm text-[var(--muted-foreground)]` }}, [TL('game.lesson'), ': ', g.proverb.lesson]),
            D.Text.P({ attrs:{ class: tw`text-xs text-[var(--muted-foreground)]` }}, [TL('game.source'), ': ', g.proverb.source])
          ])
        );
      }

      let infoSection = null;
      if (infoItems.length){
        let infoClass = tw`grid gap-4`;
        if (infoItems.length >= 3) infoClass += ' ' + tw`md:grid-cols-2 xl:grid-cols-3`;
        else if (infoItems.length === 2) infoClass += ' ' + tw`md:grid-cols-2`;
        infoSection = D.Containers.Div({ attrs:{ class: infoClass }}, infoItems);
      }

      const confettiLayer = feedbackType==='win'
        ? D.Containers.Div({ attrs:{ class:'confetti-layer', key:`confetti-${feedbackStamp}` }},
            Array.from({ length: 70 }, (_,i)=>{
              const colors = ['#f97316','#38bdf8','#a855f7','#facc15','#f472b6'];
              const left = (Math.random()*100).toFixed(2);
              const delay = (Math.random()*1.2).toFixed(2);
              return D.Text.Span({ attrs:{ key:`confetti-${i}`, class:'confetti-piece', style:`left:${left}%; background:${colors[i % colors.length]}; animation-delay:${delay}s;` }});
            })
          )
        : null;

      const resultCard = g.status==='won' && g.proverb
        ? D.Containers.Div({ attrs:{ class: `${tw`rounded-3xl p-6 space-y-4 text-center`} glass-panel celebration-card` }}, [
            D.Containers.Div({ attrs:{ class: `${tw`space-y-3`} game-overlay-content` }}, [
              UI.Badge({ attrs:{ class: tw`w-fit mx-auto` }, leading:'🎉', text:TL('game.overlay.winTitle') }),
              D.Text.P({ attrs:{ class: tw`text-base text-[var(--muted-foreground)]` }}, [TL('game.overlay.winSubtitle')]),
              D.Text.P({ attrs:{ class: tw`text-lg font-semibold` }}, [g.proverb.t]),
              D.Text.P({ attrs:{ class: tw`text-sm text-[var(--muted-foreground)] leading-relaxed` }}, [TL('game.rewardTitle'), ': ', g.proverb.lesson]),
              D.Text.P({ attrs:{ class: tw`text-xs text-[var(--muted-foreground)]` }}, [TL('game.source'), ': ', g.proverb.source]),
              UI.Button({ attrs:{ gkey:'game:start', class: tw`mt-2 px-8 py-3 rounded-full font-semibold` }, variant:'destructive', size:'lg' }, [TL('game.playAgain')])
            ])
          ])
        : g.status==='lost'
        ? D.Containers.Div({ attrs:{ class: `${tw`rounded-3xl p-6 space-y-4 text-center`} glass-panel gameover-card` }}, [
            D.Containers.Div({ attrs:{ class: `${tw`space-y-3`} game-overlay-content` }}, [
              UI.Badge({ attrs:{ class: tw`w-fit mx-auto` }, leading:'🛑', text:TL('game.overlay.loseTitle') }),
              D.Text.P({ attrs:{ class: tw`text-base text-[var(--muted-foreground)]` }}, [TL('game.overlay.loseSubtitle')]),
              D.Containers.Div({ attrs:{ class: tw`flex flex-wrap items-center justify-center gap-3 pt-2` }}, [
                UI.Button({ attrs:{ gkey:'game:start', class: tw`px-7 py-3 rounded-full font-semibold` }, variant:'destructive', size:'lg' }, [TL('game.tryAgain')]),
                (!showSolution ? UI.Button({ attrs:{ gkey:'game:reveal', class: tw`px-7 py-3 rounded-full font-semibold` }, variant:'soft', size:'lg' }, [TL('game.reveal')]) : null)
              ].filter(Boolean))
            ])
          ])
        : null;

      const playItems = [resultCard, boardCard].filter(Boolean);
      const playSection = playItems.length > 1
        ? D.Containers.Div({ attrs:{ class: tw`space-y-6` }}, playItems)
        : boardCard;

      const audioNode = (g.musicOn && g.status==='running')
        ? D.Media.Audio({ attrs:{ autoplay:true, loop:true, src:g.audioList[g.audioIdx].url, class: tw`hidden`, key:`bgm-${g.soundStamp||0}` }})
        : null;

      const cueAudio = (feedbackType && feedbackType!=='idle' && SOUND_EFFECTS[feedbackType])
        ? D.Media.Audio({ attrs:{ autoplay:true, src:SOUND_EFFECTS[feedbackType], class: tw`hidden`, key:`cue-${feedbackStamp}` }})
        : null;

      return D.Containers.Div({ attrs:{ class: `${tw`relative space-y-6`} game-panel` }}, [
        confettiLayer,
        controlCard,
        playSection,
        infoSection,
        audioNode,
        cueAudio
      ].filter(Boolean));
    }

    function MainContent(db){
      const tab = db.data.activeTab;
      if (tab==='readmeBase') return DocPanel(db, 'base');
      if (tab==='readmeTec')  return DocPanel(db, 'tec');
      if (tab==='counter') return CounterPanel(db);
      if (tab==='game')    return GamePanel(db);
      return DocPanel(db, 'base');
    }
    
    // ----------------------------------------------------------------
    // الركن الثاني: العلم الفطري (`database` as DNA)
    // هذه هي قاعدة البيانات الأولية، الشفرة الوراثية للتطبيق.
    // هي تحدد الصفات الأولية والهيئة التي سيُخلق عليها الجسد.
    // ----------------------------------------------------------------
    const database = {
      env:{ theme:'dark', lang:'ar', dir:'rtl' },
      i18n:{ lang:'ar', fallback:'en', dict },
      data:{
        activeTab: 'readmeBase',
        docs: DOCS,
        counter: 0,
        game:{
          musicOn: true,
          timerOn: true,
          timerSec: 35,
          timeLeft: 0,
          triesMax: 5,
          triesLeft: 5,
          audioList: [
            { name:'Ghost Stories', url:'https://www.fesliyanstudios.com/musicfiles/2020-10-26_-_Ghost_Stories_-_www.FesliyanStudios.com_Steve_Oxen/2020-10-26_-_Ghost_Stories_-_www.FesliyanStudios.com_Steve_Oxen.mp3' },
            { name:'The Unsolved Mystery', url:'https://www.fesliyanstudios.com/musicfiles/2018-07-22_-_The_Unsolved_Murder_-_David_Fesliyan.mp3' },
            { name:'Dark Shadows', url:'https://www.fesliyanstudios.com/musicfiles/2020-06-25_-_Dark_Shadows_-_www.FesliyanStudios.com_David_Fesliyan/2020-06-25_-_Dark_Shadows_-_www.FesliyanStudios.com_David_Fesliyan.mp3' }
          ],
          audioIdx: 0,
          proverb: null,
          guessed: {},
          intervalId: null,
          status: 'idle', // idle | running | won | lost
          revealSolution: false,
          soundStamp: 0,
          feedback: null
        }
      },
      ui:{ modalOpen:false, drawerOpen:false, toasts:[] }
    };

    // ----------------------------------------------------------------
    // عملية التسوية: `setBody`
    // هنا يتم دمج "الطين" (المكونات) مع "العلم الفطري" (البيانات)
    // لإنتاج "جسد مُصوَّر" (Virtual DOM)، وهو مخطط دقيق للتطبيق
    // قبل أن تدب فيه الحياة.
    // ----------------------------------------------------------------
    Mishkah.app.setBody(function(db, h){
      db.head = { title: makeLangLookup(db).TL('app.title') };
      return UI.AppRoot({
        shell: D.Containers.Div({ attrs:{ class: `${tw`flex flex-col`} app-shell` }}, [
          HeaderBar(db),
          D.Containers.Div({ attrs:{ class: `${tw`flex-1 w-full`} content-shell` }}, [
            D.Containers.Div({ attrs:{ class: `${tw`w-full mx-auto flex flex-col lg:flex-row gap-8 px-6 pb-12 max-w-[1600px]`}` }}, [
              D.Containers.Aside({ attrs:{ class: `${tw`hidden lg:flex lg:w-[280px] lg:flex-col`}` }}, [
                D.Containers.Div({ attrs:{ class: tw`sticky top-28` }}, [ Sidebar(db) ])
              ]),
              D.Containers.Main({ attrs:{ class: `${tw`flex-1 min-h-0`} main-region`, style:'max-height:100vh;' }}, [
                D.Containers.Div({ attrs:{ class: tw`lg:hidden mb-6` }}, [ Sidebar(db) ]),
                D.Containers.Div({ attrs:{ class: tw`space-y-8` }}, [ MainContent(db) ])
              ])
            ])
          ])
        ])
      });
    });


    // ================================================================
    // الزوج الثاني: التمكين والتكليف (نفخ الروح والحياة)
    // هنا نمنح الجسد القدرة على التفاعل والنمو.
    // ================================================================

    // ----------------------------------------------------------------
    // الركن الأول: الإيمان (`database` as State)
    // نفس قاعدة البيانات التي كانت "DNA"، أصبحت الآن "الروح" الحية،
    // وهي مصدر الحقيقة الأوحد الذي يهتدي به التطبيق.
    // ----------------------------------------------------------------
    // (ملاحظة: الـ `database` معرف مسبقًا، هنا فقط نوضح دوره الجديد)

    // ----------------------------------------------------------------
    // الركن الثاني: العمل الصالح (`orders`)
    // هذه هي الأوامر والأفعال التي تحرك الجسد وتغير من حال "إيمانه".
    // كل "order" هو عمل صالح يستجيب لأحداث المستخدم ويُحدّث الحالة.
    // ----------------------------------------------------------------
    const KEEP_MAIN_SCROLL = { keepScroll:['.main-region'] };

    const orders = {
      // Routing
      'route:readmeBase':{ on:['click'], gkeys:['route:readmeBase'], handler:(e,ctx)=>{ const s=ctx.getState(); ctx.setState({...s, data:{...s.data, activeTab:'readmeBase' }}); ctx.rebuild(); }},
      'route:readmeTec' :{ on:['click'], gkeys:['route:readmeTec' ], handler:(e,ctx)=>{ const s=ctx.getState(); ctx.setState({...s, data:{...s.data, activeTab:'readmeTec'  }}); ctx.rebuild(); }},
      'route:counter'   :{ on:['click'], gkeys:['route:counter'],   handler:(e,ctx)=>{ const s=ctx.getState(); ctx.setState({...s, data:{...s.data, activeTab:'counter'}}); ctx.rebuild(); }},
      'route:game'      :{ on:['click'], gkeys:['route:game'],      handler:(e,ctx)=>{ const s=ctx.getState(); ctx.setState({...s, data:{...s.data, activeTab:'game'   }}); ctx.rebuild(); }},

      // Counter
      'counter:inc'  :{ on:['click'], gkeys:['counter:inc'],   handler:(e,ctx)=>{ const s=ctx.getState(); ctx.setState({...s, data:{...s.data, counter:s.data.counter+1 }}); ctx.rebuild(); }},
      'counter:dec'  :{ on:['click'], gkeys:['counter:dec'],   handler:(e,ctx)=>{ const s=ctx.getState(); ctx.setState({...s, data:{...s.data, counter:s.data.counter-1 }}); ctx.rebuild(); }},
      'counter:reset':{ on:['click'], gkeys:['counter:reset'], handler:(e,ctx)=>{ const s=ctx.getState(); ctx.setState({...s, data:{...s.data, counter:0 }}); ctx.rebuild(); }},

      // Game toggles
      'game:music:toggle':{ on:['change'], gkeys:['game:music:toggle'], handler:(e,ctx)=>{
        const s=ctx.getState(); const g=s.data.game; const on = !!e.target.checked;
        const stamp = on ? Date.now() : g.soundStamp;
        ctx.setState({...s, data:{...s.data, game:{...g, musicOn:on, soundStamp: stamp }}}); ctx.rebuild(KEEP_MAIN_SCROLL);
      }},
      'game:music:select':{ on:['change'], gkeys:['game:music:select'], handler:(e,ctx)=>{
        const s=ctx.getState(); const g=s.data.game; const idx=Math.max(0,parseInt(e.target.value,10)||0);
        ctx.setState({...s, data:{...s.data, game:{...g, audioIdx: idx, soundStamp: Date.now() }}}); ctx.rebuild(KEEP_MAIN_SCROLL);
      }},
      'game:timer:toggle':{ on:['change'], gkeys:['game:timer:toggle'], handler:(e,ctx)=>{
        const s=ctx.getState(); const g=s.data.game; const on=!!e.target.checked; if(!on && g.intervalId) try{ clearInterval(g.intervalId); }catch(_){ }
        const timeLeft = on ? (g.status==='running' ? (typeof g.timeLeft === 'number' && g.timeLeft>0 ? g.timeLeft : g.timerSec) : g.timerSec) : 0;
        ctx.setState({...s, data:{...s.data, game:{...g, timerOn:on, timeLeft, intervalId: on ? g.intervalId : null }}}); ctx.rebuild(KEEP_MAIN_SCROLL);
      }},
      'game:timer:value':{ on:['input','change'], gkeys:['game:timer:value'], handler:(e,ctx)=>{
        const s=ctx.getState(); const g=s.data.game; const v=Math.max(5, parseInt(e.target.value,10)||g.timerSec);
        const timeLeft = g.timerOn ? (g.status==='running' ? v : v) : g.timeLeft;
        ctx.setState({...s, data:{...s.data, game:{...g, timerSec: v, timeLeft }}}); ctx.rebuild(KEEP_MAIN_SCROLL);
      }},

      // Start / New game
      'game:start':{ on:['click'], gkeys:['game:start'], handler:(e,ctx)=>{
        const s0=ctx.getState(); const g0=s0.data.game; if (g0.intervalId) try{ clearInterval(g0.intervalId); }catch(_){}
        const pv = PROVERBS[Math.floor(Math.random()*PROVERBS.length)];
        const stamp = Date.now();
        const baseTime = g0.timerOn ? g0.timerSec : 0;
        const g1 = { ...g0, proverb: pv, guessed:{}, triesLeft:g0.triesMax, status:'running', timeLeft: baseTime, intervalId:null, revealSolution:false, soundStamp: stamp, feedback:null };
        ctx.setState({ ...s0, data:{ ...s0.data, game:g1 } }); ctx.rebuild(KEEP_MAIN_SCROLL);

        if (g1.timerOn) {
          const iid = setInterval(()=>{
            const s=ctx.getState(); const g=s.data.game; if (g.status!=='running') { clearInterval(iid); return; }
            let timeLeft = typeof g.timeLeft === 'number' ? g.timeLeft - 1 : g.timerSec - 1;
            let triesLeft = g.triesLeft;
            let status = g.status;
            let feedback = g.feedback;
            if (timeLeft <= 0) {
              triesLeft = Math.max(0, triesLeft - 1);
              if (triesLeft === 0) {
                status = 'lost';
                timeLeft = 0;
                if (g.intervalId) try{ clearInterval(g.intervalId); }catch(_){}
                clearInterval(iid);
                feedback = { type:'lose', stamp: Date.now() };
              } else {
                timeLeft = g.timerSec;
                feedback = { type:'wrong', stamp: Date.now() };
              }
            }
            ctx.setState({ ...s, data:{ ...s.data, game:{ ...g, timeLeft, triesLeft, status, feedback, revealSolution: status==='won' ? true : g.revealSolution } }}); ctx.rebuild(KEEP_MAIN_SCROLL);
          }, 1000);
          const s1=ctx.getState(); const g2=s1.data.game;
          ctx.setState({ ...s1, data:{ ...s1.data, game:{ ...g2, intervalId:iid }}}); ctx.rebuild(KEEP_MAIN_SCROLL);
        }
      }},

      // Guess
      'game:guess':{ on:['click'], gkeys:['game:guess'], handler:(e,ctx)=>{
        const btn = e.target.closest && e.target.closest('[data-ch]'); if (!btn) return;
        const L = btn.getAttribute('data-ch'); if (!L) return;
        const s=ctx.getState(); const g=s.data.game; if (g.status!=='running' || !g.proverb) return;

        const guessed = { ...g.guessed, [L]: true };
        const target = g.proverb.t;
        const has = target.split('').some(raw => norm(raw)===L);

        let triesLeft = g.triesLeft, status = g.status;
        if (!has) {
          triesLeft=Math.max(0, triesLeft-1);
          if (triesLeft===0){ status='lost'; if (g.intervalId) try{ clearInterval(g.intervalId); }catch(_){ } }
        }
        else {
          const letters = new Set(target.split('').map(norm).filter(x=>x.trim()!=='' && x!==' '));
          const all = Array.from(letters).every(k => guessed[k]); if (all){ status='won'; if (g.intervalId) try{ clearInterval(g.intervalId); }catch(_){ } }
        }

        const timeLeft = g.timerOn ? (status==='lost' ? 0 : (typeof g.timeLeft === 'number' ? g.timeLeft : g.timerSec)) : 0;
        let feedbackType = has ? 'correct' : 'wrong';
        if (status==='won') feedbackType = 'win';
        if (status==='lost') feedbackType = 'lose';
        const feedback = feedbackType ? { type: feedbackType, stamp: Date.now() } : null;
        ctx.setState({ ...s, data:{ ...s.data, game:{ ...g, guessed, triesLeft, status,
          timeLeft,
          revealSolution: status==='won' ? true : g.revealSolution,
          feedback
        }}}); ctx.rebuild(KEEP_MAIN_SCROLL);
      }},
      'game:reveal':{ on:['click'], gkeys:['game:reveal'], handler:(e,ctx)=>{
        const s=ctx.getState(); const g=s.data.game; if (!g.proverb) return;
        ctx.setState({ ...s, data:{ ...s.data, game:{ ...g, revealSolution:true }}}); ctx.rebuild(KEEP_MAIN_SCROLL);
      }}
    };

    // ----------------------------------------------------------------
    // عملية الخلق: `createApp`
    // هنا يتم دمج "الإيمان" (database) مع "العمل الصالح" (orders)
    // لإنشاء كائن التطبيق الحي (`app`) القادر على التفاعل والنمو.
    // ----------------------------------------------------------------
    const app = Mishkah.app.createApp(database, orders);

    
    // ================================================================
    // مرحلة الإعدادات النهائية والبعث
    // ================================================================

    // ----------------------------------------------------------------
    // الإعداد التلقائي (Auto)
    // تهيئة البيئة المحيطة: الخطوط، الثيمات، اللغات، والأوامر المساعدة.
    // ----------------------------------------------------------------
    const twx = U.twcss.auto(database, app);

    // ----------------------------------------------------------------
    // دمج كل الأوامر (setOrders)
    // نجمع أوامر التطبيق الخاصة + أوامر الواجهة الجاهزة + أوامر البيئة.
    // ----------------------------------------------------------------
    app.setOrders({ ...orders, ...UI.orders, ...twx.orders });

    // ----------------------------------------------------------------
    // البعث (Mount)
    // اللحظة التي يظهر فيها الكائن الحي إلى العالم (DOM)،
    // ليبدأ رحلته في التفاعل مع المستخدم.
    // ----------------------------------------------------------------
    app.mount('#app');

  })();
  </script>
</body>
</html>
