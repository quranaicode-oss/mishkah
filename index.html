<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <title>Ù…Ø´ÙƒØ§Ø© â€” ØªØ¨ÙˆÙŠØ¨Ø§Øª + Ù„Ø¹Ø¨Ø© Ø§Ù„Ø£Ù…Ø«Ø§Ù„</title>

  <script src="./mishkah-utils.js"></script>
  <script src="./mishkah.core.js"></script>
  <script src="./mishkah-ui.js"></script>
</head>
<body>
  <div id="app"></div>

  <script>
  (function(){
    const M = Mishkah, U = M.utils, UI = M.UI, D = M.DSL;
    const { tw } = U.twcss;
    const { makeLangLookup } = U.lang;

    /*
    ================================================================
    |                                                              |
    |      Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÙŠÙ…: Ø±Ø­Ù„Ø© Ø§Ù„Ø®Ù„Ù‚ ÙÙŠ "Ù…Ø´ÙƒØ§Ø©"             |
    |                                                              |
    ================================================================
    |
    | Ø¥Ù† Ø¨Ù†Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„ÙŠØ³ Ù…Ø¬Ø±Ø¯ ÙƒØªØ§Ø¨Ø© ÙƒÙˆØ¯ØŒ Ø¨Ù„ Ù‡Ùˆ Ù…Ø­Ø§ÙƒØ§Ø© Ù„Ø±Ø­Ù„Ø©
    | Ø§Ù„Ø®Ù„Ù‚ ÙˆØ§Ù„ØªÙƒÙˆÙŠÙ† ÙƒÙ…Ø§ ØªØµÙÙ‡Ø§ ÙÙ„Ø³ÙØ© "Ù…Ø´ÙƒØ§Ø©". Ø³Ù†Ù…Ø± Ø¨Ù…Ø±Ø­Ù„ØªÙŠÙ†
    | Ø£Ø³Ø§Ø³ÙŠØªÙŠÙ†ØŒ ÙƒÙ„ Ù…Ø±Ø­Ù„Ø© ØªØªÙƒÙˆÙ† Ù…Ù† Ø²ÙˆØ¬ÙŠÙ†:
    |
    | 1. Ø§Ù„Ø²ÙˆØ¬ Ø§Ù„Ø£ÙˆÙ„: Ø§Ù„ØªØµÙ…ÙŠÙ… ÙˆØ§Ù„ØªØ³ÙˆÙŠØ© (ØªØ®Ø·ÙŠØ· Ø§Ù„Ø¬Ø³Ø¯)
    |    - Ø§Ù„Ø±ÙƒÙ† Ø§Ù„Ø£ÙˆÙ„: Ø§Ù„Ø·ÙŠÙ† ÙˆØ§Ù„Ø°Ø±Ø§Øª (Atoms as Components)
    |    - Ø§Ù„Ø±ÙƒÙ† Ø§Ù„Ø«Ø§Ù†ÙŠ: Ø§Ù„Ø¹Ù„Ù… Ø§Ù„ÙØ·Ø±ÙŠ (database as DNA)
    |    Ø§Ù„Ù†ØªÙŠØ¬Ø©: Ø¬Ø³Ø¯ Ù…ÙØµÙˆÙ‘ÙØ± (VDOM) Ù‚Ø¨Ù„ Ù†ÙØ® Ø§Ù„Ø±ÙˆØ­.
    |
    | 2. Ø§Ù„Ø²ÙˆØ¬ Ø§Ù„Ø«Ø§Ù†ÙŠ: Ø§Ù„ØªÙ…ÙƒÙŠÙ† ÙˆØ§Ù„ØªÙƒÙ„ÙŠÙ (Ù†ÙØ® Ø§Ù„Ø±ÙˆØ­ ÙˆØ§Ù„Ø­ÙŠØ§Ø©)
    |    - Ø§Ù„Ø±ÙƒÙ† Ø§Ù„Ø£ÙˆÙ„: Ø§Ù„Ø¥ÙŠÙ…Ø§Ù† (database as State)
    |    - Ø§Ù„Ø±ÙƒÙ† Ø§Ù„Ø«Ø§Ù†ÙŠ: Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„ØµØ§Ù„Ø­ (Orders)
    |    Ø§Ù„Ù†ØªÙŠØ¬Ø©: ÙƒØ§Ø¦Ù† Ø­ÙŠ Ù…ØªÙƒØ§Ù…Ù„ ÙŠØªÙØ§Ø¹Ù„ ÙˆÙŠØ³ØªØ¬ÙŠØ¨.
    |
    */

    // ================================================================
    // Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªÙ…Ù‡ÙŠØ¯ÙŠØ©: Ø¬Ù…Ø¹ Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø®Ø§Ù… Ù„Ù„Ù…Ø¹Ø±ÙØ©
    // Ù‚Ø¨Ù„ Ø§Ù„Ø®Ù„Ù‚ØŒ Ù†Ø¬Ù…Ø¹ ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø£ÙˆÙ„ÙŠØ©: Ø§Ù„Ù†ØµÙˆØµØŒ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ ÙˆØ§Ù„Ù‚ÙˆØ§Ø¹Ø¯.
    // ================================================================

    /* ===================== i18n: Ø§Ù„Ù…Ø¹Ø§Ø¬Ù… Ø§Ù„Ù„ØºÙˆÙŠØ© ===================== */
    const dict = {
      'app.title'   : { ar:'Ù…Ø´ÙƒØ§Ø© â€” ØªØ¨ÙˆÙŠØ¨Ø§Øª + Ù„Ø¹Ø¨Ø© Ø§Ù„Ø£Ù…Ø«Ø§Ù„', en:'Mishkah â€” Tabs + Proverbs Game' },
      'nav.about'   : { ar:'Ø¹Ù† Ù…Ø´ÙƒØ§Ø© (Markdown)', en:'About Mishkah (Markdown)' },
      'nav.counter' : { ar:'Ø§Ù„Ø¹Ø¯Ø§Ø¯', en:'Counter' },
      'nav.game'    : { ar:'Ù„Ø¹Ø¨Ø© Ø§Ù„Ø£Ù…Ø«Ø§Ù„', en:'Proverbs Game' },
      'counter.title':{ ar:'Ø¹Ø¯Ø§Ø¯ Ø¨Ø³ÙŠØ·', en:'Simple Counter' },
      'counter.reset':{ ar:'Ø¥Ø¹Ø§Ø¯Ø©', en:'Reset' },
      'game.title'  : { ar:'Ù„Ø¹Ø¨Ø© Ø§Ù„Ø£Ù…Ø«Ø§Ù„ Ùˆ Ø§Ù„Ø­ÙƒÙ…', en:'Proverbs & Wisdom Game' },
      'game.music'  : { ar:'Ù…ÙˆØ³ÙŠÙ‚Ù‰', en:'Music' },
      'game.timer'  : { ar:'ØªØ§ÙŠÙ…Ø±', en:'Timer' },
      'game.seconds': { ar:'Ø«', en:'s' },
      'game.start'  : { ar:'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©', en:'Start Game' },
      'game.new'    : { ar:'Ù…Ø«Ù„ Ø¬Ø¯ÙŠØ¯', en:'New Proverb' },
      'game.tries'  : { ar:'Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª', en:'Tries Left' },
      'game.hint'   : { ar:'Ø§Ù„ØªÙ„Ù…ÙŠØ­', en:'Hint' },
      'game.win'    : { ar:'Ø±Ø¨Ø­Øª! ğŸ‰', en:'You won! ğŸ‰' },
      'game.lose'   : { ar:'Ù„Ù„Ø£Ø³Ù Ø®Ø³Ø±Øª ğŸ™ˆ', en:'You lost ğŸ™ˆ' }
    };

    /* ===================== Markdown: Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø¹Ø±ÙÙŠ ===================== */
    const md_ar = [
      '# Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÙŠÙ…: ÙÙ„Ø³ÙØ© ÙˆÙ…Ø¹Ù…Ø§Ø±ÙŠØ© Ù…Ø´ÙƒØ§Ø©',
      'Ù…Ø´ÙƒØ§Ø© Ø¥Ø·Ø§Ø± Ø¹Ù…Ù„ Ø¨ÙˆØ§Ø¬Ù‡Ø© DSL Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª Ø¨Ø´ÙƒÙ„ Ù…Ù†Ø¸Ù… ÙˆÙ†Ø¸ÙŠÙ.',
      '- Ø§Ù„Ø¬Ø³Ø¯ (VDOM+DSL)ØŒ - Ø§Ù„Ø¥ÙŠÙ…Ø§Ù† (database)ØŒ - Ø§Ù„Ø¹Ù…Ù„ (orders).',
      'ÙŠÙˆÙØ± i18nØŒ ÙˆØ¥Ø¯Ø§Ø±Ø© headØŒ ÙˆØ·Ø¨Ù‚Ø© UI Ù…Ø¨Ø³Ø·Ø©ØŒ Ù…Ø¹ twcss tokens.'
    ].join('\n\n');

    const md_en = [
      '# Mishkah: Philosophy & Architecture',
      'A DSL-first UI framework: clean, structured, minimal.',
      '- Body (VDOM+DSL), - Faith/State (database), - Deeds (orders).',
      'Includes i18n, head manager, and UI tokens over twcss.'
    ].join('\n\n');

    /* ===================== Game Data: Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© ===================== */
    const PROVERBS = [
      { t:"Ø±Ø¬Ø¹ Ø¨Ø®ÙÙŠ Ø­Ù†ÙŠÙ†", h:"Ù…Ø«Ù„ Ø¹Ø±Ø¨ÙŠ ÙŠØ¯Ù„ Ø®ÙŠØ¨Ø© Ø§Ù„Ø£Ù…Ù„" },
      { t:"Ø§Ù„ÙŠ Ø§Ø®ØªØ´ÙˆØ§ Ù…Ø§ØªÙˆØ§", h:"Ù…Ø«Ù„ Ù…ØµØ±ÙŠ Ø¹Ù† ØªØ¨Ø¯Ù„ Ø§Ù„Ø£Ø®Ù„Ø§Ù‚" },
      { t:"Ø§Ù‚Ù„Ø¨ Ø§Ù„Ù‚Ø¯Ø±Ø© Ø¹Ù„Ù‰ ÙÙ…Ù‡Ø§ ØªØ·Ù„Ø¹ Ø§Ù„Ø¨Ù†Øª Ù„Ø§Ù…Ù‡Ø§", h:"Ø§Ù„Ø¨Ù†Øª ØªÙØ´Ø¨Ù‡ Ø£Ù…Ù‡Ø§" },
      { t:"Ø§Ø¨Ù†Ùƒ Ø¹Ù„Ù‰ Ù…Ø§ ØªØ±Ø¨ÙŠÙ‡ Ùˆ Ø¬ÙˆØ²Ùƒ Ø¹Ù„Ù‰ Ù…Ø§ ØªØ¹ÙˆØ¯ÙŠÙ‡", h:"Ø§Ù„Ø³Ù„ÙˆÙƒ ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ ØªØ¹Ø§Ù…Ù„ Ø§Ù„Ø§Ø¨Ù† ÙˆØ§Ù„Ø²ÙˆØ¬" },
      { t:"Ù…Ø§ Ø­Ùƒ Ø¬Ù„Ø¯Ùƒ Ù…Ø«Ù„ Ø¸ÙØ±Ùƒ", h:"Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ù…Ø±Ø¡ Ø¹Ù„Ù‰ Ù†ÙØ³Ù‡ Ø£ÙØ¶Ù„" },
      { t:"Ø®ÙŠØ± Ø§Ù„ÙƒÙ„Ø§Ù… Ù…Ø§ Ù‚Ù„ ÙˆØ¯Ù„", h:"Ø§Ù„Ø¥ÙŠØ¬Ø§Ø² Ø£ÙØ¶Ù„" },
      { t:"Ø§Ù„Ø®Ø¨Ø± Ø§Ù„ÙŠ Ø§Ù†Ù‡Ø±Ø¯Ù‡ Ø¨ÙÙ„ÙˆØ³ Ø¨ÙƒØ±Ø© ÙŠØ¨Ù‚Ù‰ Ø¨Ø¨Ù„Ø§Ø´", h:"Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ø³ØªØªÙØ´Ù‰ Ù‚Ø±ÙŠØ¨Ù‹Ø§" },
      { t:"Ù…Ù† Ø·Ù„Ø¨ Ø§Ù„Ø¹Ù„Ø§ Ø³Ù‡Ø± Ø§Ù„Ù„ÙŠØ§Ù„ÙŠ", h:"Ø§Ù„Ø§Ø¬ØªÙ‡Ø§Ø¯ Ø·Ø±ÙŠÙ‚ Ø§Ù„Ù†Ø¬Ø§Ø­" },
      { t:"Ø§Ù„ÙŠ Ø¨ÙŠØ´ÙŠÙ„ Ù‚Ø±Ø¨Ø© Ù…Ø®Ø±ÙˆÙ…Ø© Ø¨ØªØ®Ø± Ø¹Ù„Ù‰ Ø±Ø§Ø³Ù‡", h:"Ø¥Ù‡Ù…Ø§Ù„Ùƒ ÙŠØ¶Ø±Ùƒ Ø£ÙˆÙ„Ù‹Ø§" },
      { t:"Ø§Ø¯ÙŠ Ø§Ù„Ø¹ÙŠØ´ Ù„Ø®Ø¨Ø§Ø²Ù‡ ÙˆÙ„Ùˆ ÙƒÙ„ Ù†ØµÙ‡", h:"Ø£Ø¹Ø·Ù Ø§Ù„ØµÙ†Ø¹Ø© Ù„Ø£Ù‡Ù„Ù‡Ø§" },
      { t:"Ù„Ø§ ØªØ¤Ø¬Ù„ Ø¹Ù…Ù„ Ø§Ù„ÙŠÙˆÙ… Ø¥Ù„Ù‰ Ø§Ù„ØºØ¯", h:"Ø®Ø·Ø± Ø§Ù„ØªØ³ÙˆÙŠÙ" },
      { t:"Ø§Ù„ÙˆÙ‚Øª ÙƒØ§Ù„Ø³ÙŠÙ Ø§Ù† Ù„Ù… ØªÙ‚Ø·Ø¹Ù‡ Ù‚Ø·Ø¹Ùƒ", h:"Ø£Ù‡Ù…ÙŠØ© Ø§Ù„ÙˆÙ‚Øª" }
    ];
	
    const AR_ALPHA = ['Ø§','Ø¨','Øª','Ø«','Ø¬','Ø­','Ø®','Ø¯','Ø°','Ø±','Ø²','Ø³','Ø´','Øµ','Ø¶','Ø·','Ø¸','Ø¹','Øº','Ù','Ù‚','Ùƒ','Ù„','Ù…','Ù†','Ùˆ','Ù‡','Ø©','Ø¡','ÙŠ','Ù‰'];
    const norm = (ch)=> String(ch).replace(/[Ø£Ø¥Ø¢]/g,'Ø§');


    // ================================================================
    // Ø§Ù„Ø²ÙˆØ¬ Ø§Ù„Ø£ÙˆÙ„: Ø§Ù„ØªØµÙ…ÙŠÙ… ÙˆØ§Ù„ØªØ³ÙˆÙŠØ© (ØªØ®Ø·ÙŠØ· Ø§Ù„Ø¬Ø³Ø¯)
    // Ù‡Ù†Ø§ Ù†ØµÙ†Ø¹ Ø§Ù„Ù‡ÙŠÙƒÙ„ ÙˆØ§Ù„Ø´ÙƒÙ„ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚.
    // ================================================================

    // ----------------------------------------------------------------
    // Ø§Ù„Ø±ÙƒÙ† Ø§Ù„Ø£ÙˆÙ„: Ø§Ù„Ø·ÙŠÙ† ÙˆØ§Ù„Ø°Ø±Ø§Øª (`Atoms` as Components)
    // Ù‡Ø°Ù‡ Ù‡ÙŠ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§ØªØŒ Ù„Ø¨Ù†Ø§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø§Ù„ØªÙŠ ØªØ´ÙƒÙ„ Ø¬Ø³Ø¯ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.
    // ÙƒÙ„ Ù…ÙƒÙˆÙ† Ù‡Ùˆ "Ø°Ø±Ø©" Ø£Ùˆ Ù…Ø¬Ù…ÙˆØ¹Ø© "Ø°Ø±Ø§Øª" Ù„Ù‡Ø§ Ø´ÙƒÙ„ ÙˆÙˆØ¸ÙŠÙØ© Ù…Ø­Ø¯Ø¯Ø©.
    // ----------------------------------------------------------------
    
    function HeaderBar(db){
      const { TL } = makeLangLookup(db);
      return UI.Toolbar({
        left:[ D.Text.Span({ attrs:{ class: tw`text-lg font-bold` }}, [TL('app.title')]) ],
        right:[
          UI.Button({ attrs:{ gkey:'ui:lang-ar' }, variant:'ghost', size:'sm' }, ['AR']),
          UI.Button({ attrs:{ gkey:'ui:lang-en' }, variant:'ghost', size:'sm' }, ['EN']),
          UI.Button({ attrs:{ gkey:'ui:theme-toggle' }, variant:'soft', size:'sm' }, ['ğŸŒ“'])
        ]
      });
    }

    function Sidebar(db){
      const { TL } = makeLangLookup(db);
      const route = db.data.activeTab;
      const NavBtn = (id,label,icon)=>{
        const active = route===id;
        return UI.Button({
          attrs:{ gkey:`route:${id}`, class:tw`${active?'bg-[var(--accent)]':''} w-full justify-start text-start` },
          variant:'ghost', size:'sm'
        }, [`${icon} `, TL(label)]);
      };
      return D.Containers.Nav({ attrs:{ class: tw`p-3 space-y-2` }}, [
        NavBtn('about','nav.about','ğŸ“–'),
        NavBtn('counter','nav.counter','ğŸ”¢'),
        NavBtn('game','nav.game','ğŸ®')
      ]);
    }

    function AboutPanel(db){
      const lang = db.env.lang || 'ar';
      const content = lang==='ar' ? db.data.md.ar : db.data.md.en;
      return UI.Card({
        title: makeLangLookup(db).TL('nav.about'),
        content: U.UDM({ content, className: tw`prose prose-invert max-w-none` })
      });
    }

    function CounterPanel(db){
      const { TL } = makeLangLookup(db);
      return UI.Card({
        title: TL('counter.title'),
        content: D.Containers.Div({ attrs:{ class: tw`flex items-center justify-center gap-3` }}, [
          UI.Button({ attrs:{ gkey:'counter:dec' }, variant:'soft', size:'sm' }, ['âˆ’']),
          D.Text.Span({ attrs:{ class: tw`text-2xl font-bold` }}, [String(db.data.counter)]),
          UI.Button({ attrs:{ gkey:'counter:inc' }, variant:'soft', size:'sm' }, ['+']),
          UI.Button({ attrs:{ gkey:'counter:reset', class:tw`ms-4` }, variant:'ghost', size:'sm' }, [TL('counter.reset')]),
        ])
      });
    }

    function GamePanel(db){
      const { TL } = makeLangLookup(db);
      const g = db.data.game;

      const top = UI.Card({
        content: D.Containers.Div({ attrs:{ class: tw`grid md:grid-cols-3 gap-3` }}, [
          UI.Card({ variant:'card/soft-1', content:
            D.Containers.Div({ attrs:{ class: tw`flex items-center gap-2 p-3` }}, [
              UI.Input({ attrs:{ type:'checkbox', checked:g.musicOn, gkey:'game:music:toggle' } }),
              D.Text.Span({}, [TL('game.music')]),
              UI.Select({ attrs:{ gkey:'game:music:select' },
                options: g.audioList.map((it,i)=>({ value:String(i), label:it.name })) })
            ])
          }),
          UI.Card({ variant:'card/soft-1', content:
            D.Containers.Div({ attrs:{ class: tw`flex items-center gap-2 p-3` }}, [
              UI.Input({ attrs:{ type:'checkbox', checked:g.timerOn, gkey:'game:timer:toggle' } }),
              D.Text.Span({}, [TL('game.timer')]),
              UI.Input({ attrs:{ type:'number', min:'5', step:'1', value:String(g.timerSec), style:'width:70px', gkey:'game:timer:value' } }),
              D.Text.Span({ attrs:{ class: tw`text-[var(--muted-foreground)]` }}, [TL('game.seconds')])
            ])
          }),
          UI.Card({ variant:'card/soft-1', content:
            D.Containers.Div({ attrs:{ class: tw`flex items-center justify-between p-3` }}, [
              UI.Button({ attrs:{ gkey:'game:start' }, variant:'destructive', size:'md' },
                [g.status==='running' ? TL('game.new') : TL('game.start')]),
              D.Text.Span({ attrs:{ class: tw`text-xl font-bold text-[var(--primary)]` }}, [
                g.timerOn ? String(g.timeLeft||g.timerSec)+' '+TL('game.seconds') : 'â€”'
              ])
            ])
          }),
        ])
      });

      const hearts = D.Containers.Div({ attrs:{ class: tw`flex items-center gap-1` }},
        Array.from({length:g.triesMax}, (_,i)=>{
          const full = i < g.triesLeft;
          return D.Text.Span({ attrs:{ key:'heart-'+i, class: tw`text-4xl ${full?'':'opacity-40'} drop-shadow` }}, [full?'â¤ï¸':'ğŸ’”']);
        })
      );

      const pv = g.proverb?.t || '';
      const boxes = D.Containers.Div({ attrs:{ class: tw`flex flex-wrap gap-1 mt-2` }}, pv.split('').map((raw,idx)=>{
        if (raw===' ') return D.Containers.Div({ attrs:{ key:'sp'+idx, class: tw`w-5` }});
        const show = g.guessed[norm(raw)];
        return D.Containers.Div({ attrs:{ key:'bx'+idx, class: tw`w-10 h-12 grid place-items-center rounded border border-[var(--border)] bg-[var(--surface-2)] text-xl font-bold` }}, [ show ? raw : '' ]);
      }));

      const letters = D.Containers.Div({ attrs:{ class: tw`grid grid-cols-8 md:grid-cols-12 gap-1` }}, AR_ALPHA.map((L,i)=>
        UI.Button({ attrs:{ key:'L'+i, gkey:'game:guess', 'data-ch':L, disabled: g.status!=='running' || !!g.guessed[L] }, variant:'soft', size:'sm' }, [L])
      ));

      const result = g.status==='won' ? TL('game.win') : g.status==='lost' ? TL('game.lose') : '';
      const audioNode = g.musicOn ? D.Media.Audio({ attrs:{ controls:true, src: g.audioList[g.audioIdx].url, class: tw`w-full` } }) : null;

      return D.Containers.Div({ attrs:{ class: tw`space-y-3` }}, [
        top,
        UI.Card({ content:
          D.Containers.Div({ attrs:{ class: tw`grid md:grid-cols-[1fr,160px] gap-3` }}, [
            D.Containers.Div({ attrs:{ class: tw`space-y-2` }}, [ hearts, boxes, UI.Divider(), letters ]),
            D.Containers.Div({ attrs:{ class: tw`space-y-2` }}, [
              result ? UI.Card({ variant:'card/soft-2', content: D.Text.P({ attrs:{ class: tw`text-center text-lg` }}, [result]) }) : null,
              g.proverb ? UI.Card({ variant:'card/soft-2', content:
                D.Containers.Div({ attrs:{ class: tw`p-2` }}, [
                  D.Text.Strong({}, [makeLangLookup(db).TL('game.hint'), ': ']),
                  D.Text.Span({}, [g.proverb.h])
                ])
              }) : null,
              audioNode
            ].filter(Boolean))
          ])
        })
      ]);
    }

    function MainContent(db){
      const tab = db.data.activeTab;
      if (tab==='about')   return AboutPanel(db);
      if (tab==='counter') return CounterPanel(db);
      if (tab==='game')    return GamePanel(db);
      return AboutPanel(db);
    }
    
    // ----------------------------------------------------------------
    // Ø§Ù„Ø±ÙƒÙ† Ø§Ù„Ø«Ø§Ù†ÙŠ: Ø§Ù„Ø¹Ù„Ù… Ø§Ù„ÙØ·Ø±ÙŠ (`database` as DNA)
    // Ù‡Ø°Ù‡ Ù‡ÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ©ØŒ Ø§Ù„Ø´ÙØ±Ø© Ø§Ù„ÙˆØ±Ø§Ø«ÙŠØ© Ù„Ù„ØªØ·Ø¨ÙŠÙ‚.
    // Ù‡ÙŠ ØªØ­Ø¯Ø¯ Ø§Ù„ØµÙØ§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ© ÙˆØ§Ù„Ù‡ÙŠØ¦Ø© Ø§Ù„ØªÙŠ Ø³ÙŠÙØ®Ù„Ù‚ Ø¹Ù„ÙŠÙ‡Ø§ Ø§Ù„Ø¬Ø³Ø¯.
    // ----------------------------------------------------------------
    const database = {
      env:{ theme:'dark', lang:'ar', dir:'rtl' },
      i18n:{ lang:'ar', fallback:'en', dict },
      data:{
        activeTab: 'about',
        md:{ ar: md_ar, en: md_en },
        counter: 0,
        game:{
          musicOn: true,
          timerOn: true,
          timerSec: 35,
          timeLeft: 0,
          triesMax: 5,
          triesLeft: 5,
          audioList: [
            { name:'Ghost Stories', url:'https://www.fesliyanstudios.com/musicfiles/2020-10-26_-_Ghost_Stories_-_www.FesliyanStudios.com_Steve_Oxen/2020-10-26_-_Ghost_Stories_-_www.FesliyanStudios.com_Steve_Oxen.mp3' },
            { name:'The Unsolved Mystery', url:'https://www.fesliyanstudios.com/musicfiles/2018-07-22_-_The_Unsolved_Murder_-_David_Fesliyan.mp3' },
            { name:'Dark Shadows', url:'https://www.fesliyanstudios.com/musicfiles/2020-06-25_-_Dark_Shadows_-_www.FesliyanStudios.com_David_Fesliyan/2020-06-25_-_Dark_Shadows_-_www.FesliyanStudios.com_David_Fesliyan.mp3' }
          ],
          audioIdx: 0,
          proverb: null,
          guessed: {},
          intervalId: null,
          status: 'idle' // idle | running | won | lost
        }
      },
      ui:{ modalOpen:false, drawerOpen:false, toasts:[] }
    };

    // ----------------------------------------------------------------
    // Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³ÙˆÙŠØ©: `setBody`
    // Ù‡Ù†Ø§ ÙŠØªÙ… Ø¯Ù…Ø¬ "Ø§Ù„Ø·ÙŠÙ†" (Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª) Ù…Ø¹ "Ø§Ù„Ø¹Ù„Ù… Ø§Ù„ÙØ·Ø±ÙŠ" (Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
    // Ù„Ø¥Ù†ØªØ§Ø¬ "Ø¬Ø³Ø¯ Ù…ÙØµÙˆÙ‘ÙØ±" (Virtual DOM)ØŒ ÙˆÙ‡Ùˆ Ù…Ø®Ø·Ø· Ø¯Ù‚ÙŠÙ‚ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚
    // Ù‚Ø¨Ù„ Ø£Ù† ØªØ¯Ø¨ ÙÙŠÙ‡ Ø§Ù„Ø­ÙŠØ§Ø©.
    // ----------------------------------------------------------------
    Mishkah.app.setBody(function(db, h){
      db.head = { title: makeLangLookup(db).TL('app.title') };
      return UI.AppRoot({
        shell: D.Containers.Div({ attrs:{ class: tw`min-h-screen flex flex-col` }}, [
          HeaderBar(db),
          D.Containers.Div({ attrs:{ class: tw`flex flex-1` }}, [
            D.Containers.Aside({ attrs:{ class: tw`w-[240px] border-s` }}, [ Sidebar(db) ]),
            D.Containers.Main({ attrs:{ class: tw`flex-1 p-4` }}, [ MainContent(db) ])
          ])
        ])
      });
    });


    // ================================================================
    // Ø§Ù„Ø²ÙˆØ¬ Ø§Ù„Ø«Ø§Ù†ÙŠ: Ø§Ù„ØªÙ…ÙƒÙŠÙ† ÙˆØ§Ù„ØªÙƒÙ„ÙŠÙ (Ù†ÙØ® Ø§Ù„Ø±ÙˆØ­ ÙˆØ§Ù„Ø­ÙŠØ§Ø©)
    // Ù‡Ù†Ø§ Ù†Ù…Ù†Ø­ Ø§Ù„Ø¬Ø³Ø¯ Ø§Ù„Ù‚Ø¯Ø±Ø© Ø¹Ù„Ù‰ Ø§Ù„ØªÙØ§Ø¹Ù„ ÙˆØ§Ù„Ù†Ù…Ùˆ.
    // ================================================================

    // ----------------------------------------------------------------
    // Ø§Ù„Ø±ÙƒÙ† Ø§Ù„Ø£ÙˆÙ„: Ø§Ù„Ø¥ÙŠÙ…Ø§Ù† (`database` as State)
    // Ù†ÙØ³ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙŠ ÙƒØ§Ù†Øª "DNA"ØŒ Ø£ØµØ¨Ø­Øª Ø§Ù„Ø¢Ù† "Ø§Ù„Ø±ÙˆØ­" Ø§Ù„Ø­ÙŠØ©ØŒ
    // ÙˆÙ‡ÙŠ Ù…ØµØ¯Ø± Ø§Ù„Ø­Ù‚ÙŠÙ‚Ø© Ø§Ù„Ø£ÙˆØ­Ø¯ Ø§Ù„Ø°ÙŠ ÙŠÙ‡ØªØ¯ÙŠ Ø¨Ù‡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.
    // ----------------------------------------------------------------
    // (Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ù€ `database` Ù…Ø¹Ø±Ù Ù…Ø³Ø¨Ù‚Ù‹Ø§ØŒ Ù‡Ù†Ø§ ÙÙ‚Ø· Ù†ÙˆØ¶Ø­ Ø¯ÙˆØ±Ù‡ Ø§Ù„Ø¬Ø¯ÙŠØ¯)

    // ----------------------------------------------------------------
    // Ø§Ù„Ø±ÙƒÙ† Ø§Ù„Ø«Ø§Ù†ÙŠ: Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„ØµØ§Ù„Ø­ (`orders`)
    // Ù‡Ø°Ù‡ Ù‡ÙŠ Ø§Ù„Ø£ÙˆØ§Ù…Ø± ÙˆØ§Ù„Ø£ÙØ¹Ø§Ù„ Ø§Ù„ØªÙŠ ØªØ­Ø±Ùƒ Ø§Ù„Ø¬Ø³Ø¯ ÙˆØªØºÙŠØ± Ù…Ù† Ø­Ø§Ù„ "Ø¥ÙŠÙ…Ø§Ù†Ù‡".
    // ÙƒÙ„ "order" Ù‡Ùˆ Ø¹Ù…Ù„ ØµØ§Ù„Ø­ ÙŠØ³ØªØ¬ÙŠØ¨ Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙŠÙØ­Ø¯Ù‘Ø« Ø§Ù„Ø­Ø§Ù„Ø©.
    // ----------------------------------------------------------------
    const orders = {
      // Routing
      'route:about'  :{ on:['click'], gkeys:['route:about'],   handler:(e,ctx)=>{ const s=ctx.getState(); ctx.setState({...s, data:{...s.data, activeTab:'about'  }}); ctx.rebuild(); }},
      'route:counter':{ on:['click'], gkeys:['route:counter'], handler:(e,ctx)=>{ const s=ctx.getState(); ctx.setState({...s, data:{...s.data, activeTab:'counter'}}); ctx.rebuild(); }},
      'route:game'   :{ on:['click'], gkeys:['route:game'],    handler:(e,ctx)=>{ const s=ctx.getState(); ctx.setState({...s, data:{...s.data, activeTab:'game'   }}); ctx.rebuild(); }},

      // Counter
      'counter:inc'  :{ on:['click'], gkeys:['counter:inc'],   handler:(e,ctx)=>{ const s=ctx.getState(); ctx.setState({...s, data:{...s.data, counter:s.data.counter+1 }}); ctx.rebuild(); }},
      'counter:dec'  :{ on:['click'], gkeys:['counter:dec'],   handler:(e,ctx)=>{ const s=ctx.getState(); ctx.setState({...s, data:{...s.data, counter:s.data.counter-counter+1 }}); ctx.rebuild(); }},
      'counter:reset':{ on:['click'], gkeys:['counter:reset'], handler:(e,ctx)=>{ const s=ctx.getState(); ctx.setState({...s, data:{...s.data, counter:0 }}); ctx.rebuild(); }},

      // Game toggles
      'game:music:toggle':{ on:['change'], gkeys:['game:music:toggle'], handler:(e,ctx)=>{
        const s=ctx.getState(); const g=s.data.game; ctx.setState({...s, data:{...s.data, game:{...g, musicOn: !!e.target.checked }}}); ctx.rebuild();
      }},
      'game:music:select':{ on:['change'], gkeys:['game:music:select'], handler:(e,ctx)=>{
        const s=ctx.getState(); const g=s.data.game; const idx=Math.max(0,parseInt(e.target.value,10)||0);
        ctx.setState({...s, data:{...s.data, game:{...g, audioIdx: idx }}}); ctx.rebuild();
      }},
      'game:timer:toggle':{ on:['change'], gkeys:['game:timer:toggle'], handler:(e,ctx)=>{
        const s=ctx.getState(); const g=s.data.game; const on=!!e.target.checked; if(!on && g.intervalId) clearInterval(g.intervalId);
        ctx.setState({...s, data:{...s.data, game:{...g, timerOn: on }}}); ctx.rebuild();
      }},
      'game:timer:value':{ on:['input','change'], gkeys:['game:timer:value'], handler:(e,ctx)=>{
        const s=ctx.getState(); const g=s.data.game; const v=Math.max(5, parseInt(e.target.value,10)||g.timerSec);
        ctx.setState({...s, data:{...s.data, game:{...g, timerSec: v }}}); ctx.rebuild();
      }},

      // Start / New game
      'game:start':{ on:['click'], gkeys:['game:start'], handler:(e,ctx)=>{
        const s0=ctx.getState(); const g0=s0.data.game; if (g0.intervalId) try{ clearInterval(g0.intervalId) }catch(_){}
        const pv = PROVERBS[Math.floor(Math.random()*PROVERBS.length)];
        const g1 = { ...g0, proverb: pv, guessed:{}, triesLeft:g0.triesMax, status:'running', timeLeft:g0.timerSec, intervalId:null };
        ctx.setState({ ...s0, data:{ ...s0.data, game:g1 } }); ctx.rebuild();

        if (g1.timerOn) {
          const iid = setInterval(()=>{
            const s=ctx.getState(); const g=s.data.game; if (g.status!=='running') { clearInterval(iid); return; }
            let timeLeft = (g.timeLeft||g.timerSec) - 1;
            let triesLeft = g.triesLeft; let status = g.status;
            if (timeLeft<=0) { timeLeft=g.timerSec; triesLeft=Math.max(0, triesLeft-1); if (triesLeft===0){ status='lost'; clearInterval(iid); } }
            ctx.setState({ ...s, data:{ ...s.data, game:{ ...g, timeLeft, triesLeft, status } }}); ctx.rebuild();
          }, 1000);
          const s1=ctx.getState(); const g2=s1.data.game;
          ctx.setState({ ...s1, data:{ ...s1.data, game:{ ...g2, intervalId:iid }}}); ctx.rebuild();
        }
      }},

      // Guess
      'game:guess':{ on:['click'], gkeys:['game:guess'], handler:(e,ctx)=>{
        const btn = e.target.closest && e.target.closest('[data-ch]'); if (!btn) return;
        const L = btn.getAttribute('data-ch'); if (!L) return;
        const s=ctx.getState(); const g=s.data.game; if (g.status!=='running' || !g.proverb) return;

        const guessed = { ...g.guessed, [L]: true };
        const target = g.proverb.t;
        const has = target.split('').some(raw => norm(raw)===L);

        let triesLeft = g.triesLeft, status = g.status;
        if (!has) { triesLeft=Math.max(0, triesLeft-1); if (triesLeft===0){ status='lost'; if (g.intervalId) clearInterval(g.intervalId); } }
        else {
          const letters = new Set(target.split('').map(norm).filter(x=>x.trim()!=='' && x!==' '));
          const all = Array.from(letters).every(k => guessed[k]); if (all){ status='won'; if (g.intervalId) clearInterval(g.intervalId); }
        }

        ctx.setState({ ...s, data:{ ...s.data, game:{ ...g, guessed, triesLeft, status,
          timeLeft: g.timerOn ? g.timeLeft : 0
        }}}); ctx.rebuild();
      }}
    };

    // ----------------------------------------------------------------
    // Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø®Ù„Ù‚: `createApp`
    // Ù‡Ù†Ø§ ÙŠØªÙ… Ø¯Ù…Ø¬ "Ø§Ù„Ø¥ÙŠÙ…Ø§Ù†" (database) Ù…Ø¹ "Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„ØµØ§Ù„Ø­" (orders)
    // Ù„Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­ÙŠ (`app`) Ø§Ù„Ù‚Ø§Ø¯Ø± Ø¹Ù„Ù‰ Ø§Ù„ØªÙØ§Ø¹Ù„ ÙˆØ§Ù„Ù†Ù…Ùˆ.
    // ----------------------------------------------------------------
    const app = Mishkah.app.createApp(database, orders);

    
    // ================================================================
    // Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ÙˆØ§Ù„Ø¨Ø¹Ø«
    // ================================================================

    // ----------------------------------------------------------------
    // Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ (Auto)
    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„Ù…Ø­ÙŠØ·Ø©: Ø§Ù„Ø®Ø·ÙˆØ·ØŒ Ø§Ù„Ø«ÙŠÙ…Ø§ØªØŒ Ø§Ù„Ù„ØºØ§ØªØŒ ÙˆØ§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©.
    // ----------------------------------------------------------------
    const twx = U.twcss.auto(database, app);

    // ----------------------------------------------------------------
    // Ø¯Ù…Ø¬ ÙƒÙ„ Ø§Ù„Ø£ÙˆØ§Ù…Ø± (setOrders)
    // Ù†Ø¬Ù…Ø¹ Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®Ø§ØµØ© + Ø£ÙˆØ§Ù…Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¬Ø§Ù‡Ø²Ø© + Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨ÙŠØ¦Ø©.
    // ----------------------------------------------------------------
    app.setOrders({ ...orders, ...UI.orders, ...twx.orders });

    // ----------------------------------------------------------------
    // Ø§Ù„Ø¨Ø¹Ø« (Mount)
    // Ø§Ù„Ù„Ø­Ø¸Ø© Ø§Ù„ØªÙŠ ÙŠØ¸Ù‡Ø± ÙÙŠÙ‡Ø§ Ø§Ù„ÙƒØ§Ø¦Ù† Ø§Ù„Ø­ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø§Ù„Ù… (DOM)ØŒ
    // Ù„ÙŠØ¨Ø¯Ø£ Ø±Ø­Ù„ØªÙ‡ ÙÙŠ Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….
    // ----------------------------------------------------------------
    app.mount('#app');

  })();
  </script>
</body>
</html>
