# 📑 المخطط الفني الرسمي — POS على Mishkah v5 (إصدار مُعاد صياغته)

**المشروع:** نظام إدارة المطاعم (RMS)

**الوحدة الأساسية:** شاشة نقطة البيع (POS)

**المرجع:** هذا المستند هو المصدر الرسمي للفريق. يربط بين فلسفة Mishkah v5 (Truth + Regions + Guardian) وبين معايير POS العالمية، مع توصيف مُفصّل للمكوّنات، البيانات، التدفقات، الأداء، الوصولية، والطباعة.

---

## 1) المبادئ الحاكمة (Mishkah v5)

1. **الحقيقة الواحدة (Single Source of Truth)**: كل الحالة عبر `app.truth`. تحديث الحالة حصريًا عبر `truth.set()` وضمن دفعات `truth.batch()`.
2. **المناطق الجراحية (Surgical Regions)**: كل جزء UI مسجَّل كـ Region مستقل. بعد أي تغيير، استخدم `truth.mark('<region>')` لأصغر منطقة متأثرة فقط.
3. **الرقيب والأداء (Guardian & Budget)**: عيّن ميزانية زمنية لكل Region، خاصة المناطق الساخنة (قوائم/شبكات/لوحات). القاعدة: **≤16ms** لكل إطار. راقب عبر `app.devtools.printSummary()`.
4. **التفويض للأحداث**: لا `addEventListener` يدويًا؛ استعمل سمات `data-on*` لربط الأوامر.
5. **البيئة (env) والتنسيق**: `env.toggleTheme()`، `env.setLocale()`, `env.toggleDir()`؛ الاعتماد على `tw` من Mishkah لتوافق RTL/LTR و Light/Dark تلقائيًا.
6. **Atoms ثم Comp**: لا تبني عناصر خام مباشرة إن وُجد مكوّن. استخدم Comp.mole/tissue لبناء مكوّنات قابلة لإعادة الاستخدام.

---

## 2) معايير UX/UI العامة

- **ملء الشاشة 100%**، شبكة 12 عمودًا: يمين (القائمة) 7–8 أعمدة، يسار (الطلب) 4–5 أعمدة. شريط إجراءات سفلي ثابت.
- **أيقونات شبيهة بالإيموجي** (رموز خفيفة الوزن SVG/Unicode) بدل مكتبات ثقيلة.
- **أحجام لمس**: ارتفاع أزرار ≥44px. تباعد داخلي سخي. ظلال ناعمة. حواف 2xl.
- **الوضع الليلي/النهاري**: تبديل فوري، تباين كافٍ، ألوان علامة تجارية.
- **الوصولية**: دعم لوحة المفاتيح، تركيز مرئي، `aria-*`, `role`, `aria-modal`, `aria-labelledby`.
- **الأداء**: virtualization للقوائم >50 عنصرًا، lazy-images، دفعات truth.

---

## 3) نموذج البيانات المركزي (Data Model)

> المصدر: `database/` + `mock-data.js` (للبيانات الافتراضية أثناء التطوير).

### 3.1 الأصناف (Item)
- `id:number`
- `category:string`
- `translations:{ ar:{name,description}, en:{name,description} }`
- `price:number`
- `image?:string` `gallery?:string[]`
- `modifiers_profile_id?:string` (يربط ملف الإضافات/المنزوعات المناسب للصنف)
- `tax_group?:string`

### 3.2 المُعدِّلات (ModifiersProfile)
- `id:string`
- `groups: Array<{
  id:string,
  label:{ar,en},
  type:'addon'|'removal'|'sub'|'size',
  selection:'single'|'multi',
  min?:number, max?:number,
  items:Array<{ id:number, label:{ar,en}, priceDelta?:number, defaultIncluded?:boolean }>
}>`

### 3.3 الطاولات والحجوزات
**Table**
- `id:string`, `name:string`, `section?:string`, `seats:number`
- `status:'free'|'occupied'|'cleaning'|'locked'`
- `locked_by?:{ type:'reservation'|'order', id:string }`

**Reservation**
- `id:string`, `customer:{name,phone}`, `table_ids:string[]`, `headcount:number`
- `time:{ start:ISO, end:ISO }`, `status:'pending'|'active'|'canceled'|'done'`
- قواعد: قفل الطاولات في نافذة الحجز، تحقق السعة: مجموع مقاعد الطاولات ≥ headcount.

### 3.4 العملاء والتوصيل
**Customer**
- `id:string`, `name`, `phone`, `notes?`
- `addresses:Array<{ id, label, line1, area, city, geo? }>`

**Driver**
- `id`, `name`, `phone`, `vehicle?`, `status:'idle'|'on_delivery'`

### 3.5 الطلب والمدفوعات
**Order**
- `id:string`, `type:'dine_in'|'takeaway'|'delivery'`
- `table_ids?:string[]`, `customer?:CustomerRef`, `driver_id?:string`
- `status:'new'|'in_preparation'|'prepared'|'delivered'|'paid'`
- `lines:Array<OrderLine>`
- `discount_total:number`
- `service:number`, `delivery_fee:number`, `vat:number`, `grand_total:number`
- `shift_id?:string`, `cashier?:EmployeeRef`
- `created_at`, `updated_at`

**OrderLine**
- `id`, `item_id:number`, `title`, `qty:number`, `price:number`
- `mods:{ addons:number[], removals:number[], subs?:number[], size?:number }`
- `modDelta:number` (∑ priceDelta)
- `discount?:{ mode:'percent'|'amount', value:number }`
- `notes?:string`

**Payment**
- `id`, `order_id`, `method:'cash'|'card'|'wallet'|'online'|'coupon'`, `amount:number`, `currency:'EGP'|...`, `meta?`
- يدعم **تقسيم الفاتورة (Split)**: `split_id?`, `guest_name?`

### 3.6 الموظفون والورديات
**Employee**: `id`, `full_name`, `pin`, `roles:string[]`

**Shift**: `id`, `cashier:EmployeeRef`, `opened_at`, `closed_at?`, `opening_float:number`, `closing_total?:number`, `notes?`

---

## 4) خريطة المناطق (Regions) + الميزانيات

- `pos-header` — 8ms
- `menu-panel` — 12ms (شبكة عناصر + بحث)
- `order-panel` — 12ms (خطوط + إجماليات)
- `footer-bar` — 6ms (أزرار ثابتة)
- `modals-root` — 8ms (Modal/Sheet)
- `toasts-root` — 4ms

كل أوامر الأحداث تحدّث الحقيقة ضمن `truth.batch()` وتعلّم أصغر Region فقط.

---

## 5) قائمة المكوّنات الرسمية (Comp.*)

### 5.1 القشرة والهيكل
- **Comp.AppShell**: يغلّف التخطيط العام ويحقن Regions.
- **Comp.TopBar**: شعار + تبديل لغة/ثيم + حالة الورديّة.
- **Comp.FooterActionBar**: مثبت أسفل الشاشة؛ أزرار: Save, Park/Resume, Print, Settle.

### 5.2 حوارات وألواح
- **Comp.Modal**: زر إغلاق، ESC، ضغط خارج، focus-trap، أحجام sm/md/lg/xl.
- **Comp.Sheet**: Drawer جانبي/سفلي للسياقات العميقة (Modifiers/Payments/Reports).
- **Comp.Toast**: رسائل عابرة.
- **Comp.PermissionPinPrompt**: تفويض أمني سريع.

### 5.3 البحث والقائمة
- **Comp.SearchBar**: حقل + كبسولات تصنيفات.
- **Comp.MenuGrid** + **Comp.MenuCard**: شبكة أصناف؛ ضغطة تضيف للطلب.

### 5.4 الطلب
- **Comp.OrderHeader**: نوع الطلب + زر الطاولات/العميل.
- **Comp.OrderLinesList** + **Comp.OrderLineRow**: صف سطر مع **QtyBadge** و **LineQuickActions**.
- **Comp.LineQuickActions**: شريط سريع: Return, Notes, Removals, Add-ons, Discount, Override.
- **Comp.Totals**: حساب نهائي.

### 5.5 المدخلات والملاحظات
- **Comp.NumpadInteger** / **Comp.NumpadDecimal**.
- **Comp.NotesSheet**: ملاحظات السطر/الطلب.

### 5.6 المُعدِّلات (على نمط ماكدونالدز)
- **Comp.ModifiersSheet**: مجموعات (addon/removal/sub/size) مع قواعد min/max، وتسعير فوري.
- **Comp.ModifierGroup** / **Comp.ModifierItem**.

### 5.7 الطاولات والحجز
- **Comp.TablesModule**:
  - **TableMap** (حالة فورية، دمج/فصل، نقل طلب)،
  - **TableList** (بحث/فرز/سعة)،
  - **TableDetails** (Guests، Orders على الطاولة، Reservations عليها، Lock/Unlock).

### 5.8 الدفع والتقسيم
- **Comp.PaymentsSheet**: وسائل متعددة (نقد/بطاقة/محفظة/أونلاين/قسيمة)، متبقي، توزيع.
- **Comp.PaymentMethodButton**، **Comp.SplitBillSheet**.

### 5.9 التقارير والطباعة
- **Comp.ReportsPanel**: فلترة حسب الحالة/النوع/الورديّة/الموظف؛ سحب من IndexedDB.
- **Comp.PrintPreviewSheet**: معاينة مطبوعة حرارية 58/80mm.

---

## 6) المواصفات التفصيلية للمكوّنات الحرجة (أولويات التنفيذ)

> نلتزم ببناء **3 مكوّنات في كل دفعة** بتشطيب كامل.

### A) Comp.Modal
- **Props**: `{open, title, size, closeOnOutside=true, closeOnEsc=true, content}`
- **A11y**: `role=dialog`, `aria-modal`, `aria-labelledby`, focus-trap.
- **أوامر**: `closeModal`, `modalKeyDown` (ESC).
- **Regions**: `modals-root` (8ms).

### B) Comp.NumpadInteger
- **Props**: `{value, min=1, max, title}`
- **مفاتيح**: 7–9, 4–6, 1–3, C, 0, ⌫, Confirm.
- **أوامر**: `numKey`, `numSync`, `numConfirm` → تعدّل `qty` ثم `truth.mark('order-panel')`.

### C) Comp.LineQuickActions
- **أزرار**: Return, Notes, Removals, Add‑ons, Discount, Override.
- **أوامر**: `openReturn`, `openNotes`, `openRemovals`, `openAddons`, `openLineDiscount`, `openPriceOverride`.

### D) Comp.ModifiersSheet
- **قواعد**: selection single/multi, min/max، حساب `modDelta`، منع تجاوز القيود.
- **حفظ**: يطبّق `mods` على السطر ويحدث `modDelta` ويتبعها `computeTotals()`.

### E) Comp.TablesModule
- **قدرات**:
  - ربط **عدة طاولات** على **طلب واحد**،
  - ربط **عدة طلبات** على **طاولة واحدة**،
  - **حجوزات** مستقلة تقفل الطاولات بزمن،
  - **Guests**: تتبّع سعة المقاعد المتاحة والمتبقية.
- **أوامر**: `selectTable`, `mergeTables`, `splitTable`, `moveOrderToTable`, `setGuests`, `createReservation`, `editReservation`, `cancelReservation`, `lockTable`, `unlockTable`.

### F) Comp.PaymentsSheet
- **وسائل**: `cash|card|wallet|online|coupon` + مزيج في نفس الطلب.
- **التقسيم**: byItems/byGuests/byAmount مع `split_id`.
- **أوامر**: `addPayment`, `editPayment`, `removePayment`, `finalize` (تنتقل الحالة إلى `paid` + طباعة).

### G) Comp.ReportsPanel
- **مصدر**: IndexedDB `orders`.
- **حالات**: `new → in_preparation → prepared → delivered → paid`.
- **فلترة**: حسب `status`, `type`, `shift_id`, `cashier`, `date_range`.
- **عرض**: النوع، رقم الطاولة، العميل/الهاتف/العنوان، حالة الطلب، الوردية، الكاشير.
- **أوامر**: `showReports`, `filterOrders`, `refreshReports`, `openOrderFromReport`.

---

## 7) التدفقات (Flows)

### 7.1 إضافة صنف مع مُعدِّلات
1. `addToOrder(itemId)` → إنشاء `OrderLine` بالقيم الافتراضية.
2. إن وُجد `modifiers_profile_id` للصنف، فتح **ModifiersSheet**.
3. عند الحفظ: حساب `modDelta` وتحديث الإجماليات.

### 7.2 الكمية السريعة
- الضغط على شارة الكمية يفتح **NumpadInteger**، تأكيد → تحديث السطر وإجماليات الطلب.

### 7.3 شريط إجراءات السطر
- زر ⋯ يطوي/يفتح الشريط: Return/Notes/Removals/Add‑ons/Discount/Override.

### 7.4 الطاولات والحجز
- اختيار/دمج/فصل الطاولات؛ نقل طلب لطاولة أخرى.
- إنشاء حجز: يقفل الطاولات (status=locked) ضمن الفترة، مع تحقق السعة.
- استعراض الطلبات أو الحجوزات للطاولة من **TableDetails** مع أزرار الإدارة.

### 7.5 حالات الطلب (Lifecycle)
`new → in_preparation → prepared → delivered → paid` مع شارة زمنية لكل انتقال.

### 7.6 الدفع والتقسيم
- توزيع مبالغ على عدة وسائل. المتبقي = total − ∑payments.
- التقسيم على ضيوف/عناصر/مبلغ، وطباعة لكل Split عند التحصيل.

### 7.7 الطباعة الحرارية (58/80mm)
- **قوالب**: Kitchen Ticket, Customer Receipt.
- **بنية السطر**:
  - `• Big Mac`
  - `  + Extra Cheese x2  +7.00`
  - `  − No Onion`
- **معايير**: عرض ثابت أحرف، لفّ تلقائي، محاذاة إجماليات يمين، دعم لغتين واتجاهين. ترويسة/تذييل حسب الإعدادات.

---

## 8) التخزين والمزامنة

- **IndexedDB** جداول: `orders`, `order_lines`, `payments`, `shifts`, `tables`, `reservations`, `customers`, `drivers`.
- **WebSocket** أحداث: `order.created`, `order.updated`, `kds.ticket`, `delivery.assign`, `shift.opened/closed`.
- **مزامنة**: Upload عند إغلاق الوردية، أو تدريجيًا في الخلفية إذا متاح.

---

## 9) الوصولية ولوحة المفاتيح (A11y/Hotkeys)

- Modal: ESC للإغلاق؛ Trap للفوكس؛ أزرار تأكيد/إلغاء قابلة للوصول.
- اختصارات:
  - `F1` مساعدة، `F2` تبديل اللغة، `F3` بحث،
  - `Alt+Q` فتح Numpad، `Alt+P` طباعة، `Alt+S` تحصيل.

---

## 10) معايير الأداء والاختبار

- كل Region بميزانية زمنية مذكورة.
- اختبار تحميل: 1000 صنف، 100 طاولة، 500 طلب محفوظ.
- سيناريوهات اختبار:
  - إضافة صنف + Modifiers + Return،
  - طلب صالة على 3 طاولات،
  - طاولة واحدة مع 3 فواتير (split)،
  - حجز يقفل طاولتين ثم تحريره،
  - دفع مختلط (كاش+بطاقة)،
  - تقرير يفلتر `in_preparation`،
  - طباعة Kitchen/Customer في عربي/إنجليزي.

---

## 11) القواميس (i18n) — مفاتيح أساسية

```
ui: {
  shift, active, inactive, dark, light, search, dine_in, takeaway, delivery,
  select, table, customer, guest, subtotal, service, delivery_fee, vat, total,
  save_order, print, settle_pay_print, no_items, discount, confirm, cancel,
  return, notes, removals, addons, override_price, close, qty,
  reports, status, type, cashier, shift_no, prepared, delivered, paid,
}
```

---

## 12) خطة التنفيذ (دفعات 3 مكوّنات)

- **الدفعة 1 (منجَزة):** Modal, NumpadInteger, LineQuickActions.
- **الدفعة 2:** ModifiersSheet, NotesSheet, ReturnItemSheet.
- **الدفعة 3:** TablesModule (Map/List/Details).
- **الدفعة 4:** PaymentsSheet, SplitBillSheet, PrintPreviewSheet.
- **الدفعة 5:** ReportsPanel + تكامل IndexedDB/WebSocket.
- **الدفعة 6:** FooterActionBar, TopBar المتقدّم (Shift/Reports/Close Shift).

---

## 13) معايير القبول (Acceptance Criteria)

- 100% عرض الشاشة؛ الأزرار واللوحات وفق قياسات اللمس.
- تبديل لغة/اتجاه/ثيم فوري.
- تدفق حالات الطلب كامل حتى **paid**، مع طباعة Kitchen/Customer.
- الطاولات: متعدد ↔ متعدد بين الطلبات والطاولات، وحجوزات بقفل زمني وسعة دقيقة.
- المُعدِّلات: تسعير دقيق يظهر في الإجماليات والطباعة وKDS.
- التقارير: فلترة حيّة، عرض الوردية والكاشير، فتح الطلب من التقرير.
- الأداء ضمن الميزانيات، وعدم وجود Rebuild شامل إلا لضرورة.

---

**تم.** هذا هو المخطط المرجعي المُحدَّث. عند الموافقة، نتابع مباشرة بالدفعة التالية من التنفيذ (Modifiers/Notes/Return) وفق هذا المستند.

