<!DOCTYPE html>
<html lang="ar" dir="rtl" data-htmlx="quick-dashboard">
  <head>
    <meta charset="utf-8" />
    <title>Mishkah Quick Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="./mishkah.js" data-htmlx data-css="mishkah"></script>
  </head>
  <body>
    <template id="quick-dashboard">
      <script type="application/json" data-path="env">
        {
          "lang": "ar",
          "dir": "rtl",
          "theme": "auto",
          "currency": "SAR"
        }
      </script>

      <script type="application/json" data-path="i18n.strings">
        {
          "quick.title": { "ar": "لوحة سريعة", "en": "Quick Dashboard" },
          "quick.metrics.revenue": { "ar": "الإيراد", "en": "Revenue" },
          "quick.metrics.orders": { "ar": "الطلبات", "en": "Orders" },
          "quick.trend": { "ar": "أداء الأسبوع", "en": "Weekly trend" },
          "quick.timer": { "ar": "الوقت المتبقي", "en": "Time left" },
          "quick.cart.title": { "ar": "السلة المباشرة", "en": "Live cart" },
          "quick.cart.randomize": { "ar": "تحديث السلة عشوائياً", "en": "Randomize cart" },
          "quick.cart.empty": { "ar": "السلة فارغة حالياً", "en": "Cart is empty" },
          "quick.cart.items.espresso": { "ar": "إسبريسو", "en": "Espresso" },
          "quick.cart.items.cortado": { "ar": "كورتادو", "en": "Cortado" },
          "quick.cart.items.flatwhite": { "ar": "فلات وايت", "en": "Flat white" },
          "quick.cart.items.cheesecake": { "ar": "تشيز كيك بالفراولة", "en": "Strawberry cheesecake" },
          "quick.cart.items.cinnamon": { "ar": "سينابون دافئ", "en": "Warm cinnamon roll" }
        }
      </script>

      <script type="application/json" data-path="data">
        {
          "metrics": { "revenue": 12800, "orders": 54 },
          "trend": {
            "values": [18, 22, 25, 28, 35, 31, 29],
            "labels": ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"]
          },
          "timer": { "seconds": 45 },
          "cart": {
            "currency": "SAR",
            "items": [
              {
                "id": "espresso",
                "nameKey": "quick.cart.items.espresso",
                "qty": 1,
                "price": 18.5
              },
              {
                "id": "cortado",
                "nameKey": "quick.cart.items.cortado",
                "qty": 2,
                "price": 16
              }
            ]
          },
          "catalog": [
            { "id": "espresso", "nameKey": "quick.cart.items.espresso", "price": 18.5 },
            { "id": "cortado", "nameKey": "quick.cart.items.cortado", "price": 16 },
            { "id": "flatwhite", "nameKey": "quick.cart.items.flatwhite", "price": 19 },
            { "id": "cheesecake", "nameKey": "quick.cart.items.cheesecake", "price": 26.5 },
            { "id": "cinnamon", "nameKey": "quick.cart.items.cinnamon", "price": 21 }
          ]
        }
      </script>

      <section data-m-scope="quick-dashboard" class="quick-shell">
        <style data-m-scope>
          :host {
            min-height: 100vh;
            margin: 0;
            padding: var(--mk-space-6);
            box-sizing: border-box;
            background: linear-gradient(
              180deg,
              color-mix(in srgb, var(--mk-bg) 94%, var(--mk-surface-3) 6%),
              color-mix(in srgb, var(--mk-bg) 86%, var(--mk-surface-1) 14%)
            );
            color: var(--mk-fg);
            font-family: var(--mk-font-sans-ar);
          }

          .quick-shell {
            inline-size: min(960px, 100%);
            margin-inline: auto;
            display: grid;
            gap: var(--mk-space-5);
            padding: clamp(var(--mk-space-5), 4vw, var(--mk-space-7));
            border-radius: var(--mk-radius-3xl);
            background: color-mix(in srgb, var(--mk-surface-1) 92%, transparent);
            border: var(--mk-border-width) solid color-mix(in srgb, var(--mk-border) 55%, transparent);
            box-shadow: var(--mk-shadow-soft);
          }

          .quick-header {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            gap: var(--mk-space-3);
          }

          .quick-title {
            margin: 0;
            font-family: var(--mk-font-display);
            font-size: clamp(var(--mk-fs-2xl), 2.6vw, var(--mk-fs-3xl));
            font-weight: 600;
            letter-spacing: -0.015em;
          }

          .quick-switchers {
            display: inline-flex;
            flex-wrap: wrap;
            gap: var(--mk-space-3);
            align-items: center;
          }

          lang-switcher,
          theme-switcher {
            display: block;
          }

          .quick-metrics {
            display: grid;
            gap: var(--mk-space-4);
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
          }

          .quick-card {
            position: relative;
            display: grid;
            gap: var(--mk-space-2);
            padding: var(--mk-space-5);
            border-radius: var(--mk-radius-2xl);
            background: color-mix(in srgb, var(--mk-surface-0) 88%, transparent);
            border: var(--mk-border-width) solid color-mix(in srgb, var(--mk-border) 48%, transparent);
            box-shadow: var(--mk-shadow-soft);
          }

          .quick-card::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            pointer-events: none;
            background: linear-gradient(140deg, transparent 55%, color-mix(in srgb, var(--mk-primary) 12%, transparent));
            opacity: 0.4;
          }

          .quick-card > * {
            position: relative;
            z-index: 1;
          }

          .quick-muted {
            color: var(--mk-muted);
            font-size: var(--mk-fs-sm);
          }

          .quick-metric-value {
            font-size: clamp(var(--mk-fs-2xl), 2.4vw, var(--mk-fs-3xl));
            font-weight: 700;
          }

          .quick-chart {
            gap: var(--mk-space-4);
          }

          .quick-chart canvas {
            inline-size: 100%;
            block-size: 260px;
          }

          .quick-timer {
            display: flex;
            align-items: center;
            justify-content: space-between;
          }

          .quick-timer-value {
            font-size: clamp(var(--mk-fs-xl), 3vw, var(--mk-fs-2xl));
            font-weight: 600;
          }

          .quick-cart {
            gap: var(--mk-space-4);
          }

          .quick-cart-header {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            gap: var(--mk-space-3);
          }

          .quick-randomize {
            display: inline-flex;
            align-items: center;
            gap: var(--mk-space-2);
            padding-inline: var(--mk-space-4);
            padding-block: calc(var(--mk-space-2) * 1.1);
            border-radius: 999px;
            border: var(--mk-border-width) solid color-mix(in srgb, var(--mk-border) 50%, transparent);
            background: color-mix(in srgb, var(--mk-surface-2) 82%, transparent);
            color: var(--mk-fg);
            font-size: var(--mk-fs-sm);
            font-weight: 600;
            box-shadow: var(--mk-shadow-soft);
            transition: transform var(--mk-duration-fast) ease, box-shadow var(--mk-duration-fast) ease;
          }

          .quick-randomize:hover {
            transform: translateY(-2px);
            box-shadow: var(--mk-shadow);
          }

          .quick-cart-list {
            display: grid;
            gap: var(--mk-space-3);
          }

          .quick-cart-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--mk-space-4);
            padding: var(--mk-space-4);
            border-radius: var(--mk-radius-xl);
            background: color-mix(in srgb, var(--mk-surface-0) 92%, transparent);
            border: var(--mk-border-width) solid color-mix(in srgb, var(--mk-border) 42%, transparent);
          }

          .quick-cart-name {
            font-size: var(--mk-fs-base);
            font-weight: 600;
          }

          .quick-cart-qty {
            font-size: var(--mk-fs-sm);
            color: var(--mk-muted);
          }

          .quick-cart-total {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            gap: var(--mk-space-3);
            padding-top: var(--mk-space-4);
            border-top: var(--mk-border-width) dashed color-mix(in srgb, var(--mk-border) 40%, transparent);
          }

          .quick-empty {
            text-align: center;
            padding: clamp(var(--mk-space-5), 5vw, var(--mk-space-6));
            border-radius: var(--mk-radius-2xl);
            border: var(--mk-border-width) dashed color-mix(in srgb, var(--mk-border) 45%, transparent);
            background: color-mix(in srgb, var(--mk-surface-0) 80%, transparent);
            color: var(--mk-muted);
          }

          @media (max-width: 640px) {
            :host {
              padding: var(--mk-space-4);
            }

            .quick-shell {
              padding: var(--mk-space-5);
            }

            .quick-card::before {
              opacity: 0.25;
            }
          }
        </style>

        <header class="quick-header">
          <h1 class="quick-title">{trans('quick.title')}</h1>
          <div class="quick-switchers">
            <lang-switcher langs="ar,en"></lang-switcher>
            <theme-switcher themes="light,dark,auto"></theme-switcher>
          </div>
        </header>

        <div class="quick-metrics">
          <section class="quick-card">
            <p class="quick-muted">{trans('quick.metrics.revenue')}</p>
            <strong class="quick-metric-value">{formatCurrency(state.data.metrics.revenue, state.env.currency || 'SAR', state.env.lang)}</strong>
          </section>
          <section class="quick-card">
            <p class="quick-muted">{trans('quick.metrics.orders')}</p>
            <strong class="quick-metric-value">{state.data.metrics.orders}</strong>
          </section>
        </div>

        <figure class="quick-card quick-chart">
          <figcaption class="quick-muted">{trans('quick.trend')}</figcaption>
          <canvas
            data-chart-auto
            data-chart-type="line"
            data-chart-values="{state.data.trend.values.join(',')}"
            data-chart-labels="{state.data.trend.labels.join(',')}"
            data-chart-height="260"
          ></canvas>
        </figure>

        <div class="quick-card quick-timer">
          <span class="quick-muted">{trans('quick.timer')}</span>
          <strong class="quick-timer-value" data-countdown="{state.data.timer.seconds}" data-countdown-template="⏱️ {{time}}"></strong>
        </div>

        <section class="quick-card quick-cart">
          <header class="quick-cart-header">
            <h2 class="quick-title" style="font-size: var(--mk-fs-xl);">{trans('quick.cart.title')}</h2>
            <button type="button" class="quick-randomize" onclick="randomizeCart(event, ctx)">
              {trans('quick.cart.randomize')}
            </button>
          </header>
          <ul class="quick-cart-list" x-if="state.data.cart.items && state.data.cart.items.length">
            <li x-for="item in state.data.cart.items" key="item.id" class="quick-cart-item">
              <div>
                <strong class="quick-cart-name">{trans(item.nameKey)}</strong>
                <span class="quick-cart-qty">× {item.qty}</span>
              </div>
              <span class="quick-metric-value" style="font-size: var(--mk-fs-lg);">
                {formatCurrency(item.price * item.qty, state.data.cart.currency || state.env.currency || 'SAR', state.env.lang)}
              </span>
            </li>
          </ul>
          <p class="quick-empty" x-if="!state.data.cart.items || !state.data.cart.items.length">
            {trans('quick.cart.empty')}
          </p>
          <footer class="quick-cart-total">
            <span class="quick-muted">{state.data.cart.updatedAt ? formatUpdatedAt(state.data.cart.updatedAt, state.env.lang) : ''}</span>
            <strong class="quick-metric-value" style="font-size: var(--mk-fs-xl);">
              {formatCurrency(totalCart(state.data.cart), state.data.cart.currency || state.env.currency || 'SAR', state.env.lang)}
            </strong>
          </footer>
        </section>
      </section>

      <script>
        var QUICK_CATALOG_CACHE = null;

        function readCatalogFromDom() {
          if (Array.isArray(QUICK_CATALOG_CACHE) && QUICK_CATALOG_CACHE.length) {
            return QUICK_CATALOG_CACHE.slice();
          }
          try {
            var dataScript = document.querySelector('script[data-path="data"]');
            if (dataScript && dataScript.textContent) {
              var payload = JSON.parse(dataScript.textContent.trim() || '{}');
              if (payload && Array.isArray(payload.catalog)) {
                QUICK_CATALOG_CACHE = payload.catalog.slice();
                return QUICK_CATALOG_CACHE.slice();
              }
            }
          } catch (err) {
            console.warn('[Mishkah] failed to read catalog from data-path', err);
          }
          return [];
        }

        function getCatalog(ctx) {
          var snapshot = null;
          if (ctx && typeof ctx.getState === 'function') {
            try {
              snapshot = ctx.getState();
            } catch (err) {
              snapshot = null;
            }
          }
          if (!snapshot && ctx && ctx.state) {
            snapshot = ctx.state;
          }
          var catalog = snapshot && snapshot.data && Array.isArray(snapshot.data.catalog) ? snapshot.data.catalog : null;
          if (catalog && catalog.length) {
            return catalog.slice();
          }
          return readCatalogFromDom();
        }

        function ensureLanguage(lang) {
          if (typeof lang === 'string' && lang) {
            var normalized = lang.toLowerCase();
            return normalized === 'ar' ? 'ar' : normalized === 'en' ? 'en' : normalized;
          }
          return 'ar';
        }

        function cloneState(prev) {
          try {
            return JSON.parse(JSON.stringify(prev || {}));
          } catch (err) {
            if (!prev || typeof prev !== 'object') return {};
            return Array.isArray(prev) ? prev.slice() : Object.assign({}, prev);
          }
        }

        function commit(ctx, producer, after) {
          if (!ctx) return;
          if (typeof ctx.commit === 'function') {
            return ctx.commit(producer, after);
          }
          if (typeof ctx.setState !== 'function') return;
          ctx.setState(function (prev) {
            var next = cloneState(prev);
            if (typeof producer === 'function') {
              producer(next, prev || {});
            }
            return next;
          });
          if (typeof after === 'function') {
            window.setTimeout(function () {
              try {
                after(ctx.getState ? ctx.getState() : null, ctx);
              } catch (err) {
                console.error('[Mishkah] commit after hook failed', err);
              }
            }, 0);
          }
        }

        function formatCurrency(amount, currency, lang) {
          var safeLang = ensureLanguage(lang);
          var code = currency && typeof currency === 'string' ? currency : 'SAR';
          var numeric = Number(amount);
          if (!Number.isFinite(numeric)) numeric = 0;
          try {
            return new Intl.NumberFormat(safeLang === 'ar' ? 'ar-SA' : 'en-US', {
              style: 'currency',
              currency: code,
              maximumFractionDigits: 2
            }).format(numeric);
          } catch (err) {
            var fixed = numeric.toFixed(2);
            return safeLang === 'ar' ? fixed + ' ' + code : code + ' ' + fixed;
          }
        }

        function totalCart(cart) {
          if (!cart || !Array.isArray(cart.items)) return 0;
          var total = 0;
          for (var i = 0; i < cart.items.length; i += 1) {
            var item = cart.items[i];
            var line = Number(item && item.price) * Number(item && item.qty);
            if (Number.isFinite(line)) total += line;
          }
          return Math.max(0, Math.round(total * 100) / 100);
        }

        function formatUpdatedAt(timestamp, lang) {
          if (!timestamp) return '';
          try {
            var date = new Date(timestamp);
            if (Number.isNaN(date.getTime())) return '';
            var safeLang = ensureLanguage(lang);
            return date.toLocaleTimeString(safeLang === 'ar' ? 'ar-SA' : 'en-US', {
              hour: '2-digit',
              minute: '2-digit'
            });
          } catch (err) {
            return '';
          }
        }

        function pickRandomItems(ctx) {
          var pool = getCatalog(ctx);
          var count = 1 + Math.floor(Math.random() * Math.min(pool.length, 4));
          var picks = [];
          for (var i = 0; i < count && pool.length; i += 1) {
            var index = Math.floor(Math.random() * pool.length);
            var base = pool.splice(index, 1)[0];
            if (!base) continue;
            var qty = 1 + Math.floor(Math.random() * 3);
            picks.push({
              id: base.id,
              nameKey: base.nameKey,
              qty: qty,
              price: base.price
            });
          }
          return picks;
        }

        function randomizeCart(event, ctx) {
          if (event && typeof event.preventDefault === 'function') {
            event.preventDefault();
          }
          if (!ctx) return;
          var items = pickRandomItems(ctx);
          var totalQty = 0;
          for (var i = 0; i < items.length; i += 1) {
            totalQty += Number.isFinite(items[i].qty) ? items[i].qty : 0;
          }
          var now = new Date();
          commit(ctx, function (next) {
            next.data = next.data || {};
            var cart = next.data.cart || {};
            cart.items = items;
            cart.updatedAt = now.toISOString();
            cart.currency = cart.currency || (next.env && next.env.currency) || 'SAR';
            next.data.cart = cart;
            next.data.metrics = next.data.metrics || {};
            next.data.metrics.revenue = totalCart(cart);
            next.data.metrics.orders = totalQty || items.length;
          });
        }
      </script>
    </template>
  </body>
</html>
