<!DOCTYPE html>
<html lang="ar" dir="rtl" data-htmlx="quick-dashboard">
  <head>
    <meta charset="utf-8" />
    <title>Mishkah Quick Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="./mishkah.js" data-htmlx data-css="mishkah"></script>
  </head>
  <body>
    <template id="quick-dashboard">
      <script type="application/json" data-path="env">
        {
          "lang": "ar",
          "dir": "rtl",
          "theme": "auto",
          "currency": "SAR"
        }
      </script>

      <script type="application/json" data-path="i18n.strings">
        {
          "quick.title": { "ar": "لوحة سريعة", "en": "Quick Dashboard" },
          "quick.metrics.revenue": { "ar": "الإيراد", "en": "Revenue" },
          "quick.metrics.orders": { "ar": "الطلبات", "en": "Orders" },
          "quick.trend": { "ar": "أداء الأسبوع", "en": "Weekly trend" },
          "quick.timer": { "ar": "الوقت المتبقي", "en": "Time left" },
          "quick.cart.title": { "ar": "السلة المباشرة", "en": "Live cart" },
          "quick.cart.randomize": { "ar": "تحديث السلة عشوائياً", "en": "Randomize cart" },
          "quick.cart.empty": { "ar": "السلة فارغة حالياً", "en": "Cart is empty" },
          "quick.cart.items.espresso": { "ar": "إسبريسو", "en": "Espresso" },
          "quick.cart.items.cortado": { "ar": "كورتادو", "en": "Cortado" },
          "quick.cart.items.flatwhite": { "ar": "فلات وايت", "en": "Flat white" },
          "quick.cart.items.cheesecake": { "ar": "تشيز كيك بالفراولة", "en": "Strawberry cheesecake" },
          "quick.cart.items.cinnamon": { "ar": "سينابون دافئ", "en": "Warm cinnamon roll" }
        }
      </script>

      <script type="application/json" data-path="data">
        {
          "metrics": { "revenue": 12800, "orders": 54 },
          "trend": {
            "values": [18, 22, 25, 28, 35, 31, 29],
            "labels": ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"]
          },
          "timer": { "seconds": 45 },
          "cart": {
            "currency": "SAR",
            "items": [
              {
                "id": "espresso",
                "nameKey": "quick.cart.items.espresso",
                "qty": 1,
                "price": 18.5
              },
              {
                "id": "cortado",
                "nameKey": "quick.cart.items.cortado",
                "qty": 2,
                "price": 16
              }
            ]
          }
        }
      </script>

      <section data-m-scope="quick-dashboard" class="mx-auto flex min-h-screen max-w-4xl flex-col gap-6 bg-[var(--background)] p-6">
        <header class="flex flex-wrap items-center justify-between gap-3">
          <h1 class="text-2xl font-semibold">{trans('quick.title')}</h1>
          <div class="flex items-center gap-2">
            <comp name="ui.language-switch" lang="{state.env.lang}"></comp>
            <comp name="ui.theme-toggle-icon" theme="{state.env.theme}" gkey="ui:theme-toggle"></comp>
          </div>
        </header>

        <div class="grid gap-4 sm:grid-cols-2">
          <section class="rounded-2xl border border-[var(--border)] bg-[var(--card)] p-5 shadow-[var(--shadow)]">
            <p class="text-sm text-[var(--muted-foreground)]">{trans('quick.metrics.revenue')}</p>
            <strong class="text-3xl font-bold">{formatCurrency(state.data.metrics.revenue, state.env.currency || 'SAR', state.env.lang)}</strong>
          </section>
          <section class="rounded-2xl border border-[var(--border)] bg-[var(--card)] p-5 shadow-[var(--shadow)]">
            <p class="text-sm text-[var(--muted-foreground)]">{trans('quick.metrics.orders')}</p>
            <strong class="text-3xl font-bold">{state.data.metrics.orders}</strong>
          </section>
        </div>

        <figure class="rounded-3xl border border-[var(--border)] bg-[var(--card)] p-5 shadow-[var(--shadow)]">
          <figcaption class="mb-3 text-sm text-[var(--muted-foreground)]">{trans('quick.trend')}</figcaption>
          <canvas
            data-chart-auto
            data-chart-type="line"
            data-chart-values="18,22,25,28,35,31,29"
            data-chart-labels="Mon,Tue,Wed,Thu,Fri,Sat,Sun"
            data-chart-height="260"
          ></canvas>
        </figure>

        <div class="flex items-center justify-between rounded-3xl border border-[var(--border)] bg-[var(--card)] p-5 shadow-[var(--shadow)]">
          <span class="text-sm text-[var(--muted-foreground)]">{trans('quick.timer')}</span>
          <strong class="text-2xl font-semibold" data-countdown="{state.data.timer.seconds}" data-countdown-template="⏱️ {{time}}"></strong>
        </div>

        <section class="rounded-3xl border border-[var(--border)] bg-[var(--card)] p-5 shadow-[var(--shadow)]">
          <header class="mb-4 flex flex-wrap items-center justify-between gap-3">
            <h2 class="text-lg font-semibold">{trans('quick.cart.title')}</h2>
            <button type="button" class="rounded-full border border-[var(--border)] bg-[var(--surface)] px-4 py-2 text-sm font-medium text-[var(--foreground)] shadow-[var(--shadow)] transition hover:-translate-y-0.5 hover:shadow-lg" onclick="randomizeCart(event, ctx)">
              {trans('quick.cart.randomize')}
            </button>
          </header>
          <ul class="grid gap-3" x-if="state.data.cart.items && state.data.cart.items.length">
            <li x-for="item in state.data.cart.items" key="item.id" class="flex items-center justify-between rounded-2xl border border-[var(--border)] bg-[var(--surface)] px-4 py-3">
              <div class="flex flex-col">
                <strong class="text-base">{trans(item.nameKey)}</strong>
                <span class="text-sm text-[var(--muted-foreground)]">× {item.qty}</span>
              </div>
              <span class="text-base font-semibold">{formatCurrency(item.price * item.qty, state.data.cart.currency || state.env.currency || 'SAR', state.env.lang)}</span>
            </li>
          </ul>
          <p class="rounded-2xl border border-dashed border-[var(--border)] bg-[var(--surface)] px-4 py-6 text-center text-sm text-[var(--muted-foreground)]" x-if="!state.data.cart.items || !state.data.cart.items.length">
            {trans('quick.cart.empty')}
          </p>
          <footer class="mt-5 flex flex-wrap items-center justify-between gap-3 border-t border-dashed border-[var(--border)] pt-4">
            <span class="text-sm text-[var(--muted-foreground)]">{state.data.cart.updatedAt ? formatUpdatedAt(state.data.cart.updatedAt, state.env.lang) : ''}</span>
            <strong class="text-xl font-semibold">{formatCurrency(totalCart(state.data.cart), state.data.cart.currency || state.env.currency || 'SAR', state.env.lang)}</strong>
          </footer>
        </section>
      </section>

      <script>
        var CART_CATALOG = [
          { id: 'espresso', nameKey: 'quick.cart.items.espresso', price: 18.5 },
          { id: 'cortado', nameKey: 'quick.cart.items.cortado', price: 16 },
          { id: 'flatwhite', nameKey: 'quick.cart.items.flatwhite', price: 19 },
          { id: 'cheesecake', nameKey: 'quick.cart.items.cheesecake', price: 26.5 },
          { id: 'cinnamon', nameKey: 'quick.cart.items.cinnamon', price: 21 }
        ];

        function ensureLanguage(lang) {
          if (typeof lang === 'string' && lang) {
            var normalized = lang.toLowerCase();
            return normalized === 'ar' ? 'ar' : normalized === 'en' ? 'en' : normalized;
          }
          return 'ar';
        }

        function cloneState(prev) {
          try {
            return JSON.parse(JSON.stringify(prev || {}));
          } catch (err) {
            if (!prev || typeof prev !== 'object') return {};
            return Array.isArray(prev) ? prev.slice() : Object.assign({}, prev);
          }
        }

        function commit(ctx, producer, after) {
          if (!ctx) return;
          if (typeof ctx.commit === 'function') {
            return ctx.commit(producer, after);
          }
          if (typeof ctx.setState !== 'function') return;
          ctx.setState(function (prev) {
            var next = cloneState(prev);
            if (typeof producer === 'function') {
              producer(next, prev || {});
            }
            return next;
          });
          if (typeof after === 'function') {
            window.setTimeout(function () {
              try {
                after(ctx.getState ? ctx.getState() : null, ctx);
              } catch (err) {
                console.error('[Mishkah] commit after hook failed', err);
              }
            }, 0);
          }
        }

        function formatCurrency(amount, currency, lang) {
          var safeLang = ensureLanguage(lang);
          var code = currency && typeof currency === 'string' ? currency : 'SAR';
          var numeric = Number(amount);
          if (!Number.isFinite(numeric)) numeric = 0;
          try {
            return new Intl.NumberFormat(safeLang === 'ar' ? 'ar-SA' : 'en-US', {
              style: 'currency',
              currency: code,
              maximumFractionDigits: 2
            }).format(numeric);
          } catch (err) {
            var fixed = numeric.toFixed(2);
            return safeLang === 'ar' ? fixed + ' ' + code : code + ' ' + fixed;
          }
        }

        function totalCart(cart) {
          if (!cart || !Array.isArray(cart.items)) return 0;
          var total = 0;
          for (var i = 0; i < cart.items.length; i += 1) {
            var item = cart.items[i];
            var line = Number(item && item.price) * Number(item && item.qty);
            if (Number.isFinite(line)) total += line;
          }
          return Math.max(0, Math.round(total * 100) / 100);
        }

        function formatUpdatedAt(timestamp, lang) {
          if (!timestamp) return '';
          try {
            var date = new Date(timestamp);
            if (Number.isNaN(date.getTime())) return '';
            var safeLang = ensureLanguage(lang);
            return date.toLocaleTimeString(safeLang === 'ar' ? 'ar-SA' : 'en-US', {
              hour: '2-digit',
              minute: '2-digit'
            });
          } catch (err) {
            return '';
          }
        }

        function pickRandomItems() {
          var pool = CART_CATALOG.slice();
          var count = 1 + Math.floor(Math.random() * Math.min(pool.length, 4));
          var picks = [];
          for (var i = 0; i < count && pool.length; i += 1) {
            var index = Math.floor(Math.random() * pool.length);
            var base = pool.splice(index, 1)[0];
            if (!base) continue;
            var qty = 1 + Math.floor(Math.random() * 3);
            picks.push({
              id: base.id,
              nameKey: base.nameKey,
              qty: qty,
              price: base.price
            });
          }
          return picks;
        }

        function randomizeCart(event, ctx) {
          if (event && typeof event.preventDefault === 'function') {
            event.preventDefault();
          }
          if (!ctx) return;
          var items = pickRandomItems();
          var totalQty = 0;
          for (var i = 0; i < items.length; i += 1) {
            totalQty += Number.isFinite(items[i].qty) ? items[i].qty : 0;
          }
          var now = new Date();
          commit(ctx, function (next) {
            next.data = next.data || {};
            var cart = next.data.cart || {};
            cart.items = items;
            cart.updatedAt = now.toISOString();
            cart.currency = cart.currency || (next.env && next.env.currency) || 'SAR';
            next.data.cart = cart;
            next.data.metrics = next.data.metrics || {};
            next.data.metrics.revenue = totalCart(cart);
            next.data.metrics.orders = totalQty || items.length;
          });
        }
      </script>
    </template>
  </body>
</html>
