<!DOCTYPE html>
<html lang="ar" dir="rtl" data-htmlx="quick-dashboard" data-css-library="mi" data-theme="dark" class="dark">
  <head>
    <meta charset="utf-8" />
    <title>Mishkah Quick Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="./mishkah.js" data-htmlx data-css="env"></script>
  </head>
  <body class="bg-[var(--background)] text-[var(--foreground)]">
    <template id="quick-dashboard">
      <script type="application/json" data-path="env">
        {
          "theme": "dark",
          "lang": "ar",
          "dir": "rtl",
          "currency": "SAR",
          "fonts": {
            "ar": "Almarai",
            "en": "Inter",
            "display": "Almarai",
            "fallbacks": ["Cairo", "Noto Naskh Arabic", "Amiri"]
          },
          "css": ["mishkah"],
          "tailwind": true
        }
      </script>

      <script type="application/json" data-path="i18n.strings">
        {
          "quick.title": { "ar": "لوحة سريعة", "en": "Quick Dashboard" },
          "quick.tagline": { "ar": "رصد مباشر لمبيعاتك اليومية", "en": "Live snapshot of your daily sales" },
          "quick.metrics.revenue": { "ar": "الإيراد", "en": "Revenue" },
          "quick.metrics.orders": { "ar": "الطلبات", "en": "Orders" },
          "quick.trend": { "ar": "أداء الأسبوع", "en": "Weekly trend" },
          "quick.sales.title": { "ar": "مبيعات الأصناف", "en": "Product sales" },
          "quick.sales.subtitle": {
            "ar": "بالآلاف لكل شهر خلال العام الحالي",
            "en": "Monthly performance in thousands for the current year"
          },
          "quick.sales.unit": { "ar": "القيم بالألف", "en": "Values in thousands" },
          "quick.sales.latest": { "ar": "آخر شهر", "en": "Last month" },
          "quick.sales.yearly": { "ar": "إجمالي العام", "en": "Year total" },
          "quick.sales.legend": { "ar": "يتم عرض الأرقام كآلاف الريالات", "en": "Numbers shown as thousands of SAR" },
          "quick.timer": { "ar": "الوقت المتبقي", "en": "Time left" },
          "quick.cart.title": { "ar": "السلة المباشرة", "en": "Live cart" },
          "quick.cart.randomize": { "ar": "تحديث السلة عشوائياً", "en": "Randomize cart" },
          "quick.cart.empty": { "ar": "السلة فارغة حالياً", "en": "Cart is empty" },
          "quick.cart.items.espresso": { "ar": "إسبريسو", "en": "Espresso" },
          "quick.cart.items.cortado": { "ar": "كورتادو", "en": "Cortado" },
          "quick.cart.items.flatwhite": { "ar": "فلات وايت", "en": "Flat white" },
          "quick.cart.items.cheesecake": { "ar": "تشيز كيك بالفراولة", "en": "Strawberry cheesecake" },
          "quick.cart.items.cinnamon": { "ar": "سينابون دافئ", "en": "Warm cinnamon roll" }
        }
      </script>

      <script type="application/json" data-path="data">
        {
          "metrics": { "revenue": 59900, "orders": 2480 },
          "analytics": {
            "unit": "K",
            "unitLabelKey": "quick.sales.unit",
            "months": {
              "ar": [
                "يناير",
                "فبراير",
                "مارس",
                "أبريل",
                "مايو",
                "يونيو",
                "يوليو",
                "أغسطس",
                "سبتمبر",
                "أكتوبر",
                "نوفمبر",
                "ديسمبر"
              ],
              "en": [
                "Jan",
                "Feb",
                "Mar",
                "Apr",
                "May",
                "Jun",
                "Jul",
                "Aug",
                "Sep",
                "Oct",
                "Nov",
                "Dec"
              ]
            },
            "monthIndex": 11,
            "series": [
              {
                "id": "espresso",
                "nameKey": "quick.cart.items.espresso",
                "color": "#f97316",
                "values": [12.4, 13.1, 13.8, 14.6, 15.2, 16.1, 17.4, 18.2, 19.0, 19.8, 20.5, 21.2]
              },
              {
                "id": "cortado",
                "nameKey": "quick.cart.items.cortado",
                "color": "#38bdf8",
                "values": [8.2, 8.5, 8.9, 9.3, 9.7, 10.2, 10.6, 11.0, 11.4, 11.8, 12.1, 12.3]
              },
              {
                "id": "flatwhite",
                "nameKey": "quick.cart.items.flatwhite",
                "color": "#a855f7",
                "values": [6.9, 7.2, 7.5, 7.9, 8.3, 8.7, 9.1, 9.5, 9.9, 10.3, 10.6, 10.9]
              },
              {
                "id": "cheesecake",
                "nameKey": "quick.cart.items.cheesecake",
                "color": "#facc15",
                "values": [4.4, 4.7, 5.0, 5.4, 5.8, 6.1, 6.5, 6.9, 7.2, 7.6, 8.0, 8.4]
              },
              {
                "id": "cinnamon",
                "nameKey": "quick.cart.items.cinnamon",
                "color": "#22c55e",
                "values": [3.8, 4.0, 4.2, 4.4, 4.6, 4.9, 5.2, 5.5, 5.9, 6.3, 6.8, 7.1]
              }
            ],
            "chart": { "type": "line", "height": 320, "titleKey": "quick.sales.title" }
          },
          "timer": { "seconds": 270 },
          "cart": {
            "currency": "SAR",
            "items": [
              {
                "id": "espresso",
                "nameKey": "quick.cart.items.espresso",
                "qty": 1,
                "price": 18.5
              },
              {
                "id": "cortado",
                "nameKey": "quick.cart.items.cortado",
                "qty": 2,
                "price": 16
              }
            ]
          },
          "catalog": [
            { "id": "espresso", "nameKey": "quick.cart.items.espresso", "price": 18.5 },
            { "id": "cortado", "nameKey": "quick.cart.items.cortado", "price": 16 },
            { "id": "flatwhite", "nameKey": "quick.cart.items.flatwhite", "price": 19 },
            { "id": "cheesecake", "nameKey": "quick.cart.items.cheesecake", "price": 26.5 },
            { "id": "cinnamon", "nameKey": "quick.cart.items.cinnamon", "price": 21 }
          ],
          "ui": { "countdownTemplate": "⏱️ {{time}}", "salesLegendKey": "quick.sales.legend" }
        }
      </script>

      <section
        data-m-scope="quick-dashboard"
        class="mx-auto flex min-h-screen max-w-5xl flex-col gap-6 bg-[var(--background)] p-6 sm:p-10"
      >
        <header class="flex flex-wrap items-center justify-between gap-3 rounded-3xl border border-[var(--border)] bg-[var(--card)] px-6 py-5 shadow-[var(--shadow)]">
          <div class="space-y-1">
            <h1 class="text-2xl font-semibold">{trans('quick.title')}</h1>
            <p class="text-sm text-[var(--muted-foreground)]">{trans('quick.tagline')}</p>
          </div>
          <div class="flex items-center gap-2">
            <theme-switcher class="hero-switcher" themes="dark,light"></theme-switcher>
            <lang-switcher class="hero-switcher" langs="ar,en"></lang-switcher>
          </div>
        </header>

        <div class="grid gap-4 sm:grid-cols-2">
          <section class="rounded-3xl border border-[var(--border)] bg-[var(--card)] p-6 shadow-[var(--shadow)]">
            <p class="text-sm text-[var(--muted-foreground)]">{trans('quick.metrics.revenue')}</p>
            <strong class="mt-1 block text-3xl font-semibold text-[var(--primary)]">
              {formatCurrency(state.data.metrics.revenue, state.env.currency || 'SAR', state.env.lang)}
            </strong>
          </section>
          <section class="rounded-3xl border border-[var(--border)] bg-[var(--card)] p-6 shadow-[var(--shadow)]">
            <p class="text-sm text-[var(--muted-foreground)]">{trans('quick.metrics.orders')}</p>
            <strong class="mt-1 block text-3xl font-semibold text-[var(--accent)]">
              {state.data.metrics.orders}
            </strong>
          </section>
        </div>

        <figure class="rounded-3xl border border-[var(--border)] bg-[var(--card)] p-6 shadow-[var(--shadow)]">
          <header class="mb-4 flex flex-wrap items-start justify-between gap-2">
            <div>
              <figcaption class="text-sm font-medium text-[var(--muted-foreground)]">
                {trans('quick.sales.title')}
              </figcaption>
              <p class="mt-1 text-xs text-[var(--muted-foreground)]">{trans('quick.sales.subtitle')}</p>
            </div>
            <span class="text-xs text-[var(--muted-foreground)]">
              {trans(state.data.analytics.unitLabelKey || 'quick.sales.unit')}
            </span>
          </header>
          <canvas
            data-chart-auto="line"
            data-chart-type="line"
            data-chart-bind="data.analytics"
            data-chart-height="{state.data.analytics.chart && state.data.analytics.chart.height ? state.data.analytics.chart.height : 320}"
            style="min-height:{state.data.analytics.chart && state.data.analytics.chart.height ? state.data.analytics.chart.height : 320}px;height:{state.data.analytics.chart && state.data.analytics.chart.height ? state.data.analytics.chart.height : 320}px;"
            id="quick-sales-chart"
          ></canvas>
          <p
            class="mt-3 text-xs text-[var(--muted-foreground)]"
            x-if="state.data.ui && state.data.ui.salesLegendKey"
          >
            {trans(state.data.ui.salesLegendKey)}
          </p>
          <div class="mt-5 grid gap-3 lg:grid-cols-2">
            <article
              x-for="series in state.data.analytics.series"
              key="series.id"
              class="flex items-center justify-between rounded-2xl border border-[var(--border)] bg-[var(--surface)] px-4 py-3 shadow-[var(--shadow)]"
            >
              <div class="flex items-start gap-3">
                <span
                  class="mt-1 inline-block h-3 w-3 rounded-full bg-[var(--primary)]"
                  data-series-swatch
                  data-series-id="{series.id}"
                ></span>
                <div>
                  <strong class="text-sm font-semibold">{trans(series.nameKey)}</strong>
                  <p class="text-xs text-[var(--muted-foreground)]">
                    {trans('quick.sales.latest')}: {currentAnalyticsMonth(state)} — {formatThousands(latestValue(series), state.data.analytics.unit, state.env && state.env.lang)}
                  </p>
                </div>
              </div>
              <div class="text-right">
                <strong class="block text-sm font-semibold text-[var(--primary)]">
                  {formatThousands(sumSeries(series), state.data.analytics.unit, state.env && state.env.lang)}
                </strong>
                <span class="text-xs text-[var(--muted-foreground)]">{trans('quick.sales.yearly')}</span>
              </div>
            </article>
          </div>
        </figure>

        <div class="flex items-center justify-between rounded-3xl border border-[var(--border)] bg-[var(--card)] p-6 shadow-[var(--shadow)]">
          <span class="text-sm text-[var(--muted-foreground)]">{trans('quick.timer')}</span>
          <strong
            class="text-2xl font-semibold"
            data-countdown="{state.data.timer.seconds}"
            data-countdown-template="{state.data.ui.countdownTemplate}"
          ></strong>
        </div>

        <section class="rounded-3xl border border-[var(--border)] bg-[var(--card)] p-6 shadow-[var(--shadow)]">
          <header class="mb-4 flex flex-wrap items-center justify-between gap-3">
            <h2 class="text-xl font-semibold">{trans('quick.cart.title')}</h2>
            <button
              type="button"
              class="rounded-full border border-[var(--border)] bg-[var(--surface)] px-4 py-2 text-sm font-medium text-[var(--foreground)] shadow-[var(--shadow)] transition hover:-translate-y-0.5 hover:shadow-lg"
              onclick="randomizeCart(event, ctx)"
            >
              {trans('quick.cart.randomize')}
            </button>
          </header>
          <ul class="grid gap-3" x-if="state.data.cart.items && state.data.cart.items.length">
            <li
              x-for="item in state.data.cart.items"
              key="item.id"
              class="flex items-center justify-between rounded-2xl border border-[var(--border)] bg-[var(--surface)] px-4 py-3"
            >
              <div class="flex flex-col">
                <strong class="text-base font-semibold">{trans(item.nameKey)}</strong>
                <span class="text-sm text-[var(--muted-foreground)]">× {item.qty}</span>
              </div>
              <span class="text-base font-semibold">
                {formatCurrency(item.price * item.qty, state.data.cart.currency || state.env.currency || 'SAR', state.env.lang)}
              </span>
            </li>
          </ul>
          <p
            class="rounded-2xl border border-dashed border-[var(--border)] bg-[var(--surface)] px-6 py-8 text-center text-sm text-[var(--muted-foreground)]"
            x-if="!state.data.cart.items || !state.data.cart.items.length"
          >
            {trans('quick.cart.empty')}
          </p>
          <footer class="mt-5 flex flex-wrap items-center justify-between gap-3 border-t border-dashed border-[var(--border)] pt-4">
            <span class="text-sm text-[var(--muted-foreground)]">{state.data.cart.updatedAt ? formatUpdatedAt(state.data.cart.updatedAt, state.env.lang) : ''}</span>
            <strong class="text-xl font-semibold">
              {formatCurrency(totalCart(state.data.cart), state.data.cart.currency || state.env.currency || 'SAR', state.env.lang)}
            </strong>
          </footer>
        </section>
      </section>

      <script>
        function toCsv(list) {
          if (!Array.isArray(list)) return '';
          return list
            .map(function (value) {
              return value == null ? '' : String(value).trim();
            })
            .filter(function (value) {
              return value.length > 0;
            })
            .join(',');
        }

        function getCatalog(ctx) {
          var snapshot = null;
          if (ctx && typeof ctx.getState === 'function') {
            try {
              snapshot = ctx.getState();
            } catch (err) {
              snapshot = null;
            }
          }
          if (!snapshot && ctx && ctx.state) {
            snapshot = ctx.state;
          }
          var catalog = snapshot && snapshot.data && Array.isArray(snapshot.data.catalog) ? snapshot.data.catalog : null;
          if (catalog && catalog.length) {
            return catalog.slice();
          }
          return [];
        }

        function ensureLanguage(lang) {
          if (typeof lang === 'string' && lang) {
            var normalized = lang.toLowerCase();
            return normalized === 'ar' ? 'ar' : normalized === 'en' ? 'en' : normalized;
          }
          return 'ar';
        }

        function cloneState(prev) {
          try {
            return JSON.parse(JSON.stringify(prev || {}));
          } catch (err) {
            if (!prev || typeof prev !== 'object') return {};
            return Array.isArray(prev) ? prev.slice() : Object.assign({}, prev);
          }
        }

        function commit(ctx, producer, after) {
          if (!ctx) return;
          if (typeof ctx.commit === 'function') {
            return ctx.commit(producer, after);
          }
          if (typeof ctx.setState !== 'function') return;
          ctx.setState(function (prev) {
            var next = cloneState(prev);
            if (typeof producer === 'function') {
              producer(next, prev || {});
            }
            return next;
          });
          if (typeof after === 'function') {
            window.setTimeout(function () {
              try {
                after(ctx.getState ? ctx.getState() : null, ctx);
              } catch (err) {
                console.error('[Mishkah] commit after hook failed', err);
              }
            }, 0);
          }
        }

        function formatCurrency(amount, currency, lang) {
          var safeLang = ensureLanguage(lang);
          var code = currency && typeof currency === 'string' ? currency : 'SAR';
          var numeric = Number(amount);
          if (!Number.isFinite(numeric)) numeric = 0;
          try {
            return new Intl.NumberFormat(safeLang === 'ar' ? 'ar-SA' : 'en-US', {
              style: 'currency',
              currency: code,
              maximumFractionDigits: 2
            }).format(numeric);
          } catch (err) {
            var fixed = numeric.toFixed(2);
            return safeLang === 'ar' ? fixed + ' ' + code : code + ' ' + fixed;
          }
        }

        function totalCart(cart) {
          if (!cart || !Array.isArray(cart.items)) return 0;
          var total = 0;
          for (var i = 0; i < cart.items.length; i += 1) {
            var item = cart.items[i];
            var line = Number(item && item.price) * Number(item && item.qty);
            if (Number.isFinite(line)) total += line;
          }
          return Math.max(0, Math.round(total * 100) / 100);
        }

        function formatUpdatedAt(timestamp, lang) {
          if (!timestamp) return '';
          try {
            var date = new Date(timestamp);
            if (Number.isNaN(date.getTime())) return '';
            var safeLang = ensureLanguage(lang);
            return date.toLocaleTimeString(safeLang === 'ar' ? 'ar-SA' : 'en-US', {
              hour: '2-digit',
              minute: '2-digit'
            });
          } catch (err) {
            return '';
          }
        }

        var DEFAULT_MONTHS_EN = 'Jan,Feb,Mar,Apr,May,Jun,Jul,Aug,Sep,Oct,Nov,Dec'.split(',');
        var DEFAULT_MONTHS_AR = 'يناير|فبراير|مارس|أبريل|مايو|يونيو|يوليو|أغسطس|سبتمبر|أكتوبر|نوفمبر|ديسمبر'.split('|');
        var SALES_PALETTE = '#38bdf8,#f97316,#a855f7,#22c55e,#facc15,#ef4444'.split(',');
        var chartHydrationTimer = null;
        var chartHydrationAttempts = 0;
        var CHART_HYDRATION_MAX_ATTEMPTS = 80;
        var CHART_HYDRATION_BASE_DELAY = 12;
        var CHART_HYDRATION_STEP = 36;

        function resetChartHydrationBackoff() {
          if (chartHydrationTimer) {
            window.clearTimeout(chartHydrationTimer);
            chartHydrationTimer = null;
          }
          chartHydrationAttempts = 0;
        }

        function scheduleChartHydrationRetry() {
          if (chartHydrationAttempts >= CHART_HYDRATION_MAX_ATTEMPTS) return;
          var delay = Math.min(900, CHART_HYDRATION_BASE_DELAY + chartHydrationAttempts * CHART_HYDRATION_STEP);
          chartHydrationTimer = window.setTimeout(function () {
            chartHydrationTimer = null;
            attemptChartHydration();
          }, delay);
        }

        function performChartHydration(providedState, providedCtx) {
          var context = providedCtx || window.MishkahAuto || null;
          var snapshot = providedState;
          if (!snapshot && typeof resolveAutoState === 'function') {
            snapshot = resolveAutoState();
          }
          if (!snapshot && context) {
            if (typeof context.getState === 'function') {
              try {
                snapshot = context.getState();
              } catch (stateErr) {
                snapshot = context.state || snapshot;
              }
            } else if (context.state) {
              snapshot = context.state;
            }
          }
          var success = false;
          try {
            success = syncSalesChart(snapshot, context);
          } catch (err) {
            console.warn('[Mishkah] quick dashboard chart hydration attempt failed', err);
          }
          if (snapshot) {
            ensureCountdownLoop(snapshot);
          } else {
            var fallback = typeof resolveAutoState === 'function' ? resolveAutoState() : null;
            if (fallback) ensureCountdownLoop(fallback);
          }
          return !!success;
        }

        function attemptChartHydration(providedState, providedCtx, resetAttempts) {
          if (resetAttempts) {
            resetChartHydrationBackoff();
          } else if (chartHydrationTimer) {
            window.clearTimeout(chartHydrationTimer);
            chartHydrationTimer = null;
          }
          var success = performChartHydration(providedState, providedCtx);
          if (success) {
            resetChartHydrationBackoff();
            return true;
          }
          chartHydrationAttempts += 1;
          scheduleChartHydrationRetry();
          return false;
        }

        function numericList(values) {
          var list = [];
          if (!Array.isArray(values)) return list;
          for (var i = 0; i < values.length; i += 1) {
            var value = Number(values[i]);
            if (Number.isFinite(value)) {
              list.push(value);
            }
          }
          return list;
        }

        function averageOf(list) {
          if (!list.length) return NaN;
          var total = 0;
          for (var i = 0; i < list.length; i += 1) {
            total += list[i];
          }
          return total / list.length;
        }

        function translateKey(ctx, key, state) {
          if (!key) return '';
          if (ctx && typeof ctx.trans === 'function') {
            try {
              return ctx.trans(key);
            } catch (_err) {}
          }
          if (ctx && ctx.app && typeof ctx.app.trans === 'function') {
            try {
              return ctx.app.trans(key);
            } catch (_err2) {}
          }
          var lang = state && state.env ? state.env.lang : null;
          var strings = state && state.i18n && state.i18n.strings ? state.i18n.strings : null;
          if (strings && strings[key]) {
            var entry = strings[key];
            if (lang && entry[lang]) return entry[lang];
            if (entry.en) return entry.en;
            for (var entryKey in entry) {
              if (Object.prototype.hasOwnProperty.call(entry, entryKey)) {
                return entry[entryKey];
              }
            }
          }
          var host = window.Mishkah || window.Mishka || null;
          if (host && host.i18n && typeof host.i18n.translate === 'function') {
            try {
              return host.i18n.translate(key, lang);
            } catch (_err3) {}
          }
          return key;
        }

        function resolveAnalytics(state) {
          var data = state && state.data ? state.data.analytics : null;
          return data && typeof data === 'object' ? data : null;
        }

        function resolveMonths(state, analytics) {
          var lang = ensureLanguage(state && state.env && state.env.lang);
          var monthsSource = analytics && analytics.months ? analytics.months : null;
          var list = [];
          if (Array.isArray(monthsSource)) {
            list = monthsSource.slice();
          } else if (monthsSource && typeof monthsSource === 'object') {
            if (lang && Array.isArray(monthsSource[lang])) {
              list = monthsSource[lang].slice();
            } else if (Array.isArray(monthsSource.default)) {
              list = monthsSource.default.slice();
            }
          }
          if (!list.length) {
            list = (lang === 'ar' ? DEFAULT_MONTHS_AR : DEFAULT_MONTHS_EN).slice();
          }
          return list
            .map(function (label) {
              return label == null ? '' : String(label).trim();
            })
            .filter(function (label) {
              return label.length > 0;
            });
        }

        function currentAnalyticsMonth(state) {
          var analytics = resolveAnalytics(state);
          if (!analytics) return '';
          var months = resolveMonths(state, analytics);
          if (!months.length) return '';
          var index = typeof analytics.monthIndex === 'number' ? analytics.monthIndex : months.length - 1;
          if (index < 0 || index >= months.length) index = months.length - 1;
          return months[index] || '';
        }

        function latestValue(series) {
          var values = numericList(series && series.values);
          if (!values.length) return 0;
          return values[values.length - 1];
        }

        function sumSeries(series) {
          var values = numericList(series && series.values);
          if (!values.length) return 0;
          var total = 0;
          for (var i = 0; i < values.length; i += 1) {
            total += values[i];
          }
          return Math.round(total * 10) / 10;
        }

        function formatThousands(value, unit, lang) {
          var numeric = Number(value);
          if (!Number.isFinite(numeric)) numeric = 0;
          var safeLang = ensureLanguage(lang);
          var formatted;
          try {
            formatted = new Intl.NumberFormat(safeLang === 'ar' ? 'ar-SA' : 'en-US', {
              minimumFractionDigits: 1,
              maximumFractionDigits: 1
            }).format(numeric);
          } catch (err) {
            formatted = numeric.toFixed(1);
          }
          var suffix = unit || 'K';
          if (suffix && typeof suffix === 'string') {
            var lower = suffix.toLowerCase();
            if (lower === 'k' || lower === 'thousand') {
              suffix = safeLang === 'ar' ? 'ألف' : 'K';
            }
          }
          return formatted + ' ' + (suffix || '');
        }

        function hexToRgba(color, alpha) {
          if (!color || typeof color !== 'string') return null;
          if (color.indexOf('#') === 0) {
            var hex = color.slice(1);
            if (hex.length === 3) {
              hex = hex.split('').map(function (char) { return char + char; }).join('');
            }
            var value = parseInt(hex, 16);
            if (Number.isNaN(value)) return null;
            var r = (value >> 16) & 255;
            var g = (value >> 8) & 255;
            var b = value & 255;
            return 'rgba(' + r + ',' + g + ',' + b + ',' + alpha + ')';
          }
          if (color.indexOf('rgba') === 0) {
            return color.replace(/rgba\(([^)]+)\)/, function (_, values) {
              var parts = values.split(',').map(function (part) { return part.trim(); });
              while (parts.length < 4) parts.push('1');
              parts[3] = String(alpha);
              return 'rgba(' + parts.join(',') + ')';
            });
          }
          if (color.indexOf('rgb') === 0) {
            return color.replace(/rgb\(([^)]+)\)/, function (_, values) {
              return 'rgba(' + values + ',' + alpha + ')';
            });
          }
          return null;
        }

        function pickPaletteColor(index) {
          if (!SALES_PALETTE.length) return '#38bdf8';
          return SALES_PALETTE[index % SALES_PALETTE.length];
        }

        function ensureSeriesLength(values, count) {
          var list = numericList(values);
          var safeCount = Number(count);
          if (!Number.isFinite(safeCount) || safeCount <= 0) return list;
          if (list.length > safeCount) {
            list.length = safeCount;
          } else if (list.length < safeCount) {
            var filler = list.length ? list[list.length - 1] : 0;
            while (list.length < safeCount) {
              list.push(filler);
            }
          }
          return list;
        }

        function buildSalesDatasets(seriesList, months, ctx, state) {
          var datasets = [];
          if (!Array.isArray(seriesList)) return datasets;
          var count = months.length || 0;
          for (var i = 0; i < seriesList.length; i += 1) {
            var entry = seriesList[i] || {};
            var values = ensureSeriesLength(entry.values, count);
            if (!values.length) continue;
            var color = entry.color || pickPaletteColor(i);
            var label = translateKey(ctx, entry.nameKey || entry.id, state);
            var background = hexToRgba(color, 0.18) || color;
            datasets.push({
              label: label || (entry.id ? String(entry.id) : 'Series ' + (i + 1)),
              data: values,
              borderColor: color,
              backgroundColor: background,
              pointBackgroundColor: color,
              pointBorderColor: color,
              tension: 0.35,
              fill: false,
              pointRadius: 3,
              pointHoverRadius: 4
            });
          }
          return datasets;
        }

        function generateSalesSeries(previousValues, count, metrics, catalogItem) {
          var prevList = numericList(previousValues);
          var safeCount = Math.max(1, Number(count) || prevList.length || 12);
          var baseline = prevList.length ? prevList[prevList.length - 1] : averageOf(prevList);
          if (!Number.isFinite(baseline) || baseline <= 0) {
            var basePrice = catalogItem && Number.isFinite(Number(catalogItem.price)) ? Number(catalogItem.price) : 18;
            baseline = basePrice * 0.6 + Math.random() * 6;
          }
          var revenue = metrics && Number(metrics.revenue);
          if (Number.isFinite(revenue) && revenue > 0) {
            var normalized = revenue / 1000 / safeCount;
            if (Number.isFinite(normalized) && normalized > 0) {
              baseline = (baseline * 0.55) + (normalized * 0.45);
            }
          }
          var values = [];
          var current = baseline * (0.85 + Math.random() * 0.3);
          for (var i = 0; i < safeCount; i += 1) {
            var drift = (Math.random() - 0.5) * Math.max(baseline * 0.28, 2.5);
            current = Math.max(2.5, current + drift);
            if (catalogItem && Number.isFinite(Number(catalogItem.price))) {
              current = Math.max(current, Number(catalogItem.price) * 0.35);
            }
            values.push(Math.round(current * 10) / 10);
          }
          return values;
        }

        function aggregateAnalytics(seriesList, catalogMap) {
          var latestK = 0;
          var orders = 0;
          if (!Array.isArray(seriesList)) return { latestK: 0, orders: 0 };
          for (var i = 0; i < seriesList.length; i += 1) {
            var series = seriesList[i];
            if (!series) continue;
            var values = numericList(series.values);
            if (!values.length) continue;
            var last = values[values.length - 1];
            latestK += last;
            var price = catalogMap && catalogMap[series.id] ? Number(catalogMap[series.id].price) : NaN;
            if (!Number.isFinite(price) || price <= 0) price = 18;
            var estimated = Math.round((last * 1000) / price);
            if (Number.isFinite(estimated) && estimated > 0) {
              orders += estimated;
            }
          }
          return { latestK: latestK, orders: Math.max(0, Math.round(orders)) };
        }

        function applyLegendSwatches(state) {
          var analytics = resolveAnalytics(state);
          if (!analytics || !Array.isArray(analytics.series) || !analytics.series.length) return;
          var nodes = document.querySelectorAll('[data-series-swatch]');
          if (!nodes || !nodes.length) return;
          var colorMap = Object.create(null);
          for (var i = 0; i < analytics.series.length; i += 1) {
            var entry = analytics.series[i];
            if (!entry || !entry.id) continue;
            colorMap[entry.id] = entry.color || pickPaletteColor(i) || 'var(--primary)';
          }
          for (var j = 0; j < nodes.length; j += 1) {
            var node = nodes[j];
            if (!node || !node.getAttribute) continue;
            var id = node.getAttribute('data-series-id');
            var color = (id && colorMap[id]) || pickPaletteColor(j) || 'var(--primary)';
            try {
              node.style.backgroundColor = color;
            } catch (_err) {
              node.setAttribute('data-series-color', color);
            }
          }
        }

        function syncSalesChart(state, ctx) {
          var context = ctx || window.MishkahAuto || null;
          if (!state && context && typeof context.getState === 'function') {
            try {
              state = context.getState();
            } catch (err) {
              state = null;
            }
          }
          if (!state && context && context.state) {
            state = context.state;
          }
          var analytics = resolveAnalytics(state);
          if (!analytics) return false;
          var canvas = document.getElementById('quick-sales-chart');
          if (!canvas) return false;
          var host = window.Mishkah || window.Mishka || null;
          var chartApi = host && host.UI ? host.UI.Chart : null;
          applyLegendSwatches(state);
          if (!chartApi) {
            return false;
          }

          var months = resolveMonths(state, analytics);
          var datasets = buildSalesDatasets(analytics.series || [], months, context, state);
          if (!datasets.length) return false;

          if (typeof toCsv === 'function') {
            canvas.setAttribute('data-chart-labels', toCsv(months));
          }

          var chartMeta = analytics.chart && typeof analytics.chart === 'object' ? analytics.chart : {};
          var type = chartMeta.type || canvas.getAttribute('data-chart-type') || canvas.getAttribute('data-chart-auto') || 'line';
          var options = chartMeta.options && typeof chartMeta.options === 'object' ? cloneState(chartMeta.options) : {};
          if (!options.plugins) options.plugins = {};
          if (!options.plugins.legend) options.plugins.legend = { position: 'top' };
          if (options.maintainAspectRatio == null) options.maintainAspectRatio = false;
          if (options.responsive == null) options.responsive = true;

          var data = { labels: months.slice(), datasets: datasets };
          if (chartMeta.height) {
            canvas.setAttribute('data-chart-height', chartMeta.height);
          }
          if (chartMeta.titleKey) {
            canvas.setAttribute('data-chart-title', translateKey(context, chartMeta.titleKey, state));
            canvas.setAttribute('data-chart-title-key', chartMeta.titleKey);
          }

          var resolvedHeight = Number(chartMeta.height);
          if (!Number.isFinite(resolvedHeight) || resolvedHeight <= 0) {
            var attrHeight = Number(canvas.getAttribute('data-chart-height'));
            if (Number.isFinite(attrHeight) && attrHeight > 0) {
              resolvedHeight = attrHeight;
            }
          }
          if (!Number.isFinite(resolvedHeight) || resolvedHeight <= 0) {
            resolvedHeight = 320;
          }
          resolvedHeight = Math.max(160, Math.round(resolvedHeight));
          canvas.setAttribute('height', resolvedHeight);
          canvas.setAttribute('data-chart-height', resolvedHeight);
          try {
            canvas.height = resolvedHeight;
          } catch (_errHeight) {}
          if (canvas.style) {
            canvas.style.height = resolvedHeight + 'px';
            canvas.style.minHeight = resolvedHeight + 'px';
            if (!canvas.style.width) canvas.style.width = '100%';
            if (!canvas.style.display) canvas.style.display = 'block';
          } else {
            canvas.setAttribute('style', 'height:' + resolvedHeight + 'px;min-height:' + resolvedHeight + 'px;width:100%;display:block;');
          }

          var payload = typeof chartApi.buildPayload === 'function'
            ? chartApi.buildPayload(type, data, options)
            : { type: type, data: data, options: options };
          var encoded = typeof chartApi.encodePayload === 'function'
            ? chartApi.encodePayload(payload)
            : JSON.stringify(payload);
          canvas.setAttribute('data-m-chart', encoded);

          var ensured = null;
          if (typeof chartApi.ensureLibrary === 'function') {
            try {
              ensured = chartApi.ensureLibrary();
            } catch (_errEnsure) {
              ensured = null;
            }
          }
          var hydrate = function () {
            if (typeof chartApi.hydrate === 'function') {
              chartApi.hydrate(canvas.parentNode || document);
            }
            if (typeof chartApi.freeze === 'function') {
              chartApi.freeze(canvas.parentNode || canvas);
            }
          };
          if (ensured && typeof ensured.then === 'function') {
            ensured.then(hydrate).catch(hydrate);
            return true;
          }
          hydrate();
          return true;
        }

        function ensureCountdownLoop(state) {
          var node = document.querySelector('[data-countdown]');
          if (!node) return;
          var seconds = state && state.data && state.data.timer ? Number(state.data.timer.seconds) : NaN;
          if (!Number.isFinite(seconds) || seconds <= 0) seconds = 270;
          if (state && state.data && state.data.ui && state.data.ui.countdownTemplate) {
            node.setAttribute('data-countdown-template', state.data.ui.countdownTemplate);
          }
          node.dataset.countdownBaseline = String(seconds);
          if (!node.__mkCountdownLoop) {
            node.__mkCountdownLoop = true;
            node.addEventListener('countdown:finished', function () {
              var baseline = Number(node.dataset.countdownBaseline);
              if (!Number.isFinite(baseline) || baseline <= 0) baseline = seconds;
              window.requestAnimationFrame(function () {
                node.setAttribute('data-countdown', baseline);
              });
            });
          }
          var current = Number(node.getAttribute('data-countdown'));
          if (!Number.isFinite(current) || Math.abs(current - seconds) > 0.5) {
            node.setAttribute('data-countdown', seconds);
          }
        }

        function pickRandomItems(ctx, catalogSource) {
          var pool = Array.isArray(catalogSource) ? catalogSource.slice() : getCatalog(ctx);
          var count = 1 + Math.floor(Math.random() * Math.min(pool.length || 1, 4));
          var picks = [];
          for (var i = 0; i < count && pool.length; i += 1) {
            var index = Math.floor(Math.random() * pool.length);
            var base = pool.splice(index, 1)[0];
            if (!base) continue;
            var qty = 1 + Math.floor(Math.random() * 3);
            picks.push({
              id: base.id,
              nameKey: base.nameKey,
              qty: qty,
              price: base.price
            });
          }
          return picks;
        }

        function randomizeCart(event, ctx) {
          if (event && typeof event.preventDefault === 'function') {
            event.preventDefault();
          }
          if (!ctx) return;
          var catalogList = getCatalog(ctx);
          var items = pickRandomItems(ctx, catalogList);
          var totalQty = 0;
          for (var i = 0; i < items.length; i += 1) {
            totalQty += Number.isFinite(items[i].qty) ? items[i].qty : 0;
          }
          var now = new Date();
          commit(ctx, function (next, prev) {
            next.data = next.data || {};
            var cart = next.data.cart || {};
            cart.items = items;
            cart.updatedAt = now.toISOString();
            cart.currency = cart.currency || (next.env && next.env.currency) || 'SAR';
            next.data.cart = cart;

            var metricsSnapshot = {
              revenue: totalCart(cart),
              orders: totalQty || items.length
            };

            var analytics = next.data.analytics && typeof next.data.analytics === 'object' ? next.data.analytics : {};
            var prevAnalytics = prev && prev.data && typeof prev.data.analytics === 'object' ? prev.data.analytics : null;
            var months = resolveMonths(next, analytics);
            var monthCount = months.length || 12;
            var catalogMap = {};
            if (Array.isArray(catalogList)) {
              for (var j = 0; j < catalogList.length; j += 1) {
                catalogMap[catalogList[j].id] = catalogList[j];
              }
            }
            var baseSeries = Array.isArray(analytics.series) ? analytics.series.slice() : [];
            if (Array.isArray(catalogList)) {
              catalogList.forEach(function (item) {
                var exists = baseSeries.some(function (entry) { return entry && entry.id === item.id; });
                if (!exists) {
                  baseSeries.push({ id: item.id, nameKey: item.nameKey, values: [] });
                }
              });
            }
            var prevMap = {};
            if (prevAnalytics && Array.isArray(prevAnalytics.series)) {
              prevAnalytics.series.forEach(function (entry) {
                if (entry && entry.id) prevMap[entry.id] = entry;
              });
            }
            var updatedSeries = [];
            for (var index = 0; index < baseSeries.length; index += 1) {
              var base = baseSeries[index] || {};
              if (!base.id) continue;
              var previousSeries = prevMap[base.id] || base;
              var color = base.color || (previousSeries && previousSeries.color) || pickPaletteColor(index);
              var values = generateSalesSeries(previousSeries && previousSeries.values, monthCount, metricsSnapshot, catalogMap[base.id]);
              updatedSeries.push({
                id: base.id,
                nameKey: base.nameKey || (catalogMap[base.id] && catalogMap[base.id].nameKey) || base.id,
                color: color,
                values: values
              });
            }
            analytics.series = updatedSeries;
            analytics.monthIndex = monthCount - 1;
            analytics.unit = analytics.unit || 'K';
            analytics.unitLabelKey = analytics.unitLabelKey || 'quick.sales.unit';
            analytics.chart = analytics.chart || {};
            if (!analytics.chart.type) analytics.chart.type = 'line';
            if (!analytics.chart.height) analytics.chart.height = 320;
            if (!analytics.chart.titleKey) analytics.chart.titleKey = 'quick.sales.title';
            analytics.updatedAt = now.toISOString();
            next.data.analytics = analytics;

            next.data.metrics = next.data.metrics || {};
            var totals = aggregateAnalytics(updatedSeries, catalogMap);
            var computedRevenue = Math.max(totals.latestK * 1000, metricsSnapshot.revenue);
            var computedOrders = Math.max(totals.orders, metricsSnapshot.orders, updatedSeries.length);
            next.data.metrics.revenue = Math.round(computedRevenue);
            next.data.metrics.orders = Math.max(0, Math.round(computedOrders));
          }, function (latest) {
            var hydrated = false;
            try {
              hydrated = syncSalesChart(latest, ctx);
            } catch (errHydrate) {
              console.warn('[Mishkah] failed to sync chart after cart randomization', errHydrate);
            }
            if (hydrated) {
              resetChartHydrationBackoff();
            } else {
              attemptChartHydration(null, null, false);
            }
          });
        }

        function resolveAutoState() {
          var auto = window.MishkahAuto || null;
          if (!auto) return null;
          if (typeof auto.getState === 'function') {
            try {
              return auto.getState();
            } catch (err) {
              return auto.state || null;
            }
          }
          return auto.state || null;
        }

        function initialChartKickoff() {
          attemptChartHydration(null, null, true);
        }

        function scheduleAutoHydrationKick() {
          attemptChartHydration(null, window.MishkahAuto || null, false);
        }

        if (document.readyState === 'loading') {
          document.addEventListener(
            'DOMContentLoaded',
            function () {
              window.setTimeout(initialChartKickoff, 16);
            },
            { once: true }
          );
        } else {
          window.setTimeout(initialChartKickoff, 16);
        }

        if (window.MishkahAuto && typeof window.MishkahAuto.ready === 'function') {
          var readyResult = window.MishkahAuto.ready(function () {
            window.setTimeout(scheduleAutoHydrationKick, 10);
          });
          if (readyResult && typeof readyResult.catch === 'function') {
            readyResult.catch(function () {
              window.setTimeout(scheduleAutoHydrationKick, 10);
            });
          }
        } else {
          window.addEventListener('mishkah:auto-ready', function handleAutoKick() {
            window.removeEventListener('mishkah:auto-ready', handleAutoKick);
            window.setTimeout(scheduleAutoHydrationKick, 10);
          });
        }

        function wireAutoState() {
          window.MishkahAuto.onState(function (snapshot) {
            var hydrated = false;
            try {
              hydrated = syncSalesChart(snapshot, window.MishkahAuto || null);
            } catch (err) {
              console.warn('[Mishkah] failed to sync chart from state', err);
            }
            ensureCountdownLoop(snapshot);
            if (hydrated) {
              resetChartHydrationBackoff();
            } else {
              attemptChartHydration(null, null, false);
            }
          });
        }

        if (window.MishkahAuto && typeof window.MishkahAuto.onState === 'function') {
          wireAutoState();
        } else {
          window.addEventListener('mishkah:auto-ready', function handleAutoReady() {
            window.removeEventListener('mishkah:auto-ready', handleAutoReady);
            if (window.MishkahAuto && typeof window.MishkahAuto.onState === 'function') {
              wireAutoState();
            }
            window.setTimeout(scheduleAutoHydrationKick, 10);
          });
        }
      </script>
    </template>
    <script>
      (function () {
        function hydrateCharts() {
          if (!window.Mishkah || !window.Mishkah.UI || !window.Mishkah.UI.Chart) return;
          var ChartAPI = window.Mishkah.UI.Chart;
          if (typeof ChartAPI.ensureLibrary !== 'function' || typeof ChartAPI.hydrate !== 'function') return;
          ChartAPI.ensureLibrary().then(function () {
            ChartAPI.hydrate();
          });
        }

        if (window.Mishkah && window.Mishkah.UI && window.Mishkah.UI.Chart) {
          hydrateCharts();
        } else {
          window.addEventListener('mishkah:auto-ready', function handleAutoReady() {
            window.removeEventListener('mishkah:auto-ready', handleAutoReady);
            hydrateCharts();
          });
        }
      })();
    </script>
  </body>
</html>
