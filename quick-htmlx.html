<!DOCTYPE html>
<html lang="ar" dir="rtl" data-htmlx="quick-dashboard" data-css-library="mi" data-theme="dark" class="dark">
  <head>
    <meta charset="utf-8" />
    <title>Mishkah Quick Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="./mishkah.js" data-htmlx data-css="mishkah"></script>
  </head>
  <body class="bg-[var(--background)] text-[var(--foreground)]">
    <template id="quick-dashboard">
      <script type="application/json" data-path="env">
        {
          "theme": "dark",
          "lang": "ar",
          "dir": "rtl",
          "currency": "SAR"
        }
      </script>

      <script type="application/json" data-path="i18n.strings">
        {
          "quick.title": { "ar": "لوحة سريعة", "en": "Quick Dashboard" },
          "quick.tagline": { "ar": "رصد مباشر لمبيعاتك اليومية", "en": "Live snapshot of your daily sales" },
          "quick.metrics.revenue": { "ar": "الإيراد", "en": "Revenue" },
          "quick.metrics.orders": { "ar": "الطلبات", "en": "Orders" },
          "quick.trend": { "ar": "أداء الأسبوع", "en": "Weekly trend" },
          "quick.timer": { "ar": "الوقت المتبقي", "en": "Time left" },
          "quick.cart.title": { "ar": "السلة المباشرة", "en": "Live cart" },
          "quick.cart.randomize": { "ar": "تحديث السلة عشوائياً", "en": "Randomize cart" },
          "quick.cart.empty": { "ar": "السلة فارغة حالياً", "en": "Cart is empty" },
          "quick.cart.items.espresso": { "ar": "إسبريسو", "en": "Espresso" },
          "quick.cart.items.cortado": { "ar": "كورتادو", "en": "Cortado" },
          "quick.cart.items.flatwhite": { "ar": "فلات وايت", "en": "Flat white" },
          "quick.cart.items.cheesecake": { "ar": "تشيز كيك بالفراولة", "en": "Strawberry cheesecake" },
          "quick.cart.items.cinnamon": { "ar": "سينابون دافئ", "en": "Warm cinnamon roll" }
        }
      </script>

      <script type="application/json" data-path="data">
        {
          "metrics": { "revenue": 12800, "orders": 54 },
          "trend": {
            "values": [18, 22, 25, 28, 35, 31, 29],
            "labels": ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"]
          },
          "timer": { "seconds": 45 },
          "cart": {
            "currency": "SAR",
            "items": [
              {
                "id": "espresso",
                "nameKey": "quick.cart.items.espresso",
                "qty": 1,
                "price": 18.5
              },
              {
                "id": "cortado",
                "nameKey": "quick.cart.items.cortado",
                "qty": 2,
                "price": 16
              }
            ]
          },
          "catalog": [
            { "id": "espresso", "nameKey": "quick.cart.items.espresso", "price": 18.5 },
            { "id": "cortado", "nameKey": "quick.cart.items.cortado", "price": 16 },
            { "id": "flatwhite", "nameKey": "quick.cart.items.flatwhite", "price": 19 },
            { "id": "cheesecake", "nameKey": "quick.cart.items.cheesecake", "price": 26.5 },
            { "id": "cinnamon", "nameKey": "quick.cart.items.cinnamon", "price": 21 }
          ],
          "ui": { "countdownTemplate": "⏱️ {{time}}" }
        }
      </script>

      <section
        data-m-scope="quick-dashboard"
        class="mx-auto flex min-h-screen max-w-5xl flex-col gap-6 bg-[var(--background)] p-6 sm:p-10"
      >
        <header class="flex flex-wrap items-center justify-between gap-3 rounded-3xl border border-[var(--border)] bg-[var(--card)] px-6 py-5 shadow-[var(--shadow)]">
          <div class="space-y-1">
            <h1 class="text-2xl font-semibold">{trans('quick.title')}</h1>
            <p class="text-sm text-[var(--muted-foreground)]">{trans('quick.tagline')}</p>
          </div>
          <div class="flex items-center gap-2">
            <theme-switcher class="hero-switcher" themes="dark,light"></theme-switcher>
            <lang-switcher class="hero-switcher" langs="ar,en"></lang-switcher>
          </div>
        </header>

        <div class="grid gap-4 sm:grid-cols-2">
          <section class="rounded-3xl border border-[var(--border)] bg-[var(--card)] p-6 shadow-[var(--shadow)]">
            <p class="text-sm text-[var(--muted-foreground)]">{trans('quick.metrics.revenue')}</p>
            <strong class="mt-1 block text-3xl font-semibold text-[var(--primary)]">
              {formatCurrency(state.data.metrics.revenue, state.env.currency || 'SAR', state.env.lang)}
            </strong>
          </section>
          <section class="rounded-3xl border border-[var(--border)] bg-[var(--card)] p-6 shadow-[var(--shadow)]">
            <p class="text-sm text-[var(--muted-foreground)]">{trans('quick.metrics.orders')}</p>
            <strong class="mt-1 block text-3xl font-semibold text-[var(--accent)]">
              {state.data.metrics.orders}
            </strong>
          </section>
        </div>

        <figure class="rounded-3xl border border-[var(--border)] bg-[var(--card)] p-6 shadow-[var(--shadow)]">
          <figcaption class="mb-3 text-sm text-[var(--muted-foreground)]">{trans('quick.trend')}</figcaption>
          <canvas
            data-chart-auto="line"
            data-chart-type="line"
            data-chart-values="{toCsv(state.data.trend.values)}"
            data-chart-labels="{toCsv(state.data.trend.labels)}"
            data-chart-title="{trans('quick.trend')}"
            data-chart-height="260"
            id="quick-trend-chart"
          ></canvas>
        </figure>

        <div class="flex items-center justify-between rounded-3xl border border-[var(--border)] bg-[var(--card)] p-6 shadow-[var(--shadow)]">
          <span class="text-sm text-[var(--muted-foreground)]">{trans('quick.timer')}</span>
          <strong
            class="text-2xl font-semibold"
            data-countdown="{state.data.timer.seconds}"
            data-countdown-template="{state.data.ui.countdownTemplate}"
          ></strong>
        </div>

        <section class="rounded-3xl border border-[var(--border)] bg-[var(--card)] p-6 shadow-[var(--shadow)]">
          <header class="mb-4 flex flex-wrap items-center justify-between gap-3">
            <h2 class="text-xl font-semibold">{trans('quick.cart.title')}</h2>
            <button
              type="button"
              class="rounded-full border border-[var(--border)] bg-[var(--surface)] px-4 py-2 text-sm font-medium text-[var(--foreground)] shadow-[var(--shadow)] transition hover:-translate-y-0.5 hover:shadow-lg"
              onclick="randomizeCart(event, ctx)"
            >
              {trans('quick.cart.randomize')}
            </button>
          </header>
          <ul class="grid gap-3" x-if="state.data.cart.items && state.data.cart.items.length">
            <li
              x-for="item in state.data.cart.items"
              key="item.id"
              class="flex items-center justify-between rounded-2xl border border-[var(--border)] bg-[var(--surface)] px-4 py-3"
            >
              <div class="flex flex-col">
                <strong class="text-base font-semibold">{trans(item.nameKey)}</strong>
                <span class="text-sm text-[var(--muted-foreground)]">× {item.qty}</span>
              </div>
              <span class="text-base font-semibold">
                {formatCurrency(item.price * item.qty, state.data.cart.currency || state.env.currency || 'SAR', state.env.lang)}
              </span>
            </li>
          </ul>
          <p
            class="rounded-2xl border border-dashed border-[var(--border)] bg-[var(--surface)] px-6 py-8 text-center text-sm text-[var(--muted-foreground)]"
            x-if="!state.data.cart.items || !state.data.cart.items.length"
          >
            {trans('quick.cart.empty')}
          </p>
          <footer class="mt-5 flex flex-wrap items-center justify-between gap-3 border-t border-dashed border-[var(--border)] pt-4">
            <span class="text-sm text-[var(--muted-foreground)]">{state.data.cart.updatedAt ? formatUpdatedAt(state.data.cart.updatedAt, state.env.lang) : ''}</span>
            <strong class="text-xl font-semibold">
              {formatCurrency(totalCart(state.data.cart), state.data.cart.currency || state.env.currency || 'SAR', state.env.lang)}
            </strong>
          </footer>
        </section>
      </section>

      <script>
        function toCsv(list) {
          if (!Array.isArray(list)) return '';
          return list
            .map(function (value) {
              return value == null ? '' : String(value).trim();
            })
            .filter(function (value) {
              return value.length > 0;
            })
            .join(',');
        }

        function getCatalog(ctx) {
          var snapshot = null;
          if (ctx && typeof ctx.getState === 'function') {
            try {
              snapshot = ctx.getState();
            } catch (err) {
              snapshot = null;
            }
          }
          if (!snapshot && ctx && ctx.state) {
            snapshot = ctx.state;
          }
          var catalog = snapshot && snapshot.data && Array.isArray(snapshot.data.catalog) ? snapshot.data.catalog : null;
          if (catalog && catalog.length) {
            return catalog.slice();
          }
          return [];
        }

        function ensureLanguage(lang) {
          if (typeof lang === 'string' && lang) {
            var normalized = lang.toLowerCase();
            return normalized === 'ar' ? 'ar' : normalized === 'en' ? 'en' : normalized;
          }
          return 'ar';
        }

        function cloneState(prev) {
          try {
            return JSON.parse(JSON.stringify(prev || {}));
          } catch (err) {
            if (!prev || typeof prev !== 'object') return {};
            return Array.isArray(prev) ? prev.slice() : Object.assign({}, prev);
          }
        }

        function commit(ctx, producer, after) {
          if (!ctx) return;
          if (typeof ctx.commit === 'function') {
            return ctx.commit(producer, after);
          }
          if (typeof ctx.setState !== 'function') return;
          ctx.setState(function (prev) {
            var next = cloneState(prev);
            if (typeof producer === 'function') {
              producer(next, prev || {});
            }
            return next;
          });
          if (typeof after === 'function') {
            window.setTimeout(function () {
              try {
                after(ctx.getState ? ctx.getState() : null, ctx);
              } catch (err) {
                console.error('[Mishkah] commit after hook failed', err);
              }
            }, 0);
          }
        }

        function formatCurrency(amount, currency, lang) {
          var safeLang = ensureLanguage(lang);
          var code = currency && typeof currency === 'string' ? currency : 'SAR';
          var numeric = Number(amount);
          if (!Number.isFinite(numeric)) numeric = 0;
          try {
            return new Intl.NumberFormat(safeLang === 'ar' ? 'ar-SA' : 'en-US', {
              style: 'currency',
              currency: code,
              maximumFractionDigits: 2
            }).format(numeric);
          } catch (err) {
            var fixed = numeric.toFixed(2);
            return safeLang === 'ar' ? fixed + ' ' + code : code + ' ' + fixed;
          }
        }

        function totalCart(cart) {
          if (!cart || !Array.isArray(cart.items)) return 0;
          var total = 0;
          for (var i = 0; i < cart.items.length; i += 1) {
            var item = cart.items[i];
            var line = Number(item && item.price) * Number(item && item.qty);
            if (Number.isFinite(line)) total += line;
          }
          return Math.max(0, Math.round(total * 100) / 100);
        }

        function formatUpdatedAt(timestamp, lang) {
          if (!timestamp) return '';
          try {
            var date = new Date(timestamp);
            if (Number.isNaN(date.getTime())) return '';
            var safeLang = ensureLanguage(lang);
            return date.toLocaleTimeString(safeLang === 'ar' ? 'ar-SA' : 'en-US', {
              hour: '2-digit',
              minute: '2-digit'
            });
          } catch (err) {
            return '';
          }
        }

        var DEFAULT_TREND_LABELS = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

        function ensureTrendLabels(primary, fallback) {
          var list = Array.isArray(primary) ? primary.slice() : [];
          if (!list.length && Array.isArray(fallback)) {
            list = fallback.slice();
          }
          if (!list.length) {
            list = DEFAULT_TREND_LABELS.slice();
          }
          return list
            .map(function (label) {
              return label == null ? '' : String(label).trim();
            })
            .filter(function (label) {
              return label.length > 0;
            });
        }

        function numericList(values) {
          var list = [];
          if (!Array.isArray(values)) return list;
          for (var i = 0; i < values.length; i += 1) {
            var value = Number(values[i]);
            if (Number.isFinite(value)) {
              list.push(value);
            }
          }
          return list;
        }

        function averageOf(list) {
          if (!list.length) return NaN;
          var total = 0;
          for (var i = 0; i < list.length; i += 1) {
            total += list[i];
          }
          return total / list.length;
        }

        function generateTrendValues(prevTrend, count, metrics) {
          var prevValues = numericList(prevTrend && prevTrend.values);
          var baseline = Number.isFinite(prevValues[prevValues.length - 1])
            ? prevValues[prevValues.length - 1]
            : averageOf(prevValues);
          if (!Number.isFinite(baseline) || baseline <= 0) {
            baseline = 24 + Math.random() * 8;
          }
          var metricsRevenue = metrics && Number(metrics.revenue);
          if (Number.isFinite(metricsRevenue) && metricsRevenue > 0) {
            var perSegment = metricsRevenue / Math.max(count || 1, 1);
            if (perSegment > baseline) {
              baseline = (baseline * 0.6) + (perSegment * 0.4);
            }
          }
          var values = [];
          var current = baseline * (0.85 + Math.random() * 0.3);
          for (var i = 0; i < count; i += 1) {
            var drift = (Math.random() - 0.5) * baseline * 0.35;
            current = Math.max(4, current + drift);
            var rounded = Math.round(current * 10) / 10;
            values.push(rounded);
          }
          return values;
        }

        function trendDatasetLabel(state) {
          var lang = state && state.env && state.env.lang ? String(state.env.lang).toLowerCase() : 'en';
          if (lang === 'ar') return 'أداء الأسبوع';
          if (lang === 'en') return 'Weekly trend';
          return 'Trend';
        }

        function readChartColors(canvas) {
          var fallbackBorder = 'rgba(79,70,229,0.85)';
          var fallbackFill = 'rgba(79,70,229,0.18)';
          if (!canvas || typeof canvas.getAttribute !== 'function') {
            return { border: fallbackBorder, background: fallbackFill };
          }
          var color = canvas.getAttribute('data-chart-color');
          if (!color) {
            return { border: fallbackBorder, background: fallbackFill };
          }
          if (color.indexOf('#') === 0) {
            return { border: color, background: color + '33' };
          }
          if (color.indexOf('rgba') === 0 || color.indexOf('rgb') === 0) {
            return { border: color, background: color };
          }
          return { border: fallbackBorder, background: fallbackFill };
        }

        function refreshTrendChart(state, ctx) {
          if (!state) {
            if (ctx && typeof ctx.getState === 'function') {
              try {
                state = ctx.getState();
              } catch (err) {
                state = null;
              }
            }
          }
          var trend = state && state.data ? state.data.trend : null;
          if (!trend) return;
          var canvas = document.getElementById('quick-trend-chart');
          if (!canvas) return;
          var host = window.Mishkah || window.Mishka || null;
          var chartApi = host && host.UI ? host.UI.Chart : null;
          if (!chartApi) return;

          function applyUpdate() {
            var labels = ensureTrendLabels(trend.labels, DEFAULT_TREND_LABELS);
            var values = numericList(trend.values);
            if (!values.length) {
              values = generateTrendValues(trend, labels.length, state && state.data && state.data.metrics);
            }
            var colors = readChartColors(canvas);
            if (typeof toCsv === 'function') {
              canvas.setAttribute('data-chart-labels', toCsv(labels));
              canvas.setAttribute('data-chart-values', toCsv(values));
            }
            var rawPayload = canvas.getAttribute('data-m-chart');
            var payload = null;
            if (rawPayload) {
              try {
                payload = JSON.parse(rawPayload);
              } catch (_err) {
                payload = null;
              }
            }
            var type = canvas.getAttribute('data-chart-type') || canvas.getAttribute('data-chart-auto') || 'line';
            var datasetLabel = trendDatasetLabel(state);
            if (!payload || typeof payload !== 'object') {
              var data = {
                labels: labels.slice(),
                datasets: [
                  {
                    label: datasetLabel,
                    data: values.slice(),
                    borderColor: colors.border,
                    backgroundColor: colors.background,
                    fill: true
                  }
                ]
              };
              payload = chartApi && typeof chartApi.buildPayload === 'function'
                ? chartApi.buildPayload(type, data, {})
                : { type: type, data: data, options: {} };
            } else {
              if (!payload.data || typeof payload.data !== 'object') {
                payload.data = {};
              }
              payload.data.labels = labels.slice();
              if (!Array.isArray(payload.data.datasets) || !payload.data.datasets.length) {
                payload.data.datasets = [];
              }
              if (!payload.data.datasets.length) {
                payload.data.datasets.push({});
              }
              for (var i = 0; i < payload.data.datasets.length; i += 1) {
                var dataset = payload.data.datasets[i] && typeof payload.data.datasets[i] === 'object'
                  ? Object.assign({}, payload.data.datasets[i])
                  : {};
                dataset.label = dataset.label || datasetLabel;
                dataset.data = values.slice();
                if (!dataset.borderColor) dataset.borderColor = colors.border;
                if (!dataset.backgroundColor) dataset.backgroundColor = colors.background;
                if (dataset.fill == null) dataset.fill = true;
                payload.data.datasets[i] = dataset;
              }
            }
            var encoded = typeof chartApi.encodePayload === 'function'
              ? chartApi.encodePayload(payload)
              : JSON.stringify(payload);
            canvas.setAttribute('data-m-chart', encoded);
            if (typeof chartApi.hydrate === 'function') {
              chartApi.hydrate(canvas.parentNode || document);
            }
            if (typeof chartApi.freeze === 'function') {
              chartApi.freeze(canvas.parentNode || canvas);
            }
          }

          var ensured = null;
          if (typeof chartApi.ensureLibrary === 'function') {
            try {
              ensured = chartApi.ensureLibrary();
            } catch (_err) {
              ensured = null;
            }
          }
          if (ensured && typeof ensured.then === 'function') {
            ensured.then(function () {
              applyUpdate();
            }).catch(function () {
              applyUpdate();
            });
            return;
          }
          applyUpdate();
        }

        function pickRandomItems(ctx) {
          var pool = getCatalog(ctx);
          var count = 1 + Math.floor(Math.random() * Math.min(pool.length, 4));
          var picks = [];
          for (var i = 0; i < count && pool.length; i += 1) {
            var index = Math.floor(Math.random() * pool.length);
            var base = pool.splice(index, 1)[0];
            if (!base) continue;
            var qty = 1 + Math.floor(Math.random() * 3);
            picks.push({
              id: base.id,
              nameKey: base.nameKey,
              qty: qty,
              price: base.price
            });
          }
          return picks;
        }

        function randomizeCart(event, ctx) {
          if (event && typeof event.preventDefault === 'function') {
            event.preventDefault();
          }
          if (!ctx) return;
          var items = pickRandomItems(ctx);
          var totalQty = 0;
          for (var i = 0; i < items.length; i += 1) {
            totalQty += Number.isFinite(items[i].qty) ? items[i].qty : 0;
          }
          var now = new Date();
          commit(ctx, function (next, prev) {
            next.data = next.data || {};
            var cart = next.data.cart || {};
            cart.items = items;
            cart.updatedAt = now.toISOString();
            cart.currency = cart.currency || (next.env && next.env.currency) || 'SAR';
            next.data.cart = cart;
            next.data.metrics = next.data.metrics || {};
            next.data.metrics.revenue = totalCart(cart);
            next.data.metrics.orders = totalQty || items.length;
            var baseTrend = next.data.trend && typeof next.data.trend === 'object' ? next.data.trend : {};
            var prevTrend = prev && prev.data && typeof prev.data.trend === 'object' ? prev.data.trend : baseTrend;
            var labels = ensureTrendLabels(baseTrend.labels, prevTrend && prevTrend.labels);
            var metricsSnapshot = {
              revenue: next.data.metrics.revenue,
              orders: next.data.metrics.orders
            };
            var values = generateTrendValues(prevTrend, labels.length, metricsSnapshot);
            var nextTrend = {};
            for (var key in baseTrend) {
              if (!Object.prototype.hasOwnProperty.call(baseTrend, key)) continue;
              if (key === 'labels' || key === 'values') continue;
              nextTrend[key] = cloneState(baseTrend[key]);
            }
            nextTrend.labels = labels;
            nextTrend.values = values;
            next.data.trend = nextTrend;
          }, function (latest) {
            refreshTrendChart(latest, ctx);
          });
        }
      </script>
    </template>
    <script>
      (function () {
        function hydrateCharts() {
          if (!window.Mishkah || !window.Mishkah.UI || !window.Mishkah.UI.Chart) return;
          var ChartAPI = window.Mishkah.UI.Chart;
          if (typeof ChartAPI.ensureLibrary !== 'function' || typeof ChartAPI.hydrate !== 'function') return;
          ChartAPI.ensureLibrary().then(function () {
            ChartAPI.hydrate();
          });
        }

        if (window.Mishkah && window.Mishkah.UI && window.Mishkah.UI.Chart) {
          hydrateCharts();
        } else {
          window.addEventListener('mishkah:auto-ready', function handleAutoReady() {
            window.removeEventListener('mishkah:auto-ready', handleAutoReady);
            hydrateCharts();
          });
        }
      })();
    </script>
  </body>
</html>
