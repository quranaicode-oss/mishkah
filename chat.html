<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Mishkah WebSocket Demo</title>
  <script src="./mishkah-utils.js"></script>
  <script src="./mishkah.core.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/acorn@8.15.0/dist/acorn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/acorn-walk@8.3.4/dist/walk.min.js"></script>
  <script>
    window.acornWalk = window.acornWalk || (window.acorn && window.acorn.walk);
  </script>
  <script src="./mishkah-htmlx.js"></script>
  <script src="mishkah-ui.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white">

  <div id="app"></div>

  <template data-namespace="chatApp">

    <div class="container mx-auto p-8 max-w-md" x-if="!state.data.joined">
      <h1 class="text-2xl font-bold mb-4">انضم إلى الدردشة</h1>
      <div class="flex flex-col gap-4">
        <input
          type="text"
          class="p-2 rounded bg-gray-800 border border-gray-700"
          placeholder="اكتب اسمك المستعار"
          value="{state.data.username}"
          oninput="handleUsernameInput(event, ctx)"
        />
        <button
          type="button"
          class="bg-blue-600 p-2 rounded hover:bg-blue-700"
          data-m-gkey="chat:join"
        >
          دخول
        </button>
      </div>
    </div>

    <div
      class="container mx-auto p-4 flex gap-4 h-screen"
      x-if="state.data.joined"
      m-ws-connect="main_socket"
      m-ws-url="wss://ws.mas.com.eg"
    >

      <aside class="w-1/4 bg-gray-800 p-4 rounded-lg">
        <h2 class="font-bold mb-2">المتصلون الآن</h2>
        <ul m-ws-on:user-list-update="updateUsers(event.detail.payload, ctx)">
          <li
            x-for="user, idx in state.data.users"
            data-m-key="{user.id || idx}"
            class="py-1 border-b border-gray-700 last:border-0"
          >
            {user.name || user}
          </li>
        </ul>
      </aside>

      <main class="w-3/4 flex flex-col gap-4">
        <div
          class="flex-1 bg-gray-800 p-4 rounded-lg overflow-y-auto"
          m-ws-on:new-message="appendMessage(event.detail.payload, ctx)"
        >
          <div
            x-for="msg, msgIdx in state.data.messages"
            data-m-key="{msg.id || msgIdx}"
            class="mb-3"
          >
            <strong class="text-blue-300">{msg.user || 'مجهول'}:</strong>
            <span class="ml-2">{msg.text}</span>
          </div>
        </div>

        <form class="flex gap-2" onsubmit="sendMessage(event, ctx)">
          <input
            type="text"
            class="flex-1 p-2 rounded bg-gray-700 border border-gray-600"
            placeholder="اكتب رسالتك..."
            value="{state.data.newMessage}"
            oninput="handleMessageInput(event, ctx)"
          />
          <button
            type="submit"
            class="bg-green-600 p-2 rounded hover:bg-green-700"
            data-m-gkey="chat:send"
            m-ws-emit:send-message="messagePayload(ctx)"
          >
            إرسال
          </button>
        </form>
      </main>
    </div>

    <script type="application/json" data-m-data data-m-path="data">
      {
        "joined": false,
        "username": "",
        "users": [],
        "messages": [],
        "newMessage": ""
      }
    </script>

  </template>

  <script>
    (function (global) {
      var agent =
        global.Mishkah &&
        global.Mishkah.HTMLx &&
        global.Mishkah.HTMLx.Agent;

      function ensureContext(ctx) {
        if (!ctx) return null;
        if (typeof ctx.get === 'function' && typeof ctx.set === 'function') {
          return ctx;
        }
        if (agent && typeof agent.ContextAdapter === 'function') {
          return agent.ContextAdapter(ctx);
        }
        return null;
      }

      function handleUsernameInput(event, ctx) {
        var context = ensureContext(ctx);
        if (!context || !event) return;
        var value = '';
        if (event.target && typeof event.target.value === 'string') {
          value = event.target.value;
        }
        context.set('data.username', value);
      }

      function joinChat(event, ctx) {
        if (event && typeof event.preventDefault === 'function') {
          event.preventDefault();
        }
        var context = ensureContext(ctx);
        if (!context) return;
        var current = context.get ? context.get('data.username') : '';
        var name = typeof current === 'string' ? current.trim() : '';
        if (!name) {
          name = generateGuestName();
          context.set('data.username', name);
        } else if (name !== current) {
          context.set('data.username', name);
        }
        context.set('data.joined', true);
      }

      function updateUsers(userList, ctx) {
        var context = ensureContext(ctx);
        if (!context) return;
        if (Array.isArray(userList)) {
          context.set('data.users', userList);
        } else {
          context.set('data.users', []);
        }
      }

      function appendMessage(message, ctx) {
        var context = ensureContext(ctx);
        if (!context || !message) return;
        var currentMessages = context.get ? context.get('data.messages') : [];
        if (!Array.isArray(currentMessages)) {
          currentMessages = [];
        }
        var normalized = {
          id: message.id || 'msg-' + Date.now(),
          user: message.user || 'مجهول',
          text: (message.text || '').toString()
        };
        context.set('data.messages', currentMessages.concat([normalized]));
      }

      function handleMessageInput(event, ctx) {
        var context = ensureContext(ctx);
        if (!context || !event) return;
        var value = '';
        if (event.target && typeof event.target.value === 'string') {
          value = event.target.value;
        }
        context.set('data.newMessage', value);
      }

      function messagePayload(ctx) {
        var context = ensureContext(ctx);
        if (!context) return null;
        var text = context.get ? context.get('data.newMessage') : '';
        var value = typeof text === 'string' ? text.trim() : '';
        if (!value) return null;
        var username = context.get ? context.get('data.username') : '';
        if (!username) {
          username = generateGuestName();
        }
        return {
          user: username,
          text: value
        };
      }

      function sendMessage(event, ctx) {
        if (event && typeof event.preventDefault === 'function') {
          event.preventDefault();
        }
        var context = ensureContext(ctx);
        if (!context) return;
        var payload = messagePayload(context);
        if (!payload) return;
        context.set('data.newMessage', '');
      }

      function generateGuestName() {
        var random = Math.floor(Math.random() * 9000) + 1000;
        return 'ضيف-' + random;
      }

      var chatOrders = {
        'chat.join': {
          on: ['click'],
          gkeys: ['chat:join'],
          handler: function (event, context) {
            joinChat(event, context);
          }
        },
        'chat.send': {
          on: ['click'],
          gkeys: ['chat:send'],
          handler: function (event, context) {
            sendMessage(event, context);
          }
        }
      };

      global.handleUsernameInput = handleUsernameInput;
      global.joinChat = joinChat;
      global.updateUsers = updateUsers;
      global.appendMessage = appendMessage;
      global.handleMessageInput = handleMessageInput;
      global.messagePayload = messagePayload;
      global.sendMessage = sendMessage;
      global.generateGuestName = generateGuestName;
      global.chatOrders = chatOrders;
    })(window);
  </script>

  <script>
    const chatDatabase = {
      head: { title: 'Mishkah WebSocket Demo' },
      env: { lang: 'ar', dir: 'rtl', theme: 'dark' }
    };

    Mishkah.app.make(chatDatabase, { orders: window.chatOrders || {} }).then(app => {
      console.log('Mishkah HTMLx WebSocket App Initialized!');
    });
  </script>

</body>
</html>
