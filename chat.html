<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Mishkah WebSocket Demo</title>
  <script src="./mishkah-utils.js"></script>
  <script src="./mishkah.core.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/acorn@8.15.0/dist/acorn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/acorn-walk@8.3.4/dist/walk.min.js"></script>
  <script>
    window.acornWalk = window.acornWalk || (window.acorn && window.acorn.walk);
  </script>
  <script src="./mishkah-htmlx.js"></script>
  <script src="mishkah-ui.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white">

  <div id="app"></div>

  <template data-namespace="chatApp">

    <div class="container mx-auto p-8 max-w-md" x-if="!state.data.joined">
      <h1 class="text-2xl font-bold mb-4">انضم إلى الدردشة</h1>
      <div class="flex flex-col gap-4">
        <input
          type="text"
          class="p-2 rounded bg-gray-800 border border-gray-700"
          placeholder="اكتب اسمك المستعار"
          value="{state.data.username}"
          oninput="handleUsernameInput(event, ctx)"
        />
        <button
          type="button"
          class="bg-blue-600 p-2 rounded hover:bg-blue-700"
          data-m-gkey="chat:join"
        >
          دخول
        </button>
      </div>
    </div>

    <div
      class="container mx-auto p-4 flex gap-4 h-screen"
      x-if="state.data.joined"
      m-ws-connect="main_socket"
      m-ws-url="wss://ws.mas.com.eg"
    >

      <aside class="w-1/4 bg-gray-800 p-4 rounded-lg">
        <h2 class="font-bold mb-2">المتصلون الآن</h2>
        <ul m-ws-on:user-list-update="updateUsers(event.detail.payload, ctx)">
          <li
            x-for="user, idx in state.data.users"
            data-m-key="{user.id || idx}"
            class="py-1 border-b border-gray-700 last:border-0"
          >
            {user.name || user}
          </li>
        </ul>
      </aside>

      <main class="w-3/4 flex flex-col gap-4">
        <div
          class="flex-1 bg-gray-800 p-4 rounded-lg overflow-y-auto"
          m-ws-on:new-message="appendMessage(event.detail.payload, ctx)"
        >
          <div
            x-for="msg, msgIdx in state.data.messages"
            data-m-key="{msg.id || msgIdx}"
            class="mb-3"
          >
            <strong class="text-blue-300">{msg.user || 'مجهول'}:</strong>
            <span class="ml-2">{msg.text}</span>
          </div>
        </div>

        <form class="flex gap-2" onsubmit="sendMessage(event, ctx)">
          <input
            type="text"
            class="flex-1 p-2 rounded bg-gray-700 border border-gray-600"
            placeholder="اكتب رسالتك..."
            value="{state.data.newMessage}"
            oninput="handleMessageInput(event, ctx)"
          />
          <button
            type="submit"
            class="bg-green-600 p-2 rounded hover:bg-green-700"
            data-m-gkey="chat:send"
            m-ws-emit:send-message="messagePayload(ctx)"
          >
            إرسال
          </button>
        </form>
      </main>
    </div>

    <script type="application/json" data-m-data data-m-path="data">
      {
        "joined": false,
        "username": "",
        "users": [],
        "messages": [],
        "newMessage": ""
      }
    </script>

  </template>

  <script>
    (function (global) {
      var LOG_PREFIX = '%c[Chat Debug]%c ';
      var LOG_STYLE = 'color:#38bdf8;font-weight:bold;';
      var LOG_RESET = 'color:inherit;';

      function log(level, message, payload) {
        if (typeof console === 'undefined') {
          return;
        }
        var logger = typeof console[level] === 'function' ? console[level] : console.log;
        if (payload !== undefined) {
          try {
            logger.call(console, LOG_PREFIX + message, LOG_STYLE, LOG_RESET, payload);
          } catch (error) {
            console.error(LOG_PREFIX + 'فشل تسجيل الحمولة debug payload', LOG_STYLE, LOG_RESET, error);
          }
        } else {
          logger.call(console, LOG_PREFIX + message, LOG_STYLE, LOG_RESET);
        }
      }

      function info(message, payload) {
        log('info', message, payload);
      }

      function warn(message, payload) {
        log('warn', message, payload);
      }

      function error(message, payload) {
        log('error', message, payload);
      }

      function debug(message, payload) {
        log('debug', message, payload);
      }

      var utils = global.Mishkah && global.Mishkah.utils;
      var OriginalWebSocketX = utils && utils.WebSocketX;

      if (OriginalWebSocketX && !OriginalWebSocketX.__chatDebugWrapped) {
        var ChatDebugWebSocketX = /*#__PURE__*/ (function (Parent) {
          function Wrapper(url, options) {
            info('تهيئة اتصال WebSocket جديد', { url: url, options: options || {} });
            var instance = new Parent(url, options);
            try {
              instance.on('open', function () {
                info('تم فتح اتصال WebSocket', { url: url });
              });
              instance.on('close', function (evt) {
                warn('تم إغلاق اتصال WebSocket', { url: url, event: evt });
              });
              instance.on('error', function (err) {
                error('خطأ من WebSocket', { url: url, error: err });
              });
              instance.on('state', function (state) {
                debug('تغيرت حالة WebSocket', { url: url, state: state });
              });
              instance.on('message', function (message) {
                debug('رسالة WebSocket واردة', { url: url, message: message });
              });
            } catch (hookError) {
              warn('تعذر ربط مراقب لأحداث WebSocket', hookError);
            }
            return instance;
          }

          Wrapper.prototype = Parent.prototype;
          if (Object.setPrototypeOf) {
            Object.setPrototypeOf(Wrapper, Parent);
          } else if (Wrapper.__proto__) {
            Wrapper.__proto__ = Parent;
          }
          Wrapper.__chatDebugWrapped = true;
          return Wrapper;
        })(OriginalWebSocketX);

        if (utils) {
          utils.WebSocketX = ChatDebugWebSocketX;
          utils.WebSocket = ChatDebugWebSocketX;
        }
        global.__ChatOriginalWebSocketX = OriginalWebSocketX;
        info('تم تفعيل طبقة مراقبة WebSocketX للصفحة الحالية.');
      } else if (!OriginalWebSocketX) {
        warn('تعذر العثور على Mishkah.utils.WebSocketX — لن يتم تسجيل أحداث WebSocket.');
      }

      var agent =
        global.Mishkah &&
        global.Mishkah.HTMLx &&
        global.Mishkah.HTMLx.Agent;

      function ensureContext(ctx) {
        if (!ctx) {
          error('تم تمرير سياق فارغ إلى ensureContext.');
          return null;
        }
        if (typeof ctx.get === 'function' && typeof ctx.set === 'function') {
          return ctx;
        }
        if (!agent || typeof agent.ContextAdapter !== 'function') {
          error('تعذر تكيف سياق HTMLx، ContextAdapter غير متاح.');
          return null;
        }
        var adapted = agent.ContextAdapter(ctx);
        if (!adapted) {
          error('فشل ContextAdapter في إرجاع سياق صالح.');
        }
        return adapted;
      }

      function handleUsernameInput(event, ctx) {
        var context = ensureContext(ctx);
        if (!context || !event) {
          error('handleUsernameInput استقبل سياقًا أو حدثًا غير صالح.', { event: event, ctx: ctx });
          return;
        }
        var value = '';
        if (event.target && typeof event.target.value === 'string') {
          value = event.target.value;
        }
        debug('تحديث اسم المستخدم من حقل الإدخال.', { value: value });
        context.set('data.username', value);
      }

      function joinChat(event, ctx) {
        if (event && typeof event.preventDefault === 'function') {
          event.preventDefault();
        }
        var context = ensureContext(ctx);
        if (!context) {
          error('لم يتم العثور على سياق صالح عند محاولة الانضمام للدردشة.');
          return;
        }
        var current = context.get ? context.get('data.username') : '';
        var name = typeof current === 'string' ? current.trim() : '';
        if (!name) {
          name = generateGuestName();
          context.set('data.username', name);
        } else if (name !== current) {
          context.set('data.username', name);
        }
        context.set('data.joined', true);
        info('تم تنفيذ joinChat وتحديث الحالة.', { username: name });
      }

      function updateUsers(userList, ctx) {
        var context = ensureContext(ctx);
        if (!context) {
          error('updateUsers فشل في الحصول على سياق HTMLx.', { users: userList });
          return;
        }
        if (Array.isArray(userList)) {
          context.set('data.users', userList);
          info('تم استلام قائمة المستخدمين وتحديثها.', { count: userList.length, users: userList });
        } else {
          context.set('data.users', []);
          warn('تم استلام قائمة مستخدمين غير صالحة من الخادم.', { payload: userList });
        }
      }

      function appendMessage(message, ctx) {
        var context = ensureContext(ctx);
        if (!context || !message) {
          error('appendMessage استقبل بيانات غير صالحة.', { message: message });
          return;
        }
        var currentMessages = context.get ? context.get('data.messages') : [];
        if (!Array.isArray(currentMessages)) {
          currentMessages = [];
        }
        var normalized = {
          id: message.id || 'msg-' + Date.now(),
          user: message.user || 'مجهول',
          text: (message.text || '').toString()
        };
        context.set('data.messages', currentMessages.concat([normalized]));
        info('تم إضافة رسالة جديدة إلى السجل.', normalized);
      }

      function handleMessageInput(event, ctx) {
        var context = ensureContext(ctx);
        if (!context || !event) {
          error('handleMessageInput استقبل سياقًا أو حدثًا غير صالح.', { event: event });
          return;
        }
        var value = '';
        if (event.target && typeof event.target.value === 'string') {
          value = event.target.value;
        }
        debug('تحديث قيمة الرسالة المؤقتة.', { value: value });
        context.set('data.newMessage', value);
      }

      function messagePayload(ctx) {
        var context = ensureContext(ctx);
        if (!context) {
          error('messagePayload فشل في الحصول على سياق صالح.');
          return null;
        }
        var text = context.get ? context.get('data.newMessage') : '';
        var value = typeof text === 'string' ? text.trim() : '';
        if (!value) {
          warn('محاولة إرسال رسالة فارغة تم تجاهلها.');
          return null;
        }
        var username = context.get ? context.get('data.username') : '';
        if (!username) {
          username = generateGuestName();
          warn('لم يتم تعيين اسم مستخدم، تم إنشاء اسم ضيف تلقائي.', { username: username });
        }
        var payload = {
          user: username,
          text: value
        };
        debug('تم تحضير الحمولة الخاصة بإرسال الرسالة.', payload);
        return payload;
      }

      function sendMessage(event, ctx) {
        if (event && typeof event.preventDefault === 'function') {
          event.preventDefault();
        }
        var context = ensureContext(ctx);
        if (!context) {
          error('sendMessage لم يتمكن من الحصول على سياق HTMLx.');
          return;
        }
        var payload = messagePayload(context);
        if (!payload) {
          warn('sendMessage لم يحصل على حمولة صالحة، لن يتم الإرسال.');
          return;
        }
        context.set('data.newMessage', '');
        info('تم تصفير حقل الرسالة بعد الإرسال المبدئي.', { payload: payload });
      }

      function generateGuestName() {
        var random = Math.floor(Math.random() * 9000) + 1000;
        return 'ضيف-' + random;
      }

      var chatOrders = {
        'chat.join': {
          on: ['click'],
          gkeys: ['chat:join'],
          handler: function (event, context) {
            joinChat(event, context);
          }
        },
        'chat.send': {
          on: ['click'],
          gkeys: ['chat:send'],
          handler: function (event, context) {
            sendMessage(event, context);
          }
        }
      };

      global.handleUsernameInput = handleUsernameInput;
      global.joinChat = joinChat;
      global.updateUsers = updateUsers;
      global.appendMessage = appendMessage;
      global.handleMessageInput = handleMessageInput;
      global.messagePayload = messagePayload;
      global.sendMessage = sendMessage;
      global.generateGuestName = generateGuestName;
      global.chatOrders = chatOrders;
    })(window);
  </script>

  <script>
    const chatDatabase = {
      head: { title: 'Mishkah WebSocket Demo' },
      env: { lang: 'ar', dir: 'rtl', theme: 'dark' }
    };

    Mishkah.app.make(chatDatabase, { orders: window.chatOrders || {} }).then(app => {
      console.log('Mishkah HTMLx WebSocket App Initialized!');
    });
  </script>

</body>
</html>
