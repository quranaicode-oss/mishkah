<!DOCTYPE html>
<html lang="en" data-theme="light" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Daily Financial Closure</title>
  <style>
    :root {
      color-scheme: light dark;
      --mk-font-family: "Cairo", "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      --mk-radius-sm: 8px;
      --mk-radius-md: 12px;
      --mk-spacing-xs: 0.35rem;
      --mk-spacing-sm: 0.75rem;
      --mk-spacing-md: 1rem;
      --mk-spacing-lg: 1.75rem;
      --mk-border-width: 1px;
      --mk-transition: 220ms cubic-bezier(0.4, 0, 0.2, 1);

      --mk-bg: #f5f7fb;
      --mk-bg-panel: #ffffff;
      --mk-text: #1f2933;
      --mk-text-muted: #52606d;
      --mk-accent: #2563eb;
      --mk-accent-soft: rgba(37, 99, 235, 0.12);
      --mk-border: #d9dde3;
      --mk-shadow: 0 15px 35px rgba(15, 23, 42, 0.08);
      --mk-success: #16a34a;
      --mk-danger: #dc2626;
      --mk-warning: #d97706;
    }

    [data-theme="dark"] {
      --mk-bg: #0f172a;
      --mk-bg-panel: #111c32;
      --mk-text: #f8fafc;
      --mk-text-muted: #cbd5f5;
      --mk-accent: #60a5fa;
      --mk-accent-soft: rgba(96, 165, 250, 0.1);
      --mk-border: rgba(148, 163, 184, 0.3);
      --mk-shadow: 0 18px 48px rgba(15, 23, 42, 0.45);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: var(--mk-font-family);
      background: var(--mk-bg);
      color: var(--mk-text);
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      transition: background var(--mk-transition), color var(--mk-transition);
    }

    header {
      padding: var(--mk-spacing-lg) var(--mk-spacing-lg) var(--mk-spacing-sm);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: var(--mk-spacing-sm);
    }

    .brand {
      display: flex;
      flex-direction: column;
      gap: var(--mk-spacing-xs);
    }

    .brand h1 {
      margin: 0;
      font-size: clamp(1.6rem, 2vw + 0.5rem, 2.4rem);
      font-weight: 700;
    }

    .brand span {
      color: var(--mk-text-muted);
      font-size: 0.95rem;
    }

    .toolbar {
      display: flex;
      align-items: center;
      gap: var(--mk-spacing-sm);
      flex-wrap: wrap;
    }

    button,
    .select,
    .toggle {
      border-radius: var(--mk-radius-sm);
      border: var(--mk-border-width) solid var(--mk-border);
      padding: 0.55rem 1rem;
      background: var(--mk-bg-panel);
      color: var(--mk-text);
      cursor: pointer;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 0.45rem;
      transition: background var(--mk-transition), color var(--mk-transition), transform var(--mk-transition), border-color var(--mk-transition), box-shadow var(--mk-transition);
    }

    button.primary {
      background: var(--mk-accent);
      color: white;
      border-color: transparent;
      box-shadow: 0 12px 24px rgba(37, 99, 235, 0.2);
    }

    button.primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 36px rgba(37, 99, 235, 0.25);
    }

    button.danger {
      background: var(--mk-danger);
      color: #fff;
      border-color: transparent;
    }

    button.danger:hover {
      box-shadow: 0 16px 36px rgba(220, 38, 38, 0.25);
      transform: translateY(-1px);
    }

    .select {
      appearance: none;
      padding-right: 2rem;
      position: relative;
    }

    main {
      flex: 1;
      padding: 0 var(--mk-spacing-lg) var(--mk-spacing-lg);
      display: flex;
      flex-direction: column;
      gap: var(--mk-spacing-md);
    }

    .panel {
      background: var(--mk-bg-panel);
      border-radius: var(--mk-radius-md);
      border: var(--mk-border-width) solid var(--mk-border);
      padding: var(--mk-spacing-lg);
      box-shadow: var(--mk-shadow);
      transition: background var(--mk-transition), border-color var(--mk-transition);
    }

    .summary-grid {
      display: grid;
      gap: var(--mk-spacing-md);
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }

    .summary-card {
      display: flex;
      flex-direction: column;
      gap: var(--mk-spacing-xs);
      padding: var(--mk-spacing-md);
      border-radius: var(--mk-radius-md);
      background: var(--mk-accent-soft);
      border: var(--mk-border-width) dashed var(--mk-accent);
    }

    .summary-card strong {
      font-size: 1.35rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--mk-bg-panel);
      border-radius: var(--mk-radius-md);
      overflow: hidden;
    }

    thead {
      background: rgba(37, 99, 235, 0.08);
      color: var(--mk-text);
    }

    thead th {
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-size: 0.75rem;
      padding: var(--mk-spacing-sm);
    }

    tbody td {
      padding: var(--mk-spacing-sm);
      border-top: var(--mk-border-width) solid var(--mk-border);
      font-size: 0.95rem;
    }

    tbody tr:hover {
      background: rgba(37, 99, 235, 0.05);
    }

    .tag {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      padding: 0.25rem 0.75rem;
      font-size: 0.75rem;
      font-weight: 700;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    .tag.success {
      background: rgba(22, 163, 74, 0.14);
      color: var(--mk-success);
    }

    .tag.warning {
      background: rgba(217, 119, 6, 0.14);
      color: var(--mk-warning);
    }

    .toolbar .group {
      display: inline-flex;
      align-items: center;
      gap: var(--mk-spacing-xs);
    }

    .group label {
      font-size: 0.85rem;
      color: var(--mk-text-muted);
      font-weight: 600;
    }

    .floating-modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--mk-spacing-lg);
      z-index: 90;
      backdrop-filter: blur(6px);
    }

    .floating-modal.hidden {
      display: none;
    }

    .floating-modal .modal-content {
      background: var(--mk-bg-panel);
      color: var(--mk-text);
      border-radius: var(--mk-radius-md);
      padding: var(--mk-spacing-lg);
      border: var(--mk-border-width) solid var(--mk-border);
      min-width: min(560px, 90vw);
      max-height: 90vh;
      overflow: auto;
      box-shadow: var(--mk-shadow);
      display: flex;
      flex-direction: column;
      gap: var(--mk-spacing-md);
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: var(--mk-spacing-sm);
    }

    .order-line-table {
      border: var(--mk-border-width) solid var(--mk-border);
      border-radius: var(--mk-radius-sm);
      overflow: hidden;
    }

    .order-line-table th,
    .order-line-table td {
      font-size: 0.9rem;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      background: rgba(37, 99, 235, 0.12);
      color: var(--mk-accent);
      font-weight: 600;
      font-size: 0.8rem;
    }

    .status-badge::before {
      content: "";
      display: inline-block;
      width: 0.5rem;
      height: 0.5rem;
      border-radius: 50%;
      background: currentColor;
    }

    .status-badge.danger {
      background: rgba(220, 38, 38, 0.12);
      color: var(--mk-danger);
    }

    .status-badge.success {
      background: rgba(22, 163, 74, 0.12);
      color: var(--mk-success);
    }

    .footer-actions {
      margin-top: auto;
      padding: var(--mk-spacing-lg);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: var(--mk-spacing-sm);
    }

    .footer-actions .remark {
      color: var(--mk-text-muted);
      font-size: 0.9rem;
      max-width: 560px;
    }

    .language-switcher {
      display: inline-flex;
      gap: 0.5rem;
      background: var(--mk-bg-panel);
      border-radius: 999px;
      padding: 0.25rem;
      border: var(--mk-border-width) solid transparent;
      box-shadow: inset 0 0 0 var(--mk-border-width) var(--mk-border);
    }

    .language-switcher button {
      border-radius: 999px;
      border: none;
      background: transparent;
      font-weight: 700;
      padding: 0.35rem 0.9rem;
      font-size: 0.85rem;
      color: var(--mk-text-muted);
    }

    .language-switcher button.active {
      background: var(--mk-accent);
      color: #fff;
      box-shadow: 0 10px 18px rgba(37, 99, 235, 0.18);
    }

    .theme-toggle {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.4rem 0.75rem;
      background: var(--mk-bg-panel);
      border-radius: 999px;
      border: var(--mk-border-width) solid var(--mk-border);
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--mk-text-muted);
    }

    @media (max-width: 768px) {
      .floating-modal .modal-content {
        min-width: min(420px, 100vw);
      }

      header,
      main,
      .footer-actions {
        padding: var(--mk-spacing-md);
      }

      .summary-card {
        padding: var(--mk-spacing-sm);
      }

      thead th,
      tbody td {
        padding: var(--mk-spacing-xs);
      }

      .toolbar {
        justify-content: flex-start;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <h1 data-i18n="pageTitle">Daily Financial Closure</h1>
      <span data-i18n="pageSubtitle">Review, confirm, and close the day</span>
    </div>
    <div class="toolbar">
      <div class="language-switcher" role="group" aria-label="Language">
        <button type="button" data-lang="en" class="active">EN</button>
        <button type="button" data-lang="ar">AR</button>
      </div>
      <button class="theme-toggle" type="button" id="themeToggle">
        <span aria-hidden="true">🌙</span>
        <span data-i18n="themeToggle">Dark</span>
      </button>
      <div class="group">
        <label for="filterTerminal" data-i18n="filterTerminal">Terminal</label>
        <select id="filterTerminal" class="select"></select>
      </div>
      <div class="group">
        <label for="filterDate" data-i18n="filterDate">Business Date</label>
        <input id="filterDate" class="toggle" type="date" />
      </div>
    </div>
  </header>

  <main>
    <section class="panel">
      <div class="summary-grid" role="list">
        <div class="summary-card" role="listitem">
          <span data-i18n="summaryOrders">Closed Orders</span>
          <strong id="totalOrders">0</strong>
        </div>
        <div class="summary-card" role="listitem">
          <span data-i18n="summaryItems">Items Sold</span>
          <strong id="totalItems">0</strong>
        </div>
        <div class="summary-card" role="listitem">
          <span data-i18n="summaryNet">Net Amount</span>
          <strong id="totalNet">0.00</strong>
        </div>
        <div class="summary-card" role="listitem">
          <span data-i18n="summaryPayments">Payments Collected</span>
          <strong id="totalPayments">0.00</strong>
        </div>
      </div>
    </section>

    <section class="panel" aria-labelledby="ordersListTitle">
      <header style="display:flex; justify-content: space-between; align-items: center; gap: var(--mk-spacing-sm); margin-bottom: var(--mk-spacing-md);">
        <h2 id="ordersListTitle" data-i18n="ordersTable">Closed Orders</h2>
        <div class="status-badge success" id="closureStatus">
          <span data-i18n="statusReady">Ready for closure</span>
        </div>
      </header>
      <div class="table-wrapper" style="overflow-x: auto;">
        <table>
          <thead>
            <tr>
              <th data-i18n="colOrder">Order</th>
              <th data-i18n="colCustomer">Customer</th>
              <th data-i18n="colItems">Items</th>
              <th data-i18n="colTotal">Total</th>
              <th data-i18n="colPaid">Paid</th>
              <th data-i18n="colMethod">Method</th>
              <th data-i18n="colTime">Closed At</th>
              <th data-i18n="colActions">Actions</th>
            </tr>
          </thead>
          <tbody id="ordersTableBody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <section class="footer-actions">
    <p class="remark" data-i18n="footerHint">Confirming closure will archive today’s orders into history and clean the live workspace.</p>
    <div style="display:flex; gap: var(--mk-spacing-sm);">
      <button type="button" class="danger" id="resetWorkspace" data-i18n="actionReset">Reset Workspace</button>
      <button type="button" class="primary" id="confirmClosure" data-i18n="actionConfirm">Confirm Financial Closure</button>
    </div>
  </section>

  <div class="floating-modal hidden" role="dialog" aria-modal="true" id="orderDetailsModal">
    <div class="modal-content">
      <header style="display:flex; justify-content: space-between; align-items: center;">
        <h3 id="modalTitle">Order</h3>
        <button type="button" id="closeModal">✕</button>
      </header>
      <section>
        <h4 data-i18n="modalOrderLines">Order Lines</h4>
        <div class="order-line-table">
          <table>
            <thead>
              <tr>
                <th data-i18n="colItem">Item</th>
                <th data-i18n="colQty">Qty</th>
                <th data-i18n="colPrice">Price</th>
                <th data-i18n="colSubtotal">Subtotal</th>
              </tr>
            </thead>
            <tbody id="modalOrderLines"></tbody>
          </table>
        </div>
      </section>
      <section>
        <h4 data-i18n="modalPayments">Payments</h4>
        <div class="order-line-table">
          <table>
            <thead>
              <tr>
                <th data-i18n="colMethod">Method</th>
                <th data-i18n="colAmount">Amount</th>
                <th data-i18n="colReference">Reference</th>
              </tr>
            </thead>
            <tbody id="modalPayments"></tbody>
          </table>
        </div>
      </section>
      <section>
        <h4 data-i18n="modalNotes">Notes</h4>
        <p id="modalNotes">&mdash;</p>
      </section>
      <div class="modal-actions">
        <button type="button" id="modalCloseButton" data-i18n="close">Close</button>
      </div>
    </div>
  </div>

  <div class="floating-modal hidden" role="dialog" aria-modal="true" id="confirmModal">
    <div class="modal-content">
      <header>
        <h3 data-i18n="confirmTitle">Finalize daily closure?</h3>
      </header>
      <p data-i18n="confirmBody">This action will send today’s closed orders to the ERP endpoint and purge live workspace data. Continue?</p>
      <div class="modal-actions">
        <button type="button" id="cancelConfirm" data-i18n="cancel">Cancel</button>
        <button type="button" class="primary" id="confirmSend" data-i18n="confirmSend">Send &amp; Close</button>
      </div>
    </div>
  </div>

  <div class="floating-modal hidden" role="alertdialog" aria-modal="true" id="feedbackModal">
    <div class="modal-content">
      <header>
        <h3 id="feedbackTitle">Status</h3>
      </header>
      <p id="feedbackBody"></p>
      <div class="modal-actions">
        <button type="button" class="primary" id="feedbackClose" data-i18n="close">Close</button>
      </div>
    </div>
  </div>

  <script>
    const env = {
      endpoint: '/erp/proced'
    };

    const translations = {
      en: {
        pageTitle: 'Daily Financial Closure',
        pageSubtitle: 'Review, confirm, and close the day',
        summaryOrders: 'Closed Orders',
        summaryItems: 'Items Sold',
        summaryNet: 'Net Amount',
        summaryPayments: 'Payments Collected',
        ordersTable: 'Closed Orders',
        statusReady: 'Ready for closure',
        viewDetails: 'Details',
        colOrder: 'Order',
        colCustomer: 'Customer',
        colItems: 'Items',
        colTotal: 'Total',
        colPaid: 'Paid',
        colMethod: 'Method',
        colTime: 'Closed At',
        colActions: 'Actions',
        colItem: 'Item',
        colQty: 'Qty',
        colPrice: 'Price',
        colSubtotal: 'Subtotal',
        colAmount: 'Amount',
        colReference: 'Reference',
        filterTerminal: 'Terminal',
        filterDate: 'Business Date',
        footerHint: 'Confirming closure will archive today\'s orders into history and clean the live workspace.',
        actionReset: 'Reset Workspace',
        actionConfirm: 'Confirm Financial Closure',
        modalOrderLines: 'Order Lines',
        modalPayments: 'Payments',
        modalNotes: 'Notes',
        close: 'Close',
        themeToggle: 'Dark',
        confirmTitle: 'Finalize daily closure?',
        confirmBody: 'This action will send today\'s closed orders to the ERP endpoint and purge live workspace data. Continue?',
        cancel: 'Cancel',
        confirmSend: 'Send & Close',
        toastSuccessTitle: 'Closure completed',
        toastSuccessBody: 'The ERP endpoint received today\'s closed orders successfully.',
        toastErrorTitle: 'Closure failed',
        toastErrorBody: 'Please retry or contact support with the reference shown.'
      },
      ar: {
        pageTitle: 'الإقفال المالي اليومي',
        pageSubtitle: 'راجع، أكد، وأنهِ إقفال اليوم',
        summaryOrders: 'الطلبات المغلقة',
        summaryItems: 'الأصناف المباعة',
        summaryNet: 'صافي المبيعات',
        summaryPayments: 'إجمالي المدفوعات',
        ordersTable: 'الطلبات المغلقة',
        statusReady: 'جاهز للإقفال',
        viewDetails: 'عرض التفاصيل',
        colOrder: 'الطلب',
        colCustomer: 'العميل',
        colItems: 'الأصناف',
        colTotal: 'الإجمالي',
        colPaid: 'المدفوع',
        colMethod: 'طريقة السداد',
        colTime: 'تاريخ الإقفال',
        colActions: 'الاجراءات',
        colItem: 'الصنف',
        colQty: 'الكمية',
        colPrice: 'السعر',
        colSubtotal: 'الإجمالي الفرعي',
        colAmount: 'المبلغ',
        colReference: 'المرجع',
        filterTerminal: 'المحطة',
        filterDate: 'تاريخ العمل',
        footerHint: 'تأكيد الإقفال سينقل طلبات اليوم إلى الأرشيف ويُنظف مساحة العمل المباشرة.',
        actionReset: 'إعادة تهيئة المساحة',
        actionConfirm: 'تأكيد الإقفال المالي',
        modalOrderLines: 'بنود الطلب',
        modalPayments: 'طرق السداد',
        modalNotes: 'ملاحظات',
        close: 'إغلاق',
        themeToggle: 'ليلي',
        confirmTitle: 'هل تريد إنهاء الإقفال اليومي؟',
        confirmBody: 'سيتم إرسال الطلبات المغلقة اليوم إلى نظام ERP وحذف بيانات العمل المباشرة. هل تود المتابعة؟',
        cancel: 'إلغاء',
        confirmSend: 'إرسال وإقفال',
        toastSuccessTitle: 'تم الإقفال بنجاح',
        toastSuccessBody: 'تم إرسال بيانات الطلبات المغلقة اليوم إلى نظام ERP بنجاح.',
        toastErrorTitle: 'فشل الإقفال',
        toastErrorBody: 'يرجى إعادة المحاولة أو التواصل مع الدعم مع تزويدهم بالمرجع المعروض.'
      }
    };

    const sampleData = {
      businessDate: new Date().toISOString().slice(0, 10),
      terminal: 'POS-A1',
      orders: [
        {
          id: 'INV-2024-0915-01',
          customerName: 'John Carter',
          closedAt: '2024-09-15T22:10:00Z',
          notes: 'Preferred pickup at front desk.',
          totals: {
            net: 182.5,
            tax: 27.38,
            grand: 209.88
          },
          lines: [
            { sku: 'BRG-001', name: 'Classic Burger', qty: 2, price: 35, subtotal: 70 },
            { sku: 'FRS-002', name: 'Large Fries', qty: 2, price: 15, subtotal: 30 },
            { sku: 'DRK-010', name: 'Fresh Orange Juice', qty: 2, price: 18, subtotal: 36 },
            { sku: 'DSR-005', name: 'Cheesecake Slice', qty: 1, price: 18.5, subtotal: 18.5 },
            { sku: 'UPSELL', name: 'Service Charge', qty: 1, price: 28, subtotal: 28 }
          ],
          payments: [
            { method: 'Card', amount: 179.88, reference: 'TRX-982374' },
            { method: 'Cash', amount: 30, reference: 'CASH-DROP-77' }
          ]
        },
        {
          id: 'INV-2024-0915-02',
          customerName: 'أحمد العسيري',
          closedAt: '2024-09-15T23:05:00Z',
          notes: 'إرجاع 10 ريال بسبب عرض خاص.',
          totals: {
            net: 96,
            tax: 14.4,
            grand: 110.4
          },
          lines: [
            { sku: 'PZA-004', name: 'بيتزا مارجريتا', qty: 1, price: 55, subtotal: 55 },
            { sku: 'PZA-012', name: 'بيتزا أربعة أجبان', qty: 1, price: 65, subtotal: 65 },
            { sku: 'DISC-RET', name: 'خصم استرداد', qty: 1, price: -10, subtotal: -10 }
          ],
          payments: [
            { method: 'Mada', amount: 110.4, reference: 'TRX-559912' }
          ]
        },
        {
          id: 'INV-2024-0915-03',
          customerName: 'Walk-in Guest',
          closedAt: '2024-09-15T21:18:00Z',
          notes: '',
          totals: {
            net: 48,
            tax: 7.2,
            grand: 55.2
          },
          lines: [
            { sku: 'SAL-007', name: 'Quinoa Salad', qty: 2, price: 24, subtotal: 48 }
          ],
          payments: [
            { method: 'Apple Pay', amount: 55.2, reference: 'TRX-129991' }
          ]
        }
      ]
    };

    let activeLang = 'en';
    let activeTheme = 'light';
    let filteredOrders = [...sampleData.orders];

    const elements = {
      ordersTableBody: document.getElementById('ordersTableBody'),
      totalOrders: document.getElementById('totalOrders'),
      totalItems: document.getElementById('totalItems'),
      totalNet: document.getElementById('totalNet'),
      totalPayments: document.getElementById('totalPayments'),
      filterTerminal: document.getElementById('filterTerminal'),
      filterDate: document.getElementById('filterDate'),
      languageButtons: document.querySelectorAll('.language-switcher button'),
      themeToggle: document.getElementById('themeToggle'),
      modal: document.getElementById('orderDetailsModal'),
      confirmModal: document.getElementById('confirmModal'),
      feedbackModal: document.getElementById('feedbackModal'),
      modalTitle: document.getElementById('modalTitle'),
      modalOrderLines: document.getElementById('modalOrderLines'),
      modalPayments: document.getElementById('modalPayments'),
      modalNotes: document.getElementById('modalNotes'),
      confirmClosure: document.getElementById('confirmClosure'),
      confirmSend: document.getElementById('confirmSend'),
      cancelConfirm: document.getElementById('cancelConfirm'),
      feedbackTitle: document.getElementById('feedbackTitle'),
      feedbackBody: document.getElementById('feedbackBody'),
      feedbackClose: document.getElementById('feedbackClose'),
      closeModal: document.getElementById('closeModal'),
      modalCloseButton: document.getElementById('modalCloseButton'),
      resetWorkspace: document.getElementById('resetWorkspace'),
      closureStatus: document.getElementById('closureStatus')
    };

    function updateThemeToggleLabel() {
      const label = elements.themeToggle.querySelector('[data-i18n="themeToggle"]');
      if (!label) return;
      if (activeTheme === 'dark') {
        label.textContent = activeLang === 'ar' ? 'نهاري' : 'Light';
      } else {
        label.textContent = translations[activeLang].themeToggle;
      }
    }

    function formatCurrency(value) {
      return new Intl.NumberFormat(activeLang === 'ar' ? 'ar-SA' : 'en-US', {
        style: 'currency',
        currency: 'SAR'
      }).format(value);
    }

    function formatDate(value) {
      const locale = activeLang === 'ar' ? 'ar-SA' : 'en-US';
      return new Intl.DateTimeFormat(locale, {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      }).format(new Date(value));
    }

    function renderOrders() {
      const rows = filteredOrders.map((order) => {
        const itemsCount = order.lines.reduce((acc, line) => acc + line.qty, 0);
        const paymentsTotal = order.payments.reduce((sum, payment) => sum + payment.amount, 0);

        return `
          <tr>
            <td>
              <div style="display:flex; flex-direction:column; gap:0.35rem;">
                <span style="font-weight:600;">${order.id}</span>
                <span class="tag success" data-i18n="statusReady">${translations[activeLang].statusReady}</span>
              </div>
            </td>
            <td>${order.customerName || '&mdash;'}</td>
            <td>${itemsCount}</td>
            <td>${formatCurrency(order.totals.grand)}</td>
            <td>${formatCurrency(paymentsTotal)}</td>
            <td>${order.payments.map((payment) => payment.method).join(', ')}</td>
            <td>${formatDate(order.closedAt)}</td>
            <td>
              <button type="button" data-order="${order.id}" class="primary" style="padding:0.35rem 0.8rem; font-size:0.85rem;">
                <span data-i18n="viewDetails">${translations[activeLang].viewDetails}</span>
              </button>
            </td>
          </tr>
        `;
      });

      elements.ordersTableBody.innerHTML = rows.join('');

      const totals = filteredOrders.reduce(
        (acc, order) => {
          acc.orders += 1;
          acc.items += order.lines.reduce((sum, line) => sum + line.qty, 0);
          acc.net += order.totals.net;
          acc.payments += order.payments.reduce((sum, payment) => sum + payment.amount, 0);
          return acc;
        },
        { orders: 0, items: 0, net: 0, payments: 0 }
      );

      elements.totalOrders.textContent = totals.orders.toLocaleString(activeLang === 'ar' ? 'ar-SA' : 'en-US');
      elements.totalItems.textContent = totals.items.toLocaleString(activeLang === 'ar' ? 'ar-SA' : 'en-US');
      elements.totalNet.textContent = formatCurrency(totals.net);
      elements.totalPayments.textContent = formatCurrency(totals.payments);

      elements.ordersTableBody.querySelectorAll('button[data-order]').forEach((button) => {
        button.addEventListener('click', () => {
          const orderId = button.getAttribute('data-order');
          openOrderModal(orderId);
        });
      });
    }

    function openOrderModal(orderId) {
      const order = filteredOrders.find((item) => item.id === orderId);
      if (!order) return;

      elements.modalTitle.textContent = `${translations[activeLang].colOrder}: ${order.id}`;
      elements.modalOrderLines.innerHTML = order.lines
        .map(
          (line) => `
          <tr>
            <td><strong>${line.name}</strong><div style="color:var(--mk-text-muted); font-size:0.75rem;">${line.sku}</div></td>
            <td>${line.qty}</td>
            <td>${formatCurrency(line.price)}</td>
            <td>${formatCurrency(line.subtotal)}</td>
          </tr>
        `
        )
        .join('');

      elements.modalPayments.innerHTML = order.payments
        .map(
          (payment) => `
          <tr>
            <td>${payment.method}</td>
            <td>${formatCurrency(payment.amount)}</td>
            <td>${payment.reference || '&mdash;'}</td>
          </tr>
        `
        )
        .join('');

      elements.modalNotes.textContent = order.notes?.trim() || '—';

      elements.modal.classList.remove('hidden');
    }

    function closeModal(modal) {
      modal.classList.add('hidden');
    }

    function hydrateTerminalFilter() {
      const terminals = ['All', sampleData.terminal, 'POS-B2'];
      elements.filterTerminal.innerHTML = terminals
        .map((terminal) => `<option value="${terminal}">${terminal}</option>`)
        .join('');
      elements.filterTerminal.value = 'All';
    }

    function hydrateDateFilter() {
      elements.filterDate.value = sampleData.businessDate;
    }

    function bindLanguageSwitcher() {
      elements.languageButtons.forEach((button) => {
        button.addEventListener('click', () => {
          const lang = button.dataset.lang;
          setLanguage(lang);
        });
      });
    }

    function setLanguage(lang) {
      if (!translations[lang]) return;
      activeLang = lang;
      document.documentElement.lang = lang === 'ar' ? 'ar' : 'en';
      document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';

      elements.languageButtons.forEach((button) => {
        button.classList.toggle('active', button.dataset.lang === lang);
      });

      document.querySelectorAll('[data-i18n]').forEach((node) => {
        const key = node.getAttribute('data-i18n');
        const text = translations[lang][key];
        if (typeof text === 'string') {
          node.textContent = text;
        }
      });

      updateThemeToggleLabel();
      renderOrders();
    }

    function bindThemeToggle() {
      elements.themeToggle.addEventListener('click', () => {
        activeTheme = activeTheme === 'light' ? 'dark' : 'light';
        document.documentElement.dataset.theme = activeTheme;
        updateThemeToggleLabel();
      });
    }

    function bindFilters() {
      elements.filterTerminal.addEventListener('change', () => {
        applyFilters();
      });
      elements.filterDate.addEventListener('change', () => {
        applyFilters();
      });
    }

    function applyFilters() {
      const selectedTerminal = elements.filterTerminal.value;
      const selectedDate = elements.filterDate.value;

      filteredOrders = sampleData.orders.filter((order) => {
        const matchesTerminal = selectedTerminal === 'All' || selectedTerminal === sampleData.terminal;
        const matchesDate = !selectedDate || sampleData.businessDate === selectedDate;
        return matchesTerminal && matchesDate;
      });

      renderOrders();
    }

    function showConfirmModal() {
      elements.confirmModal.classList.remove('hidden');
    }

    function showFeedbackModal({ title, body, isError = false }) {
      elements.feedbackTitle.textContent = title;
      elements.feedbackBody.textContent = body;
      elements.feedbackTitle.style.color = isError ? 'var(--mk-danger)' : 'var(--mk-success)';
      elements.feedbackBody.style.color = isError ? 'var(--mk-danger)' : 'var(--mk-text)';
      elements.feedbackModal.classList.remove('hidden');
    }

    async function sendClosure() {
      try {
        const payload = buildClosurePayload();
        const response = await fetch(env.endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            id: `sales_invoice_add_json '${payload}'`
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        showFeedbackModal({
          title: translations[activeLang].toastSuccessTitle,
          body: translations[activeLang].toastSuccessBody,
          isError: false
        });
        elements.closureStatus.classList.remove('danger');
        elements.closureStatus.classList.add('success');
        elements.closureStatus.querySelector('[data-i18n="statusReady"]').textContent = translations[activeLang].toastSuccessTitle;
      } catch (error) {
        console.error(error);
        showFeedbackModal({
          title: translations[activeLang].toastErrorTitle,
          body: `${translations[activeLang].toastErrorBody}\n(${error.message})`,
          isError: true
        });
        elements.closureStatus.classList.add('danger');
      }
    }

    function buildClosurePayload() {
      const base = {
        businessDate: elements.filterDate.value || sampleData.businessDate,
        terminal: elements.filterTerminal.value === 'All' ? null : elements.filterTerminal.value,
        orders: filteredOrders
      };
      return JSON.stringify(base);
    }

    function resetWorkspace() {
      elements.closureStatus.classList.add('warning');
      elements.closureStatus.classList.remove('success', 'danger');
      elements.closureStatus.querySelector('[data-i18n="statusReady"]').textContent = activeLang === 'ar'
        ? 'يتم الآن إعادة التهيئة'
        : 'Resetting workspace...';
      setTimeout(() => {
        elements.closureStatus.classList.remove('warning');
        elements.closureStatus.classList.add('success');
        elements.closureStatus.querySelector('[data-i18n="statusReady"]').textContent = translations[activeLang].statusReady;
      }, 1600);
    }

    function bindActions() {
      elements.confirmClosure.addEventListener('click', showConfirmModal);
      elements.cancelConfirm.addEventListener('click', () => closeModal(elements.confirmModal));
      elements.confirmSend.addEventListener('click', async () => {
        elements.confirmSend.disabled = true;
        elements.confirmSend.textContent = activeLang === 'ar' ? 'جاري الإرسال...' : 'Sending...';
        await sendClosure();
        elements.confirmSend.disabled = false;
        elements.confirmSend.textContent = translations[activeLang].confirmSend;
        closeModal(elements.confirmModal);
      });
      elements.feedbackClose.addEventListener('click', () => closeModal(elements.feedbackModal));
      elements.resetWorkspace.addEventListener('click', () => {
        if (confirm(activeLang === 'ar' ? 'سيتم حذف بيانات اليوم الحية، هل أنت متأكد؟' : 'Live data for today will be removed. Are you sure?')) {
          resetWorkspace();
        }
      });
      elements.closeModal.addEventListener('click', () => closeModal(elements.modal));
      elements.modalCloseButton.addEventListener('click', () => closeModal(elements.modal));
      elements.modal.addEventListener('click', (event) => {
        if (event.target === elements.modal) {
          closeModal(elements.modal);
        }
      });
      elements.confirmModal.addEventListener('click', (event) => {
        if (event.target === elements.confirmModal) {
          closeModal(elements.confirmModal);
        }
      });
      elements.feedbackModal.addEventListener('click', (event) => {
        if (event.target === elements.feedbackModal) {
          closeModal(elements.feedbackModal);
        }
      });
    }

    function init() {
      hydrateTerminalFilter();
      hydrateDateFilter();
      bindLanguageSwitcher();
      bindThemeToggle();
      bindFilters();
      bindActions();
      setLanguage(activeLang);
      renderOrders();
    }

    init();
  </script>
</body>
</html>
