# تعليمات للوكيل الذكي لمشروع «مشكاة»

هذه الملاحظات موجهة لنفسي (الوكيل) بعد إعادة قراءة ملفات النواة `mishkah.core.js`, ووحدة الأدوات `mishkah-utils.js`, والواجهة المرجعية في `index.html` بصيغتها الحالية. الهدف هو تلخيص فلسفة المكتبة وترتيب أسلوب التطوير الذي يظهر جليًا في `index.html` حتى ألتزم به في أي مهام لاحقة.

## فلسفة مشكاة
- **DSL أولاً**: بناء كل واجهة يتم عبر `M.DSL` وطبقة المكوّنات المعلبة في `M.UI`. لا نكتب DOM خام أو نستعمل `document.querySelector` مباشرة إلا إذا استنفدنا خيارات الـDSL.
- **الجسد / الإيمان / العمل**: نُحافظ على الفصل بين:
  - *الجسد*: التصريح عن الواجهة عبر دوال المكوّنات التي تُعيد عناصر DSL.
  - *الإيمان (state)*: كائن `db` الذي يحمل `env`, `i18n`, و`data`.
  - *العمل (orders)*: الأوامر المعرّفة داخل `app.setOrders` التي تعدّل الحالة أو تتفاعل مع العالم الخارجي.
- **بيئة مترجمة دائمًا**: أي نص أو وسم يُعرض للمستخدم يجب أن يمر عبر `makeLangLookup` (أو أدوات i18n المماثلة). نهتم بثنائية اللغة والاتجاه، ونستند إلى `db.env.lang` و`db.env.dir` لتنسيق المخرجات.
- **مفاتيح gkey**: التفاعل يُدار بالكامل من خلال `attrs.gkey`، مع تسمية هرمية واضحة (`feature:action`). لا نستخدم مستمعي DOM يدويين.
- **الاعتماد على الأدوات**: نعيد استخدام أدوات `M.utils` (خصوصًا `twcss`, `lang`, `UDM`, ووحدات `Control`, `Time`, `Array`). نتجنب كتابة بدائل مكررة.

## قالب كتابة الملفات (مستخلص من index.html)
- **الهيكل العام**: نهيئ المتغيرات المرجعية `const M = Mishkah`, `U = M.utils`, `UI = M.UI`, `D = M.DSL`. بعدها نستخلص الأدوات المكررة (`const { tw } = U.twcss`, `const { makeLangLookup } = U.lang`).
- **كتل التعليقات**: نقسم الملف إلى مقاطع رئيسية باستخدام تعليقات من نمط `/* ===================== Section ===================== */` لتوضيح الغرض (i18n، بيانات، مكونات، أوامر...).
- **القواميس والنصوص**: نعرّف القواميس ثنائية اللغة والبيانات الثابتة أعلى الملف في كائنات/مصفوفات واضحة. نستخدم `makeLangLookup(db).TL` أو تدمج التفكيك (`const { TL } = makeLangLookup(db);`).
- **المكوّنات**: كل مقطع واجهة يُعرّف بدالة `Component(db)` تُعيد عناصر `UI.*` أو `D.*`. نحافظ على الدوال قصيرة، ونفكك الأجزاء الكبيرة إلى دوال فرعية تساعد في القراءة (كما في `HeaderBar`, `Sidebar`, `GamePanel`).
- **التنسيق**: نعتمد على `tw` لتجميع أصناف Tailwind. لا نكتب سلاسل CSS مباشرة إلا للضرورة القصوى (مثل عرض ثابت أو `style` مطلوب).
- **إعادة استخدام UI**: نستغل مكوّنات `UI.Card`, `UI.Toolbar`, `UI.Button`, `UI.Input`, `UI.Select`, ... إلخ. عند الحاجة لعناصر HTML خام نستعمل مقابلاتها في `D.Containers` و`D.Text`.

## العمل مع التطبيق
- **تهيئة الرأس والجسم**: نستخدم `Mishkah.app.setBody` لضبط الهيكل العام، ونقوم بتحديث `db.head` داخل الدالة قبل الإرجاع لضمان تزامن العنوان مع `ctx.rebuild`.
- **twcss.auto**: نشغل `U.twcss.auto(database, app)` مباشرة بعد إنشاء التطبيق لنستفيد من أوامر تبديل اللغة/الوضع الافتراضية وحقن التوكنات.
- **الأوامر**:
  - نكتب كل أمر داخل كائن `orders` مستخدمين `ctx.getState()` و`ctx.setState()` بدل تعديل الكائن مباشرة.
  - ننظّم المستمعات حسب المجال (`route:*`, `counter:*`, `game:*`...).
  - أي تايمر أو تأثير جانبي يُزال أو يُنظف داخل نفس الأمر (`clearInterval` عند الفوز/الخسارة مثلاً).
  - بعد بناء كائن الأوامر الخاص بنا، ندمجه مع `UI.orders` وأوامر `twcss.auto` عبر `app.setOrders({ ...orders, ...UI.orders, ...twx.orders });`.
- **التركيب والتهيئة**: ننهي بتشغيل `app.mount('#app');`. أي تجهيز إضافي (مثل إدخال بيانات أولية) يتم قبل `mount` أو داخل أمر خاص.

## ملاحظات عامة
- لا نضيف ملفات جديدة في هذا الجذر إلا إذا كانت ضرورية، وعندها يجب أن تحترم هذه المبادئ أو أي `AGENTS.md` أعمق.
- نهتم بتجربة المستخدم العربية والإنجليزية: كل نصوص الأزرار، الرسائل، والتعليقات يجب أن تكون ثنائية اللغة أو قابلة للتدويل.
- نسمّي الحقول بناءً على السياق: `db.data.*` للبيانات، `db.ui.*` لحالة الواجهة، `orders.*` لتدفق الأوامر، و`env` لما يتعلق بالثيم أو اللغة.

باتباع هذه النقاط، أضمن الالتزام بروح «مشكاة» كما يوضحها `index.html` الحالي، مما يُسهّل التطوير لاحقًا ويحافظ على تجربة متسقة.
