<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <title>مشكاة — تبويبات + لعبة الأمثال</title>

  <script src="./mishkah-utils.js"></script>
  <script src="./mishkah.core.js"></script>
  <script src="./mishkah-ui.js"></script>
  <script src="./readme.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      color-scheme: light dark;
      --page-gradient: linear-gradient(160deg, #f8f9ff 0%, #e8ecff 100%);
      --page-overlay-1: radial-gradient(circle at 20% 25%, rgba(79, 70, 229, 0.18), transparent 55%);
      --page-overlay-2: radial-gradient(circle at 80% 70%, rgba(14, 165, 233, 0.18), transparent 50%);
      --panel-glass: rgba(255, 255, 255, 0.78);
      --panel-border: rgba(99, 102, 241, 0.12);
      --panel-shadow: 0 25px 50px -20px rgba(15, 23, 42, 0.18);
      --tile-bg: linear-gradient(160deg, rgba(255, 255, 255, 0.95), rgba(241, 245, 249, 0.85));
      --tile-bg-revealed: linear-gradient(160deg, rgba(129, 140, 248, 0.75), rgba(79, 70, 229, 0.65));
      --tile-border: rgba(99, 102, 241, 0.25);
      --letters-shadow: 0 18px 45px -24px rgba(15, 23, 42, 0.35);
      --letters-hover: 0 25px 50px -20px rgba(99, 102, 241, 0.45);
      --accent-ring: rgba(79, 70, 229, 0.18);
      --tile-size: 3.1rem;
      --user-font-scale: 100;
      --font-size-body: 1rem;
      --font-size-scale-xs: 0.78rem;
      --font-size-scale-sm: 0.9rem;
      --font-size-scale-md: 1rem;
      --font-size-scale-lg: 1.18rem;
      --font-size-scale-xl: 1.38rem;
      --font-size-scale-2xl: 1.8rem;
      --font-size-scale-3xl: 2.35rem;
      --font-size-heading-1: 2.6rem;
      --font-size-heading-2: 2.05rem;
      --font-size-heading-3: 1.62rem;
      --font-size-sidebar: 1.05rem;
      --font-size-quote: 1.18rem;
      --font-size-info: 1.22rem;
      --font-size-letter: 1.35rem;
      --font-size-status: 1.22rem;
      --font-size-badge: 0.82rem;
    }

    :root.dark {
      --page-gradient: linear-gradient(160deg, #0d1224 0%, #111c3d 100%);
      --page-overlay-1: radial-gradient(circle at 80% 30%, rgba(168, 85, 247, 0.22), transparent 55%);
      --page-overlay-2: radial-gradient(circle at 15% 80%, rgba(56, 189, 248, 0.18), transparent 55%);
      --panel-glass: rgba(17, 25, 40, 0.75);
      --panel-border: rgba(148, 163, 184, 0.32);
      --panel-shadow: 0 25px 50px -18px rgba(15, 23, 42, 0.55);
      --tile-bg: linear-gradient(160deg, rgba(30, 41, 59, 0.78), rgba(15, 23, 42, 0.92));
      --tile-bg-revealed: linear-gradient(160deg, rgba(99, 102, 241, 0.55), rgba(79, 70, 229, 0.38));
      --tile-border: rgba(148, 163, 184, 0.35);
      --letters-shadow: 0 20px 40px -18px rgba(148, 163, 184, 0.35);
      --letters-hover: 0 28px 60px -20px rgba(99, 102, 241, 0.6);
      --accent-ring: rgba(129, 140, 248, 0.35);
    }

    @media (min-width: 640px) {
      :root { --tile-size: 3.25rem; }
    }

    @media (min-width: 1024px) {
      :root { --tile-size: 3.4rem; }
    }

    * {
      box-sizing: border-box;
    }

    .text-xs { font-size: calc(var(--font-size-scale-xs) * var(--user-font-scale) / 100) !important; }
    .text-xxs { font-size: calc(var(--font-size-scale-xs) * 0.9 * var(--user-font-scale) / 100) !important; }
    .text-sm { font-size: calc(var(--font-size-scale-sm) * var(--user-font-scale) / 100) !important; }
    .text-base { font-size: calc(var(--font-size-scale-md) * var(--user-font-scale) / 100) !important; }
    .text-lg { font-size: calc(var(--font-size-scale-lg) * var(--user-font-scale) / 100) !important; }
    .text-xl { font-size: calc(var(--font-size-scale-xl) * var(--user-font-scale) / 100) !important; }
    .text-2xl { font-size: calc(var(--font-size-scale-2xl) * var(--user-font-scale) / 100) !important; }
    .text-3xl { font-size: calc(var(--font-size-scale-3xl) * var(--user-font-scale) / 100) !important; }

    .sidebar-nav-button {
      font-size: calc(var(--font-size-sidebar) * var(--user-font-scale) / 100) !important;
      font-weight: 600;
    }

    .header-status-strip {
      display: inline-flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.75rem;
      padding: 0.5rem 1.1rem;
      border-radius: 999px;
      background: color-mix(in oklab, var(--surface-2) 75%, transparent);
      border: 1px solid color-mix(in oklab, var(--border) 55%, transparent);
      box-shadow: 0 18px 40px -28px rgba(79, 70, 229, 0.45);
    }

    .header-status-block {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .header-status-label {
      color: var(--muted-foreground);
      font-size: calc(var(--font-size-scale-sm) * var(--user-font-scale) / 100);
    }

    .header-status-value {
      font-size: calc(var(--font-size-status) * var(--user-font-scale) / 100);
      font-weight: 700;
      color: var(--foreground);
    }

    .header-status-hearts {
      font-size: calc(var(--font-size-status) * var(--user-font-scale) / 100);
      display: inline-flex;
      gap: 0.25rem;
    }

    .segmented-switch {
      display: inline-flex;
      align-items: center;
      position: relative;
      padding: 0.25rem;
      gap: 0.25rem;
      border-radius: 999px;
      border: 1px solid color-mix(in oklab, var(--border) 60%, transparent);
      background: color-mix(in oklab, var(--surface-1) 85%, transparent);
      box-shadow: 0 14px 32px -24px rgba(15, 23, 42, 0.4);
    }

    .segmented-switch__option {
      position: relative;
      border: none;
      background: transparent;
      color: var(--muted-foreground);
      padding: 0.35rem 0.95rem;
      border-radius: 999px;
      cursor: pointer;
      transition: color 0.25s ease;
      font-size: calc(var(--font-size-scale-sm) * var(--user-font-scale) / 100);
      font-weight: 600;
      min-width: 3.6rem;
    }

    .segmented-switch__option::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: transparent;
      opacity: 0;
      transition: opacity 0.25s ease, transform 0.25s ease;
      z-index: -1;
    }

    .segmented-switch__option.is-active {
      color: var(--primary-foreground);
    }

    .segmented-switch__option.is-active::before {
      background: var(--primary);
      opacity: 1;
      transform: scale(1.02);
      box-shadow: 0 18px 38px -22px rgba(79, 70, 229, 0.55);
    }

    .segmented-switch__option:focus-visible {
      outline: 2px solid var(--accent-ring);
      outline-offset: 2px;
    }

    .design-lab-grid {
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
    }

    .design-lab-row {
      display: grid;
      gap: 0.6rem;
      align-items: center;
      padding: 0.6rem 0.85rem;
      border-radius: 1.1rem;
      border: 1px solid color-mix(in oklab, var(--border) 55%, transparent);
      background: color-mix(in oklab, var(--surface-2) 74%, transparent);
      box-shadow: 0 14px 32px -26px rgba(15, 23, 42, 0.35);
    }

    .design-lab-row[data-type='color'] {
      grid-template-columns: minmax(0, 200px) 72px minmax(0, 180px) minmax(0, 1fr) auto;
    }

    .design-lab-row[data-type='range'] {
      grid-template-columns: minmax(0, 220px) minmax(0, 140px) minmax(0, 1fr) minmax(0, 110px) auto;
    }

    .design-lab-row[data-type='text'] {
      grid-template-columns: minmax(0, 220px) minmax(0, 1fr) auto;
    }

    .design-lab-label {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
      font-size: calc(var(--font-size-scale-sm) * var(--user-font-scale) / 100);
      color: var(--muted-foreground);
    }

    .design-lab-label strong {
      color: var(--foreground);
      font-size: calc(var(--font-size-scale-md) * var(--user-font-scale) / 100);
    }

    .design-lab-meta {
      font-size: calc(var(--font-size-scale-xs) * var(--user-font-scale) / 100);
      color: color-mix(in oklab, var(--muted-foreground) 80%, transparent);
    }

    .design-lab-color-chip {
      width: 48px;
      height: 48px;
      border-radius: 0.9rem;
      border: 1px solid color-mix(in oklab, var(--border) 65%, transparent);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.2);
    }

    .design-lab-color-input {
      width: 100%;
      height: 2.6rem;
      border-radius: 0.9rem;
      border: 1px solid color-mix(in oklab, var(--border) 55%, transparent);
      background: color-mix(in oklab, var(--surface-1) 85%, transparent);
      cursor: pointer;
    }

    .design-lab-value-input,
    .design-lab-number-input {
      width: 100%;
      border-radius: 0.85rem;
      border: 1px solid color-mix(in oklab, var(--border) 60%, transparent);
      background: color-mix(in oklab, var(--surface-1) 88%, transparent);
      padding: 0.45rem 0.75rem;
      color: var(--foreground);
      font-size: calc(var(--font-size-scale-sm) * var(--user-font-scale) / 100);
    }

    .design-lab-value-input:focus,
    .design-lab-number-input:focus {
      outline: 2px solid var(--accent-ring);
      outline-offset: 2px;
    }

    .design-lab-slider {
      width: 100%;
      accent-color: var(--primary);
      height: 0.4rem;
    }

    .design-lab-font-preview {
      display: inline-flex;
      align-items: center;
      justify-content: flex-start;
      gap: 0.35rem;
      padding: 0.25rem 0.4rem;
      border-radius: 0.75rem;
      background: color-mix(in oklab, var(--surface-1) 80%, transparent);
      color: var(--foreground);
      min-height: 2.2rem;
    }

    .design-lab-reset {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 2.1rem;
      height: 2.1rem;
      border-radius: 999px;
      border: 1px solid transparent;
      background: transparent;
      color: var(--muted-foreground);
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease;
    }

    .design-lab-reset:hover:not([disabled]) {
      background: color-mix(in oklab, var(--primary) 18%, transparent);
      color: var(--primary);
    }

    .design-lab-reset[disabled] {
      opacity: 0.35;
      cursor: not-allowed;
    }

    .game-info-text {
      font-size: calc(var(--font-size-info) * var(--user-font-scale) / 100);
      color: color-mix(in oklab, var(--foreground) 96%, var(--muted-foreground) 4%);
      line-height: 1.9;
      font-weight: 500;
    }

    .focus-pulse {
      box-shadow: 0 0 0 2px color-mix(in oklab, var(--primary) 65%, transparent), 0 0 0 12px rgba(79, 70, 229, 0.18);
      animation: focusPulse 2.2s ease-in-out forwards;
    }

    .glow-outline.focus-pulse {
      box-shadow: 0 0 0 2px color-mix(in oklab, var(--primary) 55%, transparent), 0 0 0 14px rgba(79, 70, 229, 0.18), var(--panel-shadow);
    }

    .solution-target {
      scroll-margin-block-start: 18vh;
      position: relative;
    }

    .solution-target:focus-visible {
      outline: 3px solid color-mix(in oklab, var(--primary) 70%, transparent);
      outline-offset: 4px;
    }

    .solution-target.glow-outline {
      box-shadow: 0 0 0 2px color-mix(in oklab, var(--primary) 65%, transparent),
        0 0 0 16px rgba(79, 70, 229, 0.16),
        var(--panel-shadow);
    }

    .sweet-notice-overlay {
      position: fixed;
      inset: 0;
      z-index: 70;
      display: grid;
      place-items: center;
      padding: 2rem 1.5rem;
    }

    .sweet-notice-overlay::before {
      content: '';
      position: absolute;
      inset: 0;
      background: rgba(6, 12, 24, 0.55);
      backdrop-filter: blur(10px);
    }

    .sweet-notice-overlay > * {
      position: relative;
      z-index: 1;
    }

    .sweet-notice-card {
      width: min(480px, 94vw);
    }

    body {
      margin: 0;
      min-height: 100vh;
      height: 100vh;
      font-family: 'Tajawal', 'Cairo', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-size: calc(var(--font-size-body) * var(--user-font-scale) / 100);
      background: var(--page-gradient);
      color: var(--foreground);
      position: relative;
      overflow: hidden;
      transition: background 0.45s ease, color 0.45s ease;
    }

    body::before,
    body::after {
      content: '';
      position: absolute;
      inset: 0;
      z-index: 0;
      pointer-events: none;
      background: var(--page-overlay-1);
      mix-blend-mode: screen;
      animation: pulseNebula 18s ease-in-out infinite alternate;
    }

    body::after {
      background: var(--page-overlay-2);
      animation-delay: 6s;
    }

    #app {
      position: relative;
      z-index: 1;
    }

    .app-shell {
      min-height: 100vh;
      max-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .content-shell {
      flex: 1;
      min-height: 0;
      display: flex;
      overflow: hidden;
    }

    .main-region {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      padding-bottom: 4rem;
      scroll-behavior: smooth;
    }

    .glass-panel {
      background: var(--panel-glass);
      backdrop-filter: blur(26px) saturate(135%);
      border: 1px solid var(--panel-border);
      box-shadow: var(--panel-shadow);
      transition: border-color 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
    }

    .glow-outline {
      box-shadow: 0 0 0 1px var(--accent-ring), var(--panel-shadow);
    }

    .animate-float {
      animation: floatHalo 14s ease-in-out infinite;
    }

    .letter-tile {
      transition: transform 0.35s ease, box-shadow 0.35s ease, background 0.35s ease;
      border: 1px solid var(--tile-border);
      background: var(--tile-bg);
      color: var(--foreground);
      text-shadow: 0 2px 12px rgba(15, 23, 42, 0.2);
    }

    .letter-slot {
      width: var(--tile-size);
      height: var(--tile-size);
    }

    .letter-space {
      width: calc(var(--tile-size) * 0.5);
      height: var(--tile-size);
    }

    .letter-tile[data-revealed="true"] {
      transform: translateY(-6px) scale(1.03);
      box-shadow: 0 18px 40px -22px rgba(79, 70, 229, 0.55);
      background: var(--tile-bg-revealed);
      color: #fff;
    }

    .letters-grid button {
      transition: transform 0.25s ease, box-shadow 0.25s ease, opacity 0.25s ease;
      box-shadow: var(--letters-shadow);
      font-size: calc(var(--font-size-letter) * var(--user-font-scale) / 100);
      font-weight: 700;
      border-radius: 0.9rem !important;
      height: var(--tile-size);
      min-height: var(--tile-size);
      min-width: var(--tile-size);
    }

    .letters-grid button:hover:not([disabled]) {
      transform: translateY(-5px) scale(1.03);
      box-shadow: var(--letters-hover);
    }

    .letters-grid button[disabled] {
      opacity: 0.35;
      cursor: not-allowed;
    }

    .md-prose {
      line-height: 1.8;
      font-size: calc(var(--font-size-scale-md) * var(--user-font-scale) / 100);
      color: var(--foreground);
    }

    .md-prose h1,
    .md-prose h2,
    .md-prose h3,
    .md-prose h4,
    .md-prose h5,
    .md-prose h6 {
      font-family: 'Cairo', 'Tajawal', system-ui, sans-serif;
      font-weight: 700;
      letter-spacing: 0.01em;
      color: color-mix(in oklab, var(--foreground) 92%, var(--primary) 8%);
      margin: 1.6em 0 0.8em;
    }

    .md-prose h1 {
      font-size: calc(var(--font-size-heading-1) * var(--user-font-scale) / 100);
    }

    .md-prose h2 {
      font-size: calc(var(--font-size-heading-2) * var(--user-font-scale) / 100);
    }

    .md-prose h3 {
      font-size: calc(var(--font-size-heading-3) * var(--user-font-scale) / 100);
    }

    .md-prose p {
      margin: 1em 0;
      color: color-mix(in oklab, var(--foreground) 88%, var(--muted-foreground) 12%);
      font-size: calc(var(--font-size-scale-md) * var(--user-font-scale) / 100);
    }

    .md-prose ul,
    .md-prose ol {
      margin: 1em 0;
      padding-inline-start: 1.4em;
      display: flex;
      flex-direction: column;
      gap: 0.5em;
    }

    .md-prose li {
      position: relative;
      padding-inline-start: 0.3em;
    }

    .md-prose blockquote {
      margin: 1.2em 0;
      padding: 1.2em 1.5em;
      border-inline-start: 4px solid color-mix(in oklab, var(--primary) 80%, transparent);
      background: color-mix(in oklab, var(--surface-1) 80%, transparent);
      border-radius: 1.2rem;
      color: color-mix(in oklab, var(--foreground) 80%, var(--muted-foreground) 20%);
      box-shadow: 0 12px 30px -24px rgba(79, 70, 229, 0.45);
      font-size: calc(var(--font-size-quote) * var(--user-font-scale) / 100);
    }

    .md-prose pre {
      margin: 1.4em 0;
      padding: 1.2em 1.4em;
      border-radius: 1.2rem;
      background: color-mix(in oklab, var(--surface-2) 88%, transparent);
      box-shadow: 0 24px 45px -24px rgba(15, 23, 42, 0.45);
      overflow-x: auto;
      font-size: calc(var(--font-size-scale-sm) * var(--user-font-scale) / 100);
      direction: ltr;
      text-align: left;
    }

    .md-prose code {
      font-family: 'Fira Code', 'IBM Plex Mono', 'Cascadia Code', monospace;
      background: color-mix(in oklab, var(--surface-2) 85%, transparent);
      padding: 0.15em 0.4em;
      border-radius: 0.5em;
      font-size: calc(var(--font-size-scale-sm) * var(--user-font-scale) / 100);
    }

    .md-prose pre code {
      background: transparent;
      padding: 0;
    }

    .md-prose table {
      width: 100%;
      border-collapse: collapse;
      margin: 1.5em 0;
      border-radius: 1.2rem;
      overflow: hidden;
      box-shadow: 0 18px 45px -25px rgba(15, 23, 42, 0.35);
    }

    .md-prose thead {
      background: color-mix(in oklab, var(--surface-2) 55%, var(--primary) 45%);
      color: color-mix(in oklab, var(--primary-foreground) 65%, var(--foreground) 35%);
    }

    .md-prose th,
    .md-prose td {
      padding: 0.85em 1em;
      border: 1px solid color-mix(in oklab, var(--border) 60%, transparent);
      text-align: start;
    }

    .md-prose tbody tr:nth-child(even) {
      background: color-mix(in oklab, var(--surface-1) 80%, transparent);
    }

    .md-prose img {
      max-width: 100%;
      height: auto;
      display: inline-block;
      vertical-align: middle;
    }

    .settings-tile {
      border-radius: 1.5rem;
      padding: 1rem 1.25rem;
      background: color-mix(in oklab, var(--surface-2) 70%, transparent);
      border: 1px solid color-mix(in oklab, var(--border) 55%, transparent);
      box-shadow: 0 12px 35px -22px rgba(15, 23, 42, 0.35);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.75rem;
    }

    .toggle-switch {
      position: relative;
      width: 3.25rem;
      height: 1.65rem;
    }

    .toggle-switch input {
      appearance: none;
      -webkit-appearance: none;
      width: 100%;
      height: 100%;
      border-radius: 999px;
      background: color-mix(in oklab, var(--surface-2) 88%, transparent);
      border: 1px solid color-mix(in oklab, var(--border) 65%, transparent);
      position: relative;
      cursor: pointer;
      transition: background 0.25s ease, border-color 0.25s ease;
    }

    .toggle-switch input::after {
      content: '';
      position: absolute;
      inset-inline-start: 0.2rem;
      top: 0.18rem;
      width: 1.25rem;
      height: 1.25rem;
      border-radius: 50%;
      background: color-mix(in oklab, var(--muted-foreground) 30%, white 70%);
      box-shadow: 0 10px 18px -10px rgba(15, 23, 42, 0.35);
      transition: transform 0.25s ease, background 0.25s ease;
    }

    .toggle-switch input:checked {
      background: color-mix(in oklab, var(--primary) 30%, transparent);
      border-color: color-mix(in oklab, var(--primary) 70%, transparent);
    }

    .toggle-switch input:checked::after {
      transform: translateX(1.55rem);
      background: var(--primary);
    }

    .game-panel {
      position: relative;
    }

    .game-board {
      position: relative;
      transition: transform 0.35s ease;
    }

    .puzzle-row {
      animation-duration: 0.6s;
      animation-timing-function: ease-in-out;
    }

    .game-board.feedback-correct .puzzle-row {
      animation-name: tilePop;
    }

    .game-board.feedback-wrong .puzzle-row {
      animation-name: tileShake;
    }

    .game-board.feedback-win .puzzle-row {
      animation-name: tileCelebrate;
    }

    .game-board.feedback-lose .puzzle-row {
      animation-name: tileFade;
    }

    .celebration-card,
    .gameover-card {
      position: relative;
      overflow: hidden;
    }

    .celebration-card::after {
      content: '';
      position: absolute;
      inset: -40%;
      background: radial-gradient(circle at 50% 20%, rgba(79, 70, 229, 0.25), transparent 55%);
      opacity: 0.8;
      animation: pulseNebula 8s ease-in-out infinite;
      pointer-events: none;
    }

    .gameover-card::after {
      content: '';
      position: absolute;
      inset: -30%;
      background: radial-gradient(circle at 50% 80%, rgba(239, 68, 68, 0.25), transparent 65%);
      opacity: 0.7;
      animation: overlayPulse 6s ease-in-out infinite;
      pointer-events: none;
    }

    .game-overlay-content {
      position: relative;
      z-index: 1;
    }

    .confetti-layer {
      position: fixed;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      z-index: 25;
    }

    .confetti-piece {
      position: absolute;
      top: -10vh;
      width: 0.55rem;
      height: 1.6rem;
      border-radius: 999px;
      opacity: 0;
      animation: confettiFall 3.6s ease-in forwards;
    }

    .confetti-piece:nth-child(odd) {
      animation-duration: 4s;
    }

    .md-prose a {
      color: var(--primary);
      text-decoration: none;
      border-bottom: 1px solid color-mix(in oklab, var(--primary) 65%, transparent);
      transition: color 0.2s ease, border-color 0.2s ease;
    }

    .md-prose a:hover {
      color: color-mix(in oklab, var(--primary) 90%, black);
      border-color: currentColor;
    }

    .md-prose hr {
      margin: 2.5em 0;
      border: none;
      border-top: 1px dashed color-mix(in oklab, var(--border) 65%, transparent);
    }

    @keyframes floatHalo {
      0%, 100% { transform: translate3d(0, 0, 0); }
      50% { transform: translate3d(0, -18px, 0) scale(1.01); }
    }

    @keyframes pulseNebula {
      0% { opacity: 0.45; }
      50% { opacity: 0.75; }
      100% { opacity: 0.45; }
    }

    @keyframes tilePop {
      0% { transform: scale(0.94); }
      40% { transform: scale(1.06); }
      100% { transform: scale(1); }
    }

    @keyframes tileShake {
      0%, 100% { transform: translateX(0); }
      20% { transform: translateX(-8px); }
      40% { transform: translateX(8px); }
      60% { transform: translateX(-6px); }
      80% { transform: translateX(6px); }
    }

    @keyframes tileCelebrate {
      0% { transform: translateY(0) scale(1); }
      30% { transform: translateY(-10px) scale(1.05); }
      70% { transform: translateY(4px) scale(0.98); }
      100% { transform: translateY(0) scale(1); }
    }

    @keyframes tileFade {
      0% { opacity: 1; }
      100% { opacity: 0.6; }
    }

    @keyframes overlayPulse {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 0.6; }
    }

    @keyframes focusPulse {
      0% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.0); }
      40% { box-shadow: 0 0 0 18px rgba(79, 70, 229, 0.18); }
      70% { box-shadow: 0 0 0 6px rgba(79, 70, 229, 0.22); }
      100% { box-shadow: 0 0 0 12px rgba(79, 70, 229, 0.0); }
    }

    @keyframes confettiFall {
      0% { opacity: 0; transform: translate3d(0, -20vh, 0) rotate(0deg); }
      10% { opacity: 1; }
      100% { opacity: 0; transform: translate3d(0, 110vh, 0) rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
  (function(){
    const M = Mishkah, U = M.utils, UI = M.UI, D = M.DSL;
    const { tw } = U.twcss;
    const { makeLangLookup } = U.lang;

    /*
    ================================================================
    |                                                              |
    |      بسم الله الرحمن الرحيم: رحلة الخلق في "مشكاة"             |
    |                                                              |
    ================================================================
    |
    | إن بناء هذا التطبيق ليس مجرد كتابة كود، بل هو محاكاة لرحلة
    | الخلق والتكوين كما تصفها فلسفة "مشكاة". سنمر بمرحلتين
    | أساسيتين، كل مرحلة تتكون من زوجين:
    |
    | 1. الزوج الأول: التصميم والتسوية (تخطيط الجسد)
    |    - الركن الأول: الطين والذرات (Atoms as Components)
    |    - الركن الثاني: العلم الفطري (database as DNA)
    |    النتيجة: جسد مُصوَّر (VDOM) قبل نفخ الروح.
    |
    | 2. الزوج الثاني: التمكين والتكليف (نفخ الروح والحياة)
    |    - الركن الأول: الإيمان (database as State)
    |    - الركن الثاني: العمل الصالح (Orders)
    |    النتيجة: كائن حي متكامل يتفاعل ويستجيب.
    |
    */

    // ================================================================
    // المرحلة التمهيدية: جمع المادة الخام للمعرفة
    // قبل الخلق، نجمع كل المواد الأولية: النصوص، البيانات، والقواعد.
    // ================================================================

    /* ===================== i18n: المعاجم اللغوية ===================== */
    const dict = {
      'app.title'   : { ar:'مشكاة — مشكاة النور ولعبة الأمثال', en:'Mishkah — Lighthouse Docs & Proverbs Game' },
      'header.subtitle': { ar:'مرجع النور يجمع الوثائق، الإعدادات، ولعبة الأمثال في لوحة واحدة واسعة.', en:'A radiant hub that unifies the docs, controls, and the Proverbs game in a spacious canvas.' },
      'header.theme.light': { ar:'نهار', en:'Light' },
      'header.theme.dark': { ar:'ليل', en:'Dark' },
      'header.lang.ar': { ar:'العربية', en:'Arabic' },
      'header.lang.en': { ar:'الإنجليزية', en:'English' },
      'settings.toggleLabel': { ar:'إظهار الإعدادات', en:'Show controls' },
      'settings.switch.on': { ar:'مفعّلة', en:'Visible' },
      'settings.switch.off': { ar:'مخفية', en:'Hidden' },
      'settings.title': { ar:'لوحة الإعدادات الذكية', en:'Intelligent Control Center' },
      'settings.description': { ar:'اضبط تجربة اللعبة والثيم واحتفظ بتفضيلاتك على نفس الجهاز.', en:'Tune the game experience and theming, and keep your preferences on this device.' },
      'settings.gameSection': { ar:'إعدادات اللعبة', en:'Game Settings' },
      'settings.themeSection': { ar:'خيارات الثيم', en:'Theme Options' },
      'settings.backgroundLabel': { ar:'خلفية الصفحة', en:'Page background' },
      'settings.textLabel': { ar:'ألوان النص والعناصر', en:'Text & accent colors' },
      'settings.fontLabel': { ar:'حجم الخط', en:'Font size' },
      'settings.previewLabel': { ar:'معاينة فورية', en:'Live preview' },
      'settings.previewHint': { ar:'ستتحدث التغييرات لحظيًا وتحفظ في المتصفح.', en:'Changes update instantly and are stored in the browser.' },
      'settings.reset': { ar:'إعادة الإعدادات الافتراضية', en:'Reset to defaults' },
      'settings.close': { ar:'إغلاق', en:'Close' },
      'designLab.openButton': { ar:'مختبر الألوان', en:'Design Lab' },
      'designLab.title': { ar:'مختبر تنسيق الواجهة', en:'Interface Design Lab' },
      'designLab.subtitle': { ar:'تحكم بجميع متغيرات CSS من الألوان والأحجام مع معاينة فورية.', en:'Control every CSS variable—from colors to sizes—with live preview.' },
      'designLab.themeTitle': { ar:'أوضاع الثيم السريعة', en:'Quick Theme Modes' },
      'designLab.mode.light': { ar:'وضع مضيء', en:'Light Glow' },
      'designLab.mode.dark': { ar:'وضع ليلي', en:'Nightfall' },
      'designLab.mode.pink': { ar:'وضع وردي', en:'Pink Aurora' },
      'designLab.modeHint': { ar:'اختر وضعًا ثم خصص التفاصيل أدناه.', en:'Pick a mode, then fine-tune every detail below.' },
      'designLab.resetAll': { ar:'إعادة جميع المتغيرات', en:'Reset All Variables' },
      'designLab.resetVar': { ar:'إرجاع الافتراضي', en:'Revert Default' },
      'designLab.currentValue': { ar:'القيمة الحالية', en:'Current value' },
      'designLab.defaultValue': { ar:'القيمة الافتراضية', en:'Default value' },
      'designLab.group.core': { ar:'ألوان جوهرية', en:'Core Colors' },
      'designLab.group.coreHint': { ar:'اضبط ألوان النص والعناصر البارزة.', en:'Tweak the primary text and accent colors.' },
      'designLab.group.surface': { ar:'خلفيات وطبقات', en:'Backgrounds & Layers' },
      'designLab.group.surfaceHint': { ar:'خصص الخلفيات والطبقات الزجاجية والحدود.', en:'Customize page backdrops, glass layers, and borders.' },
      'designLab.group.effects': { ar:'تأثيرات بصرية', en:'Visual Effects' },
      'designLab.group.effectsHint': { ar:'تحكم بالظلال والتوهجات أثناء اللعب.', en:'Control shadows and glows used across the game.' },
      'designLab.group.typography': { ar:'منظومة الخطوط', en:'Typography System' },
      'designLab.group.typographyHint': { ar:'خصص أحجام العناوين والنصوص الدقيقة لكل جزء.', en:'Tune heading and text sizes for every surface.' },
      'designLab.group.sizing': { ar:'أحجام العناصر', en:'Element Sizing' },
      'designLab.group.sizingHint': { ar:'ضبط أحجام البلاطات ونسبة الخط.', en:'Adjust tile sizes and the global font scale.' },
      'designLab.var.foreground': { ar:'لون النص الأساسي', en:'Primary text color' },
      'designLab.var.muted': { ar:'لون النص الثانوي', en:'Muted text color' },
      'designLab.var.primary': { ar:'لون التمييز الرئيسي', en:'Primary accent color' },
      'designLab.var.primaryForeground': { ar:'لون النص فوق التمييز', en:'Text on primary' },
      'designLab.var.accentRing': { ar:'وهج الحواف', en:'Accent ring glow' },
      'designLab.var.gradient': { ar:'تدرج خلفية الصفحة', en:'Page gradient' },
      'designLab.var.overlay1': { ar:'طبقة ضوئية أولى', en:'First light overlay' },
      'designLab.var.overlay2': { ar:'طبقة ضوئية ثانية', en:'Second light overlay' },
      'designLab.var.panelGlass': { ar:'لون اللوح الزجاجي', en:'Glass panel tint' },
      'designLab.var.panelBorder': { ar:'لون حدود اللوح', en:'Panel border color' },
      'designLab.var.tileBg': { ar:'خلفية البلاطات', en:'Tile background' },
      'designLab.var.tileRevealed': { ar:'خلفية البلاطات المكشوفة', en:'Revealed tile background' },
      'designLab.var.tileBorder': { ar:'حدود البلاطات', en:'Tile border color' },
      'designLab.var.lettersShadow': { ar:'ظل أزرار الحروف', en:'Letter buttons shadow' },
      'designLab.var.lettersHover': { ar:'تأثير التحويم للحروف', en:'Letter hover effect' },
      'designLab.var.tileSize': { ar:'حجم البلاطات', en:'Tile size' },
      'designLab.var.font.body': { ar:'نص الفقرات', en:'Body text size' },
      'designLab.var.font.h1': { ar:'عنوان ١', en:'Heading 1 size' },
      'designLab.var.font.h2': { ar:'عنوان ٢', en:'Heading 2 size' },
      'designLab.var.font.h3': { ar:'عنوان ٣', en:'Heading 3 size' },
      'designLab.var.font.scale3xl': { ar:'عنوان عرضي (3XL)', en:'Display heading (3XL)' },
      'designLab.var.font.scale2xl': { ar:'عنوان بارز (2XL)', en:'Hero heading (2XL)' },
      'designLab.var.font.scaleXl': { ar:'عنوان فرعي (XL)', en:'Sub heading (XL)' },
      'designLab.var.font.scaleLg': { ar:'نص كبير (LG)', en:'Large text (LG)' },
      'designLab.var.font.scaleMd': { ar:'نص أساسي (MD)', en:'Body scale (MD)' },
      'designLab.var.font.scaleSm': { ar:'نص صغير (SM)', en:'Small text (SM)' },
      'designLab.var.font.scaleXs': { ar:'تفاصيل دقيقة (XS)', en:'Micro text (XS)' },
      'designLab.var.font.sidebar': { ar:'نص القائمة الجانبية', en:'Sidebar label size' },
      'designLab.var.font.quote': { ar:'نص الاقتباس', en:'Blockquote size' },
      'designLab.var.font.info': { ar:'نص اللوحات التوضيحية', en:'Info panel text size' },
      'designLab.var.font.letter': { ar:'حجم حروف اللعب', en:'Letter button size' },
      'designLab.var.font.status': { ar:'حجم شريط الحالة', en:'Status strip size' },
      'designLab.var.fontScale': { ar:'مقياس الخط العام', en:'Global font scale' },
      'nav.menu'       : { ar:'التنقل', en:'Navigation' },
      'nav.readmeBase' : { ar:'مشكاة النور والذكر الأعلى', en:'Mishkah of Light & Highest Remembrance' },
      'nav.readmeTec'  : { ar:'وثيقة مشكاة التقنية', en:'Mishkah Technical Charter' },
      'nav.counter'    : { ar:'العداد', en:'Counter' },
      'nav.game'       : { ar:'لعبة الأمثال', en:'Proverbs Game' },
      'nav.logic'      : { ar:'تحدي الذكاء', en:'Logic Trainer' },
      'doc.base.lead'  : { ar:'رحلة فلسفة مشكاة ومنهج الذكر الأعلى الذي ألهم تصميمها.', en:'The philosophical journey behind Mishkah and the higher remembrance that inspires it.' },
      'doc.tec.lead'   : { ar:'الدليل التقني الكامل لمعمارية مشكاة ومحركها التعريفي.', en:'The complete technical dossier for Mishkah’s architecture and declarative engine.' },
      'doc.language.hint': { ar:'بدّل اللغة من الأعلى لتقرأ الوثيقة بلغتك المفضلة.', en:'Use the header controls to switch between Arabic and English.' },
      'counter.title'  : { ar:'عداد بسيط', en:'Simple Counter' },
      'counter.reset'  : { ar:'إعادة', en:'Reset' },
      'game.title'     : { ar:'لعبة الأمثال و الحكم', en:'Proverbs & Wisdom Game' },
      'game.music'     : { ar:'الموسيقى الغامرة', en:'Mystery Music' },
      'game.timer'     : { ar:'مؤقت التعلم', en:'Learning Timer' },
      'game.seconds'   : { ar:'ث', en:'s' },
      'game.start'     : { ar:'ابدأ اللعبة', en:'Start Game' },
      'game.new'       : { ar:'مثل جديد', en:'New Proverb' },
      'game.tries'     : { ar:'المحاولات المتبقية', en:'Tries Left' },
      'game.hintTitle' : { ar:'التلميح التعليمي', en:'Educational Hint' },
      'game.win'       : { ar:'ربحت! 🎉', en:'You won! 🎉' },
      'game.lose'      : { ar:'للأسف خسرت 🙈', en:'You lost 🙈' },
      'game.reveal'    : { ar:'اكتشف الحكمة', en:'Reveal Wisdom' },
      'game.solution'  : { ar:'الحل الكامل', en:'Full Solution' },
      'game.explanation':{ ar:'شرح المثل', en:'Explanation' },
      'game.lesson'    : { ar:'ما نتعلمه', en:'Key Lesson' },
      'game.source'    : { ar:'المصدر', en:'Source' },
      'game.timeLabel' : { ar:'الوقت المتبقي', en:'Time Left' },
      'game.letters'   : { ar:'الأحرف المتاحة', en:'Available Letters' },
      'game.statusLabel': { ar:'حالة اللعبة', en:'Game Status' },
      'game.settingsButton': { ar:'إعدادات اللعبة', en:'Game Settings' },
      'game.status.idle': { ar:'جاهزة', en:'Ready' },
      'game.status.running': { ar:'قيد اللعب', en:'In Progress' },
      'game.status.won' : { ar:'انتصار', en:'Victory' },
      'game.status.lost': { ar:'خسارة', en:'Defeat' },
      'game.feedback.correct': { ar:'أحسنت! حرف صحيح يقترب بك من الحكمة.', en:'Great job! A correct letter brings you closer to the wisdom.' },
      'game.feedback.wrong'  : { ar:'هذه المحاولة لم تصب الهدف، جرّب مسارًا آخر.', en:'That guess missed the mark—try another path.' },
      'game.feedback.win'    : { ar:'إبداع! اكتملت الحكمة بالكامل.', en:'Brilliant! The proverb has been unveiled.' },
      'game.feedback.lose'   : { ar:'انتهت المحاولات، لكن الحكمة ما زالت بانتظارك.', en:'The tries are over, yet the wisdom still awaits you.' },
      'logic.title': { ar:'تحدي الذكاء الاستقرائي', en:'Pattern Logic Trainer' },
      'logic.subtitle': { ar:'استكشف المتتاليات الذكية وصقل مهارة اكتشاف النمط.', en:'Explore clever sequences and sharpen your pattern recognition.' },
      'logic.start': { ar:'ابدأ التحدي', en:'Start Challenge' },
      'logic.newChallenge': { ar:'تحدٍ جديد', en:'New Challenge' },
      'logic.sequenceIntro': { ar:'أكمل المتتالية التالية:', en:'Complete the following sequence:' },
      'logic.optionsPrompt': { ar:'اختر الإجابة الصحيحة', en:'Pick the correct answer' },
      'logic.feedback.correct': { ar:'إجابة موفقة! منطقك حاضر.', en:'Great choice! Your reasoning is sharp.' },
      'logic.feedback.wrong': { ar:'ليست الإجابة الصحيحة، جرّب مرة أخرى.', en:'That is not the right answer—try again.' },
      'logic.explanation': { ar:'الشرح', en:'Explanation' },
      'logic.sequence.step': { ar:'تزداد القيم بمقدار {step} في كل خطوة.', en:'Values increase by {step} each step.' },
      'logic.square.hint': { ar:'الأعداد تمثل مربعات متتالية تبدأ من {start}².', en:'The terms are consecutive squares starting from {start}².' },
      'logic.double.hint': { ar:'كل قيمة تساوي ضعف السابقة.', en:'Each value doubles the previous one.' },
      'game.lastMove'        : { ar:'ردة فعل فورية', en:'Instant Feedback' },
      'game.musicOn'         : { ar:'الموسيقى مفعّلة', en:'Music On' },
      'game.musicOff'        : { ar:'الموسيقى متوقفة', en:'Music Off' },
      'game.timerOn'         : { ar:'المؤقت نشط', en:'Timer Enabled' },
      'game.timerOff'        : { ar:'المؤقت متوقف', en:'Timer Disabled' },
      'game.overlay.winTitle'    : { ar:'مبروك! لقد فزت 🎉', en:'Bravo! You Won 🎉' },
      'game.overlay.winSubtitle' : { ar:'رحلة النجاح تزداد جمالاً مع كل حكمة تتعلمها.', en:'Success shines brighter with every lesson you learn.' },
      'game.overlay.loseTitle'   : { ar:'انتهت المحاولات', en:'Game Over' },
      'game.overlay.loseSubtitle': { ar:'يمكنك البدء من جديد متى شئت.', en:'You can always start over when you wish.' },
      'game.overlay.loseInsight' : { ar:'لا تحزن من خسارتك، فلأنك تعلمت حكمة جديدة.', en:'Do not be sad about losing—you just gained new wisdom.' },
      'game.overlay.winInsight'  : { ar:'مبروك لقد أصبت! اقرأ شرح المثل وتعلم نبذة عنه.', en:'Congrats, you got it! Read the explanation and learn more about this proverb.' },
      'game.rewardTitle'     : { ar:'مكافأة الحكمة', en:'Wisdom Reward' },
      'game.tryAgain'        : { ar:'حاول مجددًا', en:'Try Again' },
      'game.playAgain'       : { ar:'العب مرة أخرى', en:'Play Again' },
      'game.revealPrompt'    : { ar:'انقر لاكتشاف الحكمة كاملة بعد نهاية الجولة.', en:'Tap to reveal the full wisdom after the round ends.' }
    };

    /* ===================== Markdown: المحتوى المعرفي ===================== */
    const readmeStore = M.readme || {};
    const DOCS = {
      base:{
        ar: (readmeStore.base && readmeStore.base.ar) || '',
        en: (readmeStore.base && readmeStore.base.en) || (readmeStore.base && readmeStore.base.ar) || ''
      },
      tec:{
        ar: (readmeStore.tec && readmeStore.tec.ar) || '',
        en: (readmeStore.tec && readmeStore.tec.en) || (readmeStore.tec && readmeStore.tec.ar) || ''
      }
    };

    /* ===================== Game Data: بيانات اللعبة ===================== */
    const PROVERBS = [
      {
        t:"رجع بخفي حنين",
        hint:"يُقال لمن عاد بلا نتيجة",
        explanation:"تحكي القصة عن رجل فشل في مفاوضة إسكافي فعاد خالي الوفاض وقد فقد نعليه، فصار مثلاً عن الخيبة بعد مشقة.",
        lesson:"التخطيط والمرونة في التفاوض يحميان من ضياع الجهد بلا ثمر.",
        source:"مثل عربي قديم"
      },
      {
        t:"الي اختشوا ماتوا",
        hint:"يُنتقد فيه ذهاب الحياء",
        explanation:"نشأ في مصر زمن الحريق حين فضلت بعض النساء المحافظة على حيائهن فمُتن، فصار كناية عن تبدل الأحوال وغياب الخجل.",
        lesson:"حياء المجتمع ينعكس على سلوكه واستقراره.",
        source:"مثل مصري شعبي"
      },
      {
        t:"اقلب القدرة على فمها تطلع البنت لامها",
        hint:"يشير للشبه بين الأجيال",
        explanation:"يعبر المثل عن أن الفتاة غالبًا ما تشبه أمها في الطباع والسلوك مهما حاولت الاختلاف.",
        lesson:"القدوة الأسرية تترك بصمتها العميقة على الأبناء.",
        source:"تراث شعبي مصري"
      },
      {
        t:"ابنك على ما تربيه و جوزك على ما تعوديه",
        hint:"فيه حديث عن أثر التربية",
        explanation:"يوضح المثل أن السلوك الذي نزرعه في الأبناء والأزواج ينعكس علينا في المعاملة والنتائج.",
        lesson:"التربية الواعية والعلاقة الطيبة تصنع استقرار الأسرة.",
        source:"مثل عربي متداول"
      },
      {
        t:"ما حك جلدك مثل ظفرك",
        hint:"دعوة للاعتماد على الذات",
        explanation:"يشجع المثل على القيام بالعمل بنفسك لأنك الأحرص على مصلحتك والأقدر على إدراك حاجتك.",
        lesson:"المبادرة الذاتية تُختصر بها الطرق وتتحقق النجاحات.",
        source:"مثل عربي فصيح"
      },
      {
        t:"خير الكلام ما قل ودل",
        hint:"يتعلق بفصاحة التعبير",
        explanation:"يحُث المثل على اختيار كلمات قليلة لكنها معبرة وواضحة بدل الإطالة المملة.",
        lesson:"الإيجاز الواضح يبني تواصلًا أقوى وأكثر تأثيرًا.",
        source:"حكمة عربية قديمة"
      },
      {
        t:"الخبر الي انهرده بفلوس بكرة يبقى ببلاش",
        hint:"يتناول سرعة انتشار الأخبار",
        explanation:"يُقال عن أسرار اليوم التي سرعان ما يعرفها الجميع، فلا جدوى من شراء ما سيشيع بلا ثمن.",
        lesson:"الحذر من التسريب وتقدير قيمة المعلومة في وقتها.",
        source:"مثل شعبي مصري"
      },
      {
        t:"من طلب العلا سهر الليالي",
        hint:"يتحدث عن الاجتهاد",
        explanation:"يدعو المثل إلى المثابرة وبذل الجهد الطويل لتحقيق الأهداف السامية.",
        lesson:"الطموح يتحقق بالعمل والصبر لا بالتمني.",
        source:"حكمة تعليمية"
      },
      {
        t:"الي بيشيل قربة مخرومة بتخر على راسه",
        hint:"تحذير من الإهمال",
        explanation:"يضرب لمن يتهاون في إصلاح الخلل فيعود عليه بالخسارة والمشقة.",
        lesson:"علاج المشكلة الصغيرة مبكرًا يمنع كوارث أكبر لاحقًا.",
        source:"مثل شعبي شاملي"
      },
      {
        t:"ادي العيش لخبازه ولو كل نصه",
        hint:"يشير إلى التخصص",
        explanation:"يوصي المثل بإسناد الأمور لأهل الخبرة حتى لو كلف الأمر؛ فالنتيجة ستكون أضمن وأجود.",
        lesson:"الثقة بالمتخصصين تضمن جودة المخرجات وتختصر الوقت.",
        source:"مثل عربي دارج"
      },
      {
        t:"لا تؤجل عمل اليوم إلى الغد",
        hint:"محاربة التسويف",
        explanation:"ينبه المثل إلى خطورة تأجيل الأعمال لأن تراكمها يسبب ضياع الفرص والاضطراب.",
        lesson:"الإنجاز الفوري يفتح أبواب النجاح ويقلل التوتر.",
        source:"حكمة إدارية عالمية"
      },
      {
        t:"الوقت كالسيف ان لم تقطعه قطعك",
        hint:"يؤكد على قيمة الزمن",
        explanation:"يشبه المثل الوقت بالسيف الحاد الذي إن لم نحسن استخدامه سيوقع بنا الخسارة.",
        lesson:"إدارة الوقت محور أساسي للتفوق في الحياة.",
        source:"مثل عربي مأثور"
      },
      {
        t:"الصبر مفتاح الفرج",
        hint:"يدعو للتريث",
        explanation:"يعلمنا المثل أن ضيق اللحظة لا يدوم وأن الصبر يفتح أبواب الحلول المتوقعة وغير المتوقعة.",
        lesson:"الهدوء والثبات يمنحاننا رؤية أوضح للفرص المختبئة.",
        source:"حكمة عربية روحانية"
      },
      {
        t:"من جد وجد ومن زرع حصد",
        hint:"يرتبط بالعمل الجاد",
        explanation:"يجمع المثل بين بذل الجهد وقطف الثمار كعلاقة سببية لا مفر منها.",
        lesson:"الاجتهاد المستمر يثمر مهما طال الزمن.",
        source:"قول مأثور في التربية"
      },
      {
        t:"في التأني السلامة وفي العجلة الندامة",
        hint:"يحذر من التسرع",
        explanation:"يظهر المثل أن التأني يمنح السلامة بينما العجلة غير المحسوبة تجر الندم.",
        lesson:"التروّي قبل القرارات المصيرية يجنّب الأخطاء الكبيرة.",
        source:"مثل عربي مشترك"
      },
      {
        t:"إذا تم العقل نقص الكلام",
        hint:"يمجد الصمت الحكيم",
        explanation:"يرى المثل أن اكتمال الحكمة يجعل صاحبها قليل الكلام لأنه يزن العبارات.",
        lesson:"الوعي بذاتك يجعلك تختار كلماتك بعناية.",
        source:"حكمة منسوبة للإمام علي"
      },
      {
        t:"إذا عرف السبب بطل العجب",
        hint:"عن فهم الخلفيات",
        explanation:"يؤكد المثل أن معرفة الأسباب تزيل الغرابة وتكشف منطق الأحداث.",
        lesson:"التحليل العميق للأحداث يمنحنا حلاً أدق وقرارًا أصوب.",
        source:"مثل عربي قديم"
      },
      {
        t:"درهم وقاية خير من قنطار علاج",
        hint:"يشجع الوقاية",
        explanation:"يدعو المثل للاستثمار في الوقاية من الخطر قبل وقوعه لأن العلاج لاحقًا مكلف ومُرهق.",
        lesson:"الاستباق والتخطيط يقللان الخسائر المادية والمعنوية.",
        source:"حكمة طبية شائعة"
      },
      {
        t:"لا يموت الذئب ولا تفنى الغنم",
        hint:"يرصد التعارض بين مصلحتين",
        explanation:"يضرب لمن يحاول الجمع بين متضادين دون تضحية، وهو أمر مستحيل غالبًا.",
        lesson:"القرارات الجادة تستلزم اختيارًا واضحًا وتضحية محسوبة.",
        source:"مثل بدوي"
      },
      {
        t:"إذا كان الكلام من فضة فالسكوت من ذهب",
        hint:"يفاضل بين الكلام والصمت",
        explanation:"يشدد المثل على قيمة الصمت في مواضع الحكمة مقارنة بالكلام الزائد.",
        lesson:"اختيار اللحظة المناسبة للكلام مهارة قيادية مهمة.",
        source:"قول مأثور عربي"
      },
      {
        t:"رب ضارة نافعة",
        hint:"يرى الخير في الابتلاء",
        explanation:"يوضح المثل أن المصائب قد تحمل في طياتها فرصًا وألطافًا لا نراها للوهلة الأولى.",
        lesson:"تغيير زاوية النظر يحوّل المحن إلى منح وعبر.",
        source:"حكمة إسلامية شائعة"
      },
      {
        t:"العلم نور",
        hint:"يُشيد بالمعرفة",
        explanation:"يشبه المثل العلم بالنور الذي يبدد الظلام ويهدي العقول إلى الصواب.",
        lesson:"التعلم المستمر يفتح الآفاق ويصون الإنسان من الجهل.",
        source:"قول تربوي مأثور"
      },
      {
        t:"ليس الفتى من قال كان أبي",
        hint:"يحث على الإنجاز الشخصي",
        explanation:"يرفض المثل الاتكاء على أمجاد الآباء ويدعو لصناعة مجد ذاتي.",
        lesson:"هوية الإنسان تبنى بجهده لا بنسبه فحسب.",
        source:"بيت من شعر المتنبي"
      },
      {
        t:"من شب على شيء شاب عليه",
        hint:"يتعلق بالعادات",
        explanation:"يؤكد المثل أن ما ينشأ عليه الإنسان في صغره يستمر غالبًا معه حتى الكبر.",
        lesson:"تشكيل العادات الإيجابية مبكرًا استثمار طويل الأمد.",
        source:"مثل عربي دارج"
      },
      {
        t:"عند الامتحان يكرم المرء أو يهان",
        hint:"عن لحظات الحسم",
        explanation:"يشير المثل إلى أن الاختبارات تكشف حقيقة الاستعداد والجدية.",
        lesson:"الاستعداد المستمر يجعل المواقف الحاسمة فرصة للتألق.",
        source:"حكمة تعليمية"
      },
      {
        t:"إذا أردت أن تطاع فأمر بما يستطاع",
        hint:"يوازن بين الطموح والقدرة",
        explanation:"يعلم المثل القادة أن التكليف بما فوق الطاقة يولد العصيان، أما الواقعية فتجلب الطاعة.",
        lesson:"الإدارة الحكيمة تراعي طاقة الفريق وحدود الموارد.",
        source:"قول منسوب لعمر بن الخطاب"
      },
      {
        t:"على قدر أهل العزم تأتي العزائم",
        hint:"عن قوة الإرادة",
        explanation:"يشير البيت إلى أن القرارات الكبيرة لا ينهض بها إلا أصحاب الهمم العالية.",
        lesson:"طموحك يحدد حجم الإنجاز الذي يمكن أن تحققه.",
        source:"من قصيدة المتنبي"
      },
      {
        t:"الطيور على أشكالها تقع",
        hint:"يتناول صحبة المتشابهين",
        explanation:"يقول المثل إن الأفراد يميلون إلى من يشبهونهم في الطباع والقيم.",
        lesson:"اختر محيطك بعناية لأنه يعكسك ويؤثر عليك.",
        source:"مثل عالمي مترجم"
      },
      {
        t:"من سار على الدرب وصل",
        hint:"يتحدث عن المثابرة",
        explanation:"يجسد المثل قيمة الاستمرار في الطريق رغم طول المسافة حتى نبلغ الهدف.",
        lesson:"المواظبة اليومية الصغيرة تصنع إنجازًا عظيمًا مع الزمن.",
        source:"حكمة تطوير ذات"
      },
      {
        t:"رحم الله امرء عرف قدر نفسه",
        hint:"حول تقدير الذات",
        explanation:"يشجع المثل على معرفة الإنسان لطاقته وحدوده حتى لا يظلم نفسه ولا يتجاوز قدرته.",
        lesson:"الوعي بالذات يساعد على اختيار ما يناسبك من فرص ومسؤوليات.",
        source:"قول مأثور عن عمر بن عبد العزيز"
      },
      {
        t:"القناعة كنز لا يفنى",
        hint:"يدعو للرضا",
        explanation:"يبين المثل أن القناعة ثروة داخلية لا تنتهي، لأنها تمنح صاحبها راحة نفسية مستدامة.",
        lesson:"تقدير النعم الحالية يجلب السكينة ويحفز العمل المتوازن.",
        source:"مثل عربي متداول"
      },
      {
        t:"إن مع العسر يسرا",
        hint:"مستمد من القرآن",
        explanation:"يرسخ المثل القرآني حقيقة أن الضيق يتبعه فرج مزدوج لمن يصبر ويأمل.",
        lesson:"الأمل والثقة بالله يثبتان القلب في مواجهة المصاعب.",
        source:"القرآن الكريم — سورة الشرح"
      }
    ];
	
    const AR_ALPHA = ['ا','ب','ت','ث','ج','ح','خ','د','ذ','ر','ز','س','ش','ص','ض','ط','ظ','ع','غ','ف','ق','ك','ل','م','ن','و','ه','ة','ء','ي','ى'];
    const norm = (ch)=> String(ch).replace(/[أإآ]/g,'ا');

    const SOUND_EFFECTS = {
      correct: 'https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3',
      wrong: 'https://assets.mixkit.co/sfx/preview/mixkit-failure-arcade-alert-notification-240.mp3',
      win: 'https://assets.mixkit.co/sfx/preview/mixkit-small-crowd-cheer-and-applause-518.mp3',
      lose: 'https://assets.mixkit.co/sfx/preview/mixkit-game-over-dark-2068.mp3'
    };

    const THEME_STORAGE_KEY = 'mishkah:theme:prefs:v1';
    const THEME_BACKGROUND_PRESETS = [
      {
        id:'nebula',
        label:{ ar:'شفق بنفسجي', en:'Violet Nebula' },
        light:{
          gradient: 'linear-gradient(160deg, #f8f9ff 0%, #e8ecff 100%)',
          overlay1: 'radial-gradient(circle at 20% 25%, rgba(79, 70, 229, 0.18), transparent 55%)',
          overlay2: 'radial-gradient(circle at 80% 70%, rgba(14, 165, 233, 0.18), transparent 50%)',
          accentRing: 'rgba(79, 70, 229, 0.18)'
        },
        dark:{
          gradient: 'linear-gradient(160deg, #0d1224 0%, #111c3d 100%)',
          overlay1: 'radial-gradient(circle at 80% 30%, rgba(168, 85, 247, 0.22), transparent 55%)',
          overlay2: 'radial-gradient(circle at 15% 80%, rgba(56, 189, 248, 0.18), transparent 55%)',
          accentRing: 'rgba(129, 140, 248, 0.35)'
        }
      },
      {
        id:'sunset',
        label:{ ar:'أفق الغروب', en:'Desert Sunset' },
        light:{
          gradient: 'linear-gradient(155deg, #fff4e6 0%, #ffd5c2 100%)',
          overlay1: 'radial-gradient(circle at 20% 25%, rgba(249, 115, 22, 0.22), transparent 55%)',
          overlay2: 'radial-gradient(circle at 80% 70%, rgba(236, 72, 153, 0.2), transparent 55%)',
          accentRing: 'rgba(249, 115, 22, 0.28)'
        },
        dark:{
          gradient: 'linear-gradient(155deg, #2b122e 0%, #40285d 100%)',
          overlay1: 'radial-gradient(circle at 70% 20%, rgba(236, 72, 153, 0.3), transparent 60%)',
          overlay2: 'radial-gradient(circle at 25% 80%, rgba(249, 115, 22, 0.28), transparent 60%)',
          accentRing: 'rgba(236, 72, 153, 0.38)'
        }
      },
      {
        id:'forest',
        label:{ ar:'ضباب الغابة', en:'Forest Mist' },
        light:{
          gradient: 'linear-gradient(150deg, #ecfdf5 0%, #d1fae5 100%)',
          overlay1: 'radial-gradient(circle at 30% 25%, rgba(16, 185, 129, 0.2), transparent 55%)',
          overlay2: 'radial-gradient(circle at 80% 70%, rgba(59, 130, 246, 0.15), transparent 55%)',
          accentRing: 'rgba(16, 185, 129, 0.28)'
        },
        dark:{
          gradient: 'linear-gradient(150deg, #052e16 0%, #0f4c3a 100%)',
          overlay1: 'radial-gradient(circle at 75% 25%, rgba(59, 130, 246, 0.22), transparent 60%)',
          overlay2: 'radial-gradient(circle at 20% 80%, rgba(16, 185, 129, 0.26), transparent 60%)',
          accentRing: 'rgba(16, 185, 129, 0.35)'
        }
      }
    ];

    const THEME_TEXT_SCHEMES = [
      {
        id:'cool',
        label:{ ar:'أزرق متزن', en:'Cool Focus' },
        light:{
          foreground: 'hsl(222 47% 16%)',
          muted: 'hsl(215 18% 42%)',
          primary: '#4f46e5',
          onPrimary: '#f9fafb'
        },
        dark:{
          foreground: 'hsl(210 40% 96%)',
          muted: 'hsl(215 20% 72%)',
          primary: '#6366f1',
          onPrimary: '#0f172a'
        }
      },
      {
        id:'warm',
        label:{ ar:'دفء الشمس', en:'Warm Glow' },
        light:{
          foreground: 'hsl(26 42% 24%)',
          muted: 'hsl(27 35% 48%)',
          primary: '#f97316',
          onPrimary: '#1f2937'
        },
        dark:{
          foreground: 'hsl(35 92% 92%)',
          muted: 'hsl(27 55% 70%)',
          primary: '#fb923c',
          onPrimary: '#111827'
        }
      },
      {
        id:'zen',
        label:{ ar:'هدوء البحر', en:'Zen Tide' },
        light:{
          foreground: 'hsl(200 45% 20%)',
          muted: 'hsl(198 34% 45%)',
          primary: '#0ea5e9',
          onPrimary: '#062029'
        },
        dark:{
          foreground: 'hsl(189 70% 92%)',
          muted: 'hsl(191 45% 70%)',
          primary: '#38bdf8',
          onPrimary: '#0f172a'
        }
      }
    ];

    const DESIGN_LAB_THEME_MODES = [
      { id:'light', icon:'🌞', labelKey:'designLab.mode.light' },
      { id:'dark', icon:'🌙', labelKey:'designLab.mode.dark' },
      { id:'pink', icon:'🌸', labelKey:'designLab.mode.pink', preset:{ backgroundId:'sunset', textSchemeId:'warm' } }
    ];

    const DESIGN_VAR_DEFINITIONS = [
      { name:'--foreground', labelKey:'designLab.var.foreground', type:'color', default:'#1f2937' },
      { name:'--muted-foreground', labelKey:'designLab.var.muted', type:'color', default:'#64748b' },
      { name:'--primary', labelKey:'designLab.var.primary', type:'color', default:'#4f46e5' },
      { name:'--primary-foreground', labelKey:'designLab.var.primaryForeground', type:'color', default:'#f9fafb' },
      { name:'--accent-ring', labelKey:'designLab.var.accentRing', type:'color', default:'#6366f1' },
      { name:'--page-gradient', labelKey:'designLab.var.gradient', type:'text', default:'linear-gradient(160deg, #f8f9ff 0%, #e8ecff 100%)' },
      { name:'--page-overlay-1', labelKey:'designLab.var.overlay1', type:'text', default:'radial-gradient(circle at 20% 25%, rgba(79, 70, 229, 0.18), transparent 55%)' },
      { name:'--page-overlay-2', labelKey:'designLab.var.overlay2', type:'text', default:'radial-gradient(circle at 80% 70%, rgba(14, 165, 233, 0.18), transparent 50%)' },
      { name:'--panel-glass', labelKey:'designLab.var.panelGlass', type:'text', default:'rgba(255, 255, 255, 0.78)' },
      { name:'--panel-border', labelKey:'designLab.var.panelBorder', type:'text', default:'rgba(99, 102, 241, 0.12)' },
      { name:'--tile-bg', labelKey:'designLab.var.tileBg', type:'text', default:'linear-gradient(160deg, rgba(255, 255, 255, 0.95), rgba(241, 245, 249, 0.85))' },
      { name:'--tile-bg-revealed', labelKey:'designLab.var.tileRevealed', type:'text', default:'linear-gradient(160deg, rgba(129, 140, 248, 0.75), rgba(79, 70, 229, 0.65))' },
      { name:'--tile-border', labelKey:'designLab.var.tileBorder', type:'text', default:'rgba(99, 102, 241, 0.25)' },
      { name:'--letters-shadow', labelKey:'designLab.var.lettersShadow', type:'text', default:'0 18px 45px -24px rgba(15, 23, 42, 0.35)' },
      { name:'--letters-hover', labelKey:'designLab.var.lettersHover', type:'text', default:'0 25px 50px -20px rgba(99, 102, 241, 0.45)' },
      { name:'--tile-size', labelKey:'designLab.var.tileSize', type:'range', min:2.6, max:4, step:0.05, unit:'rem', default:'3.1rem' },
      { name:'--font-size-body', labelKey:'designLab.var.font.body', type:'range', min:0.85, max:1.35, step:0.01, unit:'rem', default:'1rem' },
      { name:'--font-size-heading-1', labelKey:'designLab.var.font.h1', type:'range', min:2.1, max:3.4, step:0.05, unit:'rem', default:'2.6rem' },
      { name:'--font-size-heading-2', labelKey:'designLab.var.font.h2', type:'range', min:1.7, max:2.6, step:0.05, unit:'rem', default:'2.05rem' },
      { name:'--font-size-heading-3', labelKey:'designLab.var.font.h3', type:'range', min:1.3, max:2.2, step:0.05, unit:'rem', default:'1.62rem' },
      { name:'--font-size-scale-3xl', labelKey:'designLab.var.font.scale3xl', type:'range', min:1.7, max:3.1, step:0.05, unit:'rem', default:'2.35rem' },
      { name:'--font-size-scale-2xl', labelKey:'designLab.var.font.scale2xl', type:'range', min:1.4, max:2.6, step:0.05, unit:'rem', default:'1.8rem' },
      { name:'--font-size-scale-xl', labelKey:'designLab.var.font.scaleXl', type:'range', min:1.1, max:2.1, step:0.05, unit:'rem', default:'1.38rem' },
      { name:'--font-size-scale-lg', labelKey:'designLab.var.font.scaleLg', type:'range', min:1, max:1.9, step:0.03, unit:'rem', default:'1.18rem' },
      { name:'--font-size-scale-md', labelKey:'designLab.var.font.scaleMd', type:'range', min:0.85, max:1.6, step:0.02, unit:'rem', default:'1rem' },
      { name:'--font-size-scale-sm', labelKey:'designLab.var.font.scaleSm', type:'range', min:0.75, max:1.4, step:0.02, unit:'rem', default:'0.9rem' },
      { name:'--font-size-scale-xs', labelKey:'designLab.var.font.scaleXs', type:'range', min:0.6, max:1.2, step:0.02, unit:'rem', default:'0.78rem' },
      { name:'--font-size-sidebar', labelKey:'designLab.var.font.sidebar', type:'range', min:0.9, max:1.6, step:0.02, unit:'rem', default:'1.05rem' },
      { name:'--font-size-quote', labelKey:'designLab.var.font.quote', type:'range', min:1, max:1.8, step:0.02, unit:'rem', default:'1.18rem' },
      { name:'--font-size-info', labelKey:'designLab.var.font.info', type:'range', min:1.05, max:1.9, step:0.02, unit:'rem', default:'1.22rem' },
      { name:'--font-size-letter', labelKey:'designLab.var.font.letter', type:'range', min:1.1, max:1.9, step:0.02, unit:'rem', default:'1.35rem' },
      { name:'--font-size-status', labelKey:'designLab.var.font.status', type:'range', min:1, max:1.95, step:0.02, unit:'rem', default:'1.22rem' },
      { name:'--user-font-scale', labelKey:'designLab.var.fontScale', type:'range', min:90, max:130, step:2, unit:'%', default:'100', prefKey:'fontScale' }
    ];

    const DESIGN_VAR_DEF_MAP = Object.fromEntries(DESIGN_VAR_DEFINITIONS.map((def)=>[def.name, def]));
    const DESIGN_VAR_GROUPS = [
      { id:'core', labelKey:'designLab.group.core', hintKey:'designLab.group.coreHint', vars:['--foreground','--muted-foreground','--primary','--primary-foreground','--accent-ring'] },
      { id:'surface', labelKey:'designLab.group.surface', hintKey:'designLab.group.surfaceHint', vars:['--page-gradient','--page-overlay-1','--page-overlay-2','--panel-glass','--panel-border','--tile-bg','--tile-bg-revealed','--tile-border'] },
      { id:'effects', labelKey:'designLab.group.effects', hintKey:'designLab.group.effectsHint', vars:['--letters-shadow','--letters-hover'] },
      { id:'typography', labelKey:'designLab.group.typography', hintKey:'designLab.group.typographyHint', vars:[
        '--font-size-heading-1',
        '--font-size-heading-2',
        '--font-size-heading-3',
        '--font-size-scale-3xl',
        '--font-size-scale-2xl',
        '--font-size-scale-xl',
        '--font-size-scale-lg',
        '--font-size-scale-md',
        '--font-size-scale-sm',
        '--font-size-scale-xs',
        '--font-size-body',
        '--font-size-sidebar',
        '--font-size-quote',
        '--font-size-info',
        '--font-size-letter',
        '--font-size-status',
        '--user-font-scale'
      ] },
      { id:'sizing', labelKey:'designLab.group.sizing', hintKey:'designLab.group.sizingHint', vars:['--tile-size'] }
    ];

    const THEME_BACKGROUND_MAP = Object.fromEntries(THEME_BACKGROUND_PRESETS.map((p)=>[p.id, p]));
    const THEME_TEXT_SCHEME_MAP = Object.fromEntries(THEME_TEXT_SCHEMES.map((p)=>[p.id, p]));
    const THEME_DEFAULT_PREFS = { backgroundId:'nebula', textSchemeId:'cool', fontScale:100, customVars:{} };

    let CURRENT_THEME_BASELINE = {};
    let LAST_APPLIED_CUSTOM_VARS = new Set();

    function normalizeThemePrefs(raw){
      const base = { ...THEME_DEFAULT_PREFS, customVars:{} };
      const src = raw && typeof raw==='object' ? raw : {};
      if (src.backgroundId && THEME_BACKGROUND_MAP[src.backgroundId]) base.backgroundId = src.backgroundId;
      if (src.textSchemeId && THEME_TEXT_SCHEME_MAP[src.textSchemeId]) base.textSchemeId = src.textSchemeId;
      const font = parseInt(src.fontScale, 10);
      if (!Number.isNaN(font)) base.fontScale = Math.min(120, Math.max(90, font));
      if (src.customVars && typeof src.customVars==='object'){
        const nextVars = {};
        Object.entries(src.customVars).forEach(([key,value])=>{
          const def = DESIGN_VAR_DEF_MAP[key];
          if (def && def.prefKey) return;
          if (typeof value==='string' && value.trim()!=='') nextVars[key] = value;
        });
        base.customVars = nextVars;
      }
      return base;
    }

    function loadThemePrefs(){
      if (typeof window==='undefined' || !window.localStorage) return { ...THEME_DEFAULT_PREFS };
      try {
        const raw = window.localStorage.getItem(THEME_STORAGE_KEY);
        if (!raw) return { ...THEME_DEFAULT_PREFS };
        return normalizeThemePrefs(JSON.parse(raw));
      } catch (_err){
        return { ...THEME_DEFAULT_PREFS };
      }
    }

    function persistThemePrefs(prefs){
      if (typeof window==='undefined' || !window.localStorage) return;
      try { window.localStorage.setItem(THEME_STORAGE_KEY, JSON.stringify(prefs)); }
      catch(_err){ /* ignore storage quota issues */ }
    }

    function applyThemePrefs(prefs){
      if (typeof document==='undefined') return;
      const root = document.documentElement;
      if (!root) return;
      LAST_APPLIED_CUSTOM_VARS.forEach((name)=>{ try { root.style.removeProperty(name); } catch(_err){} });
      LAST_APPLIED_CUSTOM_VARS = new Set();
      const mode = root.classList.contains('dark') ? 'dark' : 'light';
      const bgPreset = THEME_BACKGROUND_MAP[prefs.backgroundId] || THEME_BACKGROUND_MAP[THEME_DEFAULT_PREFS.backgroundId];
      const textPreset = THEME_TEXT_SCHEME_MAP[prefs.textSchemeId] || THEME_TEXT_SCHEME_MAP[THEME_DEFAULT_PREFS.textSchemeId];
      const bg = bgPreset[mode];
      const text = textPreset[mode];
      if (bg){
        root.style.setProperty('--page-gradient', bg.gradient);
        root.style.setProperty('--page-overlay-1', bg.overlay1);
        root.style.setProperty('--page-overlay-2', bg.overlay2);
        if (bg.accentRing) root.style.setProperty('--accent-ring', bg.accentRing);
      }
      if (text){
        root.style.setProperty('--foreground', text.foreground);
        root.style.setProperty('--muted-foreground', text.muted);
        root.style.setProperty('--primary', text.primary);
        root.style.setProperty('--ring', text.primary);
        root.style.setProperty('--primary-foreground', text.onPrimary);
      }
      root.style.setProperty('--user-font-scale', String(prefs.fontScale));
      if (typeof window!=='undefined' && window.getComputedStyle){
        const computed = window.getComputedStyle(root);
        const snapshot = {};
        DESIGN_VAR_DEFINITIONS.forEach((def)=>{
          snapshot[def.name] = computed.getPropertyValue(def.name).trim();
        });
        CURRENT_THEME_BASELINE = snapshot;
      }
      const customVars = prefs.customVars && typeof prefs.customVars==='object' ? prefs.customVars : {};
      Object.entries(customVars).forEach(([name,value])=>{
        const def = DESIGN_VAR_DEF_MAP[name];
        if (def && def.prefKey) return;
        if (typeof value==='string' && value.trim()!==''){
          root.style.setProperty(name, value);
          LAST_APPLIED_CUSTOM_VARS.add(name);
        }
      });
    }

    const INITIAL_THEME_PREFS = loadThemePrefs();
    applyThemePrefs(INITIAL_THEME_PREFS);

    function randInt(min, max){
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function shuffle(list){
      const arr = Array.isArray(list) ? list.slice() : [];
      for (let i = arr.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function generateLogicChallenge(){
      const types = ['arithmetic','square','double'];
      const type = types[Math.floor(Math.random()*types.length)];
      if (type==='square'){
        const start = randInt(2, 6);
        const sequence = [start, start+1, start+2, start+3].map((n)=> n*n);
        const answer = sequence[3];
        const pool = new Set([answer]);
        pool.add((start+4)*(start+4));
        pool.add((start+3)*(start+2));
        pool.add(Math.max(4, answer - (2*start + 3)));
        return {
          type,
          sequence,
          answer,
          options: shuffle(Array.from(pool).slice(0,4)),
          meta:{ start }
        };
      }
      if (type==='double'){
        const start = randInt(2, 9);
        const sequence = [start, start*2, start*4, start*8];
        const answer = sequence[3];
        const pool = new Set([answer]);
        pool.add(start*6);
        pool.add(start*10);
        pool.add(start*5);
        return {
          type,
          sequence,
          answer,
          options: shuffle(Array.from(pool).slice(0,4)),
          meta:{ start }
        };
      }
      const start = randInt(2, 18);
      const step = randInt(2, 7);
      const sequence = [start, start+step, start+2*step, start+3*step];
      const answer = sequence[3];
      const pool = new Set([answer]);
      while (pool.size < 4){
        const delta = randInt(-2,2);
        if (delta===0) continue;
        const candidate = answer + delta * step;
        if (candidate > 0) pool.add(candidate);
      }
      return {
        type:'arithmetic',
        sequence,
        answer,
        options: shuffle(Array.from(pool).slice(0,4)),
        meta:{ step, start }
      };
    }


    // ================================================================
    // الزوج الأول: التصميم والتسوية (تخطيط الجسد)
    // هنا نصنع الهيكل والشكل الخارجي للتطبيق.
    // ================================================================

    // ----------------------------------------------------------------
    // الركن الأول: الطين والذرات (`Atoms` as Components)
    // هذه هي المكونات، لبنات البناء الأساسية التي تشكل جسد التطبيق.
    // كل مكون هو "ذرة" أو مجموعة "ذرات" لها شكل ووظيفة محددة.
    // ----------------------------------------------------------------
    
    function computeTimeLeft(g){
      if (!g || !g.timerOn) return null;
      if (g.status==='running') return Math.max(0, typeof g.timeLeft === 'number' ? g.timeLeft : g.timerSec);
      return g.status==='lost' ? 0 : g.timerSec;
    }

    function GameStatusStrip(db){
      if (db.data.activeTab !== 'game') return null;
      const { TL } = makeLangLookup(db);
      const g = db.data.game;
      if (!g) return null;
      const timeLeftValue = computeTimeLeft(g);
      const hearts = Array.from({ length:g.triesMax }, (_,i)=>
        D.Text.Span({ attrs:{ key:`strip-heart-${i}`, class: tw`${i < g.triesLeft ? '' : 'opacity-35'}` }}, [i < g.triesLeft ? '❤️' : '💔'])
      );
      const heartsRow = D.Containers.Div({ attrs:{ class:'header-status-hearts' }}, hearts);
      const timeBlock = D.Containers.Div({ attrs:{ class:'header-status-block', key:'status-time' }}, [
        D.Text.Span({ attrs:{ class:'header-status-label' }}, ['⏳ ', TL('game.timeLabel')]),
        D.Text.Span({ attrs:{ class:'header-status-value' }}, [timeLeftValue !== null ? String(timeLeftValue) : '—'])
      ]);
      const triesBlock = D.Containers.Div({ attrs:{ class:'header-status-block', key:'status-tries' }}, [
        D.Text.Span({ attrs:{ class:'header-status-label' }}, ['❤️ ', TL('game.tries')]),
        heartsRow,
        D.Text.Span({ attrs:{ class:'header-status-label' }}, [`/ ${g.triesMax}`])
      ]);
      const statusBlock = D.Containers.Div({ attrs:{ class:'header-status-block', key:'status-state' }}, [
        D.Text.Span({ attrs:{ class:'header-status-label' }}, ['🎯 ', TL('game.statusLabel')]),
        D.Text.Span({ attrs:{ class:'header-status-value' }}, [TL(`game.status.${g.status}`)])
      ]);
      return D.Containers.Div({ attrs:{ class:'header-status-strip', key:'status-strip' }}, [timeBlock, triesBlock, statusBlock]);
    }

    function HeaderBar(db){
      const { TL } = makeLangLookup(db);
      const g = db.data.game || {};
      const designLabButton = UI.Button({
        attrs:{
          gkey:'design:lab:open',
          class: tw`rounded-full w-11 h-11 flex items-center justify-center shadow-[0_16px_32px_-24px_rgba(79,70,229,0.55)]`,
          title: TL('designLab.openButton'),
          'aria-label': TL('designLab.openButton')
        },
        variant:'soft',
        size:'sm'
      }, ['🎛️']);
      const themeValue = db.env.theme === 'dark' ? 'dark' : 'light';
      const themeSwitcher = UI.SegmentedSwitch({
        attrs:{ 'data-switch':'theme' },
        value: themeValue,
        options:[
          { value:'light', label:`🌞 ${TL('header.theme.light')}`, gkey:'ui:theme:set' },
          { value:'dark', label:`🌙 ${TL('header.theme.dark')}`, gkey:'ui:theme:set' }
        ]
      });
      const langValue = db.env.lang === 'en' ? 'en' : 'ar';
      const langSwitcher = UI.SegmentedSwitch({
        attrs:{ 'data-switch':'lang' },
        value: langValue,
        options:[
          { value:'ar', label:`ع ${TL('header.lang.ar')}`, gkey:'ui:lang-ar' },
          { value:'en', label:`EN ${TL('header.lang.en')}`, gkey:'ui:lang-en' }
        ]
      });
      const statusStrip = GameStatusStrip(db);
      const leftBlock = D.Containers.Div({ attrs:{ class: tw`flex flex-col gap-0.5` }}, [
        D.Text.Span({ attrs:{ class: tw`text-2xl font-bold tracking-tight` }}, [TL('app.title')]),
        D.Text.Span({ attrs:{ class: tw`text-sm text-[var(--muted-foreground)]` }}, [TL('header.subtitle')])
      ]);
      const gameToggle = db.data.activeTab==='game'
        ? UI.Button({
            attrs:{
              gkey:'game:start',
              class: tw`rounded-full px-5 font-semibold`
            },
            variant:'destructive',
            size:'sm'
          }, [g.status==='running' ? TL('game.new') : TL('game.start')])
        : null;
      const controlChildren = [themeSwitcher, langSwitcher, gameToggle, designLabButton].filter(Boolean);
      const controlBlock = D.Containers.Div({ attrs:{ class: tw`flex items-center gap-2 flex-wrap justify-end` }}, controlChildren);
      const rowChildren = [
        D.Containers.Div({ attrs:{ class: tw`flex-1 min-w-[240px]` }}, [leftBlock]),
        statusStrip ? D.Containers.Div({ attrs:{ class: tw`flex-1 flex justify-center min-w-[260px]` }}, [statusStrip]) : null,
        D.Containers.Div({ attrs:{ class: tw`flex items-center justify-end gap-2 min-w-[260px]` }}, [controlBlock])
      ].filter(Boolean);
      return D.Containers.Header({ attrs:{ class: tw`px-5 pt-3 pb-3` }}, [
        D.Containers.Div({ attrs:{ class: tw`mx-auto w-full max-w-[1600px]` }}, [
          D.Containers.Div({ attrs:{ class: `${tw`rounded-2xl px-4 py-3`} glass-panel glow-outline` }}, [
            D.Containers.Div({ attrs:{ class: tw`flex flex-wrap items-center gap-3` }}, rowChildren)
          ])
        ])
      ]);
    }

    function Sidebar(db){
      const { TL } = makeLangLookup(db);
      const route = db.data.activeTab;
      const NavBtn = (id,label,icon)=>{
        const active = route===id;
        return UI.Button({
          attrs:{
            gkey:`route:${id}`,
            class:`${tw`w-full justify-start text-start rounded-2xl transition-all duration-200`} glass-panel ${active ? 'glow-outline' : 'hover:opacity-90'} ${active?'':'opacity-85'}`
          },
          variant:'ghost', size:'sm'
        }, [`${icon} `, TL(label)]);
      };
      return D.Containers.Div({ attrs:{ class: tw`space-y-4` }}, [
        D.Containers.Div({ attrs:{ class: `${tw`rounded-3xl p-4 space-y-3`} glass-panel glow-outline` }}, [
          D.Text.Span({ attrs:{ class: tw`text-sm uppercase tracking-[0.3em] text-[var(--muted-foreground)]` }}, [TL('nav.menu')]),
          D.Containers.Nav({ attrs:{ class: tw`space-y-3` }}, [
            NavBtn('readmeBase','nav.readmeBase','🌌'),
            NavBtn('readmeTec','nav.readmeTec','🛠️'),
            NavBtn('counter','nav.counter','🔢'),
            NavBtn('game','nav.game','🎮'),
            NavBtn('logic','nav.logic','🧠')
          ])
        ])
      ]);
    }

    function DocPanel(db, kind){
      const lang = db.env.lang || 'ar';
      const key = kind==='tec' ? 'doc.tec.lead' : 'doc.base.lead';
      const titleKey = kind==='tec' ? 'nav.readmeTec' : 'nav.readmeBase';
      const docs = db.data.docs || {};
      const store = kind==='tec' ? docs.tec || {} : docs.base || {};
      const fallback = lang==='ar' ? (store.en || '') : (store.ar || '');
      const content = store[lang] || fallback || '';
      const { TL } = makeLangLookup(db);

      return UI.Card({
        title: TL(titleKey),
        description: TL('doc.language.hint'),
        content: D.Containers.Div({ attrs:{ class: tw`space-y-4` }}, [
          D.Text.P({ attrs:{ class: tw`text-base font-semibold`, style:'color:color-mix(in oklab,var(--foreground) 92%, var(--primary) 8%);' }}, [TL(key)]),
          UI.Markdown({ content, className: tw`md-prose` })
        ])
      });
    }

    function CounterPanel(db){
      const { TL } = makeLangLookup(db);
      return UI.Card({
        title: TL('counter.title'),
        content: D.Containers.Div({ attrs:{ class: tw`flex items-center justify-center gap-3` }}, [
          UI.Button({ attrs:{ gkey:'counter:dec' }, variant:'soft', size:'sm' }, ['−']),
          D.Text.Span({ attrs:{ class: tw`text-2xl font-bold` }}, [String(db.data.counter)]),
          UI.Button({ attrs:{ gkey:'counter:inc' }, variant:'soft', size:'sm' }, ['+']),
          UI.Button({ attrs:{ gkey:'counter:reset', class:tw`ms-4` }, variant:'ghost', size:'sm' }, [TL('counter.reset')]),
        ])
      });
    }

    function GamePanel(db){
      const { TL } = makeLangLookup(db);
      const g = db.data.game;
      const showSolution = g.revealSolution || g.status==='won';

      const pv = g.proverb?.t || '';
      const feedbackType = g.feedback?.type || 'idle';
      const feedbackStamp = g.feedback?.stamp || 0;

      const tiles = pv.split('').map((raw, idx)=>{
        if (raw===' ') return D.Containers.Div({ attrs:{ key:'sp'+idx, class: 'letter-space' }});
        const normalized = norm(raw);
        const revealed = !!g.guessed[normalized];
        return D.Containers.Div({
          attrs:{
            key:'bx'+idx,
            class: `${tw`grid place-items-center rounded-2xl text-2xl md:text-3xl font-semibold letter-tile letter-slot`}`,
            'data-revealed': revealed ? 'true' : 'false'
          }
        }, [ revealed ? raw : '' ]);
      });

      const puzzleRow = D.Containers.Div({ attrs:{ class: `${tw`flex flex-wrap justify-center gap-3`} puzzle-row` }}, tiles);

      const letters = D.Containers.Div({ attrs:{ class: `${tw`grid grid-cols-6 sm:grid-cols-8 xl:grid-cols-10 gap-2 letters-grid`}` }}, AR_ALPHA.map((L,i)=>
        UI.Button({
          attrs:{
            key:'L'+i,
            gkey:'game:guess',
            'data-ch':L,
            disabled: g.status!=='running' || !!g.guessed[L],
            class: tw`text-xl sm:text-2xl font-extrabold tracking-wider`
          },
          variant:'soft',
          size:'lg'
        }, [L])
      ));

      const feedbackClass = feedbackType && feedbackType!=='idle' ? ` feedback-${feedbackType}` : '';

      const boardCard = D.Containers.Div({ attrs:{ class: `${tw`space-y-6`} glass-panel glow-outline p-6 rounded-3xl game-board${feedbackClass}` }}, [
        D.Containers.Div({ attrs:{ class: tw`space-y-4` }}, [
          puzzleRow,
          UI.Divider(),
          D.Containers.Div({ attrs:{ class: tw`space-y-2` }}, [
            D.Text.Strong({ attrs:{ class: tw`text-sm text-[var(--muted-foreground)]` }}, [TL('game.letters')]),
            letters
          ])
        ])
      ]);

      const feedbackMessages = {
        correct: TL('game.feedback.correct'),
        wrong: TL('game.feedback.wrong'),
        win: TL('game.feedback.win'),
        lose: TL('game.feedback.lose')
      };
      const feedbackIcons = { correct:'✅', wrong:'⚠️', win:'🏆', lose:'💔' };

      const infoItems = [];
      if (feedbackType !== 'idle' && feedbackMessages[feedbackType]){
        infoItems.push(
          D.Containers.Div({ attrs:{ class: `${tw`rounded-3xl p-5 space-y-3`} glass-panel`, key:'feedback-card' }}, [
            UI.Badge({ attrs:{ class: tw`w-fit` }, leading: feedbackIcons[feedbackType] || '✨', text:TL('game.lastMove') }),
            D.Text.P({ attrs:{ class:'game-info-text' }}, [feedbackMessages[feedbackType]])
          ])
        );
      }

      if (g.proverb){
        infoItems.push(
          D.Containers.Div({ attrs:{ class: `${tw`rounded-3xl p-5 space-y-3`} glass-panel`, key:'hint-card' }}, [
            UI.Badge({ attrs:{ class: tw`w-fit` }, leading:'💡', text:TL('game.hintTitle') }),
            D.Text.P({ attrs:{ class:'game-info-text' }}, [g.proverb.hint])
          ])
        );
      }

      if (showSolution && g.proverb){
        infoItems.push(
          D.Containers.Div({ attrs:{ class: `${tw`rounded-3xl p-5 space-y-3`} glass-panel glow-outline solution-target`, style:'grid-column: 1 / -1;', key:'solution-card', id:'game-solution-card', tabindex:'-1' }}, [
            UI.Badge({ attrs:{ class: tw`w-fit` }, leading:'📜', text:TL('game.solution') }),
            g.status==='lost'
              ? D.Text.P({ attrs:{ class:'game-info-text' }}, [TL('game.overlay.loseInsight')])
              : D.Text.P({ attrs:{ class:'game-info-text' }}, [TL('game.overlay.winInsight')]),
            D.Text.P({ attrs:{ class: tw`font-semibold` + ' game-info-text' }}, [g.proverb.t]),
            D.Text.P({ attrs:{ class:'game-info-text' }}, [TL('game.explanation'), ': ', g.proverb.explanation]),
            D.Text.P({ attrs:{ class:'game-info-text' }}, [TL('game.lesson'), ': ', g.proverb.lesson]),
            D.Text.P({ attrs:{ class: tw`text-xs text-[var(--muted-foreground)]` }}, [TL('game.source'), ': ', g.proverb.source])
          ])
        );
      }

      let infoSection = null;
      if (infoItems.length){
        let infoClass = tw`grid gap-4`;
        if (infoItems.length >= 3) infoClass += ' ' + tw`md:grid-cols-2 xl:grid-cols-3`;
        else if (infoItems.length === 2) infoClass += ' ' + tw`md:grid-cols-2`;
        infoSection = D.Containers.Div({ attrs:{ class: infoClass }}, infoItems);
      }

      const confettiLayer = feedbackType==='win'
        ? D.Containers.Div({ attrs:{ class:'confetti-layer', key:`confetti-${feedbackStamp}` }},
            Array.from({ length: 70 }, (_,i)=>{
              const colors = ['#f97316','#38bdf8','#a855f7','#facc15','#f472b6'];
              const left = (Math.random()*100).toFixed(2);
              const delay = (Math.random()*1.2).toFixed(2);
              return D.Text.Span({ attrs:{ key:`confetti-${i}`, class:'confetti-piece', style:`left:${left}%; background:${colors[i % colors.length]}; animation-delay:${delay}s;` }});
            })
          )
        : null;

      const resultCard = g.status==='won' && g.proverb
        ? D.Containers.Div({ attrs:{ class: `${tw`rounded-3xl p-6 space-y-4 text-center`} glass-panel celebration-card` }}, [
            D.Containers.Div({ attrs:{ class: `${tw`space-y-3`} game-overlay-content` }}, [
              UI.Badge({ attrs:{ class: tw`w-fit mx-auto` }, leading:'🎉', text:TL('game.overlay.winTitle') }),
              D.Text.P({ attrs:{ class:'game-info-text' }}, [TL('game.overlay.winInsight')]),
              D.Text.P({ attrs:{ class: tw`font-semibold` + ' game-info-text' }}, [g.proverb.t]),
              D.Text.P({ attrs:{ class:'game-info-text' }}, [TL('game.rewardTitle'), ': ', g.proverb.lesson]),
              D.Text.P({ attrs:{ class: tw`text-xs text-[var(--muted-foreground)]` }}, [TL('game.source'), ': ', g.proverb.source]),
              UI.Button({ attrs:{ gkey:'game:start', class: tw`mt-2 px-8 py-3 rounded-full font-semibold` }, variant:'destructive', size:'lg' }, [TL('game.playAgain')])
            ])
          ])
        : (g.status==='lost' && !g.revealSolution)
        ? UI.SweetNotice({
            attrs:{ key:'gameover-card', class: tw`gameover-card` },
            tone:'danger',
            icon:'💔',
            title: TL('game.overlay.loseTitle'),
            message: TL('game.overlay.loseSubtitle'),
            hint: !showSolution ? TL('game.revealPrompt') : null,
            actions:[
              UI.Button({ attrs:{ gkey:'game:start', class: tw`px-7 py-3 rounded-full font-semibold` }, variant:'destructive', size:'lg' }, [TL('game.tryAgain')]),
              (!showSolution ? UI.Button({ attrs:{ gkey:'game:reveal', class: tw`px-7 py-3 rounded-full font-semibold` }, variant:'soft', size:'lg' }, [TL('game.reveal')]) : null)
            ].filter(Boolean)
          })
        : null;

      const playItems = [resultCard, boardCard].filter(Boolean);
      const playSection = playItems.length > 1
        ? D.Containers.Div({ attrs:{ class: tw`space-y-6` }}, playItems)
        : boardCard;

      const audioNode = (g.musicOn && g.status==='running')
        ? D.Media.Audio({ attrs:{ autoplay:true, loop:true, src:g.audioList[g.audioIdx].url, class: tw`hidden`, key:`bgm-${g.soundStamp||0}` }})
        : null;

      const cueAudio = (feedbackType && feedbackType!=='idle' && SOUND_EFFECTS[feedbackType])
        ? D.Media.Audio({ attrs:{ autoplay:true, src:SOUND_EFFECTS[feedbackType], class: tw`hidden`, key:`cue-${feedbackStamp}` }})
        : null;

      return D.Containers.Div({ attrs:{ class: `${tw`relative space-y-6`} game-panel` }}, [
        confettiLayer,
        playSection,
        infoSection,
        audioNode,
        cueAudio
      ].filter(Boolean));
    }

    function LogicGamePanel(db){
      const { TL } = makeLangLookup(db);
      const logic = db.data.logicGame || {};
      const challenge = logic.challenge;
      const hasChallenge = Array.isArray(challenge?.sequence);
      const bodySections = [];

      if (!hasChallenge){
        bodySections.push(
          D.Containers.Div({ attrs:{ class: tw`space-y-4 text-center py-8` }}, [
            D.Text.P({ attrs:{ class: tw`text-base text-[var(--muted-foreground)]` }}, [TL('logic.subtitle')]),
            UI.Button({ attrs:{ gkey:'logic:start', class: tw`rounded-full px-10 py-3 font-semibold` }, variant:'solid', size:'lg' }, [TL('logic.start')])
          ])
        );
      } else {
        bodySections.push(
          D.Containers.Div({ attrs:{ class: tw`flex justify-end` }}, [
            UI.Button({ attrs:{ gkey:'logic:start', class: tw`rounded-full px-6 font-semibold` }, variant:'soft', size:'sm' }, [TL('logic.newChallenge')])
          ])
        );
        const seqTiles = challenge.sequence.map((value, idx, arr)=>{
          const display = idx===arr.length-1 ? '؟' : String(value);
          return D.Containers.Div({ attrs:{ key:`logic-seq-${idx}`, class: `${tw`w-16 h-16 md:w-20 md:h-20 rounded-3xl grid place-items-center text-lg md:text-xl font-semibold`} glass-panel` }}, [display]);
        });
        bodySections.push(
          D.Containers.Div({ attrs:{ class: tw`space-y-3` }}, [
            D.Text.Span({ attrs:{ class: tw`text-sm text-[var(--muted-foreground)]` }}, [TL('logic.sequenceIntro')]),
            D.Containers.Div({ attrs:{ class: tw`flex flex-wrap items-center justify-center gap-3` }}, seqTiles)
          ])
        );
        const optionsList = Array.isArray(logic.options) && logic.options.length ? logic.options : (challenge.options || []);
        const optionButtons = optionsList.map((value)=>{
          const choice = Number(value);
          const isSelected = logic.selected === choice;
          const feedbackType = logic.feedback?.type;
          const correctChoice = choice === challenge.answer;
          const isCorrectSelection = feedbackType==='correct' && isSelected && correctChoice;
          const isWrongSelection = feedbackType==='wrong' && isSelected && !correctChoice;
          let variant = 'soft';
          if (isCorrectSelection) variant = 'solid';
          else if (isWrongSelection) variant = 'destructive';
          const classParts = [];
          if (isSelected) classParts.push(tw`ring-2 ring-offset-2 ring-[var(--ring)]`);
          const btnAttrs = {
            key:`logic-opt-${choice}`,
            gkey:'logic:answer',
            'data-choice': String(choice),
            class: classParts.length ? classParts.join(' ') : undefined
          };
          if (feedbackType==='correct') btnAttrs.disabled = 'disabled';
          return UI.Button({ attrs: btnAttrs, variant, size:'md' }, [String(choice)]);
        });
        bodySections.push(
          D.Containers.Div({ attrs:{ class: tw`space-y-3` }}, [
            D.Text.Span({ attrs:{ class: tw`text-sm text-[var(--muted-foreground)]` }}, [TL('logic.optionsPrompt')]),
            D.Containers.Div({ attrs:{ class: tw`grid grid-cols-2 sm:grid-cols-4 gap-3` }}, optionButtons)
          ])
        );
        if (logic.feedback){
          let explanationText = '';
          if (challenge.type==='arithmetic'){ explanationText = TL('logic.sequence.step').replace('{step}', String(challenge.meta?.step ?? '')); }
          else if (challenge.type==='square'){ explanationText = TL('logic.square.hint').replace('{start}', String(challenge.meta?.start ?? '')); }
          else { explanationText = TL('logic.double.hint'); }
          const badgeIcon = logic.feedback.type==='correct' ? '✅' : '🧐';
          bodySections.push(
            D.Containers.Div({ attrs:{ class: `${tw`rounded-3xl p-5 space-y-3`} glass-panel` }}, [
              UI.Badge({ attrs:{ class: tw`w-fit` }, leading: badgeIcon, text: TL(`logic.feedback.${logic.feedback.type}`) }),
              explanationText ? D.Text.P({ attrs:{ class: tw`text-sm text-[var(--muted-foreground)] leading-relaxed` }}, [explanationText]) : null,
              D.Text.P({ attrs:{ class: tw`text-xs text-[var(--muted-foreground)]` }}, [TL('logic.explanation'), ': ', String(challenge.answer)])
            ].filter(Boolean))
          );
        }
      }

      return UI.Card({
        title: TL('logic.title'),
        description: TL('logic.subtitle'),
        content: D.Containers.Div({ attrs:{ class: tw`space-y-6` }}, bodySections)
      });
    }

    function DesignLabPanel(db){
      const design = db.data.designLab || {};
      if (!design.open) return null;
      const { TL } = makeLangLookup(db);
      const prefs = normalizeThemePrefs(db.data.themePrefs || INITIAL_THEME_PREFS);
      const customVars = prefs.customVars || {};
      const activeTheme = db.env.theme || 'light';

      const modeButtons = DESIGN_LAB_THEME_MODES.map((mode)=>{
        const isActive = mode.id==='pink'
          ? activeTheme==='pink'
          : (activeTheme===mode.id || (mode.id==='light' && activeTheme!=='dark' && activeTheme!=='pink'));
        const btnVariant = isActive ? 'soft' : 'ghost';
        const btnClass = isActive ? tw`shadow-[0_16px_36px_-22px_rgba(79,70,229,0.55)]` : '';
        return UI.Button({
          attrs:{
            key:`mode-${mode.id}`,
            gkey:'design:theme',
            'data-mode':mode.id,
            class: btnClass
          },
          variant: btnVariant,
          size:'sm'
        }, [`${mode.icon} `, TL(mode.labelKey)]);
      });

      const unitFor = (def)=> def.unit || (def.prefKey==='fontScale' ? '%' : '');
      const parseNumericValue = (value, unit)=>{
        if (value == null) return null;
        if (typeof value === 'number') return value;
        const str = String(value).trim();
        if (!str) return null;
        if (unit && str.endsWith(unit)){
          const raw = str.slice(0, -unit.length);
          const num = parseFloat(raw);
          return Number.isNaN(num) ? null : num;
        }
        const num = parseFloat(str);
        return Number.isNaN(num) ? null : num;
      };

      const sectionNodes = DESIGN_VAR_GROUPS.map((group)=>{
        const rows = group.vars.map((name)=>{
          const def = DESIGN_VAR_DEF_MAP[name];
          if (!def) return null;
          const unit = unitFor(def);
          let baseline = def.prefKey==='fontScale'
            ? `${THEME_DEFAULT_PREFS.fontScale}${unit || ''}`
            : (CURRENT_THEME_BASELINE[name] || def.default || '');
          if (def.type === 'color'){
            const normalizedBase = U.Color && typeof U.Color.toHex === 'function' ? U.Color.toHex(baseline) : null;
            if (normalizedBase) baseline = normalizedBase;
          }
          const stored = def.prefKey ? null : (Object.prototype.hasOwnProperty.call(customVars, name) ? customVars[name] : null);
          const hasCustom = def.prefKey
            ? (def.prefKey==='fontScale' ? prefs.fontScale !== THEME_DEFAULT_PREFS.fontScale : false)
            : Object.prototype.hasOwnProperty.call(customVars, name);

          let currentValue;
          if (def.prefKey==='fontScale') currentValue = `${prefs.fontScale}${unit || ''}`;
          else if (stored != null && String(stored).trim()!=='') currentValue = String(stored).trim();
          else currentValue = baseline;
          if (def.type === 'color'){
            const normalizedCurrent = U.Color && typeof U.Color.toHex === 'function' ? U.Color.toHex(currentValue) : null;
            if (normalizedCurrent) currentValue = normalizedCurrent;
          }

          const labelNode = D.Containers.Div({ attrs:{ class:'design-lab-label' }}, [
            D.Text.Strong({}, [TL(def.labelKey)]),
            D.Text.Span({ attrs:{ class:'design-lab-meta' }}, [TL('designLab.defaultValue'), ': ', baseline || '—']),
            D.Text.Span({ attrs:{ class:'design-lab-meta' }}, [TL('designLab.currentValue'), ': ', currentValue || '—'])
          ]);

          const resetButton = D.Forms.Button({ attrs:{
            gkey:'design:var:reset',
            'data-var':name,
            disabled: hasCustom ? undefined : 'disabled',
            class:'design-lab-reset',
            title: TL('designLab.resetVar'),
            'aria-label': TL('designLab.resetVar')
          }}, ['↺']);

          const rowAttrs = { key:name, class:'design-lab-row', 'data-type': def.type };
          const rowChildren = [labelNode];

          if (def.type === 'color'){
            const colorValue = U.Color && typeof U.Color.toHex === 'function'
              ? (U.Color.toHex(stored || currentValue || baseline || def.default || '') || U.Color.toHex(def.default || '') || '#6366f1')
              : ((stored || currentValue || baseline || def.default || '#6366f1'));
            rowChildren.push(
              D.Containers.Div({ attrs:{ class:'design-lab-color-chip', style:`background:${colorValue}` }})
            );
            rowChildren.push(
              D.Inputs.Input({ attrs:{
                type:'color',
                value: colorValue,
                gkey:'design:var:update',
                'data-var':name,
                'data-editor':'color',
                class:'design-lab-color-input'
              }})
            );
            rowChildren.push(
              D.Inputs.Input({ attrs:{
                type:'text',
                value: currentValue || '',
                placeholder: baseline,
                gkey:'design:var:update',
                'data-var':name,
                'data-editor':'text',
                class:'design-lab-value-input'
              }})
            );
          } else if (def.type === 'range'){
            rowAttrs['data-type'] = 'range';
            let sliderValue;
            if (def.prefKey==='fontScale') sliderValue = prefs.fontScale;
            else {
              const baseValue = stored != null ? stored : (currentValue || baseline || def.default);
              sliderValue = parseNumericValue(baseValue, unit);
            }
            if (sliderValue == null || Number.isNaN(sliderValue)) sliderValue = def.min;
            const sliderAttrs = {
              type:'range',
              min:String(def.min),
              max:String(def.max),
              step:String(def.step),
              value:String(sliderValue),
              class:'design-lab-slider',
              'data-var':name
            };
            if (def.prefKey==='fontScale') sliderAttrs.gkey = 'prefs:fontScale';
            else {
              sliderAttrs.gkey = 'design:var:update';
              sliderAttrs['data-editor'] = 'range';
              if (unit) sliderAttrs['data-unit'] = unit;
            }
            const previewStyle = def.prefKey==='fontScale'
              ? `font-size: calc(var(--font-size-body) * ${sliderValue} / 100);`
              : `font-size: calc(var(${name}) * var(--user-font-scale) / 100);`;
            const factorText = def.prefKey==='fontScale'
              ? `× ${(sliderValue/100).toFixed(2)}`
              : 'Aa أب';
            rowChildren.push(
              D.Text.Span({ attrs:{ class:'design-lab-font-preview', style: previewStyle }}, [factorText])
            );
            rowChildren.push(
              D.Inputs.Input({ attrs: sliderAttrs })
            );
            const decimals = (String(def.step).split('.')[1] || '').length;
            const formattedNumber = decimals ? Number(sliderValue).toFixed(decimals) : String(Math.round(sliderValue));
            const numberAttrs = {
              type:'number',
              min:String(def.min),
              max:String(def.max),
              step:String(def.step),
              value: formattedNumber,
              class:'design-lab-number-input',
              'data-var':name
            };
            if (def.prefKey==='fontScale') numberAttrs.gkey = 'prefs:fontScale';
            else {
              numberAttrs.gkey = 'design:var:update';
              numberAttrs['data-editor'] = 'number';
              if (unit) numberAttrs['data-unit'] = unit;
            }
            rowChildren.push(
              D.Inputs.Input({ attrs: numberAttrs })
            );
          } else {
            rowAttrs['data-type'] = 'text';
            rowChildren.push(
              D.Inputs.Input({ attrs:{
                type:'text',
                value: currentValue || '',
                placeholder: baseline,
                gkey:'design:var:update',
                'data-var':name,
                'data-editor':'text',
                class:'design-lab-value-input'
              }})
            );
          }

          rowChildren.push(resetButton);
          return D.Containers.Div({ attrs: rowAttrs }, rowChildren.filter(Boolean));
        }).filter(Boolean);

        if (!rows.length) return null;
        return D.Containers.Div({ attrs:{ key:`group-${group.id}`, class: tw`space-y-3` }}, [
          D.Containers.Div({ attrs:{ class: tw`space-y-1` }}, [
            D.Text.H4({ attrs:{ class: tw`text-lg font-semibold` }}, [TL(group.labelKey)]),
            D.Text.Span({ attrs:{ class: tw`text-sm text-[var(--muted-foreground)]` }}, [TL(group.hintKey)])
          ]),
          D.Containers.Div({ attrs:{ class:'design-lab-grid' }}, rows)
        ]);
      }).filter(Boolean);

      return UI.Modal({
        open: true,
        title: TL('designLab.title'),
        description: TL('designLab.subtitle'),
        size:'xl',
        closeGkey:'design:lab:close',
        content: D.Containers.Div({ attrs:{ class: tw`space-y-6` }}, [
          D.Containers.Div({ attrs:{ class: tw`space-y-3` }}, [
            D.Text.H4({ attrs:{ class: tw`text-base font-semibold` }}, [TL('designLab.themeTitle')]),
            D.Text.Span({ attrs:{ class: tw`text-sm text-[var(--muted-foreground)]` }}, [TL('designLab.modeHint')]),
            D.Containers.Div({ attrs:{ class: tw`flex flex-wrap items-center gap-3` }}, modeButtons)
          ]),
          ...sectionNodes
        ]),
        actions:[
          UI.Button({ attrs:{ gkey:'design:var:resetAll' }, variant:'ghost', size:'sm' }, [TL('designLab.resetAll')]),
          UI.Button({ attrs:{ gkey:'design:lab:close' }, variant:'soft', size:'sm' }, [TL('settings.close')])
        ]
      });
    }

    function SettingsModal(db){
      if (!db.data.settingsOpen) return null;
      const { TL } = makeLangLookup(db);
      const g = db.data.game;
      const prefs = db.data.themePrefs || INITIAL_THEME_PREFS;
      const lang = db.env.lang || 'ar';
      const backgroundOptions = THEME_BACKGROUND_PRESETS.map((opt)=>({ value: opt.id, label: opt.label[lang] || opt.label.ar }));
      const textOptions = THEME_TEXT_SCHEMES.map((opt)=>({ value: opt.id, label: opt.label[lang] || opt.label.ar }));
      const mode = db.env.theme === 'dark' ? 'dark' : 'light';
      const bgPreset = (THEME_BACKGROUND_MAP[prefs.backgroundId] || THEME_BACKGROUND_MAP[THEME_DEFAULT_PREFS.backgroundId])[mode];

      const musicTile = D.Containers.Div({ attrs:{ class: 'settings-tile' }}, [
        UI.Badge({ attrs:{ class: tw`bg-transparent text-[var(--muted-foreground)]` }, leading:'🎵', text:TL('game.music') }),
        D.Containers.Div({ attrs:{ class: tw`flex items-center gap-2` }}, [
          UI.Input({ attrs:{ type:'checkbox', checked:g.musicOn, gkey:'game:music:toggle' } }),
          D.Text.Span({ attrs:{ class: tw`text-sm` }}, [TL(g.musicOn ? 'game.musicOn' : 'game.musicOff')])
        ]),
        UI.Select({ attrs:{ gkey:'game:music:select', value:String(g.audioIdx), class: tw`min-w-[200px]` }, options: g.audioList.map((it,i)=>({ value:String(i), label:it.name })) })
      ]);

      const timerTile = D.Containers.Div({ attrs:{ class: 'settings-tile' }}, [
        UI.Badge({ attrs:{ class: tw`bg-transparent text-[var(--muted-foreground)]` }, leading:'⏱️', text:TL('game.timer') }),
        D.Containers.Div({ attrs:{ class: tw`flex items-center gap-2` }}, [
          UI.Input({ attrs:{ type:'checkbox', checked:g.timerOn, gkey:'game:timer:toggle' } }),
          D.Text.Span({ attrs:{ class: tw`text-sm` }}, [TL(g.timerOn ? 'game.timerOn' : 'game.timerOff')])
        ]),
        D.Containers.Div({ attrs:{ class: tw`flex items-center gap-2` }}, [
          UI.Input({ attrs:{ type:'number', min:'5', step:'1', value:String(g.timerSec), style:'width:92px', gkey:'game:timer:value' } }),
          D.Text.Span({ attrs:{ class: tw`text-xs text-[var(--muted-foreground)]` }}, [TL('game.seconds')])
        ])
      ]);

      const themeControls = D.Containers.Div({ attrs:{ class: tw`space-y-4` }}, [
        D.Text.P({ attrs:{ class: tw`text-sm text-[var(--muted-foreground)]` }}, [TL('settings.previewHint')]),
        D.Containers.Div({ attrs:{ class: tw`flex flex-col gap-3 md:flex-row` }}, [
          UI.Select({ attrs:{ gkey:'prefs:background', value:prefs.backgroundId, class: tw`min-w-[220px]` }, options: backgroundOptions }),
          UI.Select({ attrs:{ gkey:'prefs:text', value:prefs.textSchemeId, class: tw`min-w-[220px]` }, options: textOptions })
        ]),
        D.Containers.Div({ attrs:{ class: tw`space-y-2` }}, [
          D.Text.Span({ attrs:{ class: tw`text-sm text-[var(--muted-foreground)]` }}, [TL('settings.fontLabel'), ': ', `${prefs.fontScale}%`]),
          D.Inputs.Input({ attrs:{ type:'range', min:'90', max:'120', step:'5', value:String(prefs.fontScale), gkey:'prefs:fontScale', class: tw`w-full accent-[var(--primary)]` }})
        ]),
        D.Text.Span({ attrs:{ class: tw`text-sm text-[var(--muted-foreground)]` }}, [TL('settings.previewLabel')]),
        D.Containers.Div({ attrs:{ class: tw`rounded-2xl h-36 glass-panel overflow-hidden` }}, [
          D.Containers.Div({ attrs:{ class: tw`w-full h-full` , style:`background:${bgPreset?.gradient || 'var(--page-gradient)'};` }})
        ])
      ]);

      return UI.Modal({
        open: true,
        title: TL('settings.title'),
        description: TL('settings.description'),
        size: 'lg',
        closeGkey: 'ui:settings:close',
        content: D.Containers.Div({ attrs:{ class: tw`space-y-8` }}, [
          D.Containers.Div({ attrs:{ class: tw`space-y-3` }}, [
            D.Text.H4({ attrs:{ class: tw`text-lg font-semibold` }}, [TL('settings.gameSection')]),
            D.Containers.Div({ attrs:{ class: tw`flex flex-col gap-4` }}, [musicTile, timerTile])
          ]),
          D.Containers.Div({ attrs:{ class: tw`space-y-3` }}, [
            D.Text.H4({ attrs:{ class: tw`text-lg font-semibold` }}, [TL('settings.themeSection')]),
            themeControls
          ])
        ]),
        actions: [
          UI.Button({ attrs:{ gkey:'prefs:reset', class: tw`flex-1` }, variant:'ghost', size:'sm' }, [TL('settings.reset')]),
          UI.Button({ attrs:{ gkey:'ui:settings:close', class: tw`flex-1` }, variant:'soft', size:'sm' }, [TL('settings.close')])
        ]
      });
    }

    function MainContent(db){
      const tab = db.data.activeTab;
      if (tab==='readmeBase') return DocPanel(db, 'base');
      if (tab==='readmeTec')  return DocPanel(db, 'tec');
      if (tab==='counter') return CounterPanel(db);
      if (tab==='game')    return GamePanel(db);
      if (tab==='logic')   return LogicGamePanel(db);
      return DocPanel(db, 'base');
    }
    
    // ----------------------------------------------------------------
    // الركن الثاني: العلم الفطري (`database` as DNA)
    // هذه هي قاعدة البيانات الأولية، الشفرة الوراثية للتطبيق.
    // هي تحدد الصفات الأولية والهيئة التي سيُخلق عليها الجسد.
    // ----------------------------------------------------------------
    const database = {
      env:{ theme:'dark', lang:'ar', dir:'rtl' },
      i18n:{ lang:'ar', fallback:'en', dict },
      data:{
        activeTab: 'readmeBase',
        docs: DOCS,
        counter: 0,
        settingsOpen: false,
        themePrefs: { ...INITIAL_THEME_PREFS },
        designLab:{ open:false },
        logicGame:{
          challenge: null,
          options: [],
          selected: null,
          feedback: null
        },
        game:{
          musicOn: true,
          timerOn: true,
          timerSec: 35,
          timeLeft: 35,
          triesMax: 5,
          triesLeft: 5,
          audioList: [
            { name:'Ghost Stories', url:'https://www.fesliyanstudios.com/musicfiles/2020-10-26_-_Ghost_Stories_-_www.FesliyanStudios.com_Steve_Oxen/2020-10-26_-_Ghost_Stories_-_www.FesliyanStudios.com_Steve_Oxen.mp3' },
            { name:'The Unsolved Mystery', url:'https://www.fesliyanstudios.com/musicfiles/2018-07-22_-_The_Unsolved_Murder_-_David_Fesliyan.mp3' },
            { name:'Dark Shadows', url:'https://www.fesliyanstudios.com/musicfiles/2020-06-25_-_Dark_Shadows_-_www.FesliyanStudios.com_David_Fesliyan/2020-06-25_-_Dark_Shadows_-_www.FesliyanStudios.com_David_Fesliyan.mp3' }
          ],
          audioIdx: 0,
          proverb: null,
          guessed: {},
          intervalId: null,
          status: 'idle', // idle | running | won | lost
          revealSolution: false,
          soundStamp: 0,
          feedback: null
        }
      },
      ui:{ modalOpen:false, drawerOpen:false, toasts:[] }
    };

    // ----------------------------------------------------------------
    // عملية التسوية: `setBody`
    // هنا يتم دمج "الطين" (المكونات) مع "العلم الفطري" (البيانات)
    // لإنتاج "جسد مُصوَّر" (Virtual DOM)، وهو مخطط دقيق للتطبيق
    // قبل أن تدب فيه الحياة.
    // ----------------------------------------------------------------
    Mishkah.app.setBody(function(db, h){
      db.head = { title: makeLangLookup(db).TL('app.title') };
      applyThemePrefs(db.data?.themePrefs || INITIAL_THEME_PREFS);
      const overlays = [];
      const modalNode = SettingsModal(db);
      const designLabNode = DesignLabPanel(db);
      if (designLabNode) overlays.push(designLabNode);
      if (modalNode) overlays.push(modalNode);
      if (db.ui?.toasts && db.ui.toasts.length){ overlays.push(UI.ToastHost({ toasts: db.ui.toasts })); }
      return UI.AppRoot({
        shell: D.Containers.Div({ attrs:{ class: `${tw`flex flex-col`} app-shell` }}, [
          HeaderBar(db),
          D.Containers.Div({ attrs:{ class: `${tw`flex-1 w-full`} content-shell` }}, [
            D.Containers.Div({ attrs:{ class: `${tw`w-full mx-auto flex flex-col lg:flex-row gap-8 px-6 pb-12 max-w-[1600px]`}` }}, [
              D.Containers.Aside({ attrs:{ class: `${tw`hidden lg:flex lg:w-[280px] lg:flex-col`}` }}, [
                D.Containers.Div({ attrs:{ class: tw`sticky top-28` }}, [ Sidebar(db) ])
              ]),
              D.Containers.Main({ attrs:{ class: `${tw`flex-1 min-h-0`} main-region`, style:'max-height:100vh;' }}, [
                D.Containers.Div({ attrs:{ class: tw`lg:hidden mb-6` }}, [ Sidebar(db) ]),
                D.Containers.Div({ attrs:{ class: tw`space-y-8` }}, [ MainContent(db) ])
              ])
            ])
          ])
        ]),
        overlays
      });
    });


    // ================================================================
    // الزوج الثاني: التمكين والتكليف (نفخ الروح والحياة)
    // هنا نمنح الجسد القدرة على التفاعل والنمو.
    // ================================================================

    // ----------------------------------------------------------------
    // الركن الأول: الإيمان (`database` as State)
    // نفس قاعدة البيانات التي كانت "DNA"، أصبحت الآن "الروح" الحية،
    // وهي مصدر الحقيقة الأوحد الذي يهتدي به التطبيق.
    // ----------------------------------------------------------------
    // (ملاحظة: الـ `database` معرف مسبقًا، هنا فقط نوضح دوره الجديد)

    // ----------------------------------------------------------------
    // الركن الثاني: العمل الصالح (`orders`)
    // هذه هي الأوامر والأفعال التي تحرك الجسد وتغير من حال "إيمانه".
    // كل "order" هو عمل صالح يستجيب لأحداث المستخدم ويُحدّث الحالة.
    // ----------------------------------------------------------------
    const KEEP_MAIN_SCROLL = { keepScroll:['.main-region'] };

    const orders = {
      // Routing
      'route:readmeBase':{ on:['click'], gkeys:['route:readmeBase'], handler:(e,ctx)=>{ const s=ctx.getState(); ctx.setState({...s, data:{...s.data, activeTab:'readmeBase' }});  }},
      'route:readmeTec' :{ on:['click'], gkeys:['route:readmeTec' ], handler:(e,ctx)=>{ const s=ctx.getState(); ctx.setState({...s, data:{...s.data, activeTab:'readmeTec'  }});  }},
      'route:counter'   :{ on:['click'], gkeys:['route:counter'],   handler:(e,ctx)=>{ const s=ctx.getState(); ctx.setState({...s, data:{...s.data, activeTab:'counter'}});  }},
      'route:game'      :{ on:['click'], gkeys:['route:game'],      handler:(e,ctx)=>{ const s=ctx.getState(); ctx.setState({...s, data:{...s.data, activeTab:'game'   }});  }},
      'route:logic'     :{ on:['click'], gkeys:['route:logic'],     handler:(e,ctx)=>{ const s=ctx.getState(); let lg = s.data.logicGame || {}; if (!lg.challenge){ const created = generateLogicChallenge(); lg = { challenge: created, options: created.options, selected:null, feedback:null }; } else { lg = { ...lg }; } ctx.setState({...s, data:{...s.data, activeTab:'logic', logicGame: lg }});  }},

      // Settings modal & theme preferences
      'ui:settings:toggle':{ on:['change'], gkeys:['ui:settings:toggle'], handler:(e,ctx)=>{ const open = !!(e && e.target && e.target.checked); const s=ctx.getState(); ctx.setState({...s, data:{...s.data, settingsOpen: open }}); ctx.flush(KEEP_MAIN_SCROLL); }},
      'ui:settings:open'  :{ on:['click'], gkeys:['ui:settings:open'], handler:(e,ctx)=>{ const s=ctx.getState(); if (s.data.settingsOpen) return; ctx.setState({...s, data:{...s.data, settingsOpen:true }}); ctx.flush(KEEP_MAIN_SCROLL); }},
      'ui:settings:close' :{ on:['click'], gkeys:['ui:settings:close'], handler:(e,ctx)=>{ const s=ctx.getState(); if (!s.data.settingsOpen) return; ctx.setState({...s, data:{...s.data, settingsOpen:false }}); ctx.flush(KEEP_MAIN_SCROLL); }},
      'theme:sync'        :{ on:['click'], gkeys:['ui:theme-toggle'], handler:(e,ctx)=>{ const prefs = ctx.getState().data?.themePrefs || INITIAL_THEME_PREFS; setTimeout(()=> applyThemePrefs(prefs), 0); }},
      'prefs:background'  :{ on:['change'], gkeys:['prefs:background'], handler:(e,ctx)=>{ const value = e && e.target ? e.target.value : null; if (!value) return; const s=ctx.getState(); const current = normalizeThemePrefs(s.data?.themePrefs || INITIAL_THEME_PREFS); if (current.backgroundId === value) { applyThemePrefs(current); return; } const next = normalizeThemePrefs({ ...current, backgroundId: value }); persistThemePrefs(next); ctx.setState({...s, data:{...s.data, themePrefs: next }}); applyThemePrefs(next); ctx.flush(KEEP_MAIN_SCROLL); }},
      'prefs:text'        :{ on:['change'], gkeys:['prefs:text'], handler:(e,ctx)=>{ const value = e && e.target ? e.target.value : null; if (!value) return; const s=ctx.getState(); const current = normalizeThemePrefs(s.data?.themePrefs || INITIAL_THEME_PREFS); if (current.textSchemeId === value) { applyThemePrefs(current); return; } const next = normalizeThemePrefs({ ...current, textSchemeId: value }); persistThemePrefs(next); ctx.setState({...s, data:{...s.data, themePrefs: next }}); applyThemePrefs(next); ctx.flush(KEEP_MAIN_SCROLL); }},
      'prefs:fontScale'   :{ on:['input','change'], gkeys:['prefs:fontScale'], handler:(e,ctx)=>{ const raw = e && e.target ? parseInt(e.target.value,10) : null; if (raw==null || Number.isNaN(raw)) return; const scale = Math.min(120, Math.max(90, raw)); const s=ctx.getState(); const current = normalizeThemePrefs(s.data?.themePrefs || INITIAL_THEME_PREFS); if (current.fontScale === scale) { applyThemePrefs(current); return; } const next = { ...current, fontScale: scale }; persistThemePrefs(next); ctx.setState({...s, data:{...s.data, themePrefs: next }}); applyThemePrefs(next); ctx.flush(KEEP_MAIN_SCROLL); }},
      'prefs:reset'       :{ on:['click'], gkeys:['prefs:reset'], handler:(e,ctx)=>{ const s=ctx.getState(); const next = { ...THEME_DEFAULT_PREFS }; persistThemePrefs(next); ctx.setState({...s, data:{...s.data, themePrefs: next }}); applyThemePrefs(next); ctx.flush(KEEP_MAIN_SCROLL); }},
      'ui:theme:set'     :{ on:['click'], gkeys:['ui:theme:set'], handler:(e,ctx)=>{
        const target = e && e.target ? e.target.closest('[data-value]') : null;
        if (!target) return;
        const modeRaw = target.getAttribute('data-value');
        if (!modeRaw) return;
        const mode = modeRaw === 'dark' ? 'dark' : 'light';
        const s=ctx.getState();
        const prefs = normalizeThemePrefs(s.data?.themePrefs || INITIAL_THEME_PREFS);
        U.twcss.setTheme(mode === 'dark' ? 'dark' : 'light');
        ctx.setState({
          ...s,
          env:{ ...(s.env||{}), theme: mode },
          data:{ ...s.data, themePrefs: prefs }
        });
        applyThemePrefs(prefs);
        ctx.flush(KEEP_MAIN_SCROLL);
      }},
      'design:lab:open'   :{ on:['click'], gkeys:['design:lab:open'], handler:(e,ctx)=>{ const s=ctx.getState(); if (s.data.designLab?.open) return; ctx.setState({...s, data:{...s.data, designLab:{ ...(s.data.designLab||{}), open:true }}}); ctx.flush(KEEP_MAIN_SCROLL); }},
      'design:lab:close'  :{ on:['click'], gkeys:['design:lab:close'], handler:(e,ctx)=>{ const s=ctx.getState(); if (!s.data.designLab?.open) return; ctx.setState({...s, data:{...s.data, designLab:{ ...(s.data.designLab||{}), open:false }}}); ctx.flush(KEEP_MAIN_SCROLL); }},
      'design:theme'      :{ on:['click'], gkeys:['design:theme'], handler:(e,ctx)=>{ const btn=e && e.target ? e.target.closest('[data-mode]'):null; const mode=btn?btn.getAttribute('data-mode'):null; if(!mode) return; const s=ctx.getState(); const prefs = normalizeThemePrefs(s.data?.themePrefs || INITIAL_THEME_PREFS); let nextPrefs = prefs; if (mode==='pink'){ nextPrefs = normalizeThemePrefs({ ...prefs, backgroundId:'sunset', textSchemeId:'warm' }); U.twcss.setTheme('light'); } else { U.twcss.setTheme(mode==='dark'?'dark':'light'); }
        const envTheme = mode;
        persistThemePrefs(nextPrefs);
        ctx.setState({...s, env:{ ...(s.env||{}), theme: envTheme }, data:{...s.data, themePrefs: nextPrefs, designLab:{ ...(s.data.designLab||{}), open:true }}});
        applyThemePrefs(nextPrefs);
        ctx.flush(KEEP_MAIN_SCROLL);
      }},
      'design:var:update' :{ on:['input','change'], gkeys:['design:var:update'], handler:(e,ctx)=>{
        const target = e && e.target ? e.target : null; if (!target) return;
        const name = target.getAttribute('data-var'); if (!name) return;
        const def = DESIGN_VAR_DEF_MAP[name];
        if (def && def.prefKey) return;
        const editor = target.getAttribute('data-editor') || 'text';
        let value = target.value;
        if (editor==='range'){
          const unit = target.getAttribute('data-unit') || '';
          const num = parseFloat(value);
          if (Number.isNaN(num)) return;
          value = unit ? `${num}${unit}` : String(num);
        } else if (editor==='number'){
          const unit = target.getAttribute('data-unit') || '';
          let num = parseFloat(value);
          if (Number.isNaN(num)) return;
          if (def && typeof def.min === 'number') num = Math.max(def.min, num);
          if (def && typeof def.max === 'number') num = Math.min(def.max, num);
          const stepPrecision = def && def.step != null ? String(def.step).split('.')[1]?.length || 0 : 0;
          if (stepPrecision > 0) num = parseFloat(num.toFixed(stepPrecision));
          value = unit ? `${num}${unit}` : String(num);
        } else if (editor==='text'){
          value = typeof value==='string' ? value.trim() : '';
        } else if (editor==='color'){
          if (!value) return;
        }
        const s=ctx.getState();
        const prefs = normalizeThemePrefs(s.data?.themePrefs || INITIAL_THEME_PREFS);
        const customVars = { ...(prefs.customVars || {}) };
        if (editor==='text' && value==='') delete customVars[name]; else customVars[name] = value;
        const next = { ...prefs, customVars };
        persistThemePrefs(next);
        ctx.setState({...s, data:{...s.data, themePrefs: next }});
        applyThemePrefs(next);
        ctx.flush(KEEP_MAIN_SCROLL);
      }},
      'design:var:reset'  :{ on:['click'], gkeys:['design:var:reset'], handler:(e,ctx)=>{
        const btn = e && e.target ? e.target.closest('[data-var]') : null; const name = btn ? btn.getAttribute('data-var') : null; if(!name) return;
        const def = DESIGN_VAR_DEF_MAP[name];
        const s=ctx.getState();
        const prefs = normalizeThemePrefs(s.data?.themePrefs || INITIAL_THEME_PREFS);
        let next;
        if (def && def.prefKey==='fontScale') next = { ...prefs, fontScale: THEME_DEFAULT_PREFS.fontScale };
        else {
          const customVars = { ...(prefs.customVars || {}) };
          delete customVars[name];
          next = { ...prefs, customVars };
        }
        persistThemePrefs(next);
        ctx.setState({...s, data:{...s.data, themePrefs: next }});
        applyThemePrefs(next);
        ctx.flush(KEEP_MAIN_SCROLL);
      }},
      'design:var:resetAll':{ on:['click'], gkeys:['design:var:resetAll'], handler:(e,ctx)=>{
        const s=ctx.getState();
        const prefs = normalizeThemePrefs(s.data?.themePrefs || INITIAL_THEME_PREFS);
        const next = { ...prefs, customVars:{}, fontScale: THEME_DEFAULT_PREFS.fontScale };
        persistThemePrefs(next);
        ctx.setState({...s, data:{...s.data, themePrefs: next }});
        applyThemePrefs(next);
        ctx.flush(KEEP_MAIN_SCROLL);
      }},

      // Logic challenge
      'logic:start'       :{ on:['click'], gkeys:['logic:start'], handler:(e,ctx)=>{ const s=ctx.getState(); const challenge = generateLogicChallenge(); const next = { challenge, options: challenge.options, selected:null, feedback:null }; ctx.setState({...s, data:{...s.data, logicGame: next }}); ctx.flush(KEEP_MAIN_SCROLL); }},
      'logic:answer'      :{ on:['click'], gkeys:['logic:answer'], handler:(e,ctx)=>{ const target = e && e.target && e.target.closest ? e.target.closest('[data-choice]') : null; if (!target) return; const choice = parseInt(target.getAttribute('data-choice'),10); if (Number.isNaN(choice)) return; const s=ctx.getState(); const lg = s.data.logicGame || {}; const challenge = lg.challenge; if (!challenge) return; if (lg.feedback && lg.feedback.type==='correct') return; const feedbackType = choice === challenge.answer ? 'correct' : 'wrong'; const feedback = { type: feedbackType, stamp: Date.now() }; const next = { ...lg, selected: choice, feedback }; ctx.setState({...s, data:{...s.data, logicGame: next }}); ctx.flush(KEEP_MAIN_SCROLL); }},

      // Counter
      'counter:inc'  :{ on:['click'], gkeys:['counter:inc'],   handler:(e,ctx)=>{ const s=ctx.getState(); ctx.setState({...s, data:{...s.data, counter:s.data.counter+1 }});  }},
      'counter:dec'  :{ on:['click'], gkeys:['counter:dec'],   handler:(e,ctx)=>{ const s=ctx.getState(); ctx.setState({...s, data:{...s.data, counter:s.data.counter-1 }});  }},
      'counter:reset':{ on:['click'], gkeys:['counter:reset'], handler:(e,ctx)=>{ const s=ctx.getState(); ctx.setState({...s, data:{...s.data, counter:0 }});  }},

      // Game toggles
      'game:music:toggle':{ on:['change'], gkeys:['game:music:toggle'], handler:(e,ctx)=>{
        const s=ctx.getState(); const g=s.data.game; const on = !!e.target.checked;
        const stamp = on ? Date.now() : g.soundStamp;
        ctx.setState({...s, data:{...s.data, game:{...g, musicOn:on, soundStamp: stamp }}}); ctx.flush(KEEP_MAIN_SCROLL);
      }},
      'game:music:select':{ on:['change'], gkeys:['game:music:select'], handler:(e,ctx)=>{
        const s=ctx.getState(); const g=s.data.game; const idx=Math.max(0,parseInt(e.target.value,10)||0);
        ctx.setState({...s, data:{...s.data, game:{...g, audioIdx: idx, soundStamp: Date.now() }}}); ctx.flush(KEEP_MAIN_SCROLL);
      }},
      'game:timer:toggle':{ on:['change'], gkeys:['game:timer:toggle'], handler:(e,ctx)=>{
        const s=ctx.getState(); const g=s.data.game; const on=!!e.target.checked; if(!on && g.intervalId) try{ clearInterval(g.intervalId); }catch(_){ }
        const timeLeft = on ? (g.status==='running' ? (typeof g.timeLeft === 'number' && g.timeLeft>0 ? g.timeLeft : g.timerSec) : g.timerSec) : 0;
        ctx.setState({...s, data:{...s.data, game:{...g, timerOn:on, timeLeft, intervalId: on ? g.intervalId : null }}}); ctx.flush(KEEP_MAIN_SCROLL);
      }},
      'game:timer:value':{ on:['input','change'], gkeys:['game:timer:value'], handler:(e,ctx)=>{
        const s=ctx.getState(); const g=s.data.game; const v=Math.max(5, parseInt(e.target.value,10)||g.timerSec);
        const timeLeft = g.timerOn ? (g.status==='running' ? v : v) : g.timeLeft;
        ctx.setState({...s, data:{...s.data, game:{...g, timerSec: v, timeLeft }}}); ctx.flush(KEEP_MAIN_SCROLL);
      }},

      // Start / New game
      'game:start':{ on:['click'], gkeys:['game:start'], handler:(e,ctx)=>{
        const s0=ctx.getState(); const g0=s0.data.game; if (g0.intervalId) try{ clearInterval(g0.intervalId); }catch(_){}
        const pv = PROVERBS[Math.floor(Math.random()*PROVERBS.length)];
        const stamp = Date.now();
        const baseTime = g0.timerOn ? g0.timerSec : 0;
        const g1 = { ...g0, proverb: pv, guessed:{}, triesLeft:g0.triesMax, status:'running', timeLeft: baseTime, intervalId:null, revealSolution:false, soundStamp: stamp, feedback:null };
        ctx.setState({ ...s0, data:{ ...s0.data, game:g1 } }); ctx.flush(KEEP_MAIN_SCROLL);

        if (g1.timerOn) {
          const iid = setInterval(()=>{
            const s=ctx.getState(); const g=s.data.game; if (g.status!=='running') { clearInterval(iid); return; }
            let timeLeft = typeof g.timeLeft === 'number' ? g.timeLeft - 1 : g.timerSec - 1;
            let triesLeft = g.triesLeft;
            let status = g.status;
            let feedback = g.feedback;
            if (timeLeft <= 0) {
              triesLeft = Math.max(0, triesLeft - 1);
              if (triesLeft === 0) {
                status = 'lost';
                timeLeft = 0;
                if (g.intervalId) try{ clearInterval(g.intervalId); }catch(_){}
                clearInterval(iid);
                feedback = { type:'lose', stamp: Date.now() };
              } else {
                timeLeft = g.timerSec;
                feedback = { type:'wrong', stamp: Date.now() };
              }
            }
            ctx.setState({ ...s, data:{ ...s.data, game:{ ...g, timeLeft, triesLeft, status, feedback, revealSolution: status==='won' ? true : g.revealSolution } }}); ctx.flush(KEEP_MAIN_SCROLL);
          }, 1000);
          const s1=ctx.getState(); const g2=s1.data.game;
          ctx.setState({ ...s1, data:{ ...s1.data, game:{ ...g2, intervalId:iid }}}); ctx.flush(KEEP_MAIN_SCROLL);
        }
      }},

      // Guess
      'game:guess':{ on:['click'], gkeys:['game:guess'], handler:(e,ctx)=>{
        const btn = e.target.closest && e.target.closest('[data-ch]'); if (!btn) return;
        const L = btn.getAttribute('data-ch'); if (!L) return;
        const s=ctx.getState(); const g=s.data.game; if (g.status!=='running' || !g.proverb) return;

        const guessed = { ...g.guessed, [L]: true };
        const target = g.proverb.t;
        const has = target.split('').some(raw => norm(raw)===L);

        let triesLeft = g.triesLeft, status = g.status;
        if (!has) {
          triesLeft=Math.max(0, triesLeft-1);
          if (triesLeft===0){ status='lost'; if (g.intervalId) try{ clearInterval(g.intervalId); }catch(_){ } }
        }
        else {
          const letters = new Set(target.split('').map(norm).filter(x=>x.trim()!=='' && x!==' '));
          const all = Array.from(letters).every(k => guessed[k]); if (all){ status='won'; if (g.intervalId) try{ clearInterval(g.intervalId); }catch(_){ } }
        }

        const timeLeft = g.timerOn ? (status==='lost' ? 0 : (typeof g.timeLeft === 'number' ? g.timeLeft : g.timerSec)) : 0;
        let feedbackType = has ? 'correct' : 'wrong';
        if (status==='won') feedbackType = 'win';
        if (status==='lost') feedbackType = 'lose';
        const feedback = feedbackType ? { type: feedbackType, stamp: Date.now() } : null;
        ctx.setState({ ...s, data:{ ...s.data, game:{ ...g, guessed, triesLeft, status,
          timeLeft,
          revealSolution: status==='won' ? true : g.revealSolution,
          feedback
        }}});
        ctx.flush(KEEP_MAIN_SCROLL);
        if (status === 'won'){
          U.Control.nextTick(()=>{
            U.DOM.focusById('game-solution-card');
            U.DOM.flashClass('game-solution-card', 'focus-pulse', 2200);
          });
        }
      }},
      'game:reveal':{ on:['click'], gkeys:['game:reveal'], handler:(e,ctx)=>{
        const s=ctx.getState(); const g=s.data.game; if (!g.proverb) return;
        ctx.setState({ ...s, data:{ ...s.data, game:{ ...g, revealSolution:true }}});
        ctx.flush(KEEP_MAIN_SCROLL);
        U.Control.nextTick(()=>{
          U.DOM.focusById('game-solution-card');
          U.DOM.flashClass('game-solution-card', 'focus-pulse', 2200);
        });
      }}
    };

    // ----------------------------------------------------------------
    // عملية الخلق: `createApp`
    // هنا يتم دمج "الإيمان" (database) مع "العمل الصالح" (orders)
    // لإنشاء كائن التطبيق الحي (`app`) القادر على التفاعل والنمو.
    // ----------------------------------------------------------------
    const app = Mishkah.app.createApp(database, orders);

    
    // ================================================================
    // مرحلة الإعدادات النهائية والبعث
    // ================================================================

    // ----------------------------------------------------------------
    // الإعداد التلقائي (Auto)
    // تهيئة البيئة المحيطة: الخطوط، الثيمات، اللغات، والأوامر المساعدة.
    // ----------------------------------------------------------------
    const twx = U.twcss.auto(database, app);

    // ----------------------------------------------------------------
    // دمج كل الأوامر (setOrders)
    // نجمع أوامر التطبيق الخاصة + أوامر الواجهة الجاهزة + أوامر البيئة.
    // ----------------------------------------------------------------
    app.setOrders({ ...orders, ...UI.orders, ...twx.orders });

    // ----------------------------------------------------------------
    // البعث (Mount)
    // اللحظة التي يظهر فيها الكائن الحي إلى العالم (DOM)،
    // ليبدأ رحلته في التفاعل مع المستخدم.
    // ----------------------------------------------------------------
    app.mount('#app');

  })();
  </script>
</body>
</html>
