<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>مشكاة — عداد HTMLx التلقائي</title>
    <script src="./mishkah.js" data-css="mishkah"></script>
  </head>
  <body>
    <div id="app"></div>

    <template id="auto-counter-demo">
      <section data-m-scope="auto-counter">
        <style data-m-scope>
          :host {
            display: flex;
            min-height: 100vh;
            background: linear-gradient(180deg, color-mix(in srgb, var(--mk-bg) 92%, var(--mk-surface-3) 8%), var(--mk-bg));
            color: var(--mk-fg);
            font-family: var(--mk-font-sans-ar);
            align-items: center;
            justify-content: center;
            padding: var(--mk-space-6);
          }

          .mk-auto-shell {
            inline-size: min(560px, 100%);
            display: grid;
            gap: var(--mk-space-5);
            padding: var(--mk-space-6);
            border-radius: var(--mk-radius-2xl);
            background: color-mix(in srgb, var(--mk-surface-1) 88%, var(--mk-surface-3) 12%);
            border: var(--mk-border-width) solid color-mix(in srgb, var(--mk-border) 70%, transparent);
            box-shadow: var(--mk-shadow-soft);
          }

          .mk-auto-head {
            display: grid;
            gap: var(--mk-space-3);
          }

          .mk-auto-head .mk-badge {
            justify-self: start;
            display: inline-flex;
            align-items: center;
            gap: var(--mk-space-2);
            padding-inline: var(--mk-space-3);
            padding-block: calc(var(--mk-space-1) * 1.2);
            border-radius: 999px;
            background: color-mix(in srgb, var(--mk-primary) 16%, transparent);
            color: var(--mk-primary);
            font-size: var(--mk-fs-sm);
            letter-spacing: 0.08em;
          }

          h1 {
            margin: 0;
            font-family: var(--mk-font-display);
            font-size: var(--mk-fs-3xl);
            line-height: 1.2;
          }

          .mk-lead {
            margin: 0;
            color: var(--mk-muted);
            font-size: var(--mk-fs-md);
          }

          .mk-switchers {
            display: flex;
            flex-wrap: wrap;
            gap: var(--mk-space-3);
            align-items: center;
          }

          lang-switcher,
          theme-switcher,
          lang-select,
          theme-select {
            display: block;
          }

          .mk-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: var(--mk-space-4);
            padding: var(--mk-space-4);
            border-radius: var(--mk-radius-xl);
            background: color-mix(in srgb, var(--mk-surface-0) 55%, transparent);
            border: var(--mk-border-width) solid color-mix(in srgb, var(--mk-border) 50%, transparent);
          }

          .mk-status-block {
            display: grid;
            gap: calc(var(--mk-space-1) * 2);
          }

          .mk-status-label {
            font-size: var(--mk-fs-sm);
            color: var(--mk-muted);
          }

          .mk-status-value {
            font-size: var(--mk-fs-xl);
            font-weight: 600;
            letter-spacing: 0.02em;
          }

          .mk-card {
            display: grid;
            gap: var(--mk-space-4);
            padding: var(--mk-space-5);
            border-radius: var(--mk-radius-xl);
            background: color-mix(in srgb, var(--mk-surface-2) 88%, transparent);
            border: var(--mk-border-width) solid color-mix(in srgb, var(--mk-border) 65%, transparent);
            box-shadow: var(--mk-shadow);
          }

          .mk-counter-value {
            display: grid;
            place-items: center;
            font-size: clamp(var(--mk-fs-3xl), 4vw, 3rem);
            font-weight: 700;
            padding: var(--mk-space-4);
            border-radius: var(--mk-radius-lg);
            background: color-mix(in srgb, var(--mk-primary) 18%, transparent);
            color: var(--mk-primary-contrast);
          }

          .mk-actions {
            display: flex;
            flex-wrap: wrap;
            gap: var(--mk-space-3);
            justify-content: center;
          }

          .mk-actions .mk-btn {
            min-inline-size: 120px;
            padding-block: calc(var(--mk-space-2) * 1.6);
            padding-inline: var(--mk-space-4);
            font-weight: 600;
            font-size: var(--mk-fs-md);
          }

          .mk-history {
            display: grid;
            gap: var(--mk-space-3);
          }

          .mk-history-list {
            list-style: none;
            display: grid;
            gap: var(--mk-space-2);
            padding: 0;
            margin: 0;
          }

          .mk-history-item {
            display: grid;
            grid-template-columns: auto auto;
            gap: var(--mk-space-2);
            align-items: center;
            padding: var(--mk-space-3);
            border-radius: var(--mk-radius-md);
            background: color-mix(in srgb, var(--mk-surface-1) 82%, transparent);
            border: var(--mk-border-width) solid color-mix(in srgb, var(--mk-border) 60%, transparent);
          }

          .mk-history-item strong {
            font-weight: 600;
          }

          .mk-history-item time {
            font-size: var(--mk-fs-sm);
            color: var(--mk-muted);
          }

          .mk-history-item .mk-delta {
            justify-self: end;
            font-family: var(--mk-font-display);
          }

          .mk-auto-foot {
            display: grid;
            gap: var(--mk-space-3);
          }

          .mk-auto-foot .mk-select-row {
            display: grid;
            gap: var(--mk-space-3);
          }

          @media (min-width: 520px) {
            .mk-auto-foot .mk-select-row {
              grid-template-columns: repeat(2, minmax(0, 1fr));
            }
          }
        </style>

        <script type="application/json" data-m-env>
          {
            "theme": "light",
            "lang": "ar",
            "dir": "rtl"
          }
        </script>

        <script type="application/json" data-m-data data-m-path="head">
          {
            "title": "مشكاة — عداد HTMLx التلقائي"
          }
        </script>

        <script type="application/json" data-m-data data-m-path="i18n.strings">
          {
            "app.badge": { "ar": "HTMLx Auto", "en": "HTMLx Auto" },
            "app.title": { "ar": "عداد متعدد اللغات", "en": "Multilingual Counter" },
            "app.subtitle": {
              "ar": "جرّب التبديل بين اللغات والثيمات، كل شيء يعمل تلقائيًا.",
              "en": "Toggle languages and themes — everything wires itself."
            },
            "status.language": { "ar": "اللغة الحالية", "en": "Active language" },
            "status.theme": { "ar": "الثيم الحالي", "en": "Active theme" },
            "counter.valueLabel": { "ar": "قيمة العداد", "en": "Counter value" },
            "counter.hint": {
              "ar": "الأزرار التالية تستخدم أوامر Mishkah و HTMLx معًا.",
              "en": "The buttons below rely on Mishkah orders and HTMLx together."
            },
            "actions.increment": { "ar": "⬆️ زيادة", "en": "⬆️ Increase" },
            "actions.decrement": { "ar": "⬇️ إنقاص", "en": "⬇️ Decrease" },
            "actions.reset": { "ar": "🔄 إعادة الضبط", "en": "🔄 Reset" },
            "history.title": { "ar": "سجل الحركات", "en": "Action log" },
            "history.empty": {
              "ar": "ابدأ باستخدام الأزرار وستظهر الحركة هنا.",
              "en": "Use the controls and entries will appear here."
            },
            "footer.langSelect": { "ar": "اختيار لغة موسع", "en": "Extended language select" },
            "footer.themeSelect": { "ar": "اختيار الثيم", "en": "Theme select" }
          }
        </script>

        <script type="application/json" data-m-data data-m-path="data.counter">
          {
            "value": 1,
            "initial": 1,
            "history": []
          }
        </script>

        <script type="application/json" data-m-data data-m-path="data.copy.history">
          {
            "increment": {
              "ar": "تمت زيادة العداد",
              "en": "Counter incremented"
            },
            "decrement": {
              "ar": "تم إنقاص العداد",
              "en": "Counter decreased"
            },
            "reset": {
              "ar": "إعادة ضبط العداد",
              "en": "Counter reset"
            }
          }
        </script>

        <script type="application/json" data-m-data data-m-path="data.labels.lang">
          {
            "ar": { "ar": "العربية", "en": "Arabic" },
            "en": { "ar": "الإنجليزية", "en": "English" },
            "fr": { "ar": "الفرنسية", "en": "French" },
            "tr": { "ar": "التركية", "en": "Turkish" },
            "du": { "ar": "الهولندية", "en": "Dutch" }
          }
        </script>

        <script type="application/json" data-m-data data-m-path="data.labels.theme">
          {
            "light": { "ar": "فاتح", "en": "Light" },
            "dark": { "ar": "داكن", "en": "Dark" },
            "sunny": { "ar": "مشمس", "en": "Sunny" }
          }
        </script>

        <div class="mk-auto-shell">
          <header class="mk-auto-head">
            <span class="mk-badge" data-tone="muted">{trans('app.badge')}</span>
            <h1>{trans('app.title')}</h1>
            <p class="mk-lead">{trans('app.subtitle')}</p>
            <div class="mk-switchers">
              <lang-switcher langs="ar,en"></lang-switcher>
              <theme-switcher themes="light,dark,sunny"></theme-switcher>
            </div>
          </header>

          <section class="mk-status">
            <div class="mk-status-block">
              <span class="mk-status-label">{trans('status.language')}</span>
              <span class="mk-status-value">{currentLanguageLabel(ctx)}</span>
            </div>
            <div class="mk-status-block">
              <span class="mk-status-label">{trans('status.theme')}</span>
              <span class="mk-status-value">{currentThemeLabel(ctx)}</span>
            </div>
          </section>

          <section class="mk-card">
            <header>
              <h2>{trans('counter.valueLabel')}</h2>
              <p>{trans('counter.hint')}</p>
            </header>
            <div class="mk-counter-value">{state.data.counter.value}</div>
            <div class="mk-actions">
              <button class="mk-btn" data-variant="primary" onclick="increment(event, ctx)">{trans('actions.increment')}</button>
              <button class="mk-btn" data-variant="secondary" onclick="reset(event, ctx)">{trans('actions.reset')}</button>
              <button class="mk-btn" data-variant="secondary" onclick="decrement(event, ctx)">{trans('actions.decrement')}</button>
            </div>
          </section>

          <section class="mk-history">
            <h2>{trans('history.title')}</h2>
            <p x-if="!state.data.counter.history.length">{trans('history.empty')}</p>
            <ul class="mk-history-list" x-if="state.data.counter.history.length">
              <li class="mk-history-item" x-for="entry in state.data.counter.history" key="entry.id">
                <div>
                  <strong>{historyEntryLabel(entry, ctx)}</strong>
                  <time>{entry.time}</time>
                </div>
                <span class="mk-delta">{entry.delta > 0 ? '+' + entry.delta : entry.delta}</span>
              </li>
            </ul>
          </section>

          <footer class="mk-auto-foot">
            <div class="mk-select-row">
              <lang-select langs="ar,en,fr,tr,du" label="{trans('footer.langSelect')}"></lang-select>
              <theme-select themes="light,dark,sunny" label="{trans('footer.themeSelect')}"></theme-select>
            </div>
          </footer>
        </div>

        <script>
          function cloneState(prev) {
            try {
              return JSON.parse(JSON.stringify(prev || {}));
            } catch (_error) {
              return prev ? Object.assign({}, prev) : {};
            }
          }

          function commit(ctx, mutate, after) {
            if (!ctx || typeof ctx.setState !== 'function') return;
            ctx.setState(function (prev) {
              var draft = cloneState(prev);
              if (typeof mutate === 'function') {
                mutate(draft, prev || {});
              }
              return draft;
            });
            if (typeof after === 'function') {
              window.setTimeout(function () {
                try {
                  after(ctx.getState(), ctx);
                } catch (_error) {}
              }, 0);
            }
          }

          function resolveLocale(lang) {
            if (!lang) return 'en-US';
            if (lang === 'ar') return 'ar-EG';
            if (lang === 'en') return 'en-US';
            return lang + '-' + lang.toUpperCase();
          }

          function timestamp(ctx) {
            var lang = ctx.get('env.lang') || 'ar';
            try {
              var formatter = new Intl.DateTimeFormat(resolveLocale(lang), {
                hour: '2-digit',
                minute: '2-digit'
              });
              return formatter.format(new Date());
            } catch (error) {
              return new Date().toLocaleTimeString();
            }
          }

          function getState(ctx) {
            return (ctx && typeof ctx.getState === 'function') ? ctx.getState() : null;
          }

          function currentLanguageLabel(ctx) {
            var state = getState(ctx);
            var lang = (state && state.env && state.env.lang) || 'en';
            var labels = state && state.data && state.data.labels && state.data.labels.lang;
            var langEntry = labels && labels[lang];
            if (langEntry && (langEntry[lang] || langEntry.en)) {
              return langEntry[lang] || langEntry.en;
            }
            return lang;
          }

          function currentThemeLabel(ctx) {
            var state = getState(ctx);
            var theme = (state && state.env && state.env.theme) || 'light';
            var lang = (state && state.env && state.env.lang) || 'en';
            var labels = state && state.data && state.data.labels && state.data.labels.theme;
            var themeEntry = labels && labels[theme];
            if (themeEntry && (themeEntry[lang] || themeEntry.en)) {
              return themeEntry[lang] || themeEntry.en;
            }
            return theme;
          }

          function historyEntryLabel(entry, ctx) {
            if (!entry) return '';
            var state = getState(ctx);
            var lang = (state && state.env && state.env.lang) || 'en';
            var historyCopy = state && state.data && state.data.copy && state.data.copy.history;
            var entryCopy = historyCopy && historyCopy[entry.kind];
            if (entryCopy && (entryCopy[lang] || entryCopy.en)) {
              return entryCopy[lang] || entryCopy.en;
            }
            return entry.kind;
          }

          function applyDelta(ctx, amount, kind) {
            var stamp = timestamp(ctx);
            commit(ctx, function (draft) {
              draft.data = draft.data || {};
              draft.data.counter = draft.data.counter || { value: 0, history: [] };
              var counter = draft.data.counter;
              counter.value = (counter.value || 0) + amount;
              if (!Array.isArray(counter.history)) counter.history = [];
              counter.history.unshift({
                id: 'entry-' + Date.now() + '-' + Math.floor(Math.random() * 1000),
                delta: amount,
                kind: kind,
                time: stamp
              });
              counter.history = counter.history.slice(0, 6);
            });
          }

          function increment(event, ctx) {
            applyDelta(ctx, 1, 'increment');
          }

          function decrement(event, ctx) {
            applyDelta(ctx, -1, 'decrement');
          }

          function reset(event, ctx) {
            var initial = ctx.get('data.counter.initial') || 0;
            var stamp = timestamp(ctx);
            commit(ctx, function (draft) {
              draft.data = draft.data || {};
              draft.data.counter = draft.data.counter || { value: 0, history: [] };
              var counter = draft.data.counter;
              counter.value = initial;
              if (!Array.isArray(counter.history)) counter.history = [];
              counter.history.unshift({
                id: 'entry-' + Date.now() + '-reset',
                delta: 0,
                kind: 'reset',
                time: stamp
              });
              counter.history = counter.history.slice(0, 6);
            });
          }

          function __init__(ctx) {}
        </script>
      </section>
    </template>

    <script>
      if (window.Mishkah && window.Mishkah.auto && typeof window.Mishkah.auto.make === 'function') {
        window.Mishkah.auto.make().catch(function (error) {
          console.error('Failed to start Mishkah auto counter demo:', error);
        });
      } else {
        window.addEventListener('mishkah:auto-ready', function handleAutoReady() {
          window.removeEventListener('mishkah:auto-ready', handleAutoReady);
          window.Mishkah.auto.make().catch(function (error) {
            console.error('Failed to start Mishkah auto counter demo:', error);
          });
        });
      }
    </script>
  </body>
</html>
