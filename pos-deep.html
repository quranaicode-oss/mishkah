<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø·Ø§Ø¹Ù… - Mishkah POS</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="mishkah-theme-v5.css">
    <style>
        /* Tailwind-like utilities for Mishkah */
        .flex { display: flex; }
        .hidden { display: none; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .p-2 { padding: 0.5rem; }
        .p-4 { padding: 1rem; }
        .m-2 { margin: 0.5rem; }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .text-center { text-align: center; }
        .rounded { border-radius: 0.25rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .border { border: 1px solid var(--border-default); }
        .grid { display: grid; }
        .grid-cols-4 { grid-template-columns: repeat(4, 1fr); }
        .col-span-3 { grid-column: span 3; }
        .cursor-pointer { cursor: pointer; }
        .transition { transition: var(--transition-default); }
        
        /* POS Specific Styles */
        .pos-container {
            height: 100vh;
            background: var(--bg-page);
            color: var(--text-default);
            font-family: var(--font-sans);
        }
        
        .category-btn.active {
            background: var(--primary);
            color: var(--text-on-primary);
        }
        
        .item-card {
            background: var(--bg-surface);
            border-radius: var(--radius-lg);
            overflow: hidden;
            transition: var(--transition-default);
        }
        
        .item-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .order-item {
            border-bottom: 1px solid var(--border-default);
            padding: 0.75rem 0;
        }
        
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* RTL/LTR Support */
        [dir="rtl"] .text-left { text-align: right; }
        [dir="ltr"] .text-left { text-align: left; }
    </style>
</head>
<body>
    <div id="app"></div>

    <!-- Mishkah Libraries -->
    <script src="mishkah-core-v5.js"></script>
    <script src="mishkah-dsl-v5.js"></script>
    <script src="pos-mock-data.js"></script>

    <script>
        // POS Application using Mishkah DSL
        const POSApp = window.Mishkah.DSL.create({
            initial: {
                // Authentication
                currentEmployee: null,
                loginError: null,
                
                // Order Management
                currentOrder: {
                    items: [],
                    type: 'dine-in', // dine-in, takeaway, delivery
                    tableId: null,
                    customerInfo: {},
                    notes: '',
                    discount: 0,
                    status: 'open'
                },
                
                // UI State
                activeCategory: 'all',
                selectedTable: null,
                view: 'login', // login, pos, orders, management
                
                // Data
                categories: database.categories,
                menuItems: database.items,
                tables: database.tables,
                employees: database.employees
            },
            dictionaries: {
                // Arabic/English translations
                login: {
                    ar: 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„',
                    en: 'Login'
                },
                pin_code: {
                    ar: 'ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„',
                    en: 'PIN Code'
                },
                welcome: {
                    ar: 'Ù…Ø±Ø­Ø¨Ø§Ù‹',
                    en: 'Welcome'
                },
                total: {
                    ar: 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ',
                    en: 'Total'
                },
                // ... more translations
            }
        });

        // Define POS Module
        POSApp.module('pos-system')
            .state({
                // State is inherited from main app
            })
            .actions({
                // Authentication
                login: (state, pinCode) => {
                    const employee = state.employees.find(emp => emp.pin_code === pinCode);
                    if (employee) {
                        return {
                            ...state,
                            currentEmployee: employee,
                            loginError: null,
                            view: 'pos'
                        };
                    }
                    return {
                        ...state,
                        loginError: 'Invalid PIN code'
                    };
                },
                
                logout: (state) => ({
                    ...state,
                    currentEmployee: null,
                    view: 'login'
                }),
                
                // Order Management
                addToOrder: (state, itemId, modifiers = {}) => {
                    const item = state.menuItems.find(i => i.id === itemId);
                    if (!item) return state;
                    
                    const existingItem = state.currentOrder.items.find(i => 
                        i.id === itemId && JSON.stringify(i.modifiers) === JSON.stringify(modifiers)
                    );
                    
                    const newItems = existingItem 
                        ? state.currentOrder.items.map(i => 
                            i.id === itemId && JSON.stringify(i.modifiers) === JSON.stringify(modifiers)
                                ? { ...i, quantity: i.quantity + 1 }
                                : i
                          )
                        : [...state.currentOrder.items, {
                            ...item,
                            quantity: 1,
                            modifiers,
                            totalPrice: item.price
                        }];
                    
                    return {
                        ...state,
                        currentOrder: {
                            ...state.currentOrder,
                            items: newItems
                        }
                    };
                },
                
                updateQuantity: (state, itemIndex, newQuantity) => {
                    if (newQuantity < 1) {
                        return {
                            ...state,
                            currentOrder: {
                                ...state.currentOrder,
                                items: state.currentOrder.items.filter((_, i) => i !== itemIndex)
                            }
                        };
                    }
                    
                    const newItems = state.currentOrder.items.map((item, i) => 
                        i === itemIndex ? { ...item, quantity: newQuantity } : item
                    );
                    
                    return {
                        ...state,
                        currentOrder: {
                            ...state.currentOrder,
                            items: newItems
                        }
                    };
                },
                
                setOrderType: (state, orderType) => ({
                    ...state,
                    currentOrder: {
                        ...state.currentOrder,
                        type: orderType
                    }
                }),
                
                selectTable: (state, tableId) => ({
                    ...state,
                    selectedTable: tableId,
                    currentOrder: {
                        ...state.currentOrder,
                        tableId: tableId
                    }
                }),
                
                applyDiscount: (state, discount) => ({
                    ...state,
                    currentOrder: {
                        ...state.currentOrder,
                        discount: Math.min(discount, state.currentEmployee?.allowed_discount_rate || 0)
                    }
                }),
                
                // UI Actions
                setActiveCategory: (state, categoryId) => ({
                    ...state,
                    activeCategory: categoryId
                }),
                
                setView: (state, view) => ({
                    ...state,
                    view: view
                })
            })
            .selectors({
                orderTotal: (state) => {
                    const subtotal = state.currentOrder.items.reduce((sum, item) => 
                        sum + (item.price * item.quantity), 0
                    );
                    const discountAmount = subtotal * state.currentOrder.discount;
                    const tax = (subtotal - discountAmount) * database.settings.tax_rate;
                    const serviceCharge = (subtotal - discountAmount) * database.settings.service_charge_rate;
                    
                    return {
                        subtotal,
                        discount: discountAmount,
                        tax,
                        serviceCharge,
                        total: subtotal - discountAmount + tax + serviceCharge
                    };
                },
                
                filteredItems: (state) => {
                    if (state.activeCategory === 'all') return state.menuItems;
                    return state.menuItems.filter(item => item.category === state.activeCategory);
                },
                
                availableTables: (state) => {
                    return state.tables.filter(table => table.status === 'available');
                }
            })
            .view((state, actions, selectors, ctx) => {
                // Main POS View Router
                if (state.view === 'login') {
                    return LoginView(state, actions, ctx);
                }
                
                return MainPOSView(state, actions, selectors, ctx);
            })
            .mount('#app');

        // View Components
        function LoginView(state, actions, ctx) {
            return window.Mishkah.Atoms.div({
                tw: "flex items-center justify-center h-full bg-gradient-to-br from-primary-soft to-bg-surface"
            }, {
                default: [
                    window.Mishkah.Atoms.div({
                        tw: "bg-surface rounded-lg shadow-md p-8 w-96"
                    }, {
                        default: [
                            window.Mishkah.Atoms.h1({
                                tw: "text-2xl font-bold text-center mb-6"
                            }, {
                                default: [ctx.i18n.t('login')]
                            }),
                            
                            state.loginError && window.Mishkah.Atoms.div({
                                tw: "bg-danger-soft text-danger p-3 rounded mb-4"
                            }, {
                                default: [state.loginError]
                            }),
                            
                            window.Mishkah.Atoms.input({
                                type: "password",
                                placeholder: ctx.i18n.t('pin_code'),
                                onInput: (e) => ctx.truth.set(s => ({ ...s, loginPin: e.target.value })),
                                tw: "w-full p-3 border rounded mb-4 text-center font-mono text-2xl"
                            }),
                            
                            window.Mishkah.Atoms.button({
                                onclick: () => actions.login(state.loginPin || ''),
                                tw: "w-full bg-primary text-on-primary p-3 rounded font-bold hover:bg-primary-hover transition"
                            }, {
                                default: [ctx.i18n.t('login')]
                            })
                        ]
                    })
                ]
            });
        }

        function MainPOSView(state, actions, selectors, ctx) {
            return window.Mishkah.Atoms.div({
                tw: "h-full grid grid-cols-4 gap-0"
            }, {
                default: [
                    // Sidebar - Categories and Tables
                    window.Mishkah.Atoms.div({
                        tw: "col-span-1 bg-ui flex flex-col h-full"
                    }, {
                        default: [
                            // Employee Info
                            window.Mishkah.Atoms.div({
                                tw: "p-4 border-b border-default"
                            }, {
                                default: [
                                    window.Mishkah.Atoms.div({
                                        tw: "font-bold"
                                    }, {
                                        default: [`${ctx.i18n.t('welcome')}, ${state.currentEmployee.full_name}`]
                                    }),
                                    window.Mishkah.Atoms.button({
                                        onclick: actions.logout,
                                        tw: "text-sm text-subtle hover:text-default mt-2"
                                    }, {
                                        default: ['Logout']
                                    })
                                ]
                            }),
                            
                            // Order Type Selector
                            window.Mishkah.Atoms.div({
                                tw: "p-4 border-b border-default"
                            }, {
                                default: [
                                    window.Mishkah.Atoms.div({
                                        tw: "font-bold mb-2"
                                    }, {
                                        default: ['Order Type']
                                    }),
                                    window.Mishkah.Atoms.div({
                                        tw: "flex gap-2"
                                    }, {
                                        default: ['Dine-in', 'Takeaway', 'Delivery'].map(type => 
                                            window.Mishkah.Atoms.button({
                                                tw: `flex-1 p-2 rounded text-sm ${state.currentOrder.type === type.toLowerCase() ? 'bg-primary text-on-primary' : 'bg-ui-hover'}`,
                                                onclick: () => actions.setOrderType(type.toLowerCase())
                                            }, {
                                                default: [type]
                                            })
                                        )
                                    })
                                ]
                            }),
                            
                            // Tables (for dine-in)
                            state.currentOrder.type === 'dine-in' && window.Mishkah.Atoms.div({
                                tw: "p-4 border-b border-default"
                            }, {
                                default: [
                                    window.Mishkah.Atoms.div({
                                        tw: "font-bold mb-2"
                                    }, {
                                        default: ['Select Table']
                                    }),
                                    window.Mishkah.Atoms.div({
                                        tw: "grid grid-cols-2 gap-2"
                                    }, {
                                        default: selectors.availableTables(state).map(table =>
                                            window.Mishkah.Atoms.button({
                                                tw: `p-3 rounded ${state.selectedTable === table.id ? 'bg-primary text-on-primary' : 'bg-surface'}`,
                                                onclick: () => actions.selectTable(table.id)
                                            }, {
                                                default: [table.name]
                                            })
                                        )
                                    })
                                ]
                            }),
                            
                            // Categories
                            window.Mishkah.Atoms.div({
                                tw: "flex-1 overflow-y-auto"
                            }, {
                                default: state.categories.map(category =>
                                    window.Mishkah.Atoms.button({
                                        tw: `w-full p-4 text-left border-b border-default transition ${state.activeCategory === category.id ? 'bg-primary text-on-primary' : 'hover:bg-ui-hover'}`,
                                        onclick: () => actions.setActiveCategory(category.id)
                                    }, {
                                        default: [category.translations[ctx.env.get().locale] || category.translations.en]
                                    })
                                )
                            })
                        ]
                    }),
                    
                    // Main Content - Menu Items
                    window.Mishkah.Atoms.div({
                        tw: "col-span-2 bg-surface p-4 overflow-y-auto"
                    }, {
                        default: [
                            window.Mishkah.Atoms.div({
                                tw: "grid grid-cols-2 gap-4"
                            }, {
                                default: selectors.filteredItems(state).map(item =>
                                    window.Mishkah.Atoms.div({
                                        tw: "item-card cursor-pointer",
                                        onclick: () => actions.addToOrder(item.id)
                                    }, {
                                        default: [
                                            window.Mishkah.Atoms.img({
                                                src: item.image,
                                                tw: "w-full h-32 object-cover"
                                            }),
                                            window.Mishkah.Atoms.div({
                                                tw: "p-3"
                                            }, {
                                                default: [
                                                    window.Mishkah.Atoms.div({
                                                        tw: "font-bold"
                                                    }, {
                                                        default: [item.translations[ctx.env.get().locale]?.name || item.translations.en.name]
                                                    }),
                                                    window.Mishkah.Atoms.div({
                                                        tw: "text-sm text-subtle mb-2"
                                                    }, {
                                                        default: [item.translations[ctx.env.get().locale]?.description || item.translations.en.description]
                                                    }),
                                                    window.Mishkah.Atoms.div({
                                                        tw: "font-bold text-primary"
                                                    }, {
                                                        default: [`${item.price} ${database.settings.currency[ctx.env.get().locale]}`]
                                                    })
                                                ]
                                            })
                                        ]
                                    })
                                )
                            })
                        ]
                    }),
                    
                    // Order Panel
                    window.Mishkah.Atoms.div({
                        tw: "col-span-1 bg-ui border-l border-default flex flex-col"
                    }, {
                        default: [
                            // Order Header
                            window.Mishkah.Atoms.div({
                                tw: "p-4 border-b border-default"
                            }, {
                                default: [
                                    window.Mishkah.Atoms.div({
                                        tw: "font-bold text-lg"
                                    }, {
                                        default: ['Current Order']
                                    }),
                                    state.currentOrder.tableId && window.Mishkah.Atoms.div({
                                        tw: "text-sm text-subtle"
                                    }, {
                                        default: [`Table: ${state.tables.find(t => t.id === state.currentOrder.tableId)?.name}`]
                                    })
                                ]
                            }),
                            
                            // Order Items
                            window.Mishkah.Atoms.div({
                                tw: "flex-1 overflow-y-auto p-4"
                            }, {
                                default: state.currentOrder.items.length === 0 ? [
                                    window.Mishkah.Atoms.div({
                                        tw: "text-center text-subtle py-8"
                                    }, {
                                        default: ['No items in order']
                                    })
                                ] : state.currentOrder.items.map((item, index) =>
                                    window.Mishkah.Atoms.div({
                                        tw: "order-item"
                                    }, {
                                        default: [
                                            window.Mishkah.Atoms.div({
                                                tw: "flex justify-between items-center"
                                            }, {
                                                default: [
                                                    window.Mishkah.Atoms.div({}, {
                                                        default: [item.translations[ctx.env.get().locale]?.name || item.translations.en.name]
                                                    }),
                                                    window.Mishkah.Atoms.div({
                                                        tw: "font-bold"
                                                    }, {
                                                        default: [`${item.price * item.quantity} ${database.settings.currency[ctx.env.get().locale]}`]
                                                    })
                                                ]
                                            }),
                                            window.Mishkah.Atoms.div({
                                                tw: "flex justify-between items-center mt-2"
                                            }, {
                                                default: [
                                                    window.Mishkah.Atoms.div({
                                                        tw: "quantity-controls"
                                                    }, {
                                                        default: [
                                                            window.Mishkah.Atoms.button({
                                                                tw: "w-6 h-6 rounded-full bg-danger text-on-primary flex items-center justify-center",
                                                                onclick: () => actions.updateQuantity(index, item.quantity - 1)
                                                            }, {
                                                                default: ['-']
                                                            }),
                                                            window.Mishkah.Atoms.span({
                                                                tw: "font-bold"
                                                            }, {
                                                                default: [item.quantity]
                                                            }),
                                                            window.Mishkah.Atoms.button({
                                                                tw: "w-6 h-6 rounded-full bg-success text-on-primary flex items-center justify-center",
                                                                onclick: () => actions.updateQuantity(index, item.quantity + 1)
                                                            }, {
                                                                default: ['+']
                                                            })
                                                        ]
                                                    }),
                                                    window.Mishkah.Atoms.button({
                                                        tw: "text-danger text-sm",
                                                        onclick: () => actions.updateQuantity(index, 0)
                                                    }, {
                                                        default: ['Remove']
                                                    })
                                                ]
                                            })
                                        ]
                                    })
                                )
                            }),
                            
                            // Order Summary
                            window.Mishkah.Atoms.div({
                                tw: "p-4 border-t border-default"
                            }, {
                                default: [
                                    window.Mishkah.Atoms.div({
                                        tw: "flex justify-between mb-2"
                                    }, {
                                        default: [
                                            window.Mishkah.Atoms.span({}, {
                                                default: ['Subtotal:']
                                            }),
                                            window.Mishkah.Atoms.span({}, {
                                                default: [`${selectors.orderTotal(state).subtotal.toFixed(2)} ${database.settings.currency[ctx.env.get().locale]}`]
                                            })
                                        ]
                                    }),
                                    
                                    window.Mishkah.Atoms.div({
                                        tw: "flex justify-between mb-2"
                                    }, {
                                        default: [
                                            window.Mishkah.Atoms.span({}, {
                                                default: ['Discount:']
                                            }),
                                            window.Mishkah.Atoms.span({}, {
                                                default: [`-${selectors.orderTotal(state).discount.toFixed(2)} ${database.settings.currency[ctx.env.get().locale]}`]
                                            })
                                        ]
                                    }),
                                    
                                    window.Mishkah.Atoms.div({
                                        tw: "flex justify-between mb-2"
                                    }, {
                                        default: [
                                            window.Mishkah.Atoms.span({}, {
                                                default: ['Tax:']
                                            }),
                                            window.Mishkah.Atoms.span({}, {
                                                default: [`${selectors.orderTotal(state).tax.toFixed(2)} ${database.settings.currency[ctx.env.get().locale]}`]
                                            })
                                        ]
                                    }),
                                    
                                    window.Mishkah.Atoms.div({
                                        tw: "flex justify-between mb-4 font-bold text-lg"
                                    }, {
                                        default: [
                                            window.Mishkah.Atoms.span({}, {
                                                default: [ctx.i18n.t('total') + ':']
                                            }),
                                            window.Mishkah.Atoms.span({}, {
                                                default: [`${selectors.orderTotal(state).total.toFixed(2)} ${database.settings.currency[ctx.env.get().locale]}`]
                                            })
                                        ]
                                    }),
                                    
                                    window.Mishkah.Atoms.button({
                                        tw: "w-full bg-success text-on-primary p-3 rounded font-bold hover:bg-success-soft transition",
                                        onclick: () => processPayment(state, actions, ctx)
                                    }, {
                                        default: ['Process Payment']
                                    })
                                ]
                            })
                        ]
                    })
                ]
            });
        }

        function processPayment(state, actions, ctx) {
            // Payment processing logic would go here
            alert(`Payment processed: ${window.Mishkah.DSL.cx.selectors.orderTotal(state).total.toFixed(2)}`);
            
            // Reset order
            ctx.truth.set(s => ({
                ...s,
                currentOrder: {
                    items: [],
                    type: 'dine-in',
                    tableId: null,
                    customerInfo: {},
                    notes: '',
                    discount: 0,
                    status: 'open'
                },
                selectedTable: null
            }));
        }

        // Initialize theme toggle
        document.addEventListener('DOMContentLoaded', function() {
            // Add theme toggle button
            const themeToggle = window.Mishkah.Atoms.button({
                tw: "fixed top-4 right-4 bg-primary text-on-primary p-2 rounded-full shadow-lg",
                onclick: () => POSApp.env.toggleTheme()
            }, {
                default: ['ðŸŒ™']
            });
            
            document.body.appendChild(window.Mishkah.Atoms.toNode(themeToggle));
            
            // Add language toggle
            const langToggle = window.Mishkah.Atoms.button({
                tw: "fixed top-4 left-4 bg-ui p-2 rounded-full shadow-lg",
                onclick: () => POSApp.env.setLocale(POSApp.env.get().locale === 'ar' ? 'en' : 'ar')
            }, {
                default: ['AR/EN']
            });
            
            document.body.appendChild(window.Mishkah.Atoms.toNode(langToggle));
        });
    </script>
</body>
</html>