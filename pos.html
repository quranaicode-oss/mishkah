<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <title>مشكاة — نقطة البيع للمطاعم</title>
  <script src="pos-kds-chart-distribution.js"></script>
  <script>
    (function configureBranchParam(global) {
      if (!global) return;
      const allowed = ['dar', 'remal'];
      global.POS_ALLOWED_BRANCHES = allowed.slice();
      global.__MishkahChartReady__ = Promise.resolve();
      const normalize = (value) => {
        if (typeof value !== 'string') return '';
        return value
          .toLowerCase()
          .trim()
          .replace(/[^a-z0-9_-]+/g, '-')
          .replace(/^-+|-+$/g, '');
      };
      let branchParam = null;
      try {
        const params = new URLSearchParams(global.location ? global.location.search || '' : '');
        branchParam = normalize(params.get('brname'));
      } catch (_err) {
        branchParam = '';
      }
      if (branchParam && allowed.includes(branchParam)) {
        global.POS_BRANCH_PARAM = branchParam;
        global.POS_BRANCH_ERROR = null;
        const distributor = global.MishkahChartDistributor;
        if (distributor && typeof distributor.prepare === 'function') {
          const readiness = Promise.resolve()
            .then(() => distributor.prepare('pos'))
            .catch((error) => {
              const code = error && error.code ? error.code : 'chart-package-failed';
              global.POS_BRANCH_ERROR = code === 'chart-version-mismatch'
                ? 'chart-version-mismatch'
                : 'chart-package-failed';
              global.__MishkahChartReadyError__ = { screen: 'pos', code, error };
              throw error;
            });
          global.__MishkahChartReady__ = readiness;
        }
      } else {
        global.POS_BRANCH_PARAM = null;
        global.POS_BRANCH_ERROR = branchParam ? 'unsupported-branch' : 'missing-branch';
      }
    })(typeof window !== 'undefined' ? window : null);
  </script>
  <style>
    :root { color-scheme: light dark; }
    html, body {
      height: 100%;
      min-height: 100vh;
      width: 100vw;
      margin: 0;
      overflow: hidden;
      background: var(--background, #0f1115);
    }
    body {
      font-family: "Tajawal", "Cairo", system-ui, sans-serif;
      touch-action: manipulation;
      display: flex;
      min-height: 100vh;
      width: 100vw;
    }
    #app {
      flex: 1 1 auto;
      min-height: 100vh;
      width: 100vw;
      display: flex;
    }
    .pos-shell { flex: 1 1 auto; width: 100vw; }
  </style>
  <script src="mishkah-utils.js"></script>
  <script src="mishkah.core.js"></script>
  <script src="mishkah-ui.js"></script>
  <script src="mishkah-schema.js"></script>
  <script src="mishkah-indexeddb.js"></script>
  <script src="schema-pos.js"></script>
  <script src="pos-service-adapter.js"></script>
  <script src="pos-sync-auth.js"></script>
  <script>
    (function preloadSchemaManifest(global) {
      if (!global) return;
      if (global.MishkahSchemaManifestPromise) return;
      const manifestUrl = './schema-manifest.json';
      if (typeof global.fetch !== 'function') {
        const fallback = Promise.resolve(null);
        global.MishkahSchemaManifestPromise = fallback;
        global.MishkahSchemaManifest = null;
        global.MishkahSchemaManifestError = new Error('fetch unavailable');
        return;
      }
      const loader = (async () => {
        try {
          const response = await fetch(manifestUrl, { cache: 'no-store' });
          if (!response.ok) {
            throw new Error(`Failed to load manifest: ${response.status}`);
          }
          const payload = await response.json();
          global.MishkahSchemaManifest = payload;
          return payload;
        } catch (error) {
          console.warn('[Mishkah] schema manifest bootstrap failed', error);
          global.MishkahSchemaManifestError = error;
          return null;
        }
      })();
      global.MishkahSchemaManifestPromise = loader;
    })(typeof window !== 'undefined' ? window : null);
  </script>
  <script>
    (function configurePosWs(global){
      if(!global) return;
      const loc = global.location || null;
      const doc = global.document || null;
      const readCookie = (name)=>{
        if(!doc || !doc.cookie) return null;
        const match = doc.cookie.split(';').map(entry=> entry.trim()).find(entry=> entry.startsWith(`${name}=`));
        if(!match) return null;
        return decodeURIComponent(match.split('=').slice(1).join('='));
      };
      const writeCookie = (name, value, days)=>{
        if(!doc) return;
        const maxAge = Number.isFinite(days) ? Math.round(days * 24 * 60 * 60) : 31536000;
        const sanitized = encodeURIComponent(value);
        const parts = [
          `${name}=${sanitized}`,
          'path=/',
          `max-age=${maxAge}`,
          'SameSite=Lax'
        ];
        doc.cookie = parts.join('; ');
      };
      const randomChunk = (size=8)=>{
        const pool = 'abcdefghijklmnopqrstuvwxyz0123456789';
        let out = '';
        for(let i = 0; i < size; i += 1){
          out += pool[Math.floor(Math.random() * pool.length)];
        }
        return out;
      };
      const createUuid = ()=>{
        if(global.crypto && typeof global.crypto.randomUUID === 'function'){
          return global.crypto.randomUUID();
        }
        return `uuid-${Date.now().toString(36)}-${randomChunk(10)}`;
      };
      const normalizeId = (raw, fallback)=>{
        const value = typeof raw === 'string' ? raw.trim().toLowerCase() : '';
        if(!value) return fallback;
        const normalized = value.replace(/[^a-z0-9_-]+/g, '-').replace(/^-+|-+$/g, '');
        return normalized || fallback;
      };

      let userUniid = normalizeId(readCookie('UserUniid'), '');
      if(!userUniid){
        userUniid = normalizeId(createUuid(), `usr-${randomChunk(6)}`);
        writeCookie('UserUniid', userUniid, 365);
      }

      const rawBranchCookie = readCookie('UserBranshID');
      let userBranchId = normalizeId(rawBranchCookie, '');
      if(!userBranchId){
        const host = loc?.hostname || loc?.host || '';
        userBranchId = normalizeId(host, '');
      }
      if(!userBranchId){
        userBranchId = normalizeId(`branch-${randomChunk(10)}`, 'branch-main');
      }

      global.UserUniid = userUniid;
      global.UserBranshID = userBranchId;
      global.POS_WS2_IDENTIFIERS = {
        userId: userUniid,
        branchId: userBranchId,
        hasBranchCookie: !!rawBranchCookie
      };

      const defaultScheme = ()=>{
        if(!loc || !loc.protocol) return 'wss:';
        return loc.protocol === 'https:' ? 'wss:' : loc.protocol === 'http:' ? 'ws:' : 'wss:';
      };
      const hostWithPort = ()=>{
        if(!loc) return null;
        if(loc.host) return loc.host;
        if(!loc.hostname) return null;
        return loc.port ? `${loc.hostname}:${loc.port}` : loc.hostname;
      };
      const normalizeEndpoint = (raw)=>{
        const trimmed = typeof raw === 'string' ? raw.trim() : '';
        if(!trimmed) return null;
        if(/^wss?:\/\//i.test(trimmed)) return trimmed;
        if(trimmed.startsWith('//')) return `${defaultScheme()}${trimmed}`;
        if(trimmed.startsWith('/')){
          const host = hostWithPort();
          return host ? `${defaultScheme()}//${host}${trimmed}` : null;
        }
        if(!trimmed.includes('://')){
          return `${defaultScheme()}//${trimmed}`;
        }
        return trimmed;
      };
      const sync = ((((global.database || {}).settings) || {}).sync) || {};
      const endpointCandidates = [
        global.POS_WS2_CONFIG && global.POS_WS2_CONFIG.endpoint,
        global.POS_WS2_ENDPOINT,
        sync.ws_endpoint,
        sync.wsEndpoint,
        sync.pos_ws_endpoint,
        sync.posWsEndpoint
      ];
      let endpoint = null;
      for(const candidate of endpointCandidates){
        endpoint = normalizeEndpoint(candidate);
        if(endpoint) break;
      }
      if(!endpoint){
        const host = hostWithPort();
        endpoint = host ? `${defaultScheme()}//${host}` : 'wss://ws.mas.com.eg';
      }
      const branchCandidates = [
        global.POS_BRANCH_PARAM,
        global.POS_WS2_CONFIG && global.POS_WS2_CONFIG.branchId,
        userBranchId,
        sync.branch_id,
        sync.branchId,
        sync.channel,
        'branch-main'
      ];
      let branchId = userBranchId || 'branch-main';
      for(const candidate of branchCandidates){
        if(typeof candidate === 'string' && candidate.trim()){
          branchId = normalizeId(candidate, branchId);
          break;
        }
      }
      const role = (global.POS_WS2_CONFIG && typeof global.POS_WS2_CONFIG.role === 'string' && global.POS_WS2_CONFIG.role.trim())
        ? global.POS_WS2_CONFIG.role.trim()
        : 'pos-app';
      const historyLimit = (global.POS_WS2_CONFIG && Number.isFinite(global.POS_WS2_CONFIG.historyLimit))
        ? Number(global.POS_WS2_CONFIG.historyLimit)
        : 50;
      global.POS_WS2_CONFIG = {
        endpoint,
        branchId,
        role,
        historyLimit,
        userId: userUniid
      };
    })(typeof window !== 'undefined' ? window : null);
  </script>
  <script src="pos-ws2-bootstrap.js"></script>
  <script src="kds-mock-data.js"></script>
</head>
<body>
  <div id="app"></div>
  <script>
    (function bootstrapPos(global) {
      if (!global) return;
      const branchId = global.POS_BRANCH_PARAM;
      const allowed = Array.isArray(global.POS_ALLOWED_BRANCHES) ? global.POS_ALLOWED_BRANCHES : [];
      const container = global.document && global.document.getElementById('app');
      if (!branchId || (allowed.length && !allowed.includes(branchId))) {
        if (container) {
          const reasonKey = global.POS_BRANCH_ERROR || 'missing-branch';
          const reason = reasonKey === 'unsupported-branch'
            ? 'اسم الفرع غير مدعوم'
            : reasonKey === 'chart-version-mismatch'
              ? 'إصدار الحزمة الرسومية تغيّر'
              : reasonKey === 'chart-package-failed'
                ? 'تعذّر تحميل الحزمة الرسومية'
            : 'لم يتم تحديد الفرع';
          const hint = allowed.length ? allowed.map((entry) => `?brname=${entry}`).join(' أو ') : '?brname=<branch>';
          const action = reasonKey === 'chart-version-mismatch'
            ? 'يرجى إعادة تحميل الصفحة أو الضغط على زر إعادة التهيئة لمسح بيانات الرسم السابقة.'
            : reasonKey === 'chart-package-failed'
              ? 'حاول إعادة تحميل الصفحة لاحقًا أو تحقق من الاتصال بالشبكة.'
              : '';
          const recovery = reasonKey === 'chart-version-mismatch'
            ? `<button type="button" style="margin-top:1.75rem;padding:0.85rem 1.5rem;border-radius:999px;border:none;background:rgba(79,70,229,0.18);color:#c7d2fe;font-size:1rem;cursor:pointer;" onclick="(async function(){ if(window.MishkahChartDistributor){ try{ await window.MishkahChartDistributor.reset(); } catch(_err){} } window.location.reload(); })()">إعادة التهيئة الآن</button>`
            : '';
          container.innerHTML = `
            <section style="margin:auto;max-width:560px;padding:3rem 2rem;text-align:center;color:#f8fafc;background:rgba(15,23,42,0.72);border-radius:1.5rem;border:1px solid rgba(148,163,184,0.35);backdrop-filter:blur(8px);">
              <h1 style="font-size:2rem;margin-bottom:1rem;">يرجى اختيار الفرع</h1>
              <p style="margin:0 auto 1.5rem;line-height:1.8;">
                تحتاج شاشة نقطة البيع إلى تحديد الفرع عبر معامل <code>brname</code> في الرابط.<br/>
                مثال: <code>${hint}</code>
              </p>
              <p style="margin:0;font-size:0.95rem;color:rgba(226,232,240,0.75);">
                السبب: <strong>${reason}</strong>
              </p>
              ${action ? `<p style="margin:1rem auto 0;font-size:0.95rem;color:rgba(244,244,245,0.8);">${action}</p>` : ''}
              ${recovery}
            </section>
          `;
        }
        return;
      }
      global.MishkahBranchChannel = branchId;
      global.MishkahKdsChannel = branchId;
      global.POS_WS2_CONFIG = global.POS_WS2_CONFIG || {};
      global.POS_WS2_CONFIG.branchId = branchId;
      global.POS_WS2_DYNAMIC_ENDPOINTS = {
        branchId,
        moduleId: 'pos',
        restBase: `/api/branch/${encodeURIComponent(branchId)}/modules/pos`
      };
      if (!global.POS_SERVICE_ADAPTER) {
        const factory = global.MishkahPosServiceAdapter;
        if (factory && typeof factory.create === 'function') {
          try {
            global.POS_SERVICE_ADAPTER = factory.create({
              branchId,
              moduleId: 'pos',
              dbName: `mishkah-pos-service-${branchId}`
            });
          } catch (adapterError) {
            console.warn('[Mishkah][POS] Failed to initialise service adapter.', adapterError);
          }
        }
      }
      const readiness = global.__MishkahChartReady__ || Promise.resolve();
      const ensurePosCache = () => {
        const idb = global.MishkahIndexedDB || null;
        if(!idb) return null;
        const namespace = branchId ? `pos:${branchId}` : 'pos:default';
        const adapter = global.__MishkahPosCacheAdapter__
          || idb.createAdapter({ name:'mishkah-sync', namespace, version:1 });
        global.__MishkahPosCacheAdapter__ = adapter;
        global.POS_WS2_CACHE = global.POS_WS2_CACHE || { table:'snapshot' };
        global.POS_WS2_CACHE.adapter = adapter;
        global.POS_WS2_CACHE.table = 'snapshot';
        const hydrate = async ()=>{
          try {
            await adapter.ready;
            const cached = await adapter.load('snapshot');
            if(cached && cached.data){
              global.__MishkahCachedPosSnapshot__ = cached;
              const existing = global.database && typeof global.database === 'object' ? global.database : {};
              global.database = { ...cached.data, ...existing };
            }
          } catch(error){
            console.warn('[Mishkah][POS] Failed to hydrate IndexedDB snapshot', error);
          }
        };
        return hydrate();
      };
      const loadScript = (src) => new Promise((resolve, reject) => {
        const script = global.document.createElement('script');
        script.src = src;
        script.defer = false;
        script.onload = () => resolve();
        script.onerror = (event) => reject(new Error(`Failed to load script ${src}`));
        global.document.body.appendChild(script);
      });
      Promise.resolve(readiness)
        .then(()=> ensurePosCache())
        .then(() => ['pos-ws.js', 'pos-comp.js', 'pos-orders.js', 'pos.js'].reduce((chain, file) => {
          return chain.then(() => loadScript(`${file}`));
        }, Promise.resolve()))
        .catch((error) => {
          console.error('[Mishkah][POS] Chart package readiness failed', error);
          if (!container) return;
          const errorCode = (error && error.code) ? error.code : (global.POS_BRANCH_ERROR || 'chart-package-failed');
          const reason = errorCode === 'chart-version-mismatch'
            ? 'إصدار الحزمة الرسومية تغيّر'
            : 'تعذّر تحميل الحزمة الرسومية';
          const action = errorCode === 'chart-version-mismatch'
            ? 'يرجى إعادة تحميل الصفحة بعد مسح بيانات التخزين المرتبطة بالمخططات.'
            : 'تحقق من الاتصال وأعد المحاولة لاحقًا.';
          const recovery = errorCode === 'chart-version-mismatch'
            ? `<button type="button" style=\"margin-top:1.75rem;padding:0.85rem 1.5rem;border-radius:999px;border:none;background:rgba(79,70,229,0.18);color:#c7d2fe;font-size:1rem;cursor:pointer;\" onclick=\"(async function(){ if(window.MishkahChartDistributor){ try{ await window.MishkahChartDistributor.reset(); } catch(_err){} } window.location.reload(); })()\">إعادة التهيئة الآن</button>`
            : '';
          container.innerHTML = `
            <section style="margin:auto;max-width:560px;padding:3rem 2rem;text-align:center;color:#f8fafc;background:rgba(15,23,42,0.72);border-radius:1.5rem;border:1px solid rgba(148,163,184,0.35);backdrop-filter:blur(8px);">
              <h1 style="font-size:2rem;margin-bottom:1rem;">تعذّر بدء الواجهة</h1>
              <p style="margin:0 auto 1.5rem;line-height:1.8;">
                فشل تجهيز بيانات المخطط المطلوبة لتشغيل الشاشة الحالية.
              </p>
              <p style="margin:0;font-size:0.95rem;color:rgba(226,232,240,0.75);">
                السبب: <strong>${reason}</strong>
              </p>
              <p style="margin:1rem auto 0;font-size:0.95rem;color:rgba(244,244,245,0.8);">${action}</p>
              ${recovery}
            </section>
          `;
        });
    })(typeof window !== 'undefined' ? window : null);
  </script>


</body>
</html>
