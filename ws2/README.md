# Mishkah WS2 Gateway

WS2 هو خادم WebSocket خفيف تم تصميمه لتجارب نقطة البيع في Mishkah. يقرأ الخادم قاعدة بيانات JSON واحدة،
ينشئ نسخة "مباشرة" لكل فرع، ويحافظ على سجل تاريخي لكل تعديل داخل مجلد `data/history/`. الهدف هو تبسيط
التجارب المبكرة بعيدًا عن تعقيدات البنية الحالية، مع توفير قنوات تشخيصية واضحة للعميل والخادم.

## الميزات الأساسية
- تحميل ملف seed واحد (`data/pos-dataset.json`) وتحويله إلى snapshot حي لكل فرع.
- بروتوكول بسيط قائم على JSON:
  - `client:hello` لتحديد الفرع والدور وطلب snapshot/التاريخ.
  - `server:snapshot` يحتوي نسخة كاملة، مع `historySize` وبيانات وصفية.
  - `client:publish` مع الحقول `action=event|merge|replace|reset` لنشر أي JSON ديناميكي.
  - `server:event` لإعادة بث التحديثات لكل العملاء في الفرع، مع نسخة snapshot جديدة عند الحاجة.
  - `server:log` لرسائل التشخيص (تحذيرات، أخطاء، معلومات عامة).
- نقطة صحة HTTP (`/healthz`) ومسار قراءة سريع لأي فرع (`/branches/:id`).
- حفظ السجل في `data/history/<branch>.json` بعد كل تعديل.

## الإعداد والتشغيل
```bash
cd ws2
npm install
npm run start
```

المتغيرات المتاحة:
- `PORT` (افتراضي 3200)
- `HOST` (افتراضي `0.0.0.0`)
- `DATASET_PATH` لتغيير ملف الـJSON الأساسي.
- `HISTORY_DIR` لحفظ ملفات التاريخ في مسار مختلف.
- `LOG_LEVEL` لضبط مستوى التسجيل (`info`, `debug`, `trace`, ...).

## واجهة العميل
ملف `pos-ws2-bootstrap.js` في جذر المستودع يوفر عميلًا جاهزًا يعمل في المتصفح:
- يحافظ على Promise واحدة `whenReady()` تعود بالـsnapshot الأول.
- يعيد نشر التحديثات عبر `subscribe`.
- يوفّر `publish` و`requestHistory` للتعامل مع الخادم مباشرةً.

يمكن إعادة استخدام العميل نفسه مع أي مشروع HTMLx داخل Mishkah دون الاضطرار لتغيير منطق POS الحالي.
