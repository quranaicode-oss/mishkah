# Mishkah WS2 Gateway

## هيكل ديناميكي للفروع والموديولات

نواة WS2 أصبحت الآن تعتمد على المسارات بدلاً من ملفات ثابتة عامة. كل فرع يحتفظ بملفاته الخاصة داخل `data/branches/<branch-name>/modules/<module-name>/` بحيث يتكوّن الموديول من:

```
modules/
  pos/
    schema/definition.json   # مخطط البيانات المخصص للفرع
    seeds/initial.json       # بذور البداية (insert-only)
    live/.gitkeep            # آخر لقطة فعّالة للبيانات
    history/.gitkeep         # أرشيف للقطات السابقة
```

عند تشغيل الخادم يقوم WS2 بقراءة هذا الهيكل تلقائيًا، تحميل المخططات، ضخ البذور، ثم تخزين الحالة الجارية داخل مجلد `live/`. أي لقطة جديدة يتم أرشفتها تلقائيًا داخل `history/` باستخدام طابع زمني.

## فروع البداية

- `dar` — الفرع الرئيسي.
- `remal` — الفرع السحابي.

كلا الفرعين يبدآن بموديول `pos` وبذور متطابقة، ويمكن إضافة فروع جديدة ببساطة عن طريق إنشاء المسار نفسه ونسخ ملفات المخطط والبذور المطلوبة.

## واجهات API التلقائية

يمكن الوصول إلى البيانات وفقًا للمسارات الجديدة:

- `GET /api/branches` — قائمة مختصرة بجميع الفروع والموديولات المحملة.
- `GET /api/branches/<branch>/modules/<module>` — استرجاع لقطة الموديول الحالية.
- `POST /api/branches/<branch>/modules/<module>/events` — بث حدث insert-only إلى الموديول.
- `POST /api/branches/<branch>/modules/<module>/reset` — إعادة تهيئة الموديول مع أرشفة الحالة السابقة.
- تم توفير اختصار مكافئ عبر `GET /api/branch/<branch>/<module>` لمن يحتاج مسارًا أقصر.

جميع نقاط التزامن التقليدية (`/api/sync`, `/api/pos-sync`) ما تزال تعمل ولكنها الآن تعتمد على نفس نظام التخزين الديناميكي.

## العمل بمبدأ INSERT ONLY

الموديول `pos` مبني على فكرة تدفق البيانات في اتجاه واحد فقط:

- لا توجد عمليات تحديث (`UPDATE`) أو حذف (`DELETE`).
- كل تغيير يُمثّل كتسجيل جديد (على سبيل المثال سجل `Return` لإلغاء صنف أو log للحالات).
- يسهل هذا المفهوم نشر البيانات على أكثر من عميل ويؤسس لاحقًا لدعم بلوك تشين أو وضع offline.

تم تجهيز البذور والمخططات بما يلزم لتبني هذا الأسلوب، ويمكن تعديل الجداول الحساسة مثل `orders`, `order_lines`, `job_orders` عبر أحداث insert جديدة فقط.

## متطلبات الواجهات الأمامية

- صفحة POS (`pos.html`) وKDS (`kds.html`) لن تحمّل أي بيانات ما لم يتم تمرير معامل `brname` في رابط الصفحة. مثال:

```
pos.html?brname=dar
kds.html?brname=remal
```

- عند غياب المعامل تظهر رسالة توضيحية للمطور توضح الأفرع المتاحة وكيفية تمريرها في الرابط.
- يتم ضبط قنوات التزامن تلقائيًا بناءً على قيمة `brname` لضمان استهلاك بيانات الفرع الصحيح.

## إضافة فرع أو موديول جديد

1. أنشئ المسار `data/branches/<branch>/modules/<module>/`.
2. انسخ المخطط المناسب إلى `schema/definition.json`.
3. جهّز بذور البداية داخل `seeds/initial.json` بحيث تعتمد على insert only.
4. حدّث `data/branches.config.json` لتعريف الفرع وربطه بالموديول.
5. (اختياري) أضف تهيئة front-end لعرض الفرع الجديد في الرسالة التوضيحية أو واجهات الاختيار.

باتباع هذا النمط يصبح WS2 قادراً على قراءة هيكل البيانات ديناميكيًا، توليد نقاط API تلقائية، وإدارة السجلات الحية والتاريخية لكل فرع دون تدخل يدوي.

## أدلة تشغيلية (Operational Playbooks)

### إعادة ضبط يومية للفروع

- استخدم المسار `POST /api/manage/daily-reset` لتفريغ حالة الموديولات وإعادة تحميل البذور الخاصة بها.
- مثال على الطلب:

```http
POST /api/manage/daily-reset
Content-Type: application/json

{
  "branchId": "dar",
  "modules": ["pos"],
  "reason": "closing-shift",
  "requestedBy": "ops-team"
}
```

- عند عدم تحديد `modules` سيتم استخدام كل الموديولات المعرفة للفرع، مع تعيين علم (full-sync flag) تلقائيًا لإجبار العملاء على تحميل لقطة كاملة بعد الإعادة.
- يمكن تعطيل وضع العلم التلقائي عبر `"flagFullSync": false` إذا لم يكن ذلك مطلوبًا.

### تفعيل أو إلغاء أعلام المزامنة الكاملة

- نقاط الإدارة توفر المسار `POST /api/manage/full-sync` لتفعيل العلم، و`DELETE /api/manage/full-sync` لتعطيله.
- مثال تفعيل لموديول محدد:

```http
POST /api/manage/full-sync
Content-Type: application/json

{
  "branchId": "dar",
  "moduleId": "pos",
  "reason": "manual-audit",
  "requestedBy": "qa"
}
```

- يمكن تمرير مصفوفة عبر `modules` أو ترك الحقل فارغًا لتطبيق العلم على مستوى الفرع بأكمله (`moduleId = "*"`).
- الاستعلام عن الحالة الحالية يتم عن طريق `GET /api/manage/full-sync?branch=dar` والذي يعيد جميع الأعلام المفعّلة أو المعطّلة.

### تدقيق التعارضات وطلبات الدعم

- كل عملية رفض (مثل اكتشاف دفعة مكررة أو انتهاك سياسة insert-only) يتم تسجيلها في `events.rejected.log` داخل مجلد الموديول (`data/branches/<branch>/modules/<module>/live/`).
- السجلات تحتوي على `reason` و`transId` وبيانات التعريف للمساعدة في تتبع مصدر المشكلة أثناء التحقيق.
- يمكن مراقبة نشاط الويب سوكيت وطلبات REST عبر `GET /metrics` (مخرجات بصيغة Prometheus) أو عن طريق قراءة القيم التجميعية إن لم يتوفر `prom-client`.
